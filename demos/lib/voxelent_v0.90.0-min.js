try{if(!jQuery){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}}catch(e){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}var vxl={version:{number:"0.90.0",codename:"c4n314",plugins:[]},def:{piOver2:Math.PI/2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,essl:{VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",MODEL_VIEW_MATRIX:"mModelView",NORMAL_MATRIX:"mNormal",PERSPECTIVE_MATRIX:"mPerspective",MVP_MATRIX:"mModelViewPerspective",VERTEX_ATTRIBUTE:"aVertexPosition",NORMAL_ATTRIBUTE:"aVertexNormal",COLOR_ATTRIBUTE:"aVertexColor",TEXCOORD_ATTRIBUTE:"aVertexTextureCoords"},lut:{list:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],main:"default"},model:{loadingMode:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"},MAX_NUM_INDICES:65535,type:{SIMPLE:"SIMPLE",MESH:"MESH",BIG_DATA:"BIG DATA"}},material:{diffuse:[0.8,0.8,0.8,1],ambient:[0,0,0,1],specular:[0,0,0,1],shininess:0,opacity:1,shading:true},view:{background:[0.3,0.3,0.3]},interactor:{task:{NONE:0,PAN:1,ROTATE:2,DOLLY:3,ROLL:4}},actor:{mode:{TEXTURED:"TEXTURED",SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS",LINES:"LINES",BOUNDING_BOX:"BOUNDING_BOX",BB_AND_SOLID:"BBANDSOLID",WIRED_AND_SOLID:"WIRED_AND_SOLID",FLAT:"FLAT",},cull:{BACK:"BACK",FRONT:"FRONT",NONE:"NONE"},picking:{DISABLED:"DISABLED",CELL:"CELL",OBJECT:"OBJECT"}},camera:{type:{ORBITING:"ORBITING",TRACKING:"TRACKING",EXPLORING:"EXPLORING"},right:[1,0,0],up:[0,1,0],normal:[0,0,1],fov:30,near:0.1,far:10000,tracking:{DEFAULT:"DEFAULT",ROTATIONAL:"ROTATIONAL",TRANSLATIONAL:"TRANSLATIONAL",CINEMATIC:"CINEMATIC"}},renderer:{mode:{TIMER:"TIMER",ANIMFRAME:"ANIFRAME"},rate:{SLOW:10000,NORMAL:500}},renderable:{task:{CREATE:"CREATE",UPDATE_GEOMETRY:"UPDATE_GEOMETRY",UPDATE_COLORS:"UPDATE_COLORS"}},texture:{filter:{NEAREST:"NEAREST",LINEAR:"LINEAR",NEAREST_MIPMAP_NEAREST:"NEAREST_MIPMAP_NEAREST",LINEAR_MIPMAP_NEAREST:"LINEAR_MIPMAP_NEAREST",NEAREST_MIPMAP_LINEAR:"NEAREST_MIPMAP_LINEAR",LINEAR_MIPMAP_LINEAR:"LINEAR_MIPMAP_LINEAR"}}},events:{DEFAULT_LUT_LOADED:"vxl.events.DEFAULT_LUT_LOADED",SCENE_UPDATED:"vxl.events.SCENE_UPDATED",MODELS_LOADING:"vxl.events.MODELS_LOADING",MODEL_NEW:"vxl.events.MODEL_NEW",MODELS_LOADED:"vxl.events.MODELS_LOADED",ACTOR_MOVED:"vxl.events.ACTOR_MOVED",ACTOR_SCALED:"vxl.events.ACTOR_SCALED",ACTOR_ROTATED:"vxl.events.ACTOR_ROTATED",ACTOR_CHANGED_COLOR:"vxl.events.ACTOR_CHANGED_COLOR",ACTOR_CHANGED_SHADING:"vxl.events.ACTOR_CHANGED_SHADING",VIEW_NEW:"vxl.events.VIEW_NEW",SCENE_NEW:"vxl.events.SCENE_NEW",READER_DONE:"vxl.events.READER_DONE"},go:{debug:false,notifier:undefined,modelManager:undefined,lookupTableManager:undefined,views:[],scenes:[],essl:{},renderman:{_timid:0,_rates:[],_stop:false,render:function(){for(var a=0;
a<vxl.go.views.length;a+=1){vxl.go.views[a].renderer.render()}if(vxl.go.renderman._stop!=true){vxl.go.renderman._timid=window.requestAnimFrame(vxl.go.renderman.render)}else{vxl.go.renderman._stop=false}},cancel:function(){vxl.go.renderman._stop=true},slow:function(){},normal:function(){}},console:function(a,b){if(this.debug==true||b){console.info(a)}}},c:{scene:undefined,view:undefined,camera:undefined,actor:undefined,animation:undefined},util:{isMac:function(){return navigator.platform.toUpperCase().indexOf("MAC")!=-1
},int2rgb:function(a){return[((a>>16)&255)/256,((a>>8)&255)/256,(a&255)/256]},frac2rgb:function(f,d,a){var h=vxl.util.createArr3(f,d,a);h[0]=Math.round(255*h[0]);h[1]=Math.round(255*h[1]);h[2]=Math.round(255*h[2]);return h},rgb2frac:function(f,d,a){var h=vxl.util.createArr3(f,d,a);h[0]=Math.round(h[0]/255);h[1]=Math.round(h[1]/255);h[2]=Math.round(h[2]/255);return h},rgb2hex:function(f,d,a){var h=vxl.util.createArr3(f,d,a);return"#"+((1<<24)+(h[0]<<16)+(h[1]<<8)+h[2]).toString(16).slice(1)},hex2rgb:function(c){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;
c=c.replace(b,function(f,i,h,d){return i+i+h+h+d+d});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null},rgb2decimal:function(a){if(a==null||a==undefined){return null}return[a[0]/255,a[1]/255,a[2]/255]},createColor:function(h,f,a){var d=[];if(h==undefined){return null}if(h instanceof Array){var i=h.slice(0);h=i[0];f=i[1];a=i[2]}if(typeof(h)=="string"){d=this.rgb2decimal(this.hex2rgb(h))}else{if(typeof(h)=="number"){if(h<0||f==undefined||a==undefined||f<0||a<0){return null
}else{if(h>1||f>1||a>1){d=this.rgb2decimal([h,f,a])}else{d=[h,f,a]}}}}return d},format:function(b,d){var f=Math.pow(10,d);if(typeof(b)=="object"){var a="[";for(var c=0;c<b.length-1;c+=1){a+=Math.round(b[c]*f)/f+", "}a+=Math.round(b[b.length-1]*f)/f+"]"}else{if(typeof(b)=="number"){a="["+Math.round(b*f)/f+"]"}}return a},createVec3:function(a,d,c){var b=vec3.create();if(a instanceof Array||a instanceof Float32Array){b=vec3.clone(a)}else{b=vec3.fromValues(a,d,c)}return b},createArr3:function(a,d,c){var b=[];
if(a instanceof Array||a instanceof Float32Array){b[0]=a[0];b[1]=a[1];b[2]=a[2]}else{b[0]=a;b[1]=d;b[2]=c}return b},generateUID:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+"-"+a()+"-"+a()+"-"+a())},extend:function(){var b={};var a=arguments.length;for(var c=0;c<a;c++){for(p in arguments[c]){if(arguments[c].hasOwnProperty(p)){b[p]=arguments[c][p]}}}return b},getPath:function(a){if(a==undefined||a==null){return""}else{if(a.length-1==a.lastIndexOf("/")){return a
}else{if(a.lastIndexOf(".")>a.lastIndexOf("/")){return a.substring(0,a.lastIndexOf("/")+1)}else{return a+"/"}}}},getAngle:function(a){if(a>360||a<-360){return a%360}else{return a}},deg2rad:function(a){return a*Math.PI/180},doTimer:function(b,f,j,d){var h=(b/100)*(f/10),c=b/h,g=0,a=new Date().getTime();function i(){if(g++==h){d(h,g)}else{j(h,g);var k=(new Date().getTime()-a)-(g*c);window.setTimeout(i,(c-k))}}window.setTimeout(i,c)}}};Array.prototype.max=function(){if(this.length>65535){var a=this[0];
for(var b=0,c=this.length;b<c;b+=1){if(this[b]>a){a=this[b]}}return a}else{return Math.max.apply(null,this)}};Array.prototype.min=function(){if(this.length>65535){var b=this[0];for(var a=0,c=this.length;a<c;a+=1){if(this[a]<b){b=this[a]}}return b}else{return Math.min.apply(null,this)}};Array.prototype.hasObject=(!Array.indexOf?function(b){var a=this.length+1;while(a-=1){if(this[a-1]===b){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){return window.setTimeout(b,1000/60)
}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout})();function vxlNotifier(){this.targetList={};this.sourceList={}}vxlNotifier.prototype.subscribe=function(c,b){if(typeof(c)=="string"){this._addTarget(c,b)}else{if(c instanceof Array){for(var a=0;a<c.length;a+=1){this._addTarget(c[a],b)}}else{throw"vxlNotifier.receives: this method receives a string or a list of strings"}}};vxlNotifier.prototype.publish=function(c,b){if(typeof(c)=="string"){this._addSource(c,b)}else{if(c instanceof Array){for(var a=0;a<c.length;a+=1){this._addSource(c[a],b)}}else{throw"vxlNotifier.sends: this method receives a string or a list of strings"
}}};vxlNotifier.prototype._addTarget=function(a,b){vxl.go.console("vxlNotifier: adding target for event "+a);var c=this.targetList;if(c[a]==undefined){c[a]=[]}c[a].push(b)};vxlNotifier.prototype._addSource=function(b,d){vxl.go.console("vxlNotifier: adding source for event "+b);var c=this.targetList;var a=this.sourceList;if(a[b]==undefined){a[b]=[]}if(c[b]==undefined){c[b]=[]}a[b].push(d)};vxlNotifier.prototype.fire=function(c,d){if(this.targetList[c].length==0){return}var a=this;function b(){var h=a.targetList;
var e=a.sourceList[c].indexOf(d);if(e==-1){throw"The source "+d+" is not registered to trigger the event "+c+". Did you use vxlNotifier.publish?"}vxl.go.console("vxlNotifier: firing "+c);var f=a.targetList[c];for(var g=0;g<f.length;g++){f[g].handleEvent(c,d)}}setTimeout(function(){b()},0)};vxlNotifier.prototype.getEvents=function(){var b=[];for(var a in this.sourceList){b.push(a)}return b};vxlNotifier.prototype.getTargetsFor=function(c){var a=this.targetList[c];var d=[];for(var b=0;b<a.length;b++){d.push(a[b])
}return d};vxl.go.notifier=new vxlNotifier();(function(b){var a={};if(typeof(exports)==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){a.exports={};define(function(){return a.exports})}else{a.exports=typeof(window)!=="undefined"?window:b}}else{a.exports=exports}(function(k){if(!p){var p=0.000001}if(!e){var e=(typeof Float32Array!=="undefined")?Float32Array:Array}if(!i){var i=Math.random}var f={};f.setMatrixArrayType=function(q){e=q};if(typeof(k)!=="undefined"){k.glMatrix=f}var j=Math.PI/180;f.toRadian=function(q){return q*j
};var n={};n.create=function(){var q=new e(2);q[0]=0;q[1]=0;return q};n.clone=function(q){var r=new e(2);r[0]=q[0];r[1]=q[1];return r};n.fromValues=function(q,s){var r=new e(2);r[0]=q;r[1]=s;return r};n.copy=function(r,q){r[0]=q[0];r[1]=q[1];return r};n.set=function(r,q,s){r[0]=q;r[1]=s;return r};n.add=function(s,r,q){s[0]=r[0]+q[0];s[1]=r[1]+q[1];return s};n.subtract=function(s,r,q){s[0]=r[0]-q[0];s[1]=r[1]-q[1];return s};n.sub=n.subtract;n.multiply=function(s,r,q){s[0]=r[0]*q[0];s[1]=r[1]*q[1];
return s};n.mul=n.multiply;n.divide=function(s,r,q){s[0]=r[0]/q[0];s[1]=r[1]/q[1];return s};n.div=n.divide;n.min=function(s,r,q){s[0]=Math.min(r[0],q[0]);s[1]=Math.min(r[1],q[1]);return s};n.max=function(s,r,q){s[0]=Math.max(r[0],q[0]);s[1]=Math.max(r[1],q[1]);return s};n.scale=function(s,r,q){s[0]=r[0]*q;s[1]=r[1]*q;return s};n.scaleAndAdd=function(s,r,q,t){s[0]=r[0]+(q[0]*t);s[1]=r[1]+(q[1]*t);return s};n.distance=function(s,r){var q=r[0]-s[0],t=r[1]-s[1];return Math.sqrt(q*q+t*t)};n.dist=n.distance;
n.squaredDistance=function(s,r){var q=r[0]-s[0],t=r[1]-s[1];return q*q+t*t};n.sqrDist=n.squaredDistance;n.length=function(r){var q=r[0],s=r[1];return Math.sqrt(q*q+s*s)};n.len=n.length;n.squaredLength=function(r){var q=r[0],s=r[1];return q*q+s*s};n.sqrLen=n.squaredLength;n.negate=function(r,q){r[0]=-q[0];r[1]=-q[1];return r};n.normalize=function(t,s){var r=s[0],u=s[1];var q=r*r+u*u;if(q>0){q=1/Math.sqrt(q);t[0]=s[0]*q;t[1]=s[1]*q}return t};n.dot=function(r,q){return r[0]*q[0]+r[1]*q[1]};n.cross=function(s,r,q){var t=r[0]*q[1]-r[1]*q[0];
s[0]=s[1]=0;s[2]=t;return s};n.lerp=function(s,r,q,u){var w=r[0],v=r[1];s[0]=w+u*(q[0]-w);s[1]=v+u*(q[1]-v);return s};n.random=function(q,t){t=t||1;var s=i()*2*Math.PI;q[0]=Math.cos(s)*t;q[1]=Math.sin(s)*t;return q};n.transformMat2=function(t,s,r){var q=s[0],u=s[1];t[0]=r[0]*q+r[2]*u;t[1]=r[1]*q+r[3]*u;return t};n.transformMat2d=function(t,s,r){var q=s[0],u=s[1];t[0]=r[0]*q+r[2]*u+r[4];t[1]=r[1]*q+r[3]*u+r[5];return t};n.transformMat3=function(t,s,r){var q=s[0],u=s[1];t[0]=r[0]*q+r[3]*u+r[6];t[1]=r[1]*q+r[4]*u+r[7];
return t};n.transformMat4=function(t,s,r){var q=s[0],u=s[1];t[0]=r[0]*q+r[4]*u+r[12];t[1]=r[1]*q+r[5]*u+r[13];return t};n.forEach=(function(){var q=n.create();return function(t,x,y,w,v,r){var u,s;if(!x){x=2}if(!y){y=0}if(w){s=Math.min((w*x)+y,t.length)}else{s=t.length}for(u=y;u<s;u+=x){q[0]=t[u];q[1]=t[u+1];v(q,q,r);t[u]=q[0];t[u+1]=q[1]}return t}})();n.str=function(q){return"vec2("+q[0]+", "+q[1]+")"};if(typeof(k)!=="undefined"){k.vec2=n}var m={};m.create=function(){var q=new e(3);q[0]=0;q[1]=0;
q[2]=0;return q};m.clone=function(q){var r=new e(3);r[0]=q[0];r[1]=q[1];r[2]=q[2];return r};m.fromValues=function(q,t,s){var r=new e(3);r[0]=q;r[1]=t;r[2]=s;return r};m.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];return r};m.set=function(r,q,t,s){r[0]=q;r[1]=t;r[2]=s;return r};m.add=function(s,r,q){s[0]=r[0]+q[0];s[1]=r[1]+q[1];s[2]=r[2]+q[2];return s};m.subtract=function(s,r,q){s[0]=r[0]-q[0];s[1]=r[1]-q[1];s[2]=r[2]-q[2];return s};m.sub=m.subtract;m.multiply=function(s,r,q){s[0]=r[0]*q[0];
s[1]=r[1]*q[1];s[2]=r[2]*q[2];return s};m.mul=m.multiply;m.divide=function(s,r,q){s[0]=r[0]/q[0];s[1]=r[1]/q[1];s[2]=r[2]/q[2];return s};m.div=m.divide;m.min=function(s,r,q){s[0]=Math.min(r[0],q[0]);s[1]=Math.min(r[1],q[1]);s[2]=Math.min(r[2],q[2]);return s};m.max=function(s,r,q){s[0]=Math.max(r[0],q[0]);s[1]=Math.max(r[1],q[1]);s[2]=Math.max(r[2],q[2]);return s};m.scale=function(s,r,q){s[0]=r[0]*q;s[1]=r[1]*q;s[2]=r[2]*q;return s};m.scaleAndAdd=function(s,r,q,t){s[0]=r[0]+(q[0]*t);s[1]=r[1]+(q[1]*t);
s[2]=r[2]+(q[2]*t);return s};m.distance=function(s,r){var q=r[0]-s[0],u=r[1]-s[1],t=r[2]-s[2];return Math.sqrt(q*q+u*u+t*t)};m.dist=m.distance;m.squaredDistance=function(s,r){var q=r[0]-s[0],u=r[1]-s[1],t=r[2]-s[2];return q*q+u*u+t*t};m.sqrDist=m.squaredDistance;m.length=function(r){var q=r[0],t=r[1],s=r[2];return Math.sqrt(q*q+t*t+s*s)};m.len=m.length;m.squaredLength=function(r){var q=r[0],t=r[1],s=r[2];return q*q+t*t+s*s};m.sqrLen=m.squaredLength;m.negate=function(r,q){r[0]=-q[0];r[1]=-q[1];r[2]=-q[2];
return r};m.normalize=function(t,s){var r=s[0],v=s[1],u=s[2];var q=r*r+v*v+u*u;if(q>0){q=1/Math.sqrt(q);t[0]=s[0]*q;t[1]=s[1]*q;t[2]=s[2]*q}return t};m.dot=function(r,q){return r[0]*q[0]+r[1]*q[1]+r[2]*q[2]};m.cross=function(r,w,v){var q=w[0],y=w[1],x=w[2],u=v[0],t=v[1],s=v[2];r[0]=y*s-x*t;r[1]=x*u-q*s;r[2]=q*t-y*u;return r};m.lerp=function(s,r,q,u){var x=r[0],w=r[1],v=r[2];s[0]=x+u*(q[0]-x);s[1]=w+u*(q[1]-w);s[2]=v+u*(q[2]-v);return s};m.random=function(q,v){v=v||1;var t=i()*2*Math.PI;var u=(i()*2)-1;
var s=Math.sqrt(1-u*u)*v;q[0]=Math.cos(t)*s;q[1]=Math.sin(t)*s;q[2]=u*v;return q};m.transformMat4=function(t,s,r){var q=s[0],v=s[1],u=s[2];t[0]=r[0]*q+r[4]*v+r[8]*u+r[12];t[1]=r[1]*q+r[5]*v+r[9]*u+r[13];t[2]=r[2]*q+r[6]*v+r[10]*u+r[14];return t};m.transformMat3=function(t,s,r){var q=s[0],v=s[1],u=s[2];t[0]=q*r[0]+v*r[3]+u*r[6];t[1]=q*r[1]+v*r[4]+u*r[7];t[2]=q*r[2]+v*r[5]+u*r[8];return t};m.transformQuat=function(A,G,r){var H=G[0],F=G[1],E=G[2],C=r[0],B=r[1],w=r[2],D=r[3],u=D*H+B*E-w*F,t=D*F+w*H-C*E,s=D*E+C*F-B*H,v=-C*H-B*F-w*E;
A[0]=u*D+v*-C+t*-w-s*-B;A[1]=t*D+v*-B+s*-C-u*-w;A[2]=s*D+v*-w+u*-B-t*-C;return A};m.rotateX=function(t,s,q,w){var v=[],u=[];v[0]=s[0]-q[0];v[1]=s[1]-q[1];v[2]=s[2]-q[2];u[0]=v[0];u[1]=v[1]*Math.cos(w)-v[2]*Math.sin(w);u[2]=v[1]*Math.sin(w)+v[2]*Math.cos(w);t[0]=u[0]+q[0];t[1]=u[1]+q[1];t[2]=u[2]+q[2];return t};m.rotateY=function(t,s,q,w){var v=[],u=[];v[0]=s[0]-q[0];v[1]=s[1]-q[1];v[2]=s[2]-q[2];u[0]=v[2]*Math.sin(w)+v[0]*Math.cos(w);u[1]=v[1];u[2]=v[2]*Math.cos(w)-v[0]*Math.sin(w);t[0]=u[0]+q[0];
t[1]=u[1]+q[1];t[2]=u[2]+q[2];return t};m.rotateZ=function(t,s,q,w){var v=[],u=[];v[0]=s[0]-q[0];v[1]=s[1]-q[1];v[2]=s[2]-q[2];u[0]=v[0]*Math.cos(w)-v[1]*Math.sin(w);u[1]=v[0]*Math.sin(w)+v[1]*Math.cos(w);u[2]=v[2];t[0]=u[0]+q[0];t[1]=u[1]+q[1];t[2]=u[2]+q[2];return t};m.forEach=(function(){var q=m.create();return function(t,x,y,w,v,r){var u,s;if(!x){x=3}if(!y){y=0}if(w){s=Math.min((w*x)+y,t.length)}else{s=t.length}for(u=y;u<s;u+=x){q[0]=t[u];q[1]=t[u+1];q[2]=t[u+2];v(q,q,r);t[u]=q[0];t[u+1]=q[1];
t[u+2]=q[2]}return t}})();m.str=function(q){return"vec3("+q[0]+", "+q[1]+", "+q[2]+")"};if(typeof(k)!=="undefined"){k.vec3=m}var l={};l.create=function(){var q=new e(4);q[0]=0;q[1]=0;q[2]=0;q[3]=0;return q};l.clone=function(q){var r=new e(4);r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];return r};l.fromValues=function(q,u,t,r){var s=new e(4);s[0]=q;s[1]=u;s[2]=t;s[3]=r;return s};l.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];return r};l.set=function(s,q,u,t,r){s[0]=q;s[1]=u;s[2]=t;s[3]=r;
return s};l.add=function(s,r,q){s[0]=r[0]+q[0];s[1]=r[1]+q[1];s[2]=r[2]+q[2];s[3]=r[3]+q[3];return s};l.subtract=function(s,r,q){s[0]=r[0]-q[0];s[1]=r[1]-q[1];s[2]=r[2]-q[2];s[3]=r[3]-q[3];return s};l.sub=l.subtract;l.multiply=function(s,r,q){s[0]=r[0]*q[0];s[1]=r[1]*q[1];s[2]=r[2]*q[2];s[3]=r[3]*q[3];return s};l.mul=l.multiply;l.divide=function(s,r,q){s[0]=r[0]/q[0];s[1]=r[1]/q[1];s[2]=r[2]/q[2];s[3]=r[3]/q[3];return s};l.div=l.divide;l.min=function(s,r,q){s[0]=Math.min(r[0],q[0]);s[1]=Math.min(r[1],q[1]);
s[2]=Math.min(r[2],q[2]);s[3]=Math.min(r[3],q[3]);return s};l.max=function(s,r,q){s[0]=Math.max(r[0],q[0]);s[1]=Math.max(r[1],q[1]);s[2]=Math.max(r[2],q[2]);s[3]=Math.max(r[3],q[3]);return s};l.scale=function(s,r,q){s[0]=r[0]*q;s[1]=r[1]*q;s[2]=r[2]*q;s[3]=r[3]*q;return s};l.scaleAndAdd=function(s,r,q,t){s[0]=r[0]+(q[0]*t);s[1]=r[1]+(q[1]*t);s[2]=r[2]+(q[2]*t);s[3]=r[3]+(q[3]*t);return s};l.distance=function(t,r){var q=r[0]-t[0],v=r[1]-t[1],u=r[2]-t[2],s=r[3]-t[3];return Math.sqrt(q*q+v*v+u*u+s*s)
};l.dist=l.distance;l.squaredDistance=function(t,r){var q=r[0]-t[0],v=r[1]-t[1],u=r[2]-t[2],s=r[3]-t[3];return q*q+v*v+u*u+s*s};l.sqrDist=l.squaredDistance;l.length=function(s){var q=s[0],u=s[1],t=s[2],r=s[3];return Math.sqrt(q*q+u*u+t*t+r*r)};l.len=l.length;l.squaredLength=function(s){var q=s[0],u=s[1],t=s[2],r=s[3];return q*q+u*u+t*t+r*r};l.sqrLen=l.squaredLength;l.negate=function(r,q){r[0]=-q[0];r[1]=-q[1];r[2]=-q[2];r[3]=-q[3];return r};l.normalize=function(u,t){var r=t[0],A=t[1],v=t[2],s=t[3];
var q=r*r+A*A+v*v+s*s;if(q>0){q=1/Math.sqrt(q);u[0]=t[0]*q;u[1]=t[1]*q;u[2]=t[2]*q;u[3]=t[3]*q}return u};l.dot=function(r,q){return r[0]*q[0]+r[1]*q[1]+r[2]*q[2]+r[3]*q[3]};l.lerp=function(s,r,q,u){var x=r[0],w=r[1],v=r[2],y=r[3];s[0]=x+u*(q[0]-x);s[1]=w+u*(q[1]-w);s[2]=v+u*(q[2]-v);s[3]=y+u*(q[3]-y);return s};l.random=function(q,r){r=r||1;q[0]=i();q[1]=i();q[2]=i();q[3]=i();l.normalize(q,q);l.scale(q,q,r);return q};l.transformMat4=function(u,t,r){var q=t[0],A=t[1],v=t[2],s=t[3];u[0]=r[0]*q+r[4]*A+r[8]*v+r[12]*s;
u[1]=r[1]*q+r[5]*A+r[9]*v+r[13]*s;u[2]=r[2]*q+r[6]*A+r[10]*v+r[14]*s;u[3]=r[3]*q+r[7]*A+r[11]*v+r[15]*s;return u};l.transformQuat=function(A,G,r){var H=G[0],F=G[1],E=G[2],C=r[0],B=r[1],w=r[2],D=r[3],u=D*H+B*E-w*F,t=D*F+w*H-C*E,s=D*E+C*F-B*H,v=-C*H-B*F-w*E;A[0]=u*D+v*-C+t*-w-s*-B;A[1]=t*D+v*-B+s*-C-u*-w;A[2]=s*D+v*-w+u*-B-t*-C;return A};l.forEach=(function(){var q=l.create();return function(t,x,y,w,v,r){var u,s;if(!x){x=4}if(!y){y=0}if(w){s=Math.min((w*x)+y,t.length)}else{s=t.length}for(u=y;u<s;u+=x){q[0]=t[u];
q[1]=t[u+1];q[2]=t[u+2];q[3]=t[u+3];v(q,q,r);t[u]=q[0];t[u+1]=q[1];t[u+2]=q[2];t[u+3]=q[3]}return t}})();l.str=function(q){return"vec4("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+")"};if(typeof(k)!=="undefined"){k.vec4=l}var g={};g.create=function(){var q=new e(4);q[0]=1;q[1]=0;q[2]=0;q[3]=1;return q};g.clone=function(q){var r=new e(4);r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];return r};g.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];return r};g.identity=function(q){q[0]=1;q[1]=0;q[2]=0;q[3]=1;
return q};g.transpose=function(s,r){if(s===r){var q=r[1];s[1]=r[2];s[2]=q}else{s[0]=r[0];s[1]=r[2];s[2]=r[1];s[3]=r[3]}return s};g.invert=function(u,s){var t=s[0],r=s[1],q=s[2],w=s[3],v=t*w-q*r;if(!v){return null}v=1/v;u[0]=w*v;u[1]=-r*v;u[2]=-q*v;u[3]=t*v;return u};g.adjoint=function(s,q){var r=q[0];s[0]=q[3];s[1]=-q[1];s[2]=-q[2];s[3]=r;return s};g.determinant=function(q){return q[0]*q[3]-q[2]*q[1]};g.multiply=function(u,z,x){var t=z[0],s=z[1],r=z[2],q=z[3];var A=x[0],y=x[1],w=x[2],v=x[3];u[0]=t*A+r*y;
u[1]=s*A+q*y;u[2]=t*w+r*v;u[3]=s*w+q*v;return u};g.mul=g.multiply;g.rotate=function(v,y,x){var u=y[0],t=y[1],r=y[2],q=y[3],z=Math.sin(x),w=Math.cos(x);v[0]=u*w+r*z;v[1]=t*w+q*z;v[2]=u*-z+r*w;v[3]=t*-z+q*w;return v};g.scale=function(u,w,y){var t=w[0],s=w[1],r=w[2],q=w[3],z=y[0],x=y[1];u[0]=t*z;u[1]=s*z;u[2]=r*x;u[3]=q*x;return u};g.str=function(q){return"mat2("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+")"};g.frob=function(q){return(Math.sqrt(Math.pow(q[0],2)+Math.pow(q[1],2)+Math.pow(q[2],2)+Math.pow(q[3],2)))
};g.LDU=function(q,t,s,r){q[2]=r[2]/r[0];s[0]=r[0];s[1]=r[1];s[3]=r[3]-q[2]*s[1];return[q,t,s]};if(typeof(k)!=="undefined"){k.mat2=g}var o={};o.create=function(){var q=new e(6);q[0]=1;q[1]=0;q[2]=0;q[3]=1;q[4]=0;q[5]=0;return q};o.clone=function(q){var r=new e(6);r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];r[5]=q[5];return r};o.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];r[5]=q[5];return r};o.identity=function(q){q[0]=1;q[1]=0;q[2]=0;q[3]=1;q[4]=0;q[5]=0;return q};o.invert=function(r,v){var q=v[0],y=v[1],x=v[2],w=v[3],t=v[4],s=v[5];
var u=q*w-y*x;if(!u){return null}u=1/u;r[0]=w*u;r[1]=-y*u;r[2]=-x*u;r[3]=q*u;r[4]=(x*s-w*t)*u;r[5]=(y*t-q*s)*u;return r};o.determinant=function(q){return q[0]*q[3]-q[1]*q[2]};o.multiply=function(u,B,z){var t=B[0],s=B[1],r=B[2],q=B[3],E=B[4],D=B[5],C=z[0],A=z[1],y=z[2],x=z[3],w=z[4],v=z[5];u[0]=t*C+r*A;u[1]=s*C+q*A;u[2]=t*y+r*x;u[3]=s*y+q*x;u[4]=t*w+r*v+E;u[5]=s*w+q*v+D;return u};o.mul=o.multiply;o.rotate=function(v,y,x){var u=y[0],t=y[1],r=y[2],q=y[3],B=y[4],z=y[5],A=Math.sin(x),w=Math.cos(x);v[0]=u*w+r*A;
v[1]=t*w+q*A;v[2]=u*-A+r*w;v[3]=t*-A+q*w;v[4]=B;v[5]=z;return v};o.scale=function(u,w,z){var t=w[0],s=w[1],r=w[2],q=w[3],B=w[4],A=w[5],y=z[0],x=z[1];u[0]=t*y;u[1]=s*y;u[2]=r*x;u[3]=q*x;u[4]=B;u[5]=A;return u};o.translate=function(u,w,z){var t=w[0],s=w[1],r=w[2],q=w[3],B=w[4],A=w[5],y=z[0],x=z[1];u[0]=t;u[1]=s;u[2]=r;u[3]=q;u[4]=t*y+r*x+B;u[5]=s*y+q*x+A;return u};o.str=function(q){return"mat2d("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+", "+q[4]+", "+q[5]+")"};o.frob=function(q){return(Math.sqrt(Math.pow(q[0],2)+Math.pow(q[1],2)+Math.pow(q[2],2)+Math.pow(q[3],2)+Math.pow(q[4],2)+Math.pow(q[5],2)+1))
};if(typeof(k)!=="undefined"){k.mat2d=o}var d={};d.create=function(){var q=new e(9);q[0]=1;q[1]=0;q[2]=0;q[3]=0;q[4]=1;q[5]=0;q[6]=0;q[7]=0;q[8]=1;return q};d.fromMat4=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[4];r[4]=q[5];r[5]=q[6];r[6]=q[8];r[7]=q[9];r[8]=q[10];return r};d.clone=function(q){var r=new e(9);r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];r[5]=q[5];r[6]=q[6];r[7]=q[7];r[8]=q[8];return r};d.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];r[5]=q[5];r[6]=q[6];
r[7]=q[7];r[8]=q[8];return r};d.identity=function(q){q[0]=1;q[1]=0;q[2]=0;q[3]=0;q[4]=1;q[5]=0;q[6]=0;q[7]=0;q[8]=1;return q};d.transpose=function(s,r){if(s===r){var u=r[1],t=r[2],q=r[5];s[1]=r[3];s[2]=r[6];s[3]=u;s[5]=r[7];s[6]=t;s[7]=q}else{s[0]=r[0];s[1]=r[3];s[2]=r[6];s[3]=r[1];s[4]=r[4];s[5]=r[7];s[6]=r[2];s[7]=r[5];s[8]=r[8]}return s};d.invert=function(u,B){var t=B[0],s=B[1],r=B[2],E=B[3],D=B[4],C=B[5],z=B[6],y=B[7],w=B[8],v=w*D-C*y,q=-w*E+C*z,A=y*E-D*z,x=t*v+s*q+r*A;if(!x){return null}x=1/x;
u[0]=v*x;u[1]=(-w*s+r*y)*x;u[2]=(C*s-r*D)*x;u[3]=q*x;u[4]=(w*t-r*z)*x;u[5]=(-C*t+r*E)*x;u[6]=A*x;u[7]=(-y*t+s*z)*x;u[8]=(D*t-s*E)*x;return u};d.adjoint=function(t,x){var s=x[0],r=x[1],q=x[2],A=x[3],z=x[4],y=x[5],w=x[6],v=x[7],u=x[8];t[0]=(z*u-y*v);t[1]=(q*v-r*u);t[2]=(r*y-q*z);t[3]=(y*w-A*u);t[4]=(s*u-q*w);t[5]=(q*A-s*y);t[6]=(A*v-z*w);t[7]=(r*w-s*v);t[8]=(s*z-r*A);return t};d.determinant=function(w){var s=w[0],r=w[1],q=w[2],z=w[3],y=w[4],x=w[5],v=w[6],u=w[7],t=w[8];return s*(t*y-x*u)+r*(-t*z+x*v)+q*(u*z-y*v)
};d.multiply=function(C,H,G){var K=H[0],J=H[1],I=H[2],v=H[3],u=H[4],t=H[5],B=H[6],A=H[7],z=H[8],y=G[0],x=G[1],w=G[2],F=G[3],E=G[4],D=G[5],s=G[6],r=G[7],q=G[8];C[0]=y*K+x*v+w*B;C[1]=y*J+x*u+w*A;C[2]=y*I+x*t+w*z;C[3]=F*K+E*v+D*B;C[4]=F*J+E*u+D*A;C[5]=F*I+E*t+D*z;C[6]=s*K+r*v+q*B;C[7]=s*J+r*u+q*A;C[8]=s*I+r*t+q*z;return C};d.mul=d.multiply;d.translate=function(t,C,E){var s=C[0],r=C[1],q=C[2],G=C[3],F=C[4],D=C[5],z=C[6],w=C[7],u=C[8],B=E[0],A=E[1];t[0]=s;t[1]=r;t[2]=q;t[3]=G;t[4]=F;t[5]=D;t[6]=B*s+A*G+z;
t[7]=B*r+A*F+w;t[8]=B*q+A*D+u;return t};d.rotate=function(u,A,z){var t=A[0],r=A[1],q=A[2],D=A[3],C=A[4],B=A[5],x=A[6],w=A[7],v=A[8],E=Math.sin(z),y=Math.cos(z);u[0]=y*t+E*D;u[1]=y*r+E*C;u[2]=y*q+E*B;u[3]=y*D-E*t;u[4]=y*C-E*r;u[5]=y*B-E*q;u[6]=x;u[7]=w;u[8]=v;return u};d.scale=function(t,r,s){var q=s[0],u=s[1];t[0]=q*r[0];t[1]=q*r[1];t[2]=q*r[2];t[3]=u*r[3];t[4]=u*r[4];t[5]=u*r[5];t[6]=r[6];t[7]=r[7];t[8]=r[8];return t};d.fromMat2d=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=0;r[3]=q[2];r[4]=q[3];r[5]=0;
r[6]=q[4];r[7]=q[5];r[8]=1;return r};d.fromQuat=function(F,C){var v=C[0],u=C[1],t=C[2],A=C[3],G=v+v,r=u+u,B=t+t,s=v*G,E=u*G,D=u*r,M=t*G,L=t*r,J=t*B,K=A*G,I=A*r,H=A*B;F[0]=1-D-J;F[3]=E-H;F[6]=M+I;F[1]=E+H;F[4]=1-s-J;F[7]=L-K;F[2]=M-I;F[5]=L+K;F[8]=1-s-D;return F};d.normalFromMat4=function(J,O){var S=O[0],Q=O[1],P=O[2],M=O[3],u=O[4],t=O[5],s=O[6],r=O[7],I=O[8],H=O[9],G=O[10],F=O[11],U=O[12],T=O[13],R=O[14],N=O[15],E=S*t-Q*u,D=S*s-P*u,C=S*r-M*u,B=Q*s-P*t,A=Q*r-M*t,z=P*r-M*s,y=I*T-H*U,x=I*R-G*U,w=I*N-F*U,v=H*R-G*T,L=H*N-F*T,K=G*N-F*R,q=E*K-D*L+C*v+B*w-A*x+z*y;
if(!q){return null}q=1/q;J[0]=(t*K-s*L+r*v)*q;J[1]=(s*w-u*K-r*x)*q;J[2]=(u*L-t*w+r*y)*q;J[3]=(P*L-Q*K-M*v)*q;J[4]=(S*K-P*w+M*x)*q;J[5]=(Q*w-S*L-M*y)*q;J[6]=(T*z-R*A+N*B)*q;J[7]=(R*C-U*z-N*D)*q;J[8]=(U*A-T*C+N*E)*q;return J};d.str=function(q){return"mat3("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+", "+q[4]+", "+q[5]+", "+q[6]+", "+q[7]+", "+q[8]+")"};d.frob=function(q){return(Math.sqrt(Math.pow(q[0],2)+Math.pow(q[1],2)+Math.pow(q[2],2)+Math.pow(q[3],2)+Math.pow(q[4],2)+Math.pow(q[5],2)+Math.pow(q[6],2)+Math.pow(q[7],2)+Math.pow(q[8],2)))
};if(typeof(k)!=="undefined"){k.mat3=d}var c={};c.create=function(){var q=new e(16);q[0]=1;q[1]=0;q[2]=0;q[3]=0;q[4]=0;q[5]=1;q[6]=0;q[7]=0;q[8]=0;q[9]=0;q[10]=1;q[11]=0;q[12]=0;q[13]=0;q[14]=0;q[15]=1;return q};c.clone=function(q){var r=new e(16);r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];r[5]=q[5];r[6]=q[6];r[7]=q[7];r[8]=q[8];r[9]=q[9];r[10]=q[10];r[11]=q[11];r[12]=q[12];r[13]=q[13];r[14]=q[14];r[15]=q[15];return r};c.copy=function(r,q){r[0]=q[0];r[1]=q[1];r[2]=q[2];r[3]=q[3];r[4]=q[4];
r[5]=q[5];r[6]=q[6];r[7]=q[7];r[8]=q[8];r[9]=q[9];r[10]=q[10];r[11]=q[11];r[12]=q[12];r[13]=q[13];r[14]=q[14];r[15]=q[15];return r};c.identity=function(q){q[0]=1;q[1]=0;q[2]=0;q[3]=0;q[4]=0;q[5]=1;q[6]=0;q[7]=0;q[8]=0;q[9]=0;q[10]=1;q[11]=0;q[12]=0;q[13]=0;q[14]=0;q[15]=1;return q};c.transpose=function(t,s){if(t===s){var x=s[1],v=s[2],u=s[3],q=s[6],w=s[7],r=s[11];t[1]=s[4];t[2]=s[8];t[3]=s[12];t[4]=x;t[6]=s[9];t[7]=s[13];t[8]=v;t[9]=q;t[11]=s[14];t[12]=u;t[13]=w;t[14]=r}else{t[0]=s[0];t[1]=s[4];t[2]=s[8];
t[3]=s[12];t[4]=s[1];t[5]=s[5];t[6]=s[9];t[7]=s[13];t[8]=s[2];t[9]=s[6];t[10]=s[10];t[11]=s[14];t[12]=s[3];t[13]=s[7];t[14]=s[11];t[15]=s[15]}return t};c.invert=function(J,O){var S=O[0],Q=O[1],P=O[2],M=O[3],u=O[4],t=O[5],s=O[6],r=O[7],I=O[8],H=O[9],G=O[10],F=O[11],U=O[12],T=O[13],R=O[14],N=O[15],E=S*t-Q*u,D=S*s-P*u,C=S*r-M*u,B=Q*s-P*t,A=Q*r-M*t,z=P*r-M*s,y=I*T-H*U,x=I*R-G*U,w=I*N-F*U,v=H*R-G*T,L=H*N-F*T,K=G*N-F*R,q=E*K-D*L+C*v+B*w-A*x+z*y;if(!q){return null}q=1/q;J[0]=(t*K-s*L+r*v)*q;J[1]=(P*L-Q*K-M*v)*q;
J[2]=(T*z-R*A+N*B)*q;J[3]=(G*A-H*z-F*B)*q;J[4]=(s*w-u*K-r*x)*q;J[5]=(S*K-P*w+M*x)*q;J[6]=(R*C-U*z-N*D)*q;J[7]=(I*z-G*C+F*D)*q;J[8]=(u*L-t*w+r*y)*q;J[9]=(Q*w-S*L-M*y)*q;J[10]=(U*A-T*C+N*E)*q;J[11]=(H*C-I*A-F*E)*q;J[12]=(t*x-u*v-s*y)*q;J[13]=(S*v-Q*x+P*y)*q;J[14]=(T*D-U*B-R*E)*q;J[15]=(I*B-H*D+G*E)*q;return J};c.adjoint=function(y,B){var F=B[0],D=B[1],C=B[2],z=B[3],t=B[4],s=B[5],r=B[6],q=B[7],x=B[8],w=B[9],v=B[10],u=B[11],H=B[12],G=B[13],E=B[14],A=B[15];y[0]=(s*(v*A-u*E)-w*(r*A-q*E)+G*(r*u-q*v));y[1]=-(D*(v*A-u*E)-w*(C*A-z*E)+G*(C*u-z*v));
y[2]=(D*(r*A-q*E)-s*(C*A-z*E)+G*(C*q-z*r));y[3]=-(D*(r*u-q*v)-s*(C*u-z*v)+w*(C*q-z*r));y[4]=-(t*(v*A-u*E)-x*(r*A-q*E)+H*(r*u-q*v));y[5]=(F*(v*A-u*E)-x*(C*A-z*E)+H*(C*u-z*v));y[6]=-(F*(r*A-q*E)-t*(C*A-z*E)+H*(C*q-z*r));y[7]=(F*(r*u-q*v)-t*(C*u-z*v)+x*(C*q-z*r));y[8]=(t*(w*A-u*G)-x*(s*A-q*G)+H*(s*u-q*w));y[9]=-(F*(w*A-u*G)-x*(D*A-z*G)+H*(D*u-z*w));y[10]=(F*(s*A-q*G)-t*(D*A-z*G)+H*(D*q-z*s));y[11]=-(F*(s*u-q*w)-t*(D*u-z*w)+x*(D*q-z*s));y[12]=-(t*(w*E-v*G)-x*(s*E-r*G)+H*(s*v-r*w));y[13]=(F*(w*E-v*G)-x*(D*E-C*G)+H*(D*v-C*w));
y[14]=-(F*(s*E-r*G)-t*(D*E-C*G)+H*(D*r-C*s));y[15]=(F*(s*v-r*w)-t*(D*v-C*w)+x*(D*r-C*s));return y};c.determinant=function(L){var Q=L[0],O=L[1],M=L[2],K=L[3],t=L[4],s=L[5],r=L[6],q=L[7],H=L[8],G=L[9],F=L[10],E=L[11],S=L[12],R=L[13],P=L[14],N=L[15],D=Q*s-O*t,C=Q*r-M*t,B=Q*q-K*t,A=O*r-M*s,z=O*q-K*s,y=M*q-K*r,x=H*R-G*S,w=H*P-F*S,v=H*N-E*S,u=G*P-F*R,J=G*N-E*R,I=F*N-E*P;return D*I-C*J+B*u+A*v-z*w+y*x};c.multiply=function(C,G,D){var K=G[0],J=G[1],H=G[2],E=G[3],w=G[4],u=G[5],s=G[6],q=G[7],B=G[8],A=G[9],z=G[10],y=G[11],M=G[12],L=G[13],I=G[14],F=G[15];
var x=D[0],v=D[1],t=D[2],r=D[3];C[0]=x*K+v*w+t*B+r*M;C[1]=x*J+v*u+t*A+r*L;C[2]=x*H+v*s+t*z+r*I;C[3]=x*E+v*q+t*y+r*F;x=D[4];v=D[5];t=D[6];r=D[7];C[4]=x*K+v*w+t*B+r*M;C[5]=x*J+v*u+t*A+r*L;C[6]=x*H+v*s+t*z+r*I;C[7]=x*E+v*q+t*y+r*F;x=D[8];v=D[9];t=D[10];r=D[11];C[8]=x*K+v*w+t*B+r*M;C[9]=x*J+v*u+t*A+r*L;C[10]=x*H+v*s+t*z+r*I;C[11]=x*E+v*q+t*y+r*F;x=D[12];v=D[13];t=D[14];r=D[15];C[12]=x*K+v*w+t*B+r*M;C[13]=x*J+v*u+t*A+r*L;C[14]=x*H+v*s+t*z+r*I;C[15]=x*E+v*q+t*y+r*F;return C};c.mul=c.multiply;c.translate=function(G,I,B){var A=B[0],w=B[1],u=B[2],L,K,J,H,t,s,r,q,F,E,D,C;
if(I===G){G[12]=I[0]*A+I[4]*w+I[8]*u+I[12];G[13]=I[1]*A+I[5]*w+I[9]*u+I[13];G[14]=I[2]*A+I[6]*w+I[10]*u+I[14];G[15]=I[3]*A+I[7]*w+I[11]*u+I[15]}else{L=I[0];K=I[1];J=I[2];H=I[3];t=I[4];s=I[5];r=I[6];q=I[7];F=I[8];E=I[9];D=I[10];C=I[11];G[0]=L;G[1]=K;G[2]=J;G[3]=H;G[4]=t;G[5]=s;G[6]=r;G[7]=q;G[8]=F;G[9]=E;G[10]=D;G[11]=C;G[12]=L*A+t*w+F*u+I[12];G[13]=K*A+s*w+E*u+I[13];G[14]=J*A+r*w+D*u+I[14];G[15]=H*A+q*w+C*u+I[15]}return G};c.scale=function(t,r,s){var q=s[0],w=s[1],u=s[2];t[0]=r[0]*q;t[1]=r[1]*q;t[2]=r[2]*q;
t[3]=r[3]*q;t[4]=r[4]*w;t[5]=r[5]*w;t[6]=r[6]*w;t[7]=r[7]*w;t[8]=r[8]*u;t[9]=r[9]*u;t[10]=r[10]*u;t[11]=r[11]*u;t[12]=r[12];t[13]=r[13];t[14]=r[14];t[15]=r[15];return t};c.rotate=function(P,W,Y,q){var F=q[0],E=q[1],D=q[2],Q=Math.sqrt(F*F+E*E+D*D),K,U,J,aa,Z,X,V,C,B,A,w,O,N,M,L,I,H,G,T,S,R,v,u,r;if(Math.abs(Q)<p){return null}Q=1/Q;F*=Q;E*=Q;D*=Q;K=Math.sin(Y);U=Math.cos(Y);J=1-U;aa=W[0];Z=W[1];X=W[2];V=W[3];C=W[4];B=W[5];A=W[6];w=W[7];O=W[8];N=W[9];M=W[10];L=W[11];I=F*F*J+U;H=E*F*J+D*K;G=D*F*J-E*K;
T=F*E*J-D*K;S=E*E*J+U;R=D*E*J+F*K;v=F*D*J+E*K;u=E*D*J-F*K;r=D*D*J+U;P[0]=aa*I+C*H+O*G;P[1]=Z*I+B*H+N*G;P[2]=X*I+A*H+M*G;P[3]=V*I+w*H+L*G;P[4]=aa*T+C*S+O*R;P[5]=Z*T+B*S+N*R;P[6]=X*T+A*S+M*R;P[7]=V*T+w*S+L*R;P[8]=aa*v+C*u+O*r;P[9]=Z*v+B*u+N*r;P[10]=X*v+A*u+M*r;P[11]=V*v+w*u+L*r;if(W!==P){P[12]=W[12];P[13]=W[13];P[14]=W[14];P[15]=W[15]}return P};c.rotateX=function(q,y,x){var D=Math.sin(x),w=Math.cos(x),C=y[4],B=y[5],A=y[6],z=y[7],v=y[8],u=y[9],t=y[10],r=y[11];if(y!==q){q[0]=y[0];q[1]=y[1];q[2]=y[2];
q[3]=y[3];q[12]=y[12];q[13]=y[13];q[14]=y[14];q[15]=y[15]}q[4]=C*w+v*D;q[5]=B*w+u*D;q[6]=A*w+t*D;q[7]=z*w+r*D;q[8]=v*w-C*D;q[9]=u*w-B*D;q[10]=t*w-A*D;q[11]=r*w-z*D;return q};c.rotateY=function(v,C,B){var D=Math.sin(B),A=Math.cos(B),u=C[0],t=C[1],r=C[2],q=C[3],z=C[8],y=C[9],x=C[10],w=C[11];if(C!==v){v[4]=C[4];v[5]=C[5];v[6]=C[6];v[7]=C[7];v[12]=C[12];v[13]=C[13];v[14]=C[14];v[15]=C[15]}v[0]=u*A-z*D;v[1]=t*A-y*D;v[2]=r*A-x*D;v[3]=q*A-w*D;v[8]=u*D+z*A;v[9]=t*D+y*A;v[10]=r*D+x*A;v[11]=q*D+w*A;return v
};c.rotateZ=function(v,y,x){var D=Math.sin(x),w=Math.cos(x),u=y[0],t=y[1],r=y[2],q=y[3],C=y[4],B=y[5],A=y[6],z=y[7];if(y!==v){v[8]=y[8];v[9]=y[9];v[10]=y[10];v[11]=y[11];v[12]=y[12];v[13]=y[13];v[14]=y[14];v[15]=y[15]}v[0]=u*w+C*D;v[1]=t*w+B*D;v[2]=r*w+A*D;v[3]=q*w+z*D;v[4]=C*w-u*D;v[5]=B*w-t*D;v[6]=A*w-r*D;v[7]=z*w-q*D;return v};c.fromRotationTranslation=function(J,H,F){var C=H[0],B=H[1],A=H[2],D=H[3],K=C+C,r=B+B,E=A+A,u=C*K,t=C*r,s=C*E,I=B*r,G=B*E,N=A*E,O=D*K,M=D*r,L=D*E;J[0]=1-(I+N);J[1]=t+L;J[2]=s-M;
J[3]=0;J[4]=t-L;J[5]=1-(u+N);J[6]=G+O;J[7]=0;J[8]=s+M;J[9]=G-O;J[10]=1-(u+I);J[11]=0;J[12]=F[0];J[13]=F[1];J[14]=F[2];J[15]=1;return J};c.fromQuat=function(F,C){var v=C[0],u=C[1],t=C[2],A=C[3],G=v+v,r=u+u,B=t+t,s=v*G,E=u*G,D=u*r,M=t*G,L=t*r,J=t*B,K=A*G,I=A*r,H=A*B;F[0]=1-D-J;F[1]=E+H;F[2]=M-I;F[3]=0;F[4]=E-H;F[5]=1-s-J;F[6]=L+K;F[7]=0;F[8]=M+I;F[9]=L-K;F[10]=1-s-D;F[11]=0;F[12]=0;F[13]=0;F[14]=0;F[15]=1;return F};c.frustum=function(u,r,z,q,y,w,v){var x=1/(z-r),t=1/(y-q),s=1/(w-v);u[0]=(w*2)*x;u[1]=0;
u[2]=0;u[3]=0;u[4]=0;u[5]=(w*2)*t;u[6]=0;u[7]=0;u[8]=(z+r)*x;u[9]=(y+q)*t;u[10]=(v+w)*s;u[11]=-1;u[12]=0;u[13]=0;u[14]=(v*w*2)*s;u[15]=0;return u};c.perspective=function(t,s,r,u,q){var w=1/Math.tan(s/2),v=1/(u-q);t[0]=w/r;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=w;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=(q+u)*v;t[11]=-1;t[12]=0;t[13]=0;t[14]=(2*q*u)*v;t[15]=0;return t};c.ortho=function(t,r,z,q,x,w,v){var u=1/(r-z),y=1/(q-x),s=1/(w-v);t[0]=-2*u;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=-2*y;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=2*s;
t[11]=0;t[12]=(r+z)*u;t[13]=(x+q)*y;t[14]=(v+w)*s;t[15]=1;return t};c.lookAt=function(E,L,M,w){var K,J,H,s,r,q,z,y,x,F,I=L[0],G=L[1],D=L[2],v=w[0],u=w[1],t=w[2],C=M[0],B=M[1],A=M[2];if(Math.abs(I-C)<p&&Math.abs(G-B)<p&&Math.abs(D-A)<p){return c.identity(E)}z=I-C;y=G-B;x=D-A;F=1/Math.sqrt(z*z+y*y+x*x);z*=F;y*=F;x*=F;K=u*x-t*y;J=t*z-v*x;H=v*y-u*z;F=Math.sqrt(K*K+J*J+H*H);if(!F){K=0;J=0;H=0}else{F=1/F;K*=F;J*=F;H*=F}s=y*H-x*J;r=x*K-z*H;q=z*J-y*K;F=Math.sqrt(s*s+r*r+q*q);if(!F){s=0;r=0;q=0}else{F=1/F;
s*=F;r*=F;q*=F}E[0]=K;E[1]=s;E[2]=z;E[3]=0;E[4]=J;E[5]=r;E[6]=y;E[7]=0;E[8]=H;E[9]=q;E[10]=x;E[11]=0;E[12]=-(K*I+J*G+H*D);E[13]=-(s*I+r*G+q*D);E[14]=-(z*I+y*G+x*D);E[15]=1;return E};c.str=function(q){return"mat4("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+", "+q[4]+", "+q[5]+", "+q[6]+", "+q[7]+", "+q[8]+", "+q[9]+", "+q[10]+", "+q[11]+", "+q[12]+", "+q[13]+", "+q[14]+", "+q[15]+")"};c.frob=function(q){return(Math.sqrt(Math.pow(q[0],2)+Math.pow(q[1],2)+Math.pow(q[2],2)+Math.pow(q[3],2)+Math.pow(q[4],2)+Math.pow(q[5],2)+Math.pow(q[6],2)+Math.pow(q[6],2)+Math.pow(q[7],2)+Math.pow(q[8],2)+Math.pow(q[9],2)+Math.pow(q[10],2)+Math.pow(q[11],2)+Math.pow(q[12],2)+Math.pow(q[13],2)+Math.pow(q[14],2)+Math.pow(q[15],2)))
};if(typeof(k)!=="undefined"){k.mat4=c}var h={};h.create=function(){var q=new e(4);q[0]=0;q[1]=0;q[2]=0;q[3]=1;return q};h.rotationTo=(function(){var q=m.create();var r=m.fromValues(1,0,0);var s=m.fromValues(0,1,0);return function(w,u,t){var v=m.dot(u,t);if(v<-0.999999){m.cross(q,r,u);if(m.length(q)<0.000001){m.cross(q,s,u)}m.normalize(q,q);h.setAxisAngle(w,q,Math.PI);return w}else{if(v>0.999999){w[0]=0;w[1]=0;w[2]=0;w[3]=1;return w}else{m.cross(q,u,t);w[0]=q[0];w[1]=q[1];w[2]=q[2];w[3]=1+v;return h.normalize(w,w)
}}}})();h.setAxes=(function(){var q=d.create();return function(t,s,u,r){q[0]=u[0];q[3]=u[1];q[6]=u[2];q[1]=r[0];q[4]=r[1];q[7]=r[2];q[2]=-s[0];q[5]=-s[1];q[8]=-s[2];return h.normalize(t,h.fromMat3(t,q))}})();h.clone=l.clone;h.fromValues=l.fromValues;h.copy=l.copy;h.set=l.set;h.identity=function(q){q[0]=0;q[1]=0;q[2]=0;q[3]=1;return q};h.setAxisAngle=function(r,u,q){q=q*0.5;var t=Math.sin(q);r[0]=t*u[0];r[1]=t*u[1];r[2]=t*u[2];r[3]=Math.cos(q);return r};h.add=l.add;h.multiply=function(s,y,x){var q=y[0],A=y[1],z=y[2],r=y[3],v=x[0],u=x[1],t=x[2],w=x[3];
s[0]=q*w+r*v+A*t-z*u;s[1]=A*w+r*u+z*v-q*t;s[2]=z*w+r*t+q*u-A*v;s[3]=r*w-q*v-A*u-z*t;return s};h.mul=h.multiply;h.scale=l.scale;h.rotateX=function(s,w,u){u*=0.5;var q=w[0],y=w[1],x=w[2],r=w[3],t=Math.sin(u),v=Math.cos(u);s[0]=q*v+r*t;s[1]=y*v+x*t;s[2]=x*v-y*t;s[3]=r*v-q*t;return s};h.rotateY=function(s,w,u){u*=0.5;var q=w[0],y=w[1],x=w[2],r=w[3],t=Math.sin(u),v=Math.cos(u);s[0]=q*v-x*t;s[1]=y*v+r*t;s[2]=x*v+q*t;s[3]=r*v-y*t;return s};h.rotateZ=function(s,w,u){u*=0.5;var q=w[0],y=w[1],x=w[2],r=w[3],t=Math.sin(u),v=Math.cos(u);
s[0]=q*v+y*t;s[1]=y*v-q*t;s[2]=x*v+r*t;s[3]=r*v-x*t;return s};h.calculateW=function(s,r){var q=r[0],u=r[1],t=r[2];s[0]=q;s[1]=u;s[2]=t;s[3]=-Math.sqrt(Math.abs(1-q*q-u*u-t*t));return s};h.dot=l.dot;h.lerp=l.lerp;h.slerp=function(v,D,C,G){var q=D[0],H=D[1],F=D[2],s=D[3],A=C[0],z=C[1],y=C[2],B=C[3];var E,r,u,x,w;r=q*A+H*z+F*y+s*B;if(r<0){r=-r;A=-A;z=-z;y=-y;B=-B}if((1-r)>0.000001){E=Math.acos(r);u=Math.sin(E);x=Math.sin((1-G)*E)/u;w=Math.sin(G*E)/u}else{x=1-G;w=G}v[0]=x*q+w*A;v[1]=x*H+w*z;v[2]=x*F+w*y;
v[3]=x*s+w*B;return v};h.invert=function(w,s){var u=s[0],r=s[1],q=s[2],x=s[3],t=u*u+r*r+q*q+x*x,v=t?1/t:0;w[0]=-u*v;w[1]=-r*v;w[2]=-q*v;w[3]=x*v;return w};h.conjugate=function(r,q){r[0]=-q[0];r[1]=-q[1];r[2]=-q[2];r[3]=q[3];return r};h.length=l.length;h.len=h.length;h.squaredLength=l.squaredLength;h.sqrLen=h.squaredLength;h.normalize=l.normalize;h.fromMat3=function(u,q){var r=q[0]+q[4]+q[8];var w;if(r>0){w=Math.sqrt(r+1);u[3]=0.5*w;w=0.5/w;u[0]=(q[7]-q[5])*w;u[1]=(q[2]-q[6])*w;u[2]=(q[3]-q[1])*w}else{var v=0;
if(q[4]>q[0]){v=1}if(q[8]>q[v*3+v]){v=2}var t=(v+1)%3;var s=(v+2)%3;w=Math.sqrt(q[v*3+v]-q[t*3+t]-q[s*3+s]+1);u[v]=0.5*w;w=0.5/w;u[3]=(q[s*3+t]-q[t*3+s])*w;u[t]=(q[t*3+v]+q[v*3+t])*w;u[s]=(q[s*3+v]+q[v*3+s])*w}return u};h.str=function(q){return"quat("+q[0]+", "+q[1]+", "+q[2]+", "+q[3]+")"};if(typeof(k)!=="undefined"){k.quat=h}})(a.exports)})(this);function vxlLandmark(a,b){if(!(b instanceof vxlCamera)){alert("vxlLandmark needs a vxlCamera as argument");return null}this.name=a;var d=b;this._fov=d._fov;this.Z_NEAR=d.Z_NEAR;this.Z_FAR=d.Z_FAR;this._matrix=mat4.clone(d._matrix);this._right=vec3.clone(d._right);this._up=vec3.clone(d._up);this._forward=vec3.clone(d._forward);this._position=vec3.clone(d._position);this._focalPoint=vec3.clone(d._focalPoint);this._distanceVector=vec3.clone(d._distanceVector);this._azimuth=d._azimuth;this._elevation=d._elevation;
this._roll=d._roll;this._relAzimuth=d._relAzimuth;this._relElevation=d._relElevation;this._relRoll=d._relRoll;this._dollyingStep=d._dollyngStep;this._distance=d._distance}vxlLandmark.prototype.retrieve=function(a){var b=a;b._fov=this._fov;b.Z_NEAR=this.Z_NEAR;b.Z_FAR=this.Z_FAR;b._matrix=mat4.copy(b._matrix,this._matrix);b._right=vec3.copy(b._right,this._right);b._up=vec3.copy(b._up,this._up);b._forward=vec3.copy(b._forward,this._forward);b._position=vec3.copy(b._position,this._position);b._focalPoint=vec3.copy(b._focalPoint,this._focalPoint);
b._distanceVector=vec3.copy(b._distanceVector,this._distanceVector);b._azimuth=this._azimuth;b._elevation=this._elevation;b._roll=this._roll;b._relAzimuth=this._relAzimuth;b._relElevation=this._relElevation;b._relRoll=this._relRoll;b._dollyingStep=this._dollyngStep;b._distance=this._distance;b.refresh()};function vxlCamera(b,a){this.UID=vxl.util.generateUID();this.view=b;this._fov=vxl.def.camera.fov;this.Z_NEAR=vxl.def.camera.near;this.Z_FAR=vxl.def.camera.far;this._matrix=mat4.create();this._right=vec3.fromValues(1,0,0);this._up=vec3.fromValues(0,1,0);this._forward=vec3.fromValues(0,0,1);this._position=vec3.fromValues(0,0,1);this._focalPoint=vec3.fromValues(0,0,0);this._distanceVector=vec3.fromValues(0,0,0);this._azimuth=0;this._elevation=0;this._roll=0;this._relAzimuth=0;this._relElevation=0;this._relRoll=0;
this._dollyingStep=0;this._distance=1;this._following=undefined;this._trackingMode=vxl.def.camera.tracking.DEFAULT;this.landmarks=[];this._lmarkAnimationID=undefined;this._rotate_world=false;if(a==undefined){this.setType(vxl.def.camera.type.EXPLORING)}else{this.setType(a)}}vxlCamera.prototype.setWorldRotation=function(a){this._rotate_world=a;this._getAngles();return this};vxlCamera.prototype.setType=function(b,a){var c=vxl.def.camera.type;if(b!=c.ORBITING&&b!=c.TRACKING&&b!=c.EXPLORING){console.warn("vxlCamera.setType WARNING type ["+b+"] unknown. Setting camera to EXPLORING type.");
this.type=c.EXPLORING;this.setWorldRotation(true)}else{this.type=b;if(this.type==c.EXPLORING){this.setWorldRotation(true)}else{this.setWorldRotation(false)}this._getAngles()}if(this.type==vxl.def.camera.type.TRACKING&&a!=undefined){this.setTrackingMode(a)}return this};vxlCamera.prototype.setTrackingMode=function(a){if(this.type!=vxl.def.camera.type.TRACKING){alert("Impossible to set a tracking mode if the camera is not of tracking type");throw ("Impossible to set a tracking mode if the camera is not of tracking type")
}if(a==undefined){return}this._trackingMode=a};vxlCamera.prototype.follow=function(a,b){this.setType(vxl.def.camera.type.TRACKING,b);if(a instanceof vxlActor){instance=a}else{if(typeof(a)=="string"){instance=this.view.scene.getActorByName(a)}}if(instance==undefined){console.error("vxlCamera.follow ERROR: The actor "+a+" does not exist")}else{this._following=instance;instance.addTrackingCamera(this)}return this};vxlCamera.prototype.unfollow=function(){this._following.removeTrackingCamera(this);this._following=undefined;
return this};vxlCamera.prototype.updateWithActor=function(a){if(this._following!=a){return}switch(this._trackingMode){case vxl.def.camera.tracking.DEFAULT:break;case vxl.def.camera.tracking.ROTATIONAL:case vxl.def.camera.tracking.CINEMATIC:this.setFocalPoint(a._position);break;case vxl.def.camera.tracking.TRANSLATIONAL:this.translate(a._translation);this.setFocalPoint(a._position);break}};vxlCamera.prototype.setPosition=function(a,c,b){this._setPosition(a,c,b);this.setFocalPoint(this._focalPoint);
return this};vxlCamera.prototype.setFocalPoint=function(i,h,g){var e=vec3.fromValues(0,1,0);this._focalPoint=vxl.util.createVec3(i,h,g);if(this._trackingMode==vxl.def.camera.tracking.CINEMATIC){var f=vec3.subtract(vec3.create(),this._focalPoint,this._position);var i=f[0],h=f[1],g=f[2],a=vec3.length(f);var b=Math.asin(h/a)*vxl.def.rad2deg;var j=90+Math.atan2(g,i)*vxl.def.rad2deg;var c=mat4.create();mat4.rotateY(c,c,j*vxl.def.deg2rad);mat4.rotateX(c,c,b*vxl.def.deg2rad);e=vec3.transformMat4(vec3.create(),[0,1,0],c)
}mat4.invert(this._matrix,mat4.lookAt(mat4.create(),this._position,this._focalPoint,e));this._getAxes();this._getDistance();this._getAngles();return this};vxlCamera.prototype.setDistance=function(b){if(this._distance==b||b<0){return}this._distance=b;if(this._distance<0.0002){this._distance=0.0002;console.warn(" vxlCamera.setDistance WARN: Distance is set to minimum (0.0002)")}this._dollyingStep=this._distance/100;var e=vec3.create();var b=this._distance;var c=this._forward;var a=this._focalPoint;
e[0]=b*c[0]+a[0];e[1]=b*c[1]+a[1];e[2]=b*c[2]+a[2];this._setPosition(e);return this};vxlCamera.prototype.changeAzimuth=function(a){this.setAzimuth(this._azimuth+a);return this};vxlCamera.prototype.changeElevation=function(a){this.setElevation(this._elevation+a);return this};vxlCamera.prototype.changeRoll=function(a){this.setRoll(this._roll+a);return this};vxlCamera.prototype.setAzimuth=function(a){this._azimuth=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()
}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.setElevation=function(a){this._elevation=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.setRoll=function(a){this._roll=this._getAngle(a);this._computeMatrix();this._getAxes();
if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.rotate=function(h,g,c){if(this.type==vxl.def.camera.type.EXPLORING){h=this._getAngle(h);g=this._getAngle(g);c=this._getAngle(c);var f=quat.setAxisAngle(quat.create(),[1,0,0],-g*vxl.def.deg2rad);var e=quat.setAxisAngle(quat.create(),[0,1,0],-h*vxl.def.deg2rad);if(this._rotate_world){f=quat.setAxisAngle(quat.create(),[1,0,0],g*vxl.def.deg2rad);
e=quat.setAxisAngle(quat.create(),[0,1,0],h*vxl.def.deg2rad)}var d=quat.setAxisAngle(quat.create(),[0,0,1],c*vxl.def.deg2rad);var b=quat.multiply(quat.create(),e,f);b=quat.multiply(quat.create(),b,d);var a=mat4.fromQuat(mat4.create(),b);mat4.translate(this._matrix,this._matrix,[0,0,-this._distance]);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(Math.abs(this._elevation+g)>90){return}this._relElevation=this._getAngle(g);this._relAzimuth=this._getAngle(h);
this._relRoll=this._getAngle(c);this._elevation+=this._relElevation;this._azimuth+=this._relAzimuth;this._roll+=this._relRoll;this._computeMatrix()}this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}this._update();return this};vxlCamera.prototype.dolly=function(b){var d=this._forward;var c=vec3.clone(this._position);var a=b*this._dollyingStep;c[0]+=a*d[0];
c[1]+=a*d[1];c[2]+=a*d[2];this._setPosition(c);if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getDistance()}else{if(this.type==vxl.def.camera.type.TRACKING){vec3.add(this._focalPoint,c,this._distanceVector)}}return this};vxlCamera.prototype.pan=function(b,a){var c=vxl.util.createVec3(b,a,0);var d=vec3.clone(this._position);vec3.add(d,d,vec3.scale(vec3.create(),this._right,c[0]));vec3.add(d,d,vec3.scale(vec3.create(),this._up,c[1]));this._setPosition(d);
return this};vxlCamera.prototype.translate=function(a,e,c){var b=vxl.util.createVec3(a,e,c);var d=vec3.clone(this._position);vec3.add(d,d,b);this._setPosition(d);return this};vxlCamera.prototype.refresh=function(){this.view.refresh();return this};vxlCamera.prototype.lookAt=function(a){if(a instanceof vxlActor){this.setFocalPoint(a._position)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this.setFocalPoint(a._position)
}}}return this};vxlCamera.prototype.closeUp=function(a){if(a instanceof vxlActor){this._shot(a._bb)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this._shot(a._bb)}}}return this};vxlCamera.prototype.longShot=function(){this.view.scene.computeBoundingBox();this._shot(this.view.scene.bb);return this};vxlCamera.prototype.setFieldOfView=function(a){this._fov=a;return this};vxlCamera.prototype.createLandmark=function(e,a,d){var f=new vxlCamera(this.view,this.type);
f.setPosition(a);f.setFocalPoint(d);var b=new vxlLandmark(e,f);this.landmarks.push(b);return this};vxlCamera.prototype.setLandmark=function(b){var a=new vxlLandmark(b,this);this.landmarks.push(a);return this};vxlCamera.prototype.gotoLandmark=function(a,d,e){var h=undefined;var g=this.landmarks.length;while(g--){if(this.landmarks[g].name==a){h=this.landmarks[g];break}}if(h==undefined){console.warn("vxlCamera.goTo: landmark with name: "+a+", was not found");return}if(d==undefined||d==0){h.retrieve(this);
return}if(this._lmarkAnimationID!=undefined){window.clearTimeout(this._lmarkAnimationID)}var j=this;var k=h._position;var f=h._focalPoint;if(d==undefined){d=1000}if(e==undefined){e==20}var c=this.view.interactor;c.disconnectFromView();function b(o,l){var i=(o/100)*(l/10),p=o/i,n=0,q=new Date().getTime();function m(){var r=vec3.create();var t=vec3.create();if(n++!=i){percent=n/i;var r=vec3.lerp(r,j._focalPoint,f,percent);var t=vec3.lerp(t,j._position,k,percent);j.setFocalPoint(r);j.setPosition(t);
j.refresh();var u=vec3.dist(r,f)+vec3.dist(t,k);if(u>0.01){var s=(new Date().getTime()-q)-(n*p);j._lmarkAnimationID=window.setTimeout(m,(p-s))}else{j.setFocalPoint(f);j.setPosition(k);j.refresh();c.connectView(this.view)}return}}j._lmarkAnimationID=window.setTimeout(m,p)}b(d,e);return this};vxlCamera.prototype.doLandmarkAnimation=function(a){var c=a.slice(0);var b=this;function d(){if(c.length==0){return}step=c.splice(0,1)[0];lmark=step[0];duration=step[1];fps=step[2];b.gotoLandmark(lmark,duration,fps);
window.setTimeout(d,duration)}d();return this};vxlCamera.prototype.getLandmarks=function(){var b=[];var a=this.landmarks.length;while(a--){b.push(this.landmarks[a].name)}return b};vxlCamera.prototype._shot=function(c){this.setElevation(0);this.setAzimuth(0);this.setRoll(0);var b=Math.max(c[3]-c[0],c[4]-c[1]);cc=[0,0,0];cc[0]=(c[3]+c[0])/2;cc[1]=(c[4]+c[1])/2;cc[2]=(c[5]+c[2])/2;cc[0]=Math.round(cc[0]*1000)/1000;cc[1]=Math.round(cc[1]*1000)/1000;cc[2]=Math.round(cc[2]*1000)/1000;if(b!=0){var a=1.5*b/(Math.tan(this._fov*Math.PI/180));
this.setPosition([cc[0],cc[1],cc[2]+a])}this.setFocalPoint(cc);this.refresh()};vxlCamera.prototype.status=function(){console.info("------------- Camera Status -------------");console.info("       type: "+this.type);console.info("      right: "+vxl.util.format(this._right,2));console.info("         up: "+vxl.util.format(this._up,2));console.info("    forward: "+vxl.util.format(this._forward,2));console.info("   position: "+vxl.util.format(this._position,2));console.info("focal point: "+vxl.util.format(this._focalPoint,2));
console.info("   d vector: "+vxl.util.format(this._distanceVector,2));console.info("    azimuth: "+vxl.util.format(this._azimuth,3));console.info("  elevation: "+vxl.util.format(this._elevation,3));console.info("   distance: "+vxl.util.format(this._distance,2))};vxlCamera.prototype.getViewTransform=function(){return mat4.invert(mat4.create(),this._matrix)};vxlCamera.prototype.setMatrix=function(a){this._matrix=a;this._update()};vxlCamera.prototype._computeMatrix=function(){mat4.identity(this._matrix);
var c=quat.setAxisAngle(quat.create(),[0,0,1],this._roll*vxl.def.deg2rad);var e=undefined;var d=undefined;if(this.type==vxl.def.camera.type.TRACKING){e=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*vxl.def.deg2rad);d=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*vxl.def.deg2rad)}else{if(this._rotate_world){e=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*vxl.def.deg2rad);d=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*vxl.def.deg2rad)}else{e=quat.setAxisAngle(quat.create(),[1,0,0],-this._elevation*vxl.def.deg2rad);
d=quat.setAxisAngle(quat.create(),[0,1,0],-this._azimuth*vxl.def.deg2rad)}}var b=quat.multiply(quat.create(),d,e);b=quat.multiply(quat.create(),b,c);var a=mat4.fromQuat(mat4.create(),b);if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){mat4.translate(this._matrix,this._matrix,this._focalPoint);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(this.type==vxl.def.camera.type.TRACKING){mat4.translate(this._matrix,this._matrix,this._position);
mat4.multiply(this._matrix,this._matrix,a)}}};vxlCamera.prototype._setPosition=function(b,d,c){this._position=vxl.util.createVec3(b,d,c);var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1};vxlCamera.prototype._getAxes=function(){var a=this._matrix;vec3.copy(this._right,vec4.transformMat4(vec4.create(),[1,0,0,0],a));vec3.copy(this._up,vec4.transformMat4(vec4.create(),[0,1,0,0],a));vec3.copy(this._forward,vec4.transformMat4(vec4.create(),[0,0,1,0],a));
vec3.normalize(this._right,this._right);vec3.normalize(this._up,this._up);vec3.normalize(this._forward,this._forward)};vxlCamera.prototype._getPosition=function(){var a=this._matrix;vec3.copy(this._position,vec4.transformMat4(vec4.create(),[0,0,0,1],a));this._getDistance()};vxlCamera.prototype._getFocalPoint=function(){vec3.transformMat3(this._distanceVector,[0,0,-this._distance],mat3.fromMat4(mat3.create(),this._matrix));vec3.add(this._focalPoint,this._position,this._distanceVector);this._getDistance()
};vxlCamera.prototype._getDistance=function(){this._distanceVector=vec3.subtract(vec3.create(),this._focalPoint,this._position);this._distance=vec3.length(this._distanceVector);this._dollyingStep=this._distance/100};vxlCamera.prototype._getAngles=function(){var a=this._distanceVector[0],d=this._distanceVector[1],c=this._distanceVector[2];var b=vec3.length(this._distanceVector);if(b==0){this._elevation=0;this._azimuth=0;return}if(this.type==vxl.def.camera.type.TRACKING){this._elevation=Math.asin(d/b)*vxl.def.rad2deg;
this._azimuth=Math.atan2(-a,-c)*vxl.def.rad2deg}else{if(this._rotate_world){this._elevation=Math.asin(d/b)*vxl.def.rad2deg;this._azimuth=Math.atan2(-a,-c)*vxl.def.rad2deg}else{this._elevation=-1*Math.asin(d/b)*vxl.def.rad2deg;this._azimuth=-1*Math.atan2(-a,-c)*vxl.def.rad2deg}}};vxlCamera.prototype._update=function(){this._getAxes();this._getPosition();this._getDistance();this._getAngles()};vxlCamera.prototype._calculateAngles=function(){var f=mat4.toMat3(this._matrix);var d=mat3.toQuat4(f);var h=d[0],g=d[1],e=d[2],i=d[3];
var b=Math.atan2(2*(i*h+g*e),1-2*(h*h+g*g))*vxl.def.rad2deg;var a=Math.asin(2*(i*g-e*g))*vxl.def.rad2deg;var c=Math.atan2(2*(i*e+h*g),1-2*(g*g+e*e))*vxl.def.rad2deg;console.info(" roll :"+vxl.util.format(b,2));console.info("pitch :"+vxl.util.format(a,2));console.info("  yaw :"+vxl.util.format(c,2))};vxlCamera.prototype._getAngle=function(a){if(a==undefined){return 0}else{if(a>360||a<-360){return a%360}else{return a}}};function vxlCameraManager(a){this.view=a;this.cameras=[];this.active=this.create(vxl.def.camera.type.EXPLORING);if(vxl.c.camera==undefined){vxl.c.camera=this.active}}vxlCameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.create(a)};vxlCameraManager.prototype.create=function(b){var a=new vxlCamera(this.view,b);this.cameras.push(a);return a};vxlCameraManager.prototype.remove=function(a){if(this.cameras.length==1){throw ("vxlCameraManager.remove ERROR: the camera manager must not eliminate the last camera standing. Operation cancelled")
}else{this.cameras.splice(a,1)}};vxlCameraManager.prototype.get=function(a){this._checkBoundary(a);return this.cameras[a]};vxlCameraManager.prototype.switchTo=function(a){var b=this.view;this._checkBoundary(a);this.active=this.cameras[a];if(b.interactor!=undefined){b.interactor.connectCamera(this.active)}else{throw ("vxlCameraManager.switchTo ERROR: switching to camera ["+a+"] while the view "+b.name+" does not have an interactor set")}vxl.c.camera=this.active;return this.active};vxlCameraManager.prototype._checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")
}};function vxlViewInteractor(){this.view=undefined;this.camera=undefined;this.UID=vxl.util.generateUID();this.keymap={};this.keysEnabled=true}vxlViewInteractor.prototype.getType=function(){return"vxlViewInteractor"};vxlViewInteractor.prototype.disconnectFromView=function(){canvas=this.view.canvas;canvas.onmousedown=null;canvas.onmouseup=null;canvas.onmousemove=null;canvas.ondragover=null;canvas.ondragleave=null;canvas.ondrop=null;window.onkeydown=null;window.onkeyup=null;canvas.ondblclick=null};vxlViewInteractor.prototype.connectView=function(a){if(!(a instanceof vxlView)){throw"ViewInteractor.connectView: the parameter is not a vxlView"
}var c=this;var b=a.canvas;this.view=a;this.camera=a.cameraman.active;b.onmousedown=function(d){c.onMouseDown(d)};b.onmouseup=function(d){c.onMouseUp(d)};b.onmousemove=function(d){c.onMouseMove(d)};b.ondragover=function(d){c.onDragOver(d)};b.ondragleave=function(d){c.onDragLeave(d)};b.ondrop=function(d){c.onDrop(d)};window.onkeydown=function(d){c.onKeyDown(d)};window.onkeyup=function(d){c.onKeyUp(d)};b.ondblclick=function(d){c.onDoubleClick(d)}};vxlViewInteractor.prototype.connectCamera=function(a){if(a instanceof vxlCamera){this.camera=a;
this.camera.interactor=this}else{throw ("ViewInteractor.connectCamera: The object "+a+" is not a valid camera")}};vxlViewInteractor.prototype.addKeyAction=function(b,c){var a=b.charCodeAt(0);this.keymap[a]=c};vxlViewInteractor.prototype.removeKeyAction=function(b){var a=b.charCodeAt(0);delete this.keymap[a]};vxlViewInteractor.prototype.fireKeyAction=function(a){if(!this.keysEnabled){return}if(this.keymap[a]){this.keymap[a](this.view,this.camera)}};vxlViewInteractor.prototype.enableKeyActions=function(a){this.keysEnabled=a
};vxlTrackerInteractor.prototype=new vxlViewInteractor();vxlTrackerInteractor.prototype.constructor=vxlViewInteractor;function vxlTrackerInteractor(){vxlViewInteractor.call(this);this.MOTION_FACTOR=10;this.task=vxl.def.interactor.task.NONE;this.x=0;this.y=0;this.lastX=0;this.lastY=0;this.lastClickedX=0;this.lastClickedY=0;this.ctrlPressed=false;this.altPressed=false;this.keyPressed=0;this.button=-1;this.dragging=false;this.dragndrop=false;this.isMac=vxl.util.isMac();this.addKeyAction("F",function(a,b){a.fullscreen(true)
});this.addKeyAction("X",function(a,b){a.fullscreen(false)})}vxlTrackerInteractor.prototype.getType=function(){return"vxlTrackerInteractor"};vxlTrackerInteractor.prototype.onKeyDown=function(d){this.keyPressed=d.keyCode;this.altPressed=d.altKey;this.shiftPressed=d.shiftKey;var c=this.camera;if(!this.altPressed&&!this.shiftPressed){switch(this.keyPressed){case 38:c.changeElevation(10);break;case 40:c.changeElevation(-10);break;case 37:c.changeAzimuth(-10);break;case 39:c.changeAzimuth(10);break;default:this.fireKeyAction(this.keyPressed)
}}else{if(this.shiftPressed&&this.keyPressed!=17){var b=0;var a=0;switch(this.keyPressed){case 38:a=10;break;case 40:a=-10;break;case 37:b=-10;break;case 39:b=10;break;default:this.fireKeyAction(this.keyPressed)}if(b!=0||a!=0){this.pan(b,a)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this.ctrlPressed=false}};vxlTrackerInteractor.prototype.onMouseUp=function(a){task=vxl.def.interactor.task.NONE;this.dragging=false};vxlTrackerInteractor.prototype.onMouseDown=function(a){this.x=a.clientX;
this.y=a.clientY;this.lastClikedX=this.x;this.lastClickedY=this.y;this.button=a.button;this.dragging=true};vxlTrackerInteractor.prototype.onMouseMove=function(a){this.lastX=this.x;this.lastY=this.y;this.x=a.clientX;this.y=a.clientY;if(!this.dragging){return}if(this.button!=0){return}this.ctrlPressed=a.ctrlKey;if(this.isMac&&a.metaKey){this.ctrlPressed=true}this.altPressed=a.altKey;this.shiftPressed=a.shiftKey;var c=this.x-this.lastX;var b=this.y-this.lastY;if(this.ctrlPressed&&!this.shiftPressed){this.dolly(b)
}else{if(this.shiftPressed&&!this.ctrlPressed){this.pan(c,b)}else{if(this.ctrlPressed&&this.shiftPressed){this.roll(b)}else{this.rotate(c,b)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onDragOver=function(a){a.stopPropagation();a.preventDefault();if(this.view.dragndrop){if(!this.dragndrop){this.bgcolor=this.view.backgroundColor.slice(0);this.dragndrop=true}a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(0,0.514,0.678)}};vxlTrackerInteractor.prototype.onDragLeave=function(a){a.stopPropagation();
a.preventDefault();if(this.view.dragndrop){a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(this.bgcolor);this.dragndrop=false}};vxlTrackerInteractor.prototype.onDrop=function(c){c.stopPropagation();c.preventDefault();if(!this.view.dragndrop){return}this.dragndrop=false;this.view.setBackgroundColor(this.bgcolor);var b=c.dataTransfer.files;var a=new vxlVTKReader(this.view.scene);if(a.isSupported()){a.read(b[0])}else{throw"vxlTrackerInteractor.drop: File API is not supported on this browser"
}};vxlTrackerInteractor.prototype.onDoubleClick=function(a){this.camera.longShot()};vxlTrackerInteractor.prototype.dolly=function(a){this.task=vxl.def.interactor.task.DOLLY;this.camera.dolly(a)};vxlTrackerInteractor.prototype.roll=function(d){this.task=vxl.def.interactor.task.ROLL;var b=this.camera.view.canvas;var a=-20/b.width;var c=d*a*this.MOTION_FACTOR;this.camera.rotate(0,0,c)};vxlTrackerInteractor.prototype.rotate=function(c,a){this.task=vxl.def.interactor.task.ROTATE;var f=this.camera.view.canvas;
var i=-20/f.height;var h=-20/f.width;var d=this.MOTION_FACTOR;var b=this.MOTION_FACTOR;if(c*c>2*a*a){b*=0.5}else{if(a*a>2*c*c){d*=0.5}}var g=c*i*d;var e=a*h*b;this.camera.rotate(g,e)};vxlTrackerInteractor.prototype.pan=function(k,j){this.task=vxl.def.interactor.task.PAN;var e=this.camera;var a=e.view.canvas;var d=e.view.scene;this.dragndrop=false;var i=Math.max(a.width,a.height);var c=1/i;var b=1/i;var f=d.bb.max();var h=k*c*this.MOTION_FACTOR*f/2;var g=-j*b*this.MOTION_FACTOR*f/2;e.pan(h,g)};vxlPickerInteractor.prototype=new vxlViewInteractor();vxlPickerInteractor.prototype.constructor=vxlPickerInteractor;function vxlPickerInteractor(){vxlViewInteractor.call(this);this._drag=false;this.timerID=-1;this.list=[];this.rate=50}vxlPickerInteractor.prototype.getType=function(){return"vxlPickerInteractor"};vxlPickerInteractor.prototype.get2DCoords=function(c){var a,g,f=0,e=0,d=this.view.canvas;var b=d.getBoundingClientRect();a=c.clientX-b.left;g=vxl.c.view.canvas.height-(c.clientY-b.top);return[a,g]
};vxlPickerInteractor.prototype.onMouseUp=function(a){this._drag=false;if(this.timerID!=-1){clearInterval(this.timerID)}};vxlPickerInteractor.prototype.onMouseDown=function(a){a.preventDefault();this.view.canvas.style.cursor="crosshair";this.list.push(this.get2DCoords(a));this._doWork();this._drag=true;if(this.timerID!=-1){clearInterval(this.timerID)}this.timerID=setInterval((function(b){return function(){b._doWork()}})(this),this.rate)};vxlPickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();
if(this._drag){this.list.push(this.get2DCoords(a))}};vxlPickerInteractor.prototype._doWork=function(){var c=this.list.length;var f=this.view.renderer;var g=this.view.scene;while(c--){var e=this.list.pop();var a=f.readOffscreenPixel(e[0],e[1]);if(a[0]==0&&a[1]==0&&a[2]==0&&a[3]==0){continue}var b=vxl.go.picker.query(a);if(b==null){continue}var d=g.getActorByCellUID(b.uid);if(d==null){d=g.getActorByUID(b.uid)}if(d!=null&&d.isPickable()&&d._pickingCallback!=undefined){d._pickingCallback(d,b.uid)}}};
vxlPickerInteractor.prototype.onKeyDown=function(a){};vxlPickerInteractor.prototype.onKeyUp=function(a){};vxlPickerInteractor.prototype.onDragOver=function(a){};vxlPickerInteractor.prototype.onDragLeave=function(a){};vxlPickerInteractor.prototype.onDrop=function(a){};vxlViewInteractor.prototype.onDoubleClick=function(a){};function vxlTransforms(a){this._stack=[];this.view=a;this.mvMatrix=mat4.create();this.pMatrix=mat4.create();this.nMatrix=mat4.create();this.cMatrix=mat4.create();this.mvpMatrix=mat4.create()}vxlTransforms.prototype.calculateModelView=function(){mat4.copy(this.mvMatrix,this.view.cameraman.active.getViewTransform())};vxlTransforms.prototype.calculateNormal=function(){this.nMatrix=mat4.clone(this.mvMatrix);this.nMatrix=mat4.invert(mat4.create(),this.nMatrix);this.nMatrix=mat4.transpose(this.nMatrix,this.nMatrix)
};vxlTransforms.prototype.calculatePerspective=function(){var d=this.view.cameraman.active;var b=this.view;var a=vxl.util.deg2rad(d._fov);mat4.perspective(this.pMatrix,a,b.width/b.height,d.Z_NEAR,d.Z_FAR)};vxlTransforms.prototype.calculateModelViewPerspective=function(){mat4.multiply(this.mvpMatrix,this.pMatrix,this.mvMatrix)};vxlTransforms.prototype.update=function(){this.calculateModelView();this.calculatePerspective();this.calculateNormal();this.calculateModelViewPerspective()};vxlTransforms.prototype.push=function(){var a=mat4.create();
mat4.copy(a,this.mvMatrix);this._stack.push(a)};vxlTransforms.prototype.pop=function(){if(this._stack.length==0){return}this.mvMatrix=this._stack.pop();this.calculatePerspective();this.calculateNormal();this.calculateModelViewPerspective()};function vxlProgram(){this.ID=undefined;this.ATTRIBUTES=[];this.UNIFORMS=[];this.VERTEX_SHADER="";this.FRAGMENT_SHADER="";this.DEFAULTS={}}vxlProgram.prototype.copy=function(a){this.ID=a.ID;this.ATTRIBUTES=a.ATTRIBUTES;this.UNIFORMS=a.UNIFORMS;this.VERTEX_SHADER=a.VERTEX_SHADER;this.FRAGMENT_SHADER=a.FRAGMENT_SHADER;this.DEFAULTS=a.DEFAULTS};vxlProgram.prototype.introspect=function(){this.ATTRIBUTES=[];this.UNIFORMS=[];var d=this.VERTEX_SHADER.concat(this.FRAGMENT_SHADER);d=d.replace(/(\r\n|\n\r|\n)/gm,"");
var a=d.match(/(uniform)\s*\w*\s*\w*/g);var b=d.match(/(attribute)\s*\w*\s*\w*/g);if(a.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid uniforms")}if(b.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid attributes")}for(var c=0,e=a.length;c<e;c+=1){this.UNIFORMS.push(a[c].substr(a[c].lastIndexOf(" ")+1,a[c].length))}for(var c=0,e=b.length;c<e;c+=1){this.ATTRIBUTES.push(b[c].substr(b[c].lastIndexOf(" ")+1,b[c].length))
}};vxlProgram.createFromDOM=function(f,b,a){var c=new vxlProgram();c.ID=f;var e=document.getElementById(b);var d=document.getElementById(a);if(e==null||d==null){throw new vxlProgramException("shaders don't exist")}c.VERTEX_SHADER=e.innerHTML;c.FRAGMENT_SHADER=d.innerHTML;c.introspect();return c};vxlProgram.createFromJSON=function(a){var b=new vxlProgram();if(a.ID){b.ID=a.ID}b.VERTEX_SHADER=a.VERTEX_SHADER;b.FRAGMENT_SHADER=a.FRAGMENT_SHADER;b.DEFAULTS=a.DEFAULTS;b.introspect();return b};vxlProgram.createFromTextURL=function(c,b,a){};
function vxlProgramException(a){this.message="vxlProgramException:"+a};vxlLambertProgram.prototype=new vxlProgram();vxlLambertProgram.prototype.constructor=vxlLambertProgram;function vxlLambertProgram(){this.copy(vxlProgram.createFromJSON({ID:"lambert",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform vec4 uMaterialDiffuse;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform bool uUseLightTranslation;","uniform bool uUseTextures;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","   gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","   gl_PointSize = uPointSize;","   if (uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,uMaterialDiffuse.a);","   }","   else {","       vFinalColor = uMaterialDiffuse;","   }","   if (uUseShading){","       vec3 N = normalize(vec3(mNormal * vec4(aVertexNormal, 1.0)));","       vec3 L = normalize(uLightDirection);","       if (uUseLightTranslation){ L = vec3(mNormal * vec4(L,1.0));}","       float lambertTerm = max(dot(N,-L),0.4);","       vec4 Ia = uLightAmbient;","       vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","       vFinalColor = Ia + Id;","       vFinalColor.a = uMaterialDiffuse.a;","   }","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4      vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)  {","   if (uUseTextures){","       gl_FragColor = texture2D(uSampler, vTextureCoords);","   }","   else{","       gl_FragColor = vFinalColor;","   }","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uMaterialDiffuse:[0.9,0.9,0.9,1],uPointSize:1,uUseLightTranslation:false}}))
}vxl.go.essl.lambert=new vxlLambertProgram();vxlPhongProgram.prototype=new vxlProgram();vxlPhongProgram.prototype.constructor=vxlPhongProgram;function vxlPhongProgram(){this.copy(vxlProgram.createFromJSON({ID:"phong",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","uniform bool uUseTextures;","void main(void) {","  gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","   if(uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,1.0);","       return;","   }","   vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","   vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","   vEyeVec = -vec3(vertex.xyz);","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","  if(uUseVertexColors) {","        varMaterialDiffuse = vFinalColor;","   }","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}vxl.go.essl.phong=new vxlPhongProgram();vxlBakeProgram.prototype=new vxlProgram();vxlBakeProgram.prototype.constructor=vxlBakeProgram;function vxlBakeProgram(){this.copy(vxlProgram.createFromJSON({ID:"bake",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec3 aPosition;","attribute vec3 aScale;","attribute float aShading;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform mat4 mModelViewPerspective;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform bool uUseLightTranslation;","varying vec4 vFinalColor;","void main(void) {","   vec3 position = (aVertexPosition * aScale) + aPosition;","   gl_Position = mModelViewPerspective * vec4(position, 1.0);","   vFinalColor = vec4(aVertexColor,1.0);","   if (aShading == 1.0){","      vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","      vec3 L = normalize(uLightDirection);","      if (uUseLightTranslation) { L = vec3(mNormal * vec4(L,1.0));}","      float lambertTerm = max(dot(N,-L),0.4);","      vec4 Ia = uLightAmbient;","      vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","      vFinalColor = Ia + Id;","      vFinalColor.a = 1.0;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4  vFinalColor;","void main(void)  {","       gl_FragColor = vFinalColor;","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uUseLightTranslation:false}}))
}vxl.go.essl.bake=new vxlBakeProgram();vxlDashProgram.prototype=new vxlProgram();vxlDashProgram.prototype.constructor=vxlDashProgram;function vxlDashProgram(){this.copy(vxlProgram.createFromJSON({ID:"dash",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","attribute mat4 aActorMatrix;","uniform float uPointSize;","uniform bool uUseTextures;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","  mat4 matrix = aActorMatrix; ","  gl_Position =  mPerspective * mModelView * matrix * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","  vFinalColor = vec4(aVertexColor,1.0);","  vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","  vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","  vEyeVec = -vec3(vertex.xyz);","  if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = vFinalColor;","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uUseTextures:false,uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}vxl.go.essl.dash=new vxlDashProgram();function vxlProgramManager(a){this._gl=a;this._registered_programs={};this._programs={};this._uniform_map={};this._uniform_types={};this._current_program_object=null;this._current_program_ID=undefined;this._curr_uniform_loc_map={};this._curr_uniform_cache={};this._curr_attribute_loc_map={};this._enabled_attribute_list=[];this._defaults=[];this._one_time_warning=false;this._program_enforced=false}vxlProgramManager.prototype._isProgramRegistered=function(a){return(this._registered_programs[a]!=undefined)
};vxlProgramManager.prototype._registerProgram=function(a){vxl.go.console("Registering program "+a.ID);this._registered_programs[a.ID]=a};vxlProgramManager.prototype._isProgramCreated=function(a){return(this._programs[a]!=undefined)};vxlProgramManager.prototype._createProgramObject=function(b){if(this._isProgramCreated(b)){return}var e=this._registered_programs[b];if(e==undefined){var d="vxlProgramManager.loadProgram WARN: "/" The program "+b+" must be registered first!";console.warn(d);return}var g=this._gl;
var c=g.createProgram();var f=vxl.def.essl;if(e.VERTEX_SHADER){var h=this._createShader(f.VERTEX_SHADER,e.VERTEX_SHADER);g.attachShader(c,h)}if(e.FRAGMENT_SHADER){var a=this._createShader(f.FRAGMENT_SHADER,e.FRAGMENT_SHADER);g.attachShader(c,a)}g.bindAttribLocation(c,0,f.VERTEX_ATTRIBUTE);g.linkProgram(c);if(!g.getProgramParameter(c,g.LINK_STATUS)){alert(b+":\n\n "+g.getProgramInfoLog(c));throw ("Error linking program "+b+":\n\n "+g.getProgramInfoLog(c))}this._programs[b]=c};vxlProgramManager.prototype.useProgram=function(a){var c=this._gl;
var b=this._programs[a];if(b!=undefined&&b!=null){if(b==this._current_program_object){return}c.useProgram(b);this._current_program_object=b;this._current_program_ID=a;this._parseUniforms();this._one_time_warning=false}else{alert("Program: the program "+a+" has NOT been loaded")}};vxlProgramManager.prototype.releaseProgram=function(){this._enforce=false};vxlProgramManager.prototype.setProgram=function(b,d){var a=undefined;if(typeof b=="function"){a=new b()}else{if(typeof b=="object"){a=b}else{console.error("vxlProgramManager.setProgram ERROR: "+b+" is not an engine");
return}}if(this._enforce&&a.ID!=this._current_program_id){var c="vxlProgramManager.setProgram WARN: Unable to set the program "+a.ID+".\nThe current program ["+a.ID+"] is being enforced\nPlease use releaseProgram first.";console.warn(c);return}this._program_enforced=(d!=undefined&&d==true);if(!this._isProgramRegistered(a.ID)){this._registerProgram(a)}if(!this._isProgramCreated(a.ID)){this._createProgramObject(a.ID)}this.useProgram(a.ID);this.clearCache();this.loadDefaults()};vxlProgramManager.prototype.clearCache=function(){this._curr_uniform_cache={};
this._curr_uniform_loc_map={};this._curr_attribute_loc_map={}};vxlProgramManager.prototype.loadDefaults=function(){var b=this._registered_programs[this._current_program_ID];if("DEFAULTS" in b){var c=b.DEFAULTS;for(var a in c){this.setUniform(a,c[a])}}var c=this._defaults[this._current_program_ID];if(c!=undefined){for(var a in c){this.setUniform(a,c[a])}}};vxlProgramManager.prototype.setDefault=function(b,a,c){if(this._defaults[b]==undefined){this._defaults[b]={}}this._defaults[b][a]=c;if(b==this._current_program_ID){this.setUniform(a,c)
}};vxlProgramManager.prototype.getDefault=function(b,a){if(this._defaults[b]==undefined){return undefined}return this._defaults[b][a]};vxlProgramManager.prototype.setUniforms=function(a){for(key in a){this.setUniform(key,a[key])}};vxlProgramManager.prototype.setUniform=function(i,g,d){var e=this._gl;var b=this._current_program_object;var h=this._uniform_map[this._current_program_ID];var a=this._curr_uniform_loc_map;var c=this._curr_uniform_cache;var f=undefined;if(h.indexOf(i)){f=a[i];if(f==undefined){f=e.getUniformLocation(b,i);
a[i]=f}cached_value=c[i];if(cached_value==g){return}c[i]=g;this._setPolymorphicUniform(i,f,g,d)}else{console.warn("vxlProgramManager.setUniform: the uniform "+i+" is not defined for the program "+this._current_program_ID)}};vxlProgramManager.prototype.getUniform=function(a){return this._curr_uniform_cache[a]};vxlProgramManager.prototype.setAttributePointer=function(d,b,f,e,g,h){var c=this._getAttributeLocation(d);this._gl.vertexAttribPointer(c,b,f,e,g,h)};vxlProgramManager.prototype.enableAttribute=function(c){if(this._enabled_attribute_list.indexOf(c)!=-1){return
}var b=this._getAttributeLocation(c);this._gl.enableVertexAttribArray(b);this._enabled_attribute_list.push(c)};vxlProgramManager.prototype.disableAttribute=function(b){if(b==undefined){return}var a=this._enabled_attribute_list.indexOf(b);if(a>=0){var c=this._getAttributeLocation(b);this._gl.disableVertexAttribArray(c);this._enabled_attribute_list.splice(a,1)}};vxlProgramManager.prototype._createShader=function(a,c){var d=this._gl;var b=null;if(a==vxl.def.essl.VERTEX_SHADER){b=d.createShader(d.VERTEX_SHADER)
}else{if(a==vxl.def.essl.FRAGMENT_SHADER){b=d.createShader(d.FRAGMENT_SHADER)}}if(c==undefined||c==null){alert("Error getting the code for shader of type "+a)}d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS)){alert(a+":\n\n "+d.getShaderInfoLog(b));throw ("Error compiling shader "+a+":\n\n "+d.getShaderInfoLog(b))}return b};vxlProgramManager.prototype._parseUniforms=function(d){vs=this._registered_programs[this._current_program_ID].VERTEX_SHADER;fs=this._registered_programs[this._current_program_ID].FRAGMENT_SHADER;
uNames=this._registered_programs[this._current_program_ID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var b=uNames[a];var c=new RegExp("uniform\\s+\\w+\\s"+b,"g");if(vs.search(c)!=-1){uTypes[b]=vs.substring(vs.search(c),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(c)!=1){uTypes[b]=fs.substring(fs.search(c),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]}else{alert("Program: In the program "+this._current_program_ID+" the uniform "+b+" is listed but not used")
}}}this._uniform_map[this._current_program_ID]=uNames;this._uniform_types[this._current_program_ID]=uTypes};vxlProgramManager.prototype._getAttributeLocation=function(a){var b=this._curr_attribute_loc_map[a];if(b!=undefined){return b}b=this._gl.getAttribLocation(this._current_program_object,a);if(b==-1){console.error("vxlProgramManager._getAttributeLocation ERROR: the attribute "+a+"could not be located");b=undefined}else{this._curr_attribute_loc_map[a]=b}return b};vxlProgramManager.prototype._setPolymorphicUniform=function(d,b,c,f){var e=this._gl;
var a=this._uniform_types[this._current_program_ID][d];if(a=="bool"){e.uniform1i(b,c);return}else{if(a=="float"){e.uniform1f(b,c);return}else{if(a=="int"||a=="sampler2D"){e.uniform1i(b,c);return}else{if(a=="mat4"){e.uniformMatrix4fv(b,false,c);return}else{if(c instanceof Array){if(c.length==3&&a=="vec4"){c[3]=1;if(!this._one_time_warning){alert("The uniform "+d+" has only 3 components but voxelent needs 4. This is a one time warning");this._one_time_warning=true}}if(f=="int"){switch(c.length){case 1:e.uniform1iv(b,c);
break;case 2:e.uniform2iv(b,c);break;case 3:e.uniform3iv(b,c);break;case 4:e.uniform4iv(b,c);break;default:alert("ERROR")}}else{switch(c.length){case 1:e.uniform1fv(b,c);break;case 2:e.uniform2fv(b,c);break;case 3:e.uniform3fv(b,c);break;case 4:e.uniform4fv(b,c);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+d+" could not be mapped")}}}}}};function vxlRenderer(a){this.view=a;this.renderRate=vxl.def.renderer.rate.NORMAL;this.mode=vxl.def.renderer.mode.TIMER;this.fps=0;this.engine=undefined;this._time=0;this._startDate=0;this._running=false;this.setEngine(vxlRenderEngine);this.setProgram(vxl.go.essl.lambert)}vxlRenderer.prototype.setEngine=function(b){var a=undefined;if(typeof b=="function"){a=new b()}else{if(typeof b=="object"){a=b}else{console.warn("vxlRenderer.setEngine WARN: "+b+" is not an engine");console.warn("vxlRenderer.setEngine WARN: using vxlRenderEngine by default");
a=new vxlRenderEngine()}}a.init(this);this.engine=a};vxlRenderer.prototype.setProgram=function(a,b){this.engine.setProgram(a,b)};vxlRenderer.prototype.releaseProgram=function(){this.engine.releaseProgram()};vxlRenderer.prototype.clear=function(){this.engine.clear()};vxlRenderer.prototype.clearColor=function(d,c,a){this.engine.clearColor(d,c,a)};vxlRenderer.prototype.clearDepth=function(a){this.engine.clearDepth(a)};vxlRenderer.prototype.reallocate=function(){this.engine.allocate(this.view.scene)};
vxlRenderer.prototype.disableOffscreen=function(){this.engine.disableOffscreen()};vxlRenderer.prototype.enableOffscreen=function(){this.engine.enableOffscreen()};vxlRenderer.prototype.isOffscreenEnabled=function(){return this.engine.isOffscreenEnabled()};vxlRenderer.prototype.readOffscreenPixel=function(a,b){return this.engine.readOffscreenPixel(a,b)};vxlRenderer.prototype.setMode=function(a){this.stop();this.mode=a;this.start()};vxlRenderer.prototype.start=function(){this._running=true;this._startDate=new Date().getTime();
this._time=0;if(this.mode==vxl.def.renderer.mode.TIMER){vxl.go.console("Renderer: starting rendering for view ["+this.view.name+"] at "+this.renderRate+"ms");this._timeUp()}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){vxl.go.console("Renderer: starting rendering at the fastest speed",true);vxl.go.renderman.render()}else{if(this.mode=="DEBUG"){this.clear()}}}};vxlRenderer.prototype._timeUp=function(){if(!this._running||this.mode==vxl.def.renderer.mode.ANIMFRAME){return}this.render();if(this._time==this.renderRate*100){this._time=0;
this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(b){return function(){b._timeUp()}})(this),this.renderRate-a)};vxlRenderer.prototype.stop=function(){if(this.mode==vxl.def.renderer.mode.TIMER){this._running=false}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){vxl.go.renderman.cancel()}}};vxlRenderer.prototype.setRenderRate=function(a){if(a==undefined||a<=0){throw"vxlRenderer.setRenderRate: the rate cannot be zero or undefined"
}if(this.mode==vxl.def.renderer.mode.ANIMFRAME){throw"vxlRenderer.setRenderRate: if the mode is ANIMFRAME render rate is irrelevant"}this.stop();this.renderRate=a;this.start();vxl.go.console("Renderer: view["+this.view.name+"], render rate = "+a,true)};vxlRenderer.prototype.render=function(){var b=this.engine,c=this.view.scene,d=undefined,a=undefined;this.clear();b.allocate(c);d=new Date().getTime();b.render(c);a=new Date().getTime()-d;b.deallocate(c);if(a>0){this.fps=Math.round((this.fps*0.8+(1000/a)*0.2)*100)/100
}};function vxlRendererException(a){this.message=a};function vxlRenderTarget(a){this.canvas=a._view.canvas;this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.gl=a.gl;this.configure()}vxlRenderTarget.prototype.configure=function(){var b=this.canvas.width;var a=this.canvas.height;var c=this.gl;this.texture=c.createTexture();c.bindTexture(c.TEXTURE_2D,this.texture);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);this.renderbuffer=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a);
this.framebuffer=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.texture,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.renderbuffer);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};vxlRenderTarget.prototype.update=function(){var c=this.gl;var b=this.canvas.width;var a=this.canvas.height;c.bindTexture(c.TEXTURE_2D,this.texture);
c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a)};vxlRenderTarget.prototype.readPixel=function(a,d){var c=this.gl;var b=new Uint8Array(1*1*4);c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.readPixels(a,d,1,1,c.RGBA,c.UNSIGNED_BYTE,b);c.bindFramebuffer(c.FRAMEBUFFER,null);return b};function vxlModel(a,b){this.UID=vxl.util.generateUID();this.name=a;this.indices=[];this.vertices=[];this.scalars=undefined;this.diffuse=undefined;this.ambient=undefined;this.specular=undefined;this.shininness=undefined;this.normals=undefined;this.wireframe=undefined;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];this.mode=vxl.def.actor.mode.SOLID;this.image=undefined;this.uri=undefined;this.colors=undefined;this.type=vxl.def.model.type.SIMPLE;this.renderable=undefined;if(b!=undefined){this.load(this.name,b)
}this.setType(this.type)}vxlModel.prototype.setType=function(a){if(this.indices.max()<vxl.def.model.MAX_NUM_INDICES&&a==vxl.def.model.type.BIG_DATA){throw ("The model is not big enough to be of BIG_DATA type. Max index found: "+this.indices.max())}this.type=a};vxlModel.BB_INDICES=[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7];vxlModel.prototype.load=function(a,b){this.name=a.replace(/\.[^/.]+$/,"");if(b.name!=null){this.name=b.name}for(i in b){this[i]=b[i]}this.update()};vxlModel.prototype.update=function(){if(this.vertices==undefined){alert("The model "+this.name+" does not have vertices. Impossible to render!")
}if((this.normals==undefined||(this.normals!=undefined&&this.normals.length==0))&&this.indices!=undefined){this.computeNormals()}if(this.wireframe==undefined){this.computeWireframeIndices()}if(this.mode==undefined){this.mode=vxl.def.actor.mode.SOLID}if(this.texture!=undefined){this.mode=vxl.def.actor.mode.TEXTURED}this.computeBoundingBox();if(this.type==vxl.def.model.type.SIMPLE&&this.indices.max()>vxl.def.model.MAX_NUM_INDICES){this.setType(vxl.def.model.type.BIG_DATA)}};vxlModel.prototype.computeNormals=function(){var n=this.vertices;
var a=this.indices;var k=0;var f=1;var e=2;var g=[];for(var b=0;b<n.length;b=b+3){g[b+k]=0;g[b+f]=0;g[b+e]=0}for(var b=0;b<a.length;b=b+3){var l=[];var h=[];var d=[];l[k]=n[3*a[b+2]+k]-n[3*a[b+1]+k];l[f]=n[3*a[b+2]+f]-n[3*a[b+1]+f];l[e]=n[3*a[b+2]+e]-n[3*a[b+1]+e];h[k]=n[3*a[b]+k]-n[3*a[b+1]+k];h[f]=n[3*a[b]+f]-n[3*a[b+1]+f];h[e]=n[3*a[b]+e]-n[3*a[b+1]+e];d[k]=l[f]*h[e]-l[e]*h[f];d[f]=l[e]*h[k]-l[k]*h[e];d[e]=l[k]*h[f]-l[f]*h[k];for(j=0;j<3;j++){g[3*a[b+j]+k]=g[3*a[b+j]+k]+d[k];g[3*a[b+j]+f]=g[3*a[b+j]+f]+d[f];
g[3*a[b+j]+e]=g[3*a[b+j]+e]+d[e]}}for(var b=0;b<n.length;b=b+3){var m=[];m[k]=g[b+k];m[f]=g[b+f];m[e]=g[b+e];var c=Math.sqrt((m[k]*m[k])+(m[f]*m[f])+(m[e]*m[e]));if(c==0){c=1}m[k]=m[k]/c;m[f]=m[f]/c;m[e]=m[e]/c;g[b+k]=m[k];g[b+f]=m[f];g[b+e]=m[e]}this.normals=g};vxlModel.prototype.flipNormals=function(){var b=this.normals;if(b==undefined){return}for(var a=0;a<b.length;a+=1){b[a]=-b[a]}};vxlModel.prototype.computeWireframeIndices=function(){var d=this.indices;var c=[];var a=0;for(var b=0;b<d.length;
b=b+3){c[a]=d[b];c[a+1]=d[b+1];c[a+2]=d[b+1];c[a+3]=d[b+2];c[a+4]=d[b+2];c[a+5]=d[b];a=a+6}this.wireframe=c};vxlModel.prototype.computeBoundingBox=function(){if(this.vertices.length==0){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];return}var f=this.vertices;var a=[f[0],f[1],f[2],f[0],f[1],f[2]];var b=f.length;for(var b=0,d=f.length;b<d;b=b+3){a[0]=Math.min(a[0],f[b]);a[1]=Math.min(a[1],f[b+1]);a[2]=Math.min(a[2],f[b+2]);a[3]=Math.max(a[3],f[b]);a[4]=Math.max(a[4],f[b+1]);a[5]=Math.max(a[5],f[b+2])
}var e=[0,0,0];e[0]=(a[3]+a[0])/2;e[1]=(a[4]+a[1])/2;e[2]=(a[5]+a[2])/2;this.bb=a;this.centre=e};vxlModel.prototype.getBoundingBoxVertices=function(){var a=this.bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};function vxlCell(d,c,b,a){this.UID=vxl.util.generateUID();this.mesh=d;this.index=c;this.vertices=b;this.color=a==undefined?[0.8,0.8,0.8]:a;this.normal=[0,0,0];this.position=[0,0,0];this._calculatePosition();this._calculateNormal();this._pickingColor=vxl.go.picker.getColorFor(this)}vxlCell.prototype._calculatePosition=function(){this.position[0]=(this.vertices[0][0]+this.vertices[1][0]+this.vertices[2][0])/3;this.position[1]=(this.vertices[0][1]+this.vertices[1][1]+this.vertices[2][1])/3;this.position[2]=(this.vertices[0][2]+this.vertices[1][2]+this.vertices[2][2])/3
};vxlCell.prototype._calculateNormal=function(){var b=vec3.subtract(vec3.create(),this.vertices[1],this.vertices[0]);var a=vec3.subtract(vec3.create(),this.vertices[2],this.vertices[0]);this.normal=vec3.normalize(this.normal,vec3.cross(this.normal,b,a))};vxlCell.prototype.getFlattenVertices=function(){var a=this.vertices;return[a[0][0],a[0][1],a[0][2],a[1][0],a[1][1],a[1][2],a[2][0],a[2][1],a[2][2]]};vxlCell.prototype.setColor=function(d,c,a){this.color=vxl.util.createArr3(d,c,a);this.mesh._updateCellColor(this.index)
};function vxlMesh(a){if(a==undefined){throw ("vxlMesh: the model passed as parameter cannot be undefined")}this.name=a.name+"-mesh";this.cells=[];this.color=[0.8,0.8,0.8];this.actor=a;this.model=undefined;this._createMesh(a)}vxlMesh.prototype.setColor=function(a){this.color=a;this._setModelColor(this.color)};vxlMesh.prototype.scalarsToCellColors=function(a,b){};vxlMesh.prototype.updateColor=function(){var b=this.model;b.colors=[];b.pickingColors=[];for(var c=0,d=this.cells.length;c<d;c+=1){for(var a=0;
a<3;a+=1){b.colors.push.apply(b.colors,this.cells[c].color);b.pickingColors.push.apply(b.pickingColors,this.cells[c]._pickingColor)}}this.actor.updateRenderable()};vxlMesh.prototype.hasCell=function(a){var b=this.cells.length;while(b--){if(this.cells[b].UID==a){return true}}return false};vxlMesh.prototype.getCell=function(a){var b=this.cells.length;while(b--){if(this.cells[b].UID==a){return this.cells[b]}}return null};vxlMesh.prototype.removeCell=function(b){var a=-1;var c=this.cells.length;while(c--){if(this.cells[c].UID==b){a=c;
break}}if(a!=-1){this.cells.splice(a,1);this._createModel()}};vxlMesh.prototype.intersect=function(b,c){var a=b._forward;selection=[];return selection};vxlMesh.prototype._createMesh=function(c){var d=c.model;var a=d.vertices;var e=d.indices;var b=this;this.cells=[];function f(){var g=new Date().getTime();var m=0;var k=[b.color[0],b.color[1],b.color[2]];for(var h=0,n=e.length;h<n;h+=3){q=e[h];var j=[],p,o,l,q;p=a[q*3];o=a[q*3+1];l=a[q*3+2];j.push([p,o,l]);q=e[h+1];p=a[q*3];o=a[q*3+1];l=a[q*3+2];j.push([p,o,l]);
q=e[h+2];p=a[q*3];o=a[q*3+1];l=a[q*3+2];j.push([p,o,l]);b.cells.push(new vxlCell(b,m,j,k));m+=1}b._createModel();var r=new Date().getTime()-g;console.info("Mesh ["+b.name+"] generated in "+r+" ms")}setTimeout(function(){f()},0)};vxlMesh.prototype._createModel=function(){var b=new vxlModel(this.name+"-model");b.colors=[];b.pickingColors=[];for(var c=0,d=this.cells.length;c<d;c+=1){b.indices.push.apply(b.indices,[c*3,c*3+1,c*3+2]);b.vertices.push.apply(b.vertices,this.cells[c].getFlattenVertices());
for(var a=0;a<3;a+=1){b.colors.push.apply(b.colors,this.cells[c].color);b.pickingColors.push.apply(b.pickingColors,this.cells[c]._pickingColor)}}b.computeNormals();b.setType(vxl.def.model.type.MESH);this.model=b;this.actor.updateRenderable(vxl.def.renderable.task.CREATE)};vxlMesh.prototype._setModelColor=function(a){if(this.model==undefined){return}var c=this.model;c.colors=[];for(var d=0,e=this.cells.length;d<e;d+=1){this.cells[d].color=[a[0],a[1],a[2]];for(var b=0;b<3;b+=1){c.colors.push.apply(c.colors,this.cells[d].color)
}}this.actor.updateRenderable(vxl.def.renderable.task.CREATE)};vxlMesh.prototype._updateCellColor=function(b){var a=this.cells[b].color;for(var c=b*9,d=b*9+9;c<d;c+=3){this.model.colors[c]=a[0];this.model.colors[c+1]=a[1];this.model.colors[c+2]=a[2]}this.actor.updateRenderable(vxl.def.renderable.task.UPDATE_COLORS)};function vxlActor(a){this._bb=[0,0,0,0,0,0];this._position=vec3.fromValues(0,0,0);this._translation=vec3.fromValues(0,0,0);this._centre=vec3.fromValues(0,0,0);this._scale=vec3.fromValues(1,1,1);this._rotation=vec3.fromValues(0,0,0);this._matrix=mat4.create();this._matrix_world=mat4.create();this._matrix_normal=mat4.create();this._dirty=false;this._picking=vxl.def.actor.picking.DISABLED;this._pickingCallback=undefined;this._pickingColor=undefined;this._trackingCameras=[];this.UID=vxl.util.generateUID();
this.scene=undefined;this.clones=0;this.mode=vxl.def.actor.mode.SOLID;this.cull=vxl.def.actor.cull.NONE;this.visible=true;this.mesh=undefined;this.material=new vxlMaterial();this.renderable=undefined;this._bb_disabled=false;if(a){this.model=a;this.name=a.name;this.mode=a.mode;this._bb=a.bb.slice(0);this._centre=vec3.clone(a.centre);this.material.getFrom(a);if(a.type==vxl.def.model.type.BIG_DATA){this.renderable=new vxlRenderable(this)}}else{this.model=new vxlModel()}var b=vxl.events;vxl.go.notifier.publish([b.ACTOR_MOVED,b.ACTOR_SCALED,b.ACTOR_ROTATED,b.ACTOR_CHANGED_COLOR,b.ACTOR_CHANGED_SHADING,],this)
}vxlActor.prototype.setScene=function(a){this.scene=a};vxlActor.prototype.setPosition=function(b,e,d){var c=vxl.util.createVec3(b,e,d);vec3.subtract(this._translation,c,this._position);this._position=c;var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1;if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this);return this};vxlActor.prototype.translate=function(b,d,c){this._translation=vxl.util.createVec3(b,d,c);
var a=this._matrix;mat4.translate(a,a,this._translation);this._position=vec3.fromValues(a[12],a[13],a[14]);if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this);return this};vxlActor.prototype.rotateX=function(d){var b=this._matrix;var c=vxl.util.deg2rad(vxl.util.getAngle(d));mat4.rotateX(b,b,c);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.rotateY=function(d){var b=this._matrix;
var c=vxl.util.deg2rad(vxl.util.getAngle(d));mat4.rotateY(b,b,c);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.rotateZ=function(d){var b=this._matrix;var c=vxl.util.deg2rad(vxl.util.getAngle(d));mat4.rotateZ(b,b,c);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.setScale=function(f,e,d){if(f==0&&e==undefined&&d==undefined){return
}if(typeof(f)=="number"&&e==undefined&&d==undefined){this._scale=vxl.util.createVec3(f,f,f)}else{this._scale=vxl.util.createVec3(f,e,d)}var c=this._matrix;mat4.scale(c,c,this._scale);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_SCALED,this);return this};vxlActor.prototype.addTrackingCamera=function(a){if(a instanceof vxlCamera&&a.type!=vxl.def.camera.type.TRACKING){throw"vxlActor._addTrackingCamera ERROR: the selected camera is not set to tracking"}else{if(a instanceof vxlCamera){this._trackingCameras.push(a)
}else{throw"vxlActor._addTrackingCamera ERROR: the object passed as a parameter is not a vxlCamera"}}};vxlActor.prototype.removeTrackingCamera=function(b){var a=this._trackingCameras.indexOf(b);this._trackingCameras.splice(a,1)};vxlActor.prototype._notifyTrackingCameras=function(){for(var a=0,b=this._trackingCameras.length;a<b;a+=1){this._trackingCameras[a].updateWithActor(this)}};vxlActor.prototype._computeBoundingBox=function(){var f=this.model.vertices;var d=[];var c=this._matrix;for(var e=0;e<f.length;
e=e+3){var a=vxl.util.createVec3(f[e],f[e+1],f[e+2]);vec3.transformMat4(a,a,c);d.push(a[0],a[1],a[2])}var b=[d[0],d[1],d[2],d[0],d[1],d[2]];for(var e=0;e<d.length;e=e+3){b[0]=Math.min(b[0],d[e]);b[1]=Math.min(b[1],d[e+1]);b[2]=Math.min(b[2],d[e+2]);b[3]=Math.max(b[3],d[e]);b[4]=Math.max(b[4],d[e+1]);b[5]=Math.max(b[5],d[e+2])}this._bb=b};vxlActor.prototype.getBoundingBoxVertices=function(){var a=this._bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]
};vxlActor.prototype.getBoundingBox=function(){return this._bb.slice[0]};vxlActor.prototype.getHeight=function(){var a=this._bb;return a[4]-a[1]};vxlActor.prototype.setColor=function(d,c,a){this.material.diffuse=vxl.util.createVec3(d,c,a);if(this.mesh){this.mesh.setColor(this.material.diffuse)}vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_COLOR,this);return this};vxlActor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.material.opacity=a}else{throw"The opacity value is not valid"}return this
};vxlActor.prototype.setShininess=function(a){this.material.shininess=a;return this};vxlActor.prototype.setTexture=function(a){this.material.texture=new vxlTexture(a);this.dirty=true;return this};vxlActor.prototype.setProperty=function(c,b,a){if(a==vxl.def.actor||a==undefined||a==null){switch(c){case"position":this.setPosition(b);break;case"scale":this.setScale(b);break;case"color":this.setColor(b);break;case"shading":this.setShading(b);break;case"texture":this.setTexture(b);break;case"opacity":this.setOpacity(b);
break;case"shininess":this.setShininess(b);break;default:this[c]=b;break}vxl.go.console("Actor: The actor "+this.name+" has been updated. ["+c+" = "+b+"]")}else{if(a==vxl.def.model){this.model[c]=b;vxl.go.console("vxlActor: The model "+this.model.namname+" has been updated. ["+c+" = "+b+"]")}else{throw ("vxlActor.setProperty. Scope:"+a+" is not valid")}}return this};vxlActor.prototype.setShading=function(a){this.material.shading=a;vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_SHADING,this);return this
};vxlActor.prototype.getProperty=function(a){if(a=="color"){return this.materia.diffuse}else{if(this.hasOwnProperty(a)){return this[a]}else{if(this.material.hasOwnProperty(a)){return this.material[a]}else{if(this.model.hasOwnProperty(a)){return this.model[a]}else{return undefined}}}}};vxlActor.prototype.computePosition=function(){bb=this._bb;var a=vec3.create();a[0]=(bb[3]+bb[0])/2;a[1]=(bb[4]+bb[1])/2;a[2]=(bb[5]+bb[2])/2;a[0]=Math.round(a[0]*1000)/1000;a[1]=Math.round(a[1]*1000)/1000;a[2]=Math.round(a[2]*1000)/1000;
return vec3.clone(a)};vxlActor.prototype.setVisualizationMode=function(a){this.mode=a;this._dirty=true;return this};vxlActor.prototype.cullFace=function(a){this.cull=a;return this};vxlActor.prototype.setLookupTable=function(e,c,a){if(this.model.scalars==undefined){return}var b=this;function d(f){var g=vxl.go.lookupTableManager.get(e);b.material.colors=g.getColors(b.model.scalars,c,a);if(b.model.type==vxl.def.model.type.BIG_DATA){b.renderable.update()}}setTimeout(function(){d()},0);return this};vxlActor.prototype.flipNormals=function(){this.model.flipNormals();
return this};vxlActor.prototype.setVisible=function(a){this.visible=a;return this};vxlActor.prototype.isVisible=function(){return this.visible};vxlActor.prototype.clone=function(){this.clones++;var a=new vxlActor(this.model);a.name+="-"+this.clones;a.material=this.material.clone();return a};vxlActor.prototype.setPicker=function(b,d){this._picking=b;switch(b){case vxl.def.actor.picking.DISABLED:this._pickingCallback=undefined;this.mesh=undefined;this.renderable=undefined;this.setVisualizationMode(vxl.def.actor.mode.SOLID);
break;case vxl.def.actor.picking.CELL:if(this.mesh==undefined){this.mesh=new vxlMesh(this);this.mesh.setColor(this.material.diffuse);this.renderable=new vxlRenderable(this);this.setVisualizationMode(vxl.def.actor.mode.FLAT)}this._pickingCallback=d;break;case vxl.def.actor.picking.OBJECT:this._pickingColor=vxl.go.picker.getColorFor(this);this._pickingCallback=d;break}if(this._picking!=vxl.def.actor.picking.DISABLED){var a=this.scene.views.length;while(a--){var c=this.scene.views[a].renderer;if(!c.isOffscreenEnabled()){c.enableOffscreen()
}}}return this};vxlActor.prototype.isPickable=function(){return(this._picking!=vxl.def.actor.picking.DISABLED)};vxlActor.prototype.getPickingType=function(){return this._picking};vxlActor.prototype.getRenderableModel=function(){if(this.mesh&&this.mesh.model){return this.mesh.model}else{if(this.model.type==vxl.def.model.type.BIG_DATA){return this.model}else{return undefined}}};vxlActor.prototype.updateRenderable=function(a){this.renderable.update(a)};vxlActor.prototype.reallocate=function(){this._dirty=true
};function vxlPicker(){this._objects={};this._colors={}}vxlPicker.RESOLUTION=1/255;vxlPicker.prototype._hex2rgb=function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=d.replace(c,function(f,i,h,e){return i+i+h+h+e+e});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null};vxlPicker.prototype._rgb2hex=function(e,d,a){var f=vxl.util.createArr3(e,d,a);return"#"+((1<<24)+(f[0]<<16)+(f[1]<<8)+f[2]).toString(16).slice(1)};vxlPicker.prototype._getColor=function(){function a(){var c=Math.floor(Math.random()*255);
if(c==0){return a()}else{return c}}return[a(),a(),a()]};vxlPicker.prototype.color2decimal=function(a){r=a[0]*vxlPicker.RESOLUTION;g=a[1]*vxlPicker.RESOLUTION;b=a[2]*vxlPicker.RESOLUTION;return[r,g,b]};vxlPicker.prototype.getColorFor=function(e){var d=e.UID;if(d==null||d==undefined){alert("vxlPicker.getColor: invalid object");return}var a,c;if(!this._objects[d]){do{a=this._getColor();c=this._rgb2hex(a)}while(c in this._colors);this._objects[d]=a;this._colors[c]=d}a=this._objects[d];return this.color2decimal(a)
};vxlPicker.prototype.query=function(e){var h=100;var f=undefined;var d={};var a=e.slice(0,3);var c=this._rgb2hex(a);if(this._colors[c]){d.uid=this._colors[c];d.color=a;return d}return null};vxl.go.picker=new vxlPicker();function vxlEngine(){this.gl=undefined;this.pm=undefined;this._view=undefined;this._clear_color=undefined;this._transforms=undefined}vxlEngine.prototype.allocate=function(a){};vxlEngine.prototype.render=function(a){};vxlEngine.prototype.deallocate=function(a){};vxlEngine.prototype.reallocate=function(a){};vxlEngine.prototype.disableOffscreen=function(){};vxlEngine.prototype.enableOffscreen=function(){};vxlEngine.prototype.isOffscreenEnabled=function(){};vxlEngine.prototype.readOffscreenPixel=function(a,b){};
vxlEngine.prototype.init=function(a){this._getGL(a);this._view=a.view;this.pm=new vxlProgramManager(this.gl);this._transforms=new vxlTransforms(a.view);this.configure()};vxlEngine.prototype._getGL=function(b){var a=undefined;var c=b.view.canvas;var g=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.gl=undefined;for(var d=0;d<g.length;++d){try{a=c.getContext(g[d])}catch(f){}if(a){break}}if(a==null){alert("Sorry: WebGL is not available on this browser. Have you tried the newest version of Firefox, Chrome or Safari?");
return undefined}else{this.gl=a}};vxlEngine.prototype.configure=function(){var a=this.gl;a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.depthFunc(a.LESS);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true)};vxlEngine.prototype.clear=function(){var d=this.gl;var b=this._view.canvas;var c=b.width;var a=b.height;var e=this._clear_color;d.clearColor(e[0],e[1],e[2],1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);d.viewport(0,0,c,a);this._transforms.calculatePerspective()
};vxlEngine.prototype.clearColor=function(d,c,a){var e=vxl.util.createArr3(d,c,a);this._clear_color=e;this.gl.clearColor(e[0],e[1],e[2],1)};vxlEngine.prototype.clearDepth=function(a){this.gl.clearDepth(a)};vxlEngine.prototype.releaseProgram=function(){this.pm.releaseProgram()};vxlEngine.prototype.setProgram=function(a,b){this.pm.setProgram(a,b)};vxlExternalEngine.prototype=new vxlEngine();vxlExternalEngine.prototype.constructor=vxlExternalEngine;function vxlExternalEngine(c,d,b,a){this.renderer=c;this.allocateCallback=d;this.renderCallback=b;this.deallocateCallback=a}vxlExternalEngine.prototype.allocate=function(a){this.allocateCallback(this.renderer,a)};vxlExternalEngine.prototype.render=function(a){this.renderCallback(this.renderer,a)};vxlExternalEngine.prototype.deallocate=function(a){this.deallocateCallback(this.renderer,a)};vxlRenderEngine.prototype=new vxlEngine();vxlRenderEngine.prototype.constructor=vxlRenderEngine;function vxlRenderEngine(){vxlEngine.call(this);this._gl_buffers={};this._gl_textures={};this._offscreen=false;this._target=undefined;this._onPickingBuffer=false;this._debug_picking_flag=false}vxlRenderEngine.prototype.configure=function(){vxlEngine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};vxlRenderEngine.prototype.allocate=function(c){var b=c._actors.concat(c.toys.list);
var a=b.length;while(a--){this._allocateActor(b[a])}};vxlRenderEngine.prototype.deallocate=function(a){};vxlRenderEngine.prototype._allocateActor=function(c){var d=this.gl;var b=c.model;var a={};if(!(b.UID in this._gl_buffers)||c._dirty){this._reallocateActor(c);c._dirty=false}};vxlRenderEngine.prototype._reallocateActor=function(d){var g=this.gl;var c=d.model;var a=this._gl_buffers[c.UID]||{};var e=vxl.def.actor.mode;if(a.vertex==undefined){a.vertex=g.createBuffer()}var b=undefined;switch(d.mode){case e.BOUNDING_BOX:b=d.getBoundingBoxVertices();
break;default:b=c.vertices}g.bindBuffer(g.ARRAY_BUFFER,a.vertex);g.bufferData(g.ARRAY_BUFFER,new Float32Array(b),g.STATIC_DRAW);if(c.normals){if(a.normal==undefined){a.normal=g.createBuffer()}g.bindBuffer(g.ARRAY_BUFFER,a.normal);g.bufferData(g.ARRAY_BUFFER,new Float32Array(c.normals),g.STATIC_DRAW)}if(c.scalars!=undefined||c.colors!=undefined){if(a.color==undefined){a.color=g.createBuffer()}}if(c.indices!=undefined){if(a.index==undefined){a.index=g.createBuffer()}var f=undefined;switch(d.mode){case e.SOLID:f=c.indices;
break;case e.WIREFRAME:f=c.wireframe;break;case e.POINTS:f=c.indices;break;case e.LINES:f=c.indices;break;case e.BOUNDING_BOX:f=vxlModel.BB_INDICES;break;case e.BB_AND_SOLID:f=c.indices;break;case e.WIRED_AND_SOLID:f=c.indices;break;case e.FLAT:f=c.indices;break;case e.TEXTURED:f=c.indices;break;default:throw ("There was a problem while rendering the actor ["+d.name+"].The visualization mode: "+d.mode+" is not valid.")}g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),g.STATIC_DRAW)
}if(d.mode==e.FLAT){if(a.vertex_parts==undefined){a.vertex_parts=g.createBuffer()}if(a.normal_parts==undefined){a.normal_parts=g.createBuffer()}if(a.color_parts==undefined){a.color_parts=g.createBuffer()}if(a.index_parts==undefined){a.index_parts=g.createBuffer()}}else{if(a.vertex_parts!=undefined){g.deleteBuffer(a.vertex_parts);a.vertex_parts=null;delete a.vertex_parts}if(a.normal_parts!=undefined){g.deleteBuffer(a.normal_parts);a.normal_parts=null;delete a.normal_parts}if(a.color_parts!=undefined){g.deleteBuffer(a.color_parts);
a.color_parts=null;delete a.color_parts}if(a.index_parts!=undefined){g.deleteBuffer(a.index_parts);a.index_parts=null;delete a.index_parts}}if(d.mode==e.WIRED_AND_SOLID){a.index_ws=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index_ws);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.wireframe),g.STATIC_DRAW);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)}else{if(a.index_ws!=undefined){g.deleteBuffer(a.index_ws);a.index_ws=null;delete a.index_ws}}if(d.mode==e.BB_AND_SOLID){a.vertex_bs=g.createBuffer();
g.bindBuffer(g.ARRAY_BUFFER,a.vertex_bs);g.bufferData(g.ARRAY_BUFFER,new Float32Array(d.getBoundingBoxVertices()),g.STATIC_DRAW);g.bindBuffer(g.ARRAY_BUFFER,null);a.index_bs=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index_bs);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(vxlModel.BB_INDICES),g.STATIC_DRAW);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)}else{if(a.vertex_bs!=undefined){g.deleteBuffer(a.vertex_bs);a.vertex_bs=null;delete a.vertex_bs}if(a.index_bs!=undefined){g.deleteBuffer(a.index_bs);
a.index_bs=null;delete a.index_bs}}if(c.texcoords&&d.material.texture&&d.material.texture.loaded){a.texcoords=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,a.texcoords);g.bufferData(g.ARRAY_BUFFER,new Float32Array(c.texcoords),g.STATIC_DRAW);this._gl_textures[d.UID]=g.createTexture();g.bindTexture(g.TEXTURE_2D,this._gl_textures[d.UID]);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,d.material.texture.image);g.generateMipmap(g.TEXTURE_2D);g.bindTexture(g.TEXTURE_2D,null)}g.bindBuffer(g.ARRAY_BUFFER,null);
g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);this._gl_buffers[c.UID]=a};vxlRenderEngine.prototype._setNormals=function(d){var b=d.model;var f=this.gl;var c=this.pm;var a=this._gl_buffers[b.UID];var e=vxl.def.essl;if(b.normals&&d.material.shading){f.bindBuffer(f.ARRAY_BUFFER,a.normal);c.enableAttribute(e.NORMAL_ATTRIBUTE);c.setAttributePointer(e.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0)}};vxlRenderEngine.prototype._setColors=function(d){var b=d.model;var f=this.gl;var c=this.pm;var a=this._gl_buffers[b.UID];
var e=vxl.def.essl;if(d.material.colors&&d.material.colors.length==d.model.vertices.length){c.setUniform("uUseVertexColors",true);f.bindBuffer(f.ARRAY_BUFFER,a.color);f.bufferData(f.ARRAY_BUFFER,new Float32Array(d.material.colors),f.STATIC_DRAW);c.enableAttribute(e.COLOR_ATTRIBUTE);c.setAttributePointer(e.COLOR_ATTRIBUTE,3,f.FLOAT,false,0,0)}};vxlRenderEngine.prototype._setRenderableVertices=function(d,b){var f=this.gl;var c=this.pm;var a=this._gl_buffers[d.model.UID];var e=vxl.def.essl;f.bindBuffer(f.ARRAY_BUFFER,a.vertex_parts);
f.bufferData(f.ARRAY_BUFFER,new Float32Array(b.vertices),f.STATIC_DRAW);c.setAttributePointer(e.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0)};vxlRenderEngine.prototype._setRenderableNormals=function(d,b){var f=this.gl;var c=this.pm;var a=this._gl_buffers[model.UID];var e=vxl.def.essl;if(b.normals!=undefined&&b.normals.length>0){f.bindBuffer(f.ARRAY_BUFFER,a.normal_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(b.normals),f.STATIC_DRAW);c.enableAttribute(e.NORMAL_ATTRIBUTE);c.setAttributePointer(e.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0)
}};vxlRenderEngine.prototype._setRenderableColors=function(d,b){var f=this.gl;var c=this.pm;var a=this._gl_buffers[model.UID];var e=vxl.def.essl;if(b.colors!=undefined&&b.colors.length>0){c.setUniform("uUseVertexColors",true);f.bindBuffer(f.ARRAY_BUFFER,a.color_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(b.colors),f.STATIC_DRAW);c.enableAttribute(e.COLOR_ATTRIBUTE);c.setAttributePointer(e.COLOR_ATTRIBUTE,3,f.FLOAT,false,0,0)}};vxlRenderEngine.prototype._updateActorTransforms=function(e){var c=this._transforms;
var d=e._actors.concat(e.toys.list);var f=d.length;var b=undefined;c.calculateModelView();for(var a=0;a<f;a+=1){b=d[a];if(!b.visible){continue}b._matrix_world=mat4.multiply(b._matrix_world,c.mvMatrix,b._matrix);b._matrix_normal=mat4.copy(b._matrix_normal,b._matrix_world);b._matrix_normal=mat4.invert(mat4.create(),b._matrix_normal);b._matrix_normal=mat4.transpose(b._matrix_normal,b._matrix_normal)}};vxlRenderEngine.prototype.render=function(f){var c=this._transforms,b=this.pm,g=this.gl,e=vxl.def.essl;
this._updateActorTransforms(f);if(f.frameAnimation!=undefined){f.frameAnimation.update()}this._renderPicking(f._actors);var d=f._actors.concat(f.toys.list);var a=d.length;while(a--){this._renderActor(d[a])}};vxlRenderEngine.prototype._renderPicking=function(b){if(this._target==undefined){return}if(this._offscreen){var c=this.gl;this._onPickingBuffer=true;c.bindFramebuffer(c.FRAMEBUFFER,this._target.framebuffer);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);var a=b.length;while(a--){if(b[a].isPickable()){this._renderActor(b[a])
}}this._onPickingBuffer=false;c.bindFramebuffer(c.FRAMEBUFFER,null)}if(this._debug_picking_flag){c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT)}};vxlRenderEngine.prototype._renderActor=function(c){if(!c.visible){return}var e=c.model;var j=this._gl_buffers[e.UID];var g=this._gl_textures[c.UID];var d=this.gl;var a=this.pm;var i=vxl.def.essl;var b=this._transforms;var h=[c.material.diffuse[0],c.material.diffuse[1],c.material.diffuse[2],c.material.opacity];if(c.mode==vxl.def.actor.mode.FLAT){this.setProgram(vxl.go.essl.lambert)
}else{}a.disableAttribute(i.TEXCOORD_ATTRIBUTE);a.disableAttribute(i.COLOR_ATTRIBUTE);a.disableAttribute(i.NORMAL_ATTRIBUTE);a.disableAttribute(i.PICKING_COLOR_ATTRIBUTE);a.enableAttribute(i.VERTEX_ATTRIBUTE);a.setUniform("uUseVertexColors",false);a.setUniform("uUseTextures",false);a.setUniform("uUseShading",c.material.shading);a.setUniform("uMaterialDiffuse",h);a.setUniform(i.MODEL_VIEW_MATRIX,c._matrix_world);a.setUniform(i.NORMAL_MATRIX,c._matrix_normal);a.setUniform(i.PERSPECTIVE_MATRIX,b.pMatrix);
this._handleCulling(c);if(this._onPickingBuffer||this._debug_picking_flag){this._renderPickingBuffer(c);return}if(c.mode!=vxl.def.actor.mode.FLAT&&c.model.type!=vxl.def.model.type.BIG_DATA){d.bindBuffer(d.ARRAY_BUFFER,j.vertex);a.setAttributePointer(i.VERTEX_ATTRIBUTE,3,d.FLOAT,false,0,0)}var f=vxl.def.actor.mode;switch(c.mode){case f.SOLID:this._renderSolid(c);break;case f.WIREFRAME:this._renderWireframe(c);break;case f.POINTS:this._renderPoints(c);break;case f.LINES:this._renderLines(c);break;case f.BOUNDING_BOX:this._renderBoundingBox(c);
break;case f.BB_AND_SOLID:this._renderBoundingBoxAndSolid(c);break;case f.WIRED_AND_SOLID:this._renderWiredAndSolid(c);break;case f.FLAT:this._renderFlat(c);break;case f.TEXTURED:this._renderTextured(c);break;default:throw ("There was a problem while rendering the actor ["+c.name+"]. The visualization mode: "+c.mode+" is not valid.")}d.bindBuffer(d.ARRAY_BUFFER,null);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null)};vxlRenderEngine.prototype._renderSolid=function(e){var a=this._gl_buffers[e.model.UID];var g=this.gl;
var d=this.pm;var f=vxl.def.essl;if(e.model.type!=vxl.def.model.type.SIMPLE){if(e.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=e.renderable.parts;var c=parts.length;while(c--){var b=parts[c];this._setRenderableVertices(e,b);this._setRenderableNormals(e,b);this._setRenderableColors(e,b);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index_part);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.indices),g.STATIC_DRAW);
g.drawElements(g.TRIANGLES,b.indices.length,g.UNSIGNED_SHORT,0)}}else{this._setNormals(e);this._setColors(e);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index);g.drawElements(g.TRIANGLES,e.model.indices.length,g.UNSIGNED_SHORT,0)}};vxlRenderEngine.prototype._renderWireframe=function(c){var a=this._gl_buffers[c.model.UID];var e=this.gl;var b=this.pm;var d=vxl.def.essl;if(!c.toy){this._setNormals(c)}this._setColors(c);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.index);e.drawElements(e.LINES,c.model.wireframe.length,e.UNSIGNED_SHORT,0)
};vxlRenderEngine.prototype._renderPoints=function(c){var a=c.model;var d=this.gl;var b=this.pm;b.setUniform("uUseShading",false);b.setUniform("uPointSize",5);this._setColors(c);d.drawArrays(d.POINTS,0,a.vertices.length/3)};vxlRenderEngine.prototype._renderLines=function(c){var a=this._gl_buffers[c.model.UID];var e=this.gl;var b=this.pm;var d=vxl.def.essl;b.setUniform("uUseShading",false);this._setColors(c);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.index);e.drawElements(e.LINES,c.model.indices.length,e.UNSIGNED_SHORT,0)
};vxlRenderEngine.prototype._renderBoundingBox=function(c){var a=this._gl_buffers[c.model.UID];var e=this.gl;var b=this.pm;var d=vxl.def.essl;b.disableAttribute(d.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",false);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.index);e.drawElements(e.LINES,vxlModel.BB_INDICES.length,e.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderBoundingBoxAndSolid=function(d){var b=d.model;var a=this._gl_buffers[b.UID];var g=this.gl;var c=this.pm;var f=vxl.def.essl;var e=this._transforms;
this._renderSolid(d);e.calculateModelView();e.calculateNormal();c.setUniform(f.MODEL_VIEW_MATRIX,e.mvMatrix);c.setUniform(f.NORMAL_MATRIX,e.nMatrix);c.disableAttribute(f.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",false);g.bindBuffer(g.ARRAY_BUFFER,a.vertex_bs);c.setAttributePointer(f.VERTEX_ATTRIBUTE,3,g.FLOAT,false,0,0);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index_bs);g.drawElements(g.LINES,vxlModel.BB_INDICES.length,g.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderWiredAndSolid=function(d){var b=d.model;
var a=this._gl_buffers[b.UID];var f=this.gl;var c=this.pm;var e=vxl.def.essl;this._renderSolid(d);c.setUniform("uUseShading",false);c.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);c.disableAttribute(e.NORMAL_ATTRIBUTE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.index_ws);f.drawElements(f.LINES,b.wireframe.length,f.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderFlat=function(d){var g=d.model;var k=this._gl_buffers[g.UID];var h=this._gl_textures[d.UID];var f=this.gl;var b=this.pm;var j=vxl.def.essl;
if(d.mesh==undefined){d.mesh=new vxlMesh(d);d.renderable=new vxlRenderable(d)}if(d.mesh.model==undefined){var g=d.model;f.bindBuffer(f.ARRAY_BUFFER,k.vertex);b.setAttributePointer(j.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0);f.bindBuffer(f.ARRAY_BUFFER,k.normal);b.setAttributePointer(j.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0);f.bindBuffer(f.ARRAY_BUFFER,null);b.enableAttribute(j.NORMAL_ATTRIBUTE);b.setUniform("uUseShading",d.material.shading);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(g.wireframe),f.STATIC_DRAW);
f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);this._renderWireframe(d);return}b.setUniform("uUseShading",true);b.enableAttribute(j.NORMAL_ATTRIBUTE);var c=d.renderable.parts;var e=c.length;while(e--){var a=c[e];f.bindBuffer(f.ARRAY_BUFFER,k.vertex_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(a.vertices),f.STATIC_DRAW);b.setAttributePointer(j.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0);f.bindBuffer(f.ARRAY_BUFFER,k.normal_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(a.normals),f.STATIC_DRAW);b.setAttributePointer(j.NORMAL_ATTRIBUTE,3,f.FLOAT,false,0,0);
if(a.colors&&a.colors.length>0){b.enableAttribute(j.COLOR_ATTRIBUTE);b.setUniform("uUseVertexColors",true);f.bindBuffer(f.ARRAY_BUFFER,k.color_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(a.colors),f.STATIC_DRAW);b.setAttributePointer(j.COLOR_ATTRIBUTE,3,f.FLOAT,false,0,0)}f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,k.index_parts);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),f.STATIC_DRAW);f.drawElements(f.TRIANGLES,a.indices.length,f.UNSIGNED_SHORT,0)}};vxlRenderEngine.prototype._renderPickingBuffer=function(d){var g=d.model;
var j=this._gl_buffers[g.UID];var f=this.gl;var b=this.pm;var h=vxl.def.essl;if(d._picking==vxl.def.actor.picking.DISABLED){return}b.setUniform("uUseShading",false);if(d._picking==vxl.def.actor.picking.CELL){if(d.mesh==undefined||d.mesh.model==undefined){return}if(j.picking_parts==undefined){j.picking_parts=f.createBuffer();j.picking_colors=f.createBuffer();j.picking_index=f.createBuffer()}b.setUniform("uUseVertexColors",true);b.enableAttribute(h.COLOR_ATTRIBUTE);var c=d.renderable.parts;var e=c.length;
while(e--){var a=c[e];f.bindBuffer(f.ARRAY_BUFFER,j.picking_parts);f.bufferData(f.ARRAY_BUFFER,new Float32Array(a.vertices),f.STATIC_DRAW);b.setAttributePointer(h.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0);if(a.pickingColors&&a.pickingColors.length==a.vertices.length){f.bindBuffer(f.ARRAY_BUFFER,j.picking_colors);f.bufferData(f.ARRAY_BUFFER,new Float32Array(a.pickingColors),f.STATIC_DRAW);b.setAttributePointer(h.COLOR_ATTRIBUTE,3,f.FLOAT,false,0,0)}else{alert("The object "+a.name+" does not have picking colors assigned.");
throw ("The object "+a.name+" does not have picking colors assigned.")}f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,j.picking_index);f.bufferData(f.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),f.STATIC_DRAW);f.drawElements(f.TRIANGLES,a.indices.length,f.UNSIGNED_SHORT,0)}}else{if(d._picking==vxl.def.actor.picking.OBJECT){b.setUniform("uMaterialDiffuse",d._pickingColor.concat(1));f.bindBuffer(f.ARRAY_BUFFER,j.vertex);b.setAttributePointer(h.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,j.index);
f.drawElements(f.TRIANGLES,g.indices.length,f.UNSIGNED_SHORT,0)}}f.bindBuffer(f.ARRAY_BUFFER,null);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)};vxlRenderEngine.prototype._renderTextured=function(d){var b=d.model;var a=this._gl_buffers[b.UID];var e=this._gl_textures[d.UID];var g=this.gl;var c=this.pm;var f=vxl.def.essl;if(!d.material.texture.loaded){this._renderSolid(d);return}if(b.texcoords){c.setUniform("uUseTextures",true);g.bindBuffer(g.ARRAY_BUFFER,a.texcoords);g.bufferData(g.ARRAY_BUFFER,new Float32Array(b.texcoords),g.STATIC_DRAW);
c.setAttributePointer(f.TEXCOORD_ATTRIBUTE,2,g.FLOAT,false,0,0);c.enableAttribute(f.TEXCOORD_ATTRIBUTE)}else{throw ("error")}g.activeTexture(g.TEXTURE0);g.bindTexture(g.TEXTURE_2D,e);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,d.material.texture.getMagFilter(g));g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,d.material.texture.getMinFilter(g));c.setUniform("uSampler",0);
g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.index);g.drawElements(g.TRIANGLES,b.indices.length,g.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._handleCulling=function(a){var b=this.gl;b.disable(b.CULL_FACE);if(a.cull!=vxl.def.actor.cull.NONE){b.enable(b.CULL_FACE);switch(a.cull){case vxl.def.actor.cull.BACK:b.cullFace(b.BACK);break;case vxl.def.actor.cull.FRONT:b.cullFace(b.FRONT);break}}};vxlRenderEngine.prototype.enableOffscreen=function(){this._offscreen=true;this._target=new vxlRenderTarget(this)};vxlRenderEngine.prototype.disableOffscreen=function(){this._offscreen=false;
delete this._target;this._target=undefined};vxlRenderEngine.prototype.isOffscreenEnabled=function(){return(this._target!=undefined)};vxlRenderEngine.prototype.readOffscreenPixel=function(a,c){var b=this._target.readPixel(a,c);value=Array.apply([],b);value.constructor===Array;return value};function vxlBakeEngine(a){this.renderer=a;var b=a.gl;this._calls={};this._gl_buffers={index:b.createBuffer(),baked:b.createBuffer(),position:b.createBuffer(),scale:b.createBuffer(),shading:b.createBuffer()};this._data={index:[],baked:[],position:[],scale:[],shading:[]};this._allocated=[];this._offsets={position:{},scale:{},shading:{},baked:{}};this.glsl=vxl.util.extend(vxl.def.essl,{POSITION:"aPosition",SCALE:"aScale",SHADING:"aShading"})}vxlBakeEngine.prototype._populate=function(f,e){var b=[];for(var d=0;
d<e;d+=1){if(f instanceof Array||f instanceof Float32Array){for(var c=0;c<f.length;c+=1){b.push(f[c])}}else{b.push(f)}}return b};vxlBakeEngine.prototype._computeRequiredCalls=function(f){var e=f._actors;var a=e.length;var b=0;var d=1;for(var c=0;c<a;c+=1){b+=e[c].model.indices.length;if(b>65000){b=0;d++}}return d};vxlBakeEngine.prototype._allocateActor=function(f){if(this._allocated.indexOf(f.UID)!=-1){return}var h=this._data;var d=this._offsets;var j=this.renderer.gl;var k=f.model;var a=k.vertices.length;
var e=[],l=[];if(f.material.diffuse){e=this._populate(f.material.diffuse,a/3)}else{e=this._populate([0.7,0.7,0.7],a/3)}if(k.normals){l=k.normals}else{l=this._populate(0,a)}d.baked[f.UID]=h.baked.length;for(var g=0;g<a;g+=3){h.baked.push(k.vertices[g]);h.baked.push(k.vertices[g+1]);h.baked.push(k.vertices[g+2]);h.baked.push(l[g]);h.baked.push(l[g+1]);h.baked.push(l[g+2]);h.baked.push(e[g]);h.baked.push(e[g+1]);h.baked.push(e[g+2])}d.position[f.UID]=h.position.length;d.scale[f.UID]=h.scale.length;d.shading[f.UID]=h.shading.length;
h.position=h.position.concat(this._populate(f._position,a/3));h.scale=h.scale.concat(this._populate(f._scale,a/3));h.shading=h.shading.concat(this._populate(f.material.opacity,a/3));var b=k.indices.slice(0);if(h.index.length>0){var m=h.index.max()+1;var c=k.indices.length;for(var g=0;g<c;g+=1){b[g]+=m}h.index=h.index.concat(b)}else{h.index=b}this._allocated.push(f.UID)};vxlBakeEngine.prototype._updateActorPosition=function(b){var c=this._data;var e=this._offsets.position[b.UID];if(e==undefined){return
}var d=b.model.vertices.length+e;for(var a=e;a<d;a+=3){c.position[a]=b._position[0];c.position[a+1]=b._position[1];c.position[a+2]=b._position[2]}};vxlBakeEngine.prototype._updateActorScale=function(b){var c=this._data;var e=this._offsets.scale[b.UID];if(e==undefined){return}var d=b.model.vertices.length+e;for(var a=e;a<d;a+=3){c.scale[a]=b._scale[0];c.scale[a+1]=b._scale[1];c.scale[a+2]=b._scale[2]}};vxlBakeEngine.prototype._updateActorColor=function(b){var c=this._data;var e=this._offsets.baked[b.UID];
if(e==undefined){return}var d=(b.model.vertices.length*3)+e;for(var a=e;a<d;a+=9){c.baked[a+6]=b.material.diffuse[0];c.baked[a+7]=b.material.diffuse[1];c.baked[a+8]=b.material.diffuse[2]}};vxlBakeEngine.prototype._updateActorShading=function(b){var c=this._data;var f=this._offsets.shading[b.UID];if(f==undefined){return}var d=(b.model.vertices.length/3)+f;var e=0;if(b.material.opacity){e=1}for(var a=f;a<d;a+=1){c.shading[a]=e}};vxlBakeEngine.prototype.deallocate=function(a){};vxlBakeEngine.prototype.allocate=function(h){if(this._computeRequiredCalls(h)>1){throw"Not renderable yet. Working on it. The number of indices exceeds the 65K limit"
}var a=h._actors;var c=a.length;var b=this.renderer;var l=this._gl_buffers;var f=this._data;var d=b.pm;var g=b.gl;var k=this.glsl;var j=g.STATIC_DRAW;for(var e=0;e<c;e+=1){this._allocateActor(a[e])}d.enableAttribute(k.VERTEX_ATTRIBUTE);d.enableAttribute(k.NORMAL_ATTRIBUTE);d.enableAttribute(k.COLOR_ATTRIBUTE);d.enableAttribute(k.POSITION);d.enableAttribute(k.SCALE);d.enableAttribute(k.SHADING);g.bindBuffer(g.ARRAY_BUFFER,l.baked);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.baked),j);d.setAttributePointer(k.VERTEX_ATTRIBUTE,3,g.FLOAT,false,36,0);
d.setAttributePointer(k.NORMAL_ATTRIBUTE,3,g.FLOAT,false,36,12);d.setAttributePointer(k.COLOR_ATTRIBUTE,3,g.FLOAT,false,36,24);g.bindBuffer(g.ARRAY_BUFFER,l.position);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.position),j);d.setAttributePointer(k.POSITION,3,g.FLOAT,false,12,0);g.bindBuffer(g.ARRAY_BUFFER,l.scale);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.scale),j);d.setAttributePointer(k.SCALE,3,g.FLOAT,false,12,0);g.bindBuffer(g.ARRAY_BUFFER,l.shading);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.shading),j);
d.setAttributePointer(k.SHADING,1,g.FLOAT,false,4,0);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,l.index);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(f.index),j)};vxlBakeEngine.prototype.render=function(h){var a=this.renderer;var c=a.transforms;var b=a.pm;var g=a.gl;var k=vxl.def.essl;var e=this._data;c.update();b.setUniform(k.PERSPECTIVE_MATRIX,c.pMatrix);b.setUniform(k.MODEL_VIEW_MATRIX,c.mvMatrix);b.setUniform(k.NORMAL_MATRIX,c.nMatrix);b.setUniform(k.MVP_MATRIX,c.mvpMatrix);for(var f=0,j=h._actors.length;
f<j;f+=1){var d=h._actors[f];this._updateActorPosition(d);this._updateActorScale(d);this._updateActorShading(d);this._updateActorColor(d)}g.drawElements(g.TRIANGLES,e.index.length,g.UNSIGNED_SHORT,0);g.bindBuffer(g.ARRAY_BUFFER,null);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)};function vxlScene(){this.views=[];this._actors=[];this._groups=[];this.toys=new vxlSceneToys(this);this.loadingMode=vxl.def.model.loadingMode.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.scalarMIN=Number.MAX_VALUE;this.scalarMAX=Number.MIN_VALUE;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];this.frameAnimation=null;this.UID=vxl.util.generateUID();if(vxl.c.scene==null){vxl.c.scene=this}vxl.go.scenes.push(this);var b=vxl.go.notifier;var a=vxl.events;b.publish([a.SCENE_NEW,a.SCENE_UPDATED],this);
b.subscribe([a.MODELS_LOADED,a.DEFAULT_LUT_LOADED],this);b.fire(a.SCENE_NEW,this)}vxlScene.prototype.handleEvent=function(a,b){if(a==vxl.events.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}else{if(a==vxl.events.DEFAULT_LUT_LOADED){this.lutID="default";this.setLookupTable(this.lutID)}}};vxlScene.prototype.setLoadingMode=function(b){var a=vxl.def.model.loadingMode;if(b==undefined||b==null||(b!=a.LIVE&&b!=a.LATER&&b!=a.DETACHED)){throw ("the mode "+b+"is not a valid loading mode")
}this.loadingMode=b};vxlScene.prototype._updateBoundingBoxWith=function(c){var a=c._bb;vxl.go.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");if(this._actors.length==1){this.bb=this._actors[0]._bb.slice(0);this.toys.update();return}var d=this.bb;var e=this.centre;d[0]=Math.min(d[0],a[0]);d[1]=Math.min(d[1],a[1]);d[2]=Math.min(d[2],a[2]);d[3]=Math.max(d[3],a[3]);d[4]=Math.max(d[4],a[4]);d[5]=Math.max(d[5],a[5]);e[0]=(d[3]+d[0])/2;e[1]=(d[4]+d[1])/2;
e[2]=(d[5]+d[2])/2;e[0]=Math.round(e[0]*1000)/1000;e[1]=Math.round(e[1]*1000)/1000;e[2]=Math.round(e[2]*1000)/1000;this.toys.update()};vxlScene.prototype.computeBoundingBox=function(){if(this._actors.length>0){this.bb=this._actors[0]._bb.slice(0)}else{this.bb=[0,0,0,0,0,0]}this.centre=[0,0,0];var a=this._actors.length;while(a--){this._updateBoundingBoxWith(this._actors[a])}};vxlScene.prototype.createActor=function(a){var b=new vxlActor(a);this.addActor(b);return b};vxlScene.prototype.createActors=function(b){var a=b.length;
while(a--){this.createActor(b[a])}};vxlScene.prototype.addActor=function(a){a.setScene(this);if(this.normalsFlipped){a.flipNormals(true)}if(this.lutID!=null){a.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this._actors.push(a);this._updateBoundingBoxWith(a);vxl.go.console("Scene: Actor for model "+a.model.name+" added");if(this._actors.length==1){vxl.c.actor=a}else{vxl.c.actor=undefined}vxl.go.notifier.fire(vxl.events.SCENE_UPDATED,this)};vxlScene.prototype.updateActor=function(b){if(!this.hasActor(b)){return
}b.dirty=true;var a=this.views.length;while(a--){this.views[a].renderer.reallocate()}b.dirty=false};vxlScene.prototype.removeActor=function(b){var a=this._actors.indexOf(b);this._actors.splice(a,1);this.computeBoundingBox()};vxlScene.prototype.hasActor=function(b){if(b instanceof vxlActor){return(this._actors.indexOf(b)!=-1)}else{if(typeof(b)=="string"){var a=this.getActorByName(b);return(a!=undefined)}else{return false}}};vxlScene.prototype.setPropertyForAll=function(c,b){var a=this._actors.length;
while(a--){this._actors[a].setProperty(c,b)}};vxlScene.prototype.setPropertyFor=function(e,d,c){var a=e.length;while(a--){if(this.hasActor(e[a])){var b=undefined;if(typeof(e[a])=="string"){b=this.getActorByName(e[a])}else{if(e[a] instanceof vxlActor){e[a].setProperty(d,c)}else{throw"vxlScene.setPropertyFor: ERROR, the list of actors is invalid"}}}}};vxlScene.prototype.updateScalarRange=function(){var a=this._actors.length;while(a--){var b=this._actors[a];if(b.model.scalars&&b.model.scalars.max()>this.scalarMAX){this.scalarMAX=b.model.scalars.max()
}if(b.model.scalars&&b.model.scalars.min()<this.scalarMIN){this.scalarMIN=b.model.scalars.min()}}};vxlScene.prototype.setLookupTable=function(b){this.lutID=b;var a=this._actors.length;while(a--){this._actors[a].setLookupTable(b,this.scalarMIN,this.scalarMAX)}};vxlScene.prototype.reset=function(){var a=this._actors.length;while(a--){this._actors[a]=null}this._actors=[];vxl.c.actor=null;this.computeBoundingBox()};vxlScene.prototype.getActorByName=function(a){a=a.replace(/\.[^/.]+$/,"");var b=this._actors.length;
while(b--){if(this._actors[b].name==a){return this._actors[b]}}return null};vxlScene.prototype.getActorByUID=function(a){var b=this._actors.length;while(b--){if(this._actors[b].UID==a){return this._actors[b]}}return null};vxlScene.prototype.getActor=function(b){var a=this.getActorByName(b);if(a==null){a=this.getActorByUID(b)}return a};vxlScene.prototype.getActorsThat=function(e){var a=[];var d=this._actors.length;while(d--){if(e(this._actors[d])){a.push(d)}}var c=[];var b=a.length;while(b--){c.push(this._actors[a[b]])
}return c};vxlScene.prototype.setOpacity=function(d,a){if(a==null){var b=this._actors.length;while(b--){this._actors[b].setOpacity(d)}}else{var c=this.getActorByName(a);c.setOpacity(d)}};vxlScene.prototype.flipNormals=function(){var a=this._actors.length;while(a--){this._actors[a].flipNormals()}};vxlScene.prototype.setVisualizationMode=function(b){if(b==null||b==undefined){return}var a=this._actors.length;while(a--){this._actors[a].setVisualizationMode(b)}};vxlScene.prototype.setAnimation=function(b){if(b instanceof vxlFrameAnimation){this.frameAnimation=b;
this.frameAnimation.scene=this;var a=this.views.length;while(a--){this.views[a].renderer.setMode(vxl.def.renderer.mode.ANIMFRAME)}vxl.go.console("Scene: animation added")}};vxlScene.prototype.clearAnimation=function(){if(this.frameAnimation){this.frameAnimation.scene=null;this.frameAnimation=null}};vxlScene.prototype.getActorNames=function(){var b=[];var a=this._actors.length;while(a--){b.push(this._actors[a].name)}return b};vxlScene.prototype.getPickableActors=function(){function a(b){return b.isPickable()
}return this.getActorsThat(a)};vxlScene.prototype.getActorByCellUID=function(a){var d=[];var b=this._actors.length;while(b--){var c=this._actors[b];if(c.mesh!=undefined&&c.mesh.hasCell(a)){return c}}return null};vxlScene.prototype.createActorGroup=function(a,c){var d=undefined;if(this.getActorGroup(a)!=null){alert("vxlScene.createActorGroup: an actor group with the name "+a+" already exists");throw ("vxlScene.createActorGroup: an actor group with the name "+a+" already exists")}try{d=new vxlActorGroup(this,a,c);
this._groups.push(d)}catch(b){if(b instanceof vxlActorGroupException){alert(b.messages)}}finally{return d}};vxlScene.prototype.getActorGroup=function(a){var b=this._groups.length;while(b--){if(this._groups[b].name==a){return this._groups[b]}}return null};function vxlSceneToys(a){this.scene=a;this.list=[];this.axis=new vxlAxis();this.boundingbox=new vxlBoundingBox();this.floor=new vxlFloor();this.list.push(this.axis);this.list.push(this.boundingbox);this.list.push(this.floor)}vxlSceneToys.prototype.update=function(){this.axis.setCentre(this.scene.centre);this.boundingbox.setBoundingBox(this.scene.bb)};function vxlLookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE}vxlLookupTable.prototype.load=function(a,c){this.ID=a;this.map=c;for(var b in this.map){var d=Number(b);if(d<this.min){this.min=d}else{if(d>=this.max){this.max=d}}}};vxlLookupTable.prototype._scale=function(c,b,a){return c*this.max/a};vxlLookupTable.prototype.getColor=function(g,e,a){var f=this._scale(g,e,a);var b=this;var d=Math.round(f);if(d>=b.min&&d<=b.max){var h=[b.map[d][0],b.map[d][1],b.map[d][2]];
return h}else{if(d<b.min){return[b.map[b.min][0],b.map[b.min][1],b.map[b.min][2]]}else{if(d>b.max){return[b.map[b.max][0],b.map[b.max][1],b.map[b.max][2]]}else{alert("assertion error in getColor routine");return[b.map[b.min][0],b.map[b.min][1],b.map[b.min][2]]}}}};vxlLookupTable.prototype.getColors=function(e,d,a){var g=[];for(var b=0;b<e.length;b++){var f=this.getColor(e[b],d,a);g.push(f[0]);g.push(f[1]);g.push(f[2])}return g};function vxlLookupTableManager(){this._hashmap={};this._location="";vxl.go.notifier.publish(vxl.events.DEFAULT_LUT_LOADED,this)}vxlLookupTableManager.prototype.setLocation=function(a){this._location=a};vxlLookupTableManager.prototype.load=function(c){if(this.isLoaded(c)){return}var d=this;var f=this._location+"/"+c+".lut";var g=f+"?nocache="+(new Date()).getTime();var b=function(i,h){return function(j,k){i._handle(h,j)}};var a=function(h){return function(k,i,j){if(j.code=1012){alert("The file "+h+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")
}else{alert("There was a problem loading the file "+h+". HTTP error code:"+k.status)}}};var e=$.ajax({url:g,type:"GET",dataType:"json",success:b(d,c),error:a(f)})};vxlLookupTableManager.prototype._handle=function(a,c){var b=new vxlLookupTable();b.load(a,c);this._hashmap[a]=b;if(b.ID==vxl.def.lut.main){vxl.go.notifier.fire(vxl.events.DEFAULT_LUT_LOADED,this)}};vxlLookupTableManager.prototype.isLoaded=function(a){return this._hashmap[a]!=undefined};vxlLookupTableManager.prototype.get=function(a){return this._hashmap[a]
};vxlLookupTableManager.prototype.getAllLoaded=function(){var a=[];for(lut in this._hashmap){a.push(this._hashmap[lut].ID)}return a};vxlLookupTableManager.prototype.allLoaded=function(){var a=0;for(lut in this._hashmap){a++}return(vxl.def.lut.list.length==a)};vxlLookupTableManager.prototype.loadAll=function(){for(var a=0;a<vxl.def.lut.list.length;a++){this.load(vxl.def.lut.list[a])}};vxl.go.lookupTableManager=new vxlLookupTableManager();vxl.def.model.boundingBox=new vxlModel();vxl.def.model.boundingBox.load("bounding box",{vertices:[],wireframe:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],color:[1,1,1,1],shading:false});vxlBoundingBox.prototype=new vxlActor();vxlBoundingBox.prototype.constructor=vxlBoundingBox;function vxlBoundingBox(){vxlActor.call(this,vxl.def.model.boundingBox);this.bb=this.setBoundingBox([-1,-1,-1,1,1,1]);this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true}vxlBoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];
this.model.vertices=this.bb;this.reallocate()};vxl.def.model.axis=new vxlModel();vxl.def.model.axis.load("axis",{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],wireframe:[0,1,2,3,4,5],colors:[1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],shading:false});vxlAxis.prototype=new vxlActor();vxlAxis.prototype.constructor=vxlAxis;function vxlAxis(){vxlActor.call(this,vxl.def.model.axis);this.centre=[0,0,0];this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true}vxlAxis.prototype.setCentre=function(c){var b=c[0];var e=c[1];var d=c[2];this.centre[0]=b;
this.centre[1]=e;this.centre[2]=d;var a=this.model.vertices;a[0]=b-1;a[1]=e;a[2]=d;a[3]=b+1;a[4]=e;a[5]=d;a[6]=b;a[7]=e-2;a[8]=d;a[9]=b;a[10]=e+2;a[11]=d;a[12]=b;a[13]=e;a[14]=d-1;a[15]=b;a[16]=e;a[17]=d+1};vxl.def.model.floor=new vxlModel();vxl.def.model.floor.load("floor",{vertices:[],indices:[],color:[0.6,0.6,0.6,1],shading:false});vxlFloor.prototype=new vxlActor();vxlFloor.prototype.constructor=vxlFloor;function vxlFloor(){vxlActor.call(this,vxl.def.model.floor);this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true}vxlFloor.prototype.setGrid=function(g,h){var f=g;var b=2*f/h;var e=2*f/b;var c=[];var d=[];for(var a=0;a<=b;a++){c[6*a]=-f;c[6*a+1]=0;c[6*a+2]=-f+(a*e);c[6*a+3]=f;c[6*a+4]=0;
c[6*a+5]=-f+(a*e);c[6*(b+1)+6*a]=-f+(a*e);c[6*(b+1)+6*a+1]=0;c[6*(b+1)+6*a+2]=-f;c[6*(b+1)+6*a+3]=-f+(a*e);c[6*(b+1)+6*a+4]=0;c[6*(b+1)+6*a+5]=f;d[2*a]=2*a;d[2*a+1]=2*a+1;d[2*(b+1)+2*a]=2*(b+1)+2*a;d[2*(b+1)+2*a+1]=2*(b+1)+2*a+1}this.model.vertices=c.slice(0);this.model.wireframe=d.slice(0);this.visible=true;this.reallocate()};function vxlView(d,c,f){this.canvas=document.getElementById(d);if(this.canvas==null){alert("View: the canvas "+d+" does not exist.");throw ("View: the canvas "+d+" does not exist.")}this.name=d;this.width=this.canvas.width;this.height=this.canvas.height;this.clearDepth=1;this.backgroundColor=vxl.def.view.background.slice(0);this.dragndrop=false;this.renderer=new vxlRenderer(this);this.setBackgroundColor(this.backgroundColor);this.setClearDepth(this.clearDepth);this.cameraman=new vxlCameraManager(this);
this.interactor=new vxlTrackerInteractor();this.interactor.connectView(this);if(c!=null&&c instanceof vxlScene){this.scene=c}else{if(vxl.c.scene!=undefined){this.scene=vxl.c.scene}else{this.scene=new vxlScene()}}this.scene.views.push(this);if(vxl.c.view==undefined){vxl.c.view=this}vxl.go.views.push(this);if(f==undefined){f=true}this.setAutoResize(f);this._fullscreenFlag=true;this.UID=vxl.util.generateUID();var b=vxl.go.notifier;var a=vxl.events;b.publish(a.VIEW_NEW,this);b.subscribe(a.DEFAULT_LUT_LOADED,this);
b.fire(a.VIEW_NEW,this);vxl.go.console("View: the view "+this.name+" has been created")}vxlView.prototype.handleEvent=function(a,b){vxl.go.console("vxlView ["+this.name+"]: receiving event "+a);if(a==vxl.events.DEFAULT_LUT_LOADED){this.scene.setLookupTable(vxl.def.lut.main)}};vxlView.prototype.clear=function(){this.renderer.clear()};vxlView.prototype._wrapDiv=function(){$(this.canvas).css({position:"absolute",height:"auto",bottom:0,top:0,left:0,right:0,margin:"5px"});$(this.canvas).wrap("<div id="+this.name+"-wrapper />");
$("#"+this.name+"-wrapper").css({width:"100%",height:"100%"});this.canvas.focus()};vxlView.prototype.resize=function(){var a=this.canvas.parentNode;this.width=$(a).width()-5;this.height=$(a).height()-5;if(this.width>window.innerWidth-5){this.width=window.innerWidth-5}if(this.height>window.innerHeight-5){this.height=window.innerHeight-5}$(this.canvas).attr("width",this.width);$(this.canvas).attr("height",this.height)};vxlView.prototype.setAutoResize=function(a){if(a){this._wrapDiv();this.resize();
$(window).resize((function(b){return function(){b.resize()}})(this))}else{$(window).unbind("resize")}};vxlView.prototype._runPrefixMethod=function(d,f){var e=["webkit","moz","ms","o",""];var c=0,a,b;while(c<e.length&&!d[a]){a=f;if(e[c]==""){a=a.substr(0,1).toLowerCase()+a.substr(1)}a=e[c]+a;b=typeof d[a];if(b!="undefined"){e=[e[c]];return(b=="function"?d[a]():d[a])}c++}};vxlView.prototype.fullscreen=function(a){if(!this._fullscreenFlag){return}if(a==true){this._runPrefixMethod(this.canvas,"RequestFullScreen")
}else{if(this._runPrefixMethod(document,"FullScreen")||this._runPrefixMethod(document,"isFullScreen")){this._runPrefixMethod(document,"CancelFullScreen")}}};vxlView.prototype.disableFullScreen=function(){this._fullscreenFlag=false};vxlView.prototype.enableFullScreen=function(){this._fullscreenFlag=true};vxlView.prototype.start=function(){this.renderer.start();this.refresh()};vxlView.prototype.stop=function(){this.renderer.stop()};vxlView.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();
this.start()};vxlView.prototype.setBackgroundColor=function(d,c,a){this.backgroundColor=vxl.util.createColor(d,c,a);this.renderer.clearColor(this.backgroundColor)};vxlView.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};vxlView.prototype.refresh=function(){this.renderer.render()};vxlView.prototype.setInteractor=function(a){this.interactor=a;this.interactor.connectView(this)};vxlView.prototype.setDragAndDrop=function(a){this.dragndrop=a};vxlView.prototype.getFPS=function(){return this.renderer.fps
};function vxlModelManager(){this.toLoad=[];this.models=[];var a=vxl.events;vxl.go.notifier.publish([a.MODELS_LOADING,a.MODEL_NEW,a.MODELS_LOADED],this);vxl.go.notifier.subscribe(a.READER_DONE,this)}vxlModelManager.prototype.handleEvent=function(c,d){var a=d;var e=a.getParts();for(var b=0;b<e.length;b+=1){this.add(e[b],e[b].name,a.scene)}};vxlModelManager.prototype.load=function(b,f){var d=this;var a=b.replace(/^.*[\\\/]/,"");var c=a.split(".")[0];var i=a.split(".")[1];var j="json";if(d.isModelLoaded(c)){return
}if(i=="vtk"){j="text"}else{if(i=="json"){j="json"}else{alert("vxlManager.load ERROR: Unknown filetype ["+i+"]");throw ("vxlManager.load ERROR: Unknown filetype ["+i+"]")}}nocacheuri=b+"?nocache="+(new Date()).getTime();vxl.go.console("ModelManager.load: Requesting "+b+"...");vxl.go.notifier.fire(vxl.events.MODELS_LOADING,this);var h=function(l,k,m){switch(i){case"json":return function(n,o){n.uri=a;n.path=vxl.util.getPath(b);l.add(n,k,m)};break;case"vtk":return function(n){reader=new vxlVTKReader(m);
reader.parseText(k,n)}}};var g=function(k){return function(n,l,m){if(m.code=1012){alert("The file "+k+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+k+". HTTP error code:"+n.status)}}};var e=$.ajax({url:nocacheuri,type:"GET",dataType:j,success:h(d,c,f),error:g(b)})};vxlModelManager.prototype.loadList=function(b,c){this.toLoad=b.slice(0);vxl.go.console("ModelManager.loadList: models to load ->"+this.toLoad.length);
for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],c)}};vxlModelManager.prototype.add=function(c,b,e){var a=this;function d(){var f=new vxlModel(b,c);f.loaded=true;a.models.push(f);a.toLoad.splice(b,1);vxl.go.console("ModelManager: model "+f.name+" created.");if(e!=undefined&&e instanceof vxlScene){vxl.go.console("ModelManager: notifying the scene...");if(e.loadingMode==vxl.def.model.loadingMode.LIVE){e.createActor(f)}else{if(e.loadingMode==vxl.def.model.loadingMode.LATER){if(a.allLoaded()){e.createActors(a.models)
}}else{if(e.loadingMode==vxl.def.model.loadingMode.DETACHED){}}}}if(a.allLoaded()){vxl.go.notifier.fire(vxl.events.MODELS_LOADED,a)}else{vxl.go.notifier.fire(vxl.events.MODEL_NEW,a)}}setTimeout(function(){d()},0)};vxlModelManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.models.length;a++){this.models[a]=null}this.models=[];this.toLoad=[]};vxlModelManager.prototype.isModelLoaded=function(a){for(var b=0;b<this.models.length;b++){if(this.models[b].name==a){return true
}}return false};vxlModelManager.prototype.allLoaded=function(){return(this.toLoad.length==0)};vxlModelManager.prototype.getModelByName=function(b){for(var c=0,a=this.models.length;c<a;c+=1){if(this.models[c].name==b){return this.models[c]}}return null};vxl.go.modelManager=new vxlModelManager();vxl.api={setup:function(a,b,c){if(b!=null&&!(b instanceof vxlScene)){throw ("api.setup: scene parameter is invalid")}return new vxlView(a,b,c)},setRenderRate:function(a){vxl.c.view.renderer.setRenderRate(a)},setRenderMode:function(b,a){if(a==undefined&&vxl.c.view==undefined){throw ("api.setRnederMode: you need to define a view")}else{if(a!=undefined&&a instanceof vxlView){a.renderer.setMode(b)}else{vxl.c.view.renderer.setMode(b)}}},setFieldOfView:function(a){if(a>0&&a<=360){vxl.c.camera.setFieldOfView(a)
}else{throw ("api.setFieldOfView: the field of view should be between 0 and 360 degrees")}},setCurrentView:function(b){if(b instanceof vxlView){vxl.c.view=b}},getCurrentView:function(){return vxl.c.view},setCurrentActor:function(a){if(a instanceof vxlActor){vxl.c.actor=a}else{if(typeof a=="string"){if(vxl.c.scene==undefined){throw ("vxl.api.setCurrentActor: there is no Current scene. Please call vxl.api.setCurrentScene")}var b=vxl.c.scene.getActorByName(a);if(b!=undefined){vxl.c.actor=b}else{throw ("vxl.api.setCurrentActor: the actor "+a+" does not exist in the current scene")
}}else{vxl.c.actor=a}}},getCurrentActor:function(){return vxl.c.actor},setCurrentCamera:function(b){if(b instanceof vxlCamera){vxl.c.camera=b}},getCurrentCamera:function(){return vxl.c.camera},setLookupTable:function(a){if(!vxl.go.lookupTableManager.isLoaded(a)){vxl.go.console("Lookup Table "+a+" has not been loaded");return}vxl.c.view.scene.setLookupTable(a)},loadLUTS:function(a){vxl.go.lookupTableManager.setLocation(a);vxl.go.lookupTableManager.loadAll()},resetScene:function(){if(vxl.c.animation){vxl.c.animation.stop()
}vxl.c.view.reset();vxl.go.modelManager.reset()},load:function(b,e,f,d){var d=d==null?vxl.c.scene:d;var g=[];var c=vxl.util.getPath(e);if(typeof(b)=="string"||b instanceof String){g.push(c+b)}else{if(b instanceof Array){for(var a=0;a<b.length;a++){g.push(c+b[a])}}}if(f!=undefined&&f!=null){d.setLoadingMode(f)}vxl.go.modelManager.loadList(g,d)},loadSequence:function(h,b,d,j,g,f){var f=f==null?vxl.c.scene:f;var a=[];var c=vxl.util.getPath(j);for(var e=b;e<=d;e+=1){a.push(c+h+e+".json")}if(g!=undefined&&g!=null){f.setLoadingMode(g)
}vxl.go.modelManager.loadList(a,f)},axisON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisON: There is no current scene")}vxl.c.scene.toys.axis.setVisible(true);vxl.c.camera.refresh()},axisOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisOFF: There is no current scene")}vxl.c.scene.toys.axis.setVisible(false);vxl.c.camera.refresh()},boundingBoxON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxON: There is no current scene")}vxl.c.scene.toys.boundingbox.setVisible(true);
vxl.c.camera.refresh()},boundingBoxOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxOFF: There is no current scene")}vxl.c.scene.toys.boundingbox.setVisible(false);vxl.c.camera.refresh()},floorON:function(a,b){if(vxl.c.scene==undefined){throw ("vxl.api.floorON: There is no current scene")}if(a==undefined||b==undefined){vxl.c.scene.toys.floor.setVisible(true)}else{vxl.c.scene.toys.floor.setGrid(a,b)}vxl.c.camera.refresh()},floorOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.floorOFF: There is no current scene")
}vxl.c.scene.toys.floor.setVisible(false);vxl.c.camera.refresh()},setBackgroundColor:function(d,c,a){vxl.c.view.setBackgroundColor(d,c,a)},wireframeON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)}else{vxl.c.scene.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)}vxl.go.console("API:Wireframe is shown.")},surfaceON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.SOLID)
}vxl.go.console("API:Wireframe is hidden.")},pointsON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.POINTS)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.POINTS)}},solidWireframeON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.WIRED_AND_SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.WIRED_AND_SOLID)}vxl.go.console("API:Wireframe is hidden.")},getActorNames:function(b){var a=b;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorNames: There is no current scene")
}else{a=vxl.c.scene}}return a.getActorNames()},createActorGroup:function(a,b){return vxl.c.scene.createActorGroup(a,b)},getActor:function(c,b){var a=this.getActorByName(c,b);if(a==null){a=this.getActorByUID(c,b)}return a},getActorByUID:function(b,c){var a=c;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByUID: There is no current scene. Please the scene you want to look the actor with uid: "+UID+" into")}else{a=vxl.c.scene}}return a.getActorByUID(b)},getActorByName:function(c,b){var a=b;
if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByName: There is no current scene. Please the scene you want to look the actor "+c+" into")}else{a=vxl.c.scene}}return a.getActorByName(c)},setActorOpacity:function(b){var a=Math.min(Math.max(0,Math.abs(b)),1);if(vxl.c.actor){vxl.c.actor.setOpacity(b)}else{vxl.c.view.scene.setOpacity(a)}vxl.c.view.refresh();vxl.go.console("API:Opacity changed to "+(b*100)+"%")},setActorProperty:function(b,d,c){if(vxl.c.scene==undefined){throw ("vxl.api.setActorProperty: there is no current scene. Please call vxl.api.setCurrentScene")
}var e=vxl.c.scene;var a=b;if(a instanceof vxlActor){a.setProperty(d,c)}else{a=e.getActorByName(a);if(a==undefined){throw"The actor "+a+" does not belong to the current scene"}a.setProperty(d,c)}},setPropertyForAll:function(c,b,d){var a=undefined;if(vxl.c.scene==undefined&&d==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(d==undefined){a=vxl.c.scene}else{a=d}a.setPropertyForAll(c,b)},setPropertyFor:function(d,c,b,e){var a=undefined;
if(vxl.c.scene==undefined&&e==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(e==undefined){a=vxl.c.scene}else{a=e}a.setPropertyFor(d,c,b)},getActorsThat:function(c,b){var a=undefined;if(vxl.c.scene==undefined&&b==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(b==undefined){a=vxl.c.scene}else{a=b}return a.getActorsThat(c)},flipActorNormals:function(){if(vxl.c.actor){vxl.c.actor.flipNormals()
}else{vxl.c.view.scene.flipNormals()}vxl.c.view.refresh()},stopAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.stop()}},startAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.start()}},setFrame:function(c){if(vxl.c.animation==null){return}var b=vxl.c.animation;b.stop();if(c>=1){b.setFrame(c)}else{vxl.go.console("API:frame "+c+" does not exist. Animation goes back to the beginning");b.setFrame(1)}},clearAnimation:function(){if(vxl.c.animation){vxl.c.animation.stop();vxl.c.animation=null
}},resetCamera:function(){vxl.c.camera.reset()},saveCamera:function(){vxl.c.camera.save()},retrieveCamera:function(){vxl.c.camera.retrieve()},setAzimuth:function(b){vxl.c.camera.setAzimuth(b)},setElevation:function(a){vxl.c.camera.setElevation(a)},getLookupTables:function(){return vxl.go.lookupTableManager.getAllLoaded()},setProgram:function(a,b){a.renderer.engine.pm.setProgram(b)},releaseProgram:function(a){a.renderer.engine.pm.releaseProgram()},getProgram:function(a){if(a==undefined){a=vxl.c.view
}if(a==undefined){throw ("vxl.api.getProgram: please indicate a view")}return a.renderer.engine.pm._current_program_ID},setUniformDefault:function(a,c,b){vxl.c.view.renderer.engine.pm.setDefault(a,c,b)},setUniform:function(b,a){vxl.c.view.renderer.engine.pm.setUniform(b,a)},getUniformDefault:function(a,b){vxl.c.view.renderer.engine.pm.getDefault(a,b)},getUniformList:function(){return vxl.c.view.renderer.pm._uniformList[vxl.c.view.renderer.pm._currentProgramID].slice(0)},getUniform:function(a){return vxl.c.view.renderer.pm.getUniform(a)
},subscribe:function(b,a){vxl.go.notifier.subscribe(b,a)}};function vxlFrameAnimation(a){this.scene=null;this.actorByFrameMap=[];this.activeFrame=1;this.mark=1;this._running=false;this.frameCount=0;this.renderRate=500;this._startDate=undefined;this._time=0;this._setup(a);if(vxl.c.animation==null){vxl.c.animation=this}}vxlFrameAnimation.prototype.addActorToFrame=function(b,a){if(typeof(this.actorByFrameMap[b])=="undefined"){this.actorByFrameMap[b]=new Array()}if(this.actorByFrameMap[b].indexOf(a)==-1){this.actorByFrameMap[b].push(a)}if(b>this.frameCount){this.frameCount=b
}};vxlFrameAnimation.prototype._setup=function(e){this.activeFrame=1;for(var d in e){var b=e[d];var g=parseInt(d.substr(5,d.length));for(var c=0,a=b.length;c<a;c+=1){this.addActorToFrame(g,b[c])}}vxl.go.console("FrameAnimation: Setup finished.")};vxlFrameAnimation.prototype.start=function(a){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this._startDate=new Date().getTime();this._time=0;this._running=true;if(a!=undefined&&a>=0){this.renderRate=a
}this._timeUp()};vxlFrameAnimation.prototype._timeUp=function(){if(!this._running){return}this.nextFrame();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(b){return function(){b._timeUp()}})(this),this.renderRate-a)};vxlFrameAnimation.prototype.stop=function(){this._running=false};vxlFrameAnimation.prototype.setFrameRate=function(a){if(a<=0){return
}this.stop();this.renderRate=a;this.start()};vxlFrameAnimation.prototype.update=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this.scene.setPropertyForAll("visible",false);var c=this.actorByFrameMap[this.activeFrame];var a=c.length;for(var b=0;b<a;b++){var d=this.scene.getActorByName(c[b]);if(d!=null){d.setVisible(true)}}};vxlFrameAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)
};vxlFrameAnimation.prototype.nextFrame=function(){if(this.activeFrame<this.frameCount){this.activeFrame++}else{this.activeFrame=1}};vxlFrameAnimation.prototype.getNextFrames=function(f){var d=[];var e=this.activeFrame;if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e+a;if(this.isValidFrame(b)){d.push(b)}else{d.push(b-this.frameCount)}}vxl.go.console("Animation: next frames: "+d);return d};vxlFrameAnimation.prototype.getPreviousFrames=function(f){var d=[];var e=this.activeFrame;
if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e-a;if(this.isValidFrame(b)){d.push(b)}else{d.push(this.frameCount+b)}}vxl.go.console("Animation: previous frames: "+d);return d};vxlFrameAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){this.activeFrame=a;this.render()}};function vxlVTKReader(a){this.scene=a;this.ARRAY_SIZE=65536*3;this.vertices=[];this.indices=[];this.normals=[];this.scalars=[];this.colors=[];this.mode="SOLID";this.tags={NOWHERE:0,POINTS:1,LINES:2,POLYGONS:3,POINT_DATA:4,NORMALS:5,CELL_DATA:6,TEXTURE_COORDINATES:7,SCALARS:8,LOOKUP_TABLE:9,COLOR_SCALARS:10};this.parts=[];vxl.go.notifier.publish(vxl.events.READER_DONE,this)}vxlVTKReader.prototype.isSupported=function(){return(window.File&&window.FileReader&&window.FileList&&window.Blob)};vxlVTKReader.prototype.read=function(d){var b=this;
var c=d.name;if(c.length-4!==c.indexOf(".vtk")){throw"vxlVTKReader.read: the file "+d+" is not a VTK file"}modelname=c.replace(/\.[^/.]+$/,"");var a=new FileReader();a.onload=function(g){document.body.style.cursor="default";var f=g.target.result.trim();var e=f.split(/\r\n|\r|\n/);b._parse(e);b._processIndexBlocks(modelname);vxl.go.notifier.fire(vxl.events.READER_DONE,b)};document.body.style.cursor="wait";a.readAsText(d)};vxlVTKReader.prototype.parseText=function(b,c){document.body.style.cursor="wait";
var a=c.split(/\r\n|\r|\n/);this._parse(a);this._processIndexBlocks(b);vxl.go.notifier.fire(vxl.events.READER_DONE,this);document.body.style.cursor="default"};vxlVTKReader.prototype._parse=function(a){this.outputfile="";this.numBlocks=0;this.location="NOWHERE";var d=0;for(var d=0;d<a.length;d++){try{if(a[d].indexOf("POINTS")==0){console.log(a[d]);this.location=this.tags.POINTS;continue}else{if(a[d].indexOf("LINES")==0){console.log(a[d]);this.location=this.tags.LINES;this.mode="LINES";continue}else{if(a[d].indexOf("POLYGONS")==0){console.log(a[d]);
this.location=this.tags.POLYGONS;continue}else{if(a[d].indexOf("POINT_DATA")==0){this.location=this.tags.POINT_DATA;continue}else{if(a[d].indexOf("NORMALS")==0){console.log(a[d]);this.location=this.tags.NORMALS;continue}else{if(a[d].indexOf("CELL_DATA")==0){console.log(a[d]);this.location=this.tags.CELL_DATA;continue}else{if(a[d].indexOf("TEXTURE_COORDINATES")==0){console.log(a[d]);this.location=this.tags.TEXTURE_COORDINATES;continue}else{if(a[d].indexOf("SCALARS")==0){console.log(a[d]);this.location=this.tags.SCALARS;
continue}else{if(a[d].indexOf("LOOKUP_TABLE")==0){console.log(a[d]);this.location=this.tags.LOOKUP_TABLE;continue}else{if(a[d].indexOf("COLOR_SCALARS")==0){console.log(a[d]);this.location=this.tags.COLOR_SCALARS;continue}else{if(this.location==this.tags.POINTS){var c=a[d].trim().split(" ");if(c==""){continue}for(var e=0;e<c.length;e++){this.vertices.push(parseFloat(c[e]))}}else{if(this.location==this.tags.LINES){var f=a[d].trim().split(" ");if(f==""){continue}if(f.length>0&&f[0]=="2"){this.indices.push(parseInt(f[1]));
this.indices.push(parseInt(f[2]))}}else{if(this.location==this.tags.POLYGONS){var f=a[d].trim().split(" ");if(f==""){continue}if(f.length>0&&f[0]!="3"){throw"Not triangles here"}for(var e=1;e<f.length;e++){this.indices.push(parseInt(f[e]))}}else{if(this.location==this.tags.LOOKUP_TABLE){if(a[d].indexOf("LOOKUP_TABLE")==0){continue}else{var b=a[d].trim().split(" ");if(b==""){continue}for(var e=0;e<b.length;e++){this.scalars.push(parseFloat(b[e]))}}}else{if(this.location==this.tags.COLOR_SCALARS){var h=a[d].trim().split(" ");
if(h==""){continue}for(var e=0;e<h.length;e++){this.colors.push(parseFloat(h[e]))}}else{if(this.location==this.tags.NORMALS){var h=a[d].trim().split(" ");if(h==""){continue}for(var e=0;e<h.length;e++){this.normals.push(parseFloat(h[e]))}}}}}}}}}}}}}}}}}}catch(g){console.log("Error while processing line "+d.toString());throw g}}};vxlVTKReader.prototype._processIndexBlocks=function(b){this.numBlocks=0;var f=this.vertices.length/3;var c=this.normals.length/3;var e=this.indices.length;var a=e/3;var g=this.colors.length/3;
var h=this.scalars.length;console.log("vertices:\t"+f.toString()+"\nnormals:\t"+c.toString()+"\nindices:\t"+e.toString()+"\ntriangles:\t"+a.toString()+"\nscalars:\t"+h.toString()+"\ncolors:\t"+g.toString()+"\n");this.numBlocks=parseInt(e/this.ARRAY_SIZE);if(e%this.ARRAY_SIZE!=0){this.numBlocks=this.numBlocks+1}console.log("Number of Blocks: "+this.numBlocks.toString());for(var d=0;d<this.numBlocks;d++){this._processBlock(d,b)}};vxlVTKReader.prototype._processBlock=function(a,b){var e=(a+1).toString();
var c="";if(this.numBlocks==1){c=b}else{c=b+"_"+e}var d=this._weaveBlock(a);this._writeJSON(c,d);console.log("Block ["+e+"] processed,  output: "+c)};vxlVTKReader.prototype._weaveBlock=function(k){var m=this.ARRAY_SIZE*k;var f=this.ARRAY_SIZE*(k+1);if(f>this.indices.length){f=this.indices.length}var b={};var e={vertices:[],indices:[],scalars:[],colors:[]};var a=(this.scalars.length>0);var h=(this.colors.length>0);var d=this.indices.slice(m,f);taux=d.length;var c=-1;console.log("Weaving block #"+(k+1)+"  ["+m+","+f+"]");
for(var g=0;g<taux;g+=1){var l=d[g];if(b[l]==undefined){c++;e.indices.push(c);b[l]=c;var j=l*3;e.vertices.push(this.vertices[j]);e.vertices.push(this.vertices[j+1]);e.vertices.push(this.vertices[j+2]);if(a){e.scalars.push(this.scalars[l])}if(h){e.colors.push(this.colors[j]);e.colors.push(this.colors[j+1]);e.colors.push(this.colors[j+2])}}else{e.indices.push(b[l])}}delete d;return e};vxlVTKReader.prototype._writeJSON=function(c,b){var a=new Object();a.name=c;a.vertices=b.vertices.slice(0);a.indices=b.indices.slice(0);
if(b.scalars.length>0){a.scalars=b.scalars.slice(0)}if(b.colors.length>0){a.colors=b.colors.slice(0)}a.mode=this.mode;this.parts.push(a)};vxlVTKReader.prototype.getParts=function(){return this.parts};function vxlTexture(b){var a=this;this.image=new Image();this.image.onload=function(){a._onLoad()};this.image.onError=function(){a._onError()};this.uri=b;if(this.uri!=undefined){this.load(this.uri)}this.mag=vxl.def.texture.filter.LINEAR;this.min=vxl.def.texture.filter.LINEAR_MIPMAP_LINEAR;this.loaded=false}vxlTexture.prototype.setMagFilter=function(a){this.mag=a};vxlTexture.prototype.setMinFilter=function(a){this.min=a};vxlTexture.prototype.load=function(a){this.image.src=a};vxlTexture.prototype._onError=function(){console.info("vxlTexture: the texture "+this.uri+" could not be found.");
this.loaded=false};vxlTexture.prototype._onLoad=function(){this.loaded=true};vxlTexture.prototype.getMagFilter=function(b){var a=vxl.def.texture.filter;switch(this.mag){case a.LINEAR:return b.LINEAR;break;case a.NEAREST:return b.NEAREST;break;default:return b.NEAREST}};vxlTexture.prototype.getMinFilter=function(b){var a=vxl.def.texture.filter;switch(this.min){case a.LINEAR:return b.LINEAR;break;case a.NEAREST:return b.NEAREST;break;case a.LINEAR_MIPMAP_LINEAR:return b.LINEAR_MIPMAP_LINEAR;break;case a.LINEAR_MIPMAP_NEAREST:return b.LINEAR_MIPMAP_NEAREST;
break;case a.NEAREST_MIPMAP_LINEAR:return b.NEAREST_MIPMAP_LINEAR;break;case a.NEAREST_MIPMAP_NEAREST:return b.NEAREST_MIPMAP_NEAREST;break;default:return b.NEAREST}};function vxlMaterial(a){this.ambient=vxl.def.material.ambient;this.diffuse=vxl.def.material.diffuse;this.specular=vxl.def.material.specular;this.shininess=vxl.def.material.shininess;this.opacity=vxl.def.material.opacity;this.shading=vxl.def.material.shading;this.texture=undefined;this.colors=undefined;if(a){this.getFrom(a)}}vxlMaterial.prototype.getFrom=function(a){if(a.ambient!=undefined){this.ambient=a.ambient.slice(0)}if(a.diffuse!=undefined){this.diffuse=a.diffuse.slice(0)}if(a.specular!=undefined){this.specular=a.specular.slice(0)
}if(a.color!=undefined){this.diffuse=a.color.slice(0)}if(a.shininess!=undefined){this.shininess=a.shininess}if(a.opacity!=undefined){this.opacity=a.opacity}if(a.shading!=undefined){this.shading=a.shading}if(a.texture!=undefined){this.texture=new vxlTexture(a.path+a.texture)}if(a.colors!=undefined){this.colors=a.colors}};vxlMaterial.prototype.clone=function(){var c=new vxlMaterial();var a=this;for(var b in a){if(a.hasOwnProperty(b)){if(a[b] instanceof Array){c[b]=a[b].slice(0)}else{c[b]=a[b]}}}return c
};function vxlRenderable(a){if(a==undefined){throw ("vxlRenderable: the actor can not be undefined")}this.actor=a;this.parts=[];this.update(vxl.def.renderable.task.CREATE)}vxlRenderable.prototype.update=function(a){if(a==undefined){throw ("vxlRenderable.update: Please specify a task")}var b=this.actor.getRenderableModel();if(b==undefined){return}switch(b.type){case vxl.def.model.type.MESH:this._processMesh(b,a);break;case vxl.def.model.type.BIG_DATA:this._processBigData(b,a);break}};vxlRenderable.prototype._processMesh=function(h,c){var l=vxl.def.model.MAX_NUM_INDICES;
var j=Math.floor(h.indices.length/l),e=h.indices.length%l;if(c==vxl.def.renderable.task.CREATE){this.parts=[];for(var f=0;f<=j;f+=1){var b=new vxlModel(h.name+"-renderable-part-"+f);var k=f*l;var g=k+l;var a=f*l*3;var d=a+l*3;if(f==j){k=j*l;g=k+e;a=j*l*3;d=a+e*3;if(e==0){break}}b.indices=this._reindex(h.indices.slice(k,g));b.vertices=h.vertices.slice(a,d);if(h.normals&&h.normals.length>0){b.normals=h.normals.slice(a,d)}if(h.colors&&h.colors.length>0){b.colors=h.colors.slice(a,d)}if(h.pickingColors){b.pickingColors=h.pickingColors.slice(a,d)
}b.update();this.parts.push(b)}}else{if(c==vxl.def.renderable.task.UPDATE_COLORS){for(var f=0;f<=j;f+=1){var b=this.parts[f];var a=f*l*3;var d=a+l*3;if(f==j){a=j*l*3;d=a+e*3;if(e==0){break}}if(h.colors&&h.colors.length>0){b.colors=h.colors.slice(a,d)}}}}};vxlRenderable.prototype._reindex=function(c){var b=c.min();var a=c.length;while(a--){c[a]=c[a]-b}return c};vxlRenderable.prototype._processBigData=function(h,p){var o=h.indices;var r=vxl.def.model.MAX_NUM_INDICES;var l=Math.floor(h.indices.length/r);
var f=h.indices.length%r;var m=this.actor.material;for(var g=0;g<=l;g+=1){var b=new vxlModel(h.name+"-renderable-part-"+g);var n=[],j=[],c=[],a=0;if(g==l){if(f>0){c=o.slice(g*r,g*r+f)}else{break}}else{c=o.slice(g*r,(g+1)*r)}if(m.colors&&m.colors.length>0){b.colors=[]}if(h.normals&&h.normals.length>0){b.normals=[]}if(h.scalars&&h.scalars.length>0){b.scalars=[]}for(var d=0,q=c.length;d<q;d+=1){var e=c[d];if(n[e]==undefined){n[e]=a;vertexInfo=this._getBigDataVertexInfo(e);b.vertices.push.apply(b.vertices,vertexInfo.coords);
if(h.normals&&h.normals.length>0){b.normals.push.apply(b.normals,vertexInfo.normal)}if(m.colors&&m.colors.length>0){b.colors.push.apply(b.colors,vertexInfo.color)}if(h.scalars&&h.scalars.length>0){b.scalars.push(vertexInfo.scalar)}a+=1}b.indices.push(n[e])}b.update();this.parts.push(b)}};vxlRenderable.prototype._getBigDataVertexInfo=function(b){var d=this.actor.material;var a=this.actor.model;var c={};c.coords=a.vertices.slice(b*3,b*3+3);if(a.normals){c.normal=a.normals.slice(b*3,b*3+3)}if(d.colors){c.color=d.colors.slice(b*3,b*3+3)
}if(a.scalars){c.scalar=a.scalars[b]}return c};function vxlActorGroup(c,a,b){this.scene=c;this.name=a;this.list=[];this.addList(b)}vxlActorGroup.prototype.addList=function(e){var d=[];for(var b=0,f=e.length;b<f;b+=1){var c=e[b];if(c instanceof vxlActor&&c.scene==this.scene){this.list.push(c)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);if(a!=null){this.list.push(a)}else{d.push("Could not find actor: "+c)}}else{d.push("The object "+c+" is not of the expected type (vxlActor, string)")}}}if(d.length!=0){this.list=[];throw new vxlActorGroupException(d)
}};vxlActorGroup.prototype.add=function(b){var c=[];if(b instanceof vxlActor&&b.scene==this.scene){this.list.push(b)}else{if(typeof(b)=="string"){var a=this.scene.getActor(b);if(a!=null){this.list.push(a)}else{c.push("Could not find actor: "+b)}}else{c.push("The object "+b+" is not of the expected type (vxlActor, string)")}}if(c.length!=0){this.list=[];throw new vxlActorGroupException(c)}};vxlActorGroup.prototype.hasActor=function(b){if(b instanceof vxlActor){return(this.list.indexOf(b)!=-1)}else{if(typeof(b)=="string"){var a=this.scene.getActor(b);
return(a!=null)}else{return false}}};vxlActorGroup.prototype.remove=function(b){var a=-1;if(b instanceof vxlActor){a=this.list.indexOf(b)}else{if(typeof(b)=="string"){actorObject=this.scene.getActor(b);a=this.list.indexOf(actorObject)}}if(a!=1){this.list.splice(a,1)}else{throw new vxlActorGroupException(["the actor "+b+" was not found in the group "+this.name])}};vxlActorGroup.prototype.size=function(){return this.list.length};vxlActorGroup.prototype.setProperty=function(c,b){for(var a=0,d=this.list.length;
a<d;a+=1){this.list[a].setProperty(c,b,vxl.def.actor)}return this};vxlActorGroup.prototype._apply=function(a,c){for(var b=0,d=this.list.length;b<d;b+=1){a.apply(this.list[b],c)}return this};vxlActorGroup.prototype.flipNormals=function(){return this._apply(vxlActor.prototype.flipNormals)};vxlActorGroup.prototype.rotateX=function(a){return this._apply(vxlActor.prototype.rotateX,[a])};vxlActorGroup.prototype.rotateY=function(a){return this._apply(vxlActor.prototype.rotateY,[a])};vxlActorGroup.prototype.rotateZ=function(a){return this._apply(vxlActor.prototype.rotateZ,[a])
};vxlActorGroup.prototype.translate=function(a,c,b){return this._apply(vxlActor.prototype.translate,[a,c,b])};vxlActorGroup.prototype.setColor=function(a){return this.setProperty("color",a)};vxlActorGroup.prototype.setLookupTable=function(c,b,a){return this._apply(vxlActor.prototype.setLookupTable,[c,b,a])};vxlActorGroup.prototype.setOpacity=function(a){return this.setProperty("opacity",a)};vxlActorGroup.prototype.setPicker=function(a,b){return this._apply(vxlActor.prototype.setPicker,[a,b])};vxlActorGroup.prototype.setPosition=function(a,c,b){return this._apply(vxlActor.prototype.setPosition,[a,c,b])
};vxlActorGroup.prototype.setScale=function(a,c,b){return this._apply(vxlActor.prototype.setScale,[a,c,b])};vxlActorGroup.prototype.setShininess=function(a){return this.setProperty("shininess",a)};vxlActorGroup.prototype.setVisible=function(a){return this.setProperty("visible",a)};vxlActorGroup.prototype.setShading=function(a){return this.setProperty("shading",a)};vxlActorGroup.prototype.setVisualizationMode=function(a){return this._apply(vxlActor.prototype.setVisualizationMode,[a])};function vxlActorGroupException(a){this.messages=a
};function vxlSilo(a){this._mode=a;this._actors=[];this.data={};this.cached={};this.added={};this.prepare()}vxlSilo.prototype.populate=function(c){var d=c.length;for(var a=0;a<d;a+=1){var b=c[a];if(this.cached[b.UID]==undefined&&b.mode==this._mode){this._actors.push(b);this.cached[b.UID]=b}}};vxlSilo.prototype.prepare=function(){var a={mixin:[],index:[],matrix:[[],[],[],[]]};this.data=a};vxlSilo.prototype.process=function(){var c=this._actors.length;for(var a=0;a<c;a+=1){var b=this._actors[a];if(this.added[b.UID]==undefined){this.processActor(this._actors[a]);
this.added[b.UID]=b}}};vxlSilo.prototype.processActor=function(e){var g=e.model;var k=e.material;var m=this.data.mixin;var j=this.data.index;var l=this.data.matrix;var a=g.vertices.length;var d=g.indices.length;var h=Array.prototype.slice.call(e._matrix);if(k.colors!=undefined){}else{for(var f=0;f<a;f+=3){m=m.concat([g.vertices[f],g.vertices[f+1],g.vertices[f+2],g.normals[f],g.normals[f+1],g.normals[f+2],k.diffuse[0],k.diffuse[1],k.diffuse[2]]);l[0]=l[0].concat(h.slice(0,4));l[1]=l[1].concat(h.slice(4,8));
l[2]=l[2].concat(h.slice(8,12));l[3]=l[3].concat(h.slice(12,16))}}var b=g.indices.slice(0);if(j.length>0){var c=j.max()+1;for(var f=0;f<d;f+=1){b[f]+=c}j=j.concat(b)}else{j=b}this.data.mixin=m;this.data.index=j;this.data.matrix=l};vxlDashEngine.prototype=new vxlEngine();vxlDashEngine.prototype.constructor=vxlDashEngine;function vxlDashEngine(a){vxlEngine.call(this);this.silos={};this._createSilos();this._gl_buffers={};this._createGLBuffers();this.essl=vxl.util.extend(vxl.def.essl,{ACTOR_MATRIX:"aActorMatrix"})}vxlRenderEngine.prototype.configure=function(){vxlEngine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};vxlDashEngine.prototype._createSilos=function(){for(key in vxl.def.actor.mode){this.silos[key]={};
this.silos[key]=new vxlSilo(key)}};vxlDashEngine.prototype._createGLBuffers=function(){var a=this.renderer.gl;for(key in vxl.def.actor.mode){this._gl_buffers[key]={};this._gl_buffers[key].mixin=a.createBuffer();this._gl_buffers[key].index=a.createBuffer();this._gl_buffers[key].matrix=a.createBuffer()}};vxlDashEngine.prototype.allocate=function(b){var a=b._actors;for(key in this.silos){this.silos[key].populate(a);this.silos[key].process()}};vxlDashEngine.prototype.render=function(e){var c=this.renderer;
var b=c.transforms;var a=c.pm;var f=c.gl;var d=this.essl;if(e._actors.length==0){return}b.update();a.setUniform(d.PERSPECTIVE_MATRIX,b.pMatrix);a.setUniform(d.MODEL_VIEW_MATRIX,b.mvMatrix);a.setUniform(d.NORMAL_MATRIX,b.nMatrix);a.setUniform(d.MVP_MATRIX,b.mvpMatrix);this._renderSolid()};vxlDashEngine.prototype.deallocate=function(a){};vxlDashEngine.prototype.enableMatrixAttribute=function(b){var a=this.renderer;var i=a.gl;var c=a.pm._essl;var d=vxl.def.actor.mode;var g=this.silos[d.SOLID];var h=g.data;
var k=i.getAttribLocation(c,b);i.enableVertexAttribArray(k);i.enableVertexAttribArray(k+1);i.enableVertexAttribArray(k+2);i.enableVertexAttribArray(k+3);var l=i.createBuffer();var j=i.createBuffer();var f=i.createBuffer();var e=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l);i.bufferData(i.ARRAY_BUFFER,new Float32Array(h.matrix[0]),i.STATIC_DRAW);i.vertexAttribPointer(k,4,i.FLOAT,false,0,0);i.bindBuffer(i.ARRAY_BUFFER,j);i.bufferData(i.ARRAY_BUFFER,new Float32Array(h.matrix[1]),i.STATIC_DRAW);i.vertexAttribPointer(k+1,4,i.FLOAT,false,0,0);
i.bindBuffer(i.ARRAY_BUFFER,f);i.bufferData(i.ARRAY_BUFFER,new Float32Array(h.matrix[2]),i.STATIC_DRAW);i.vertexAttribPointer(k+2,4,i.FLOAT,false,0,0);i.bindBuffer(i.ARRAY_BUFFER,e);i.bufferData(i.ARRAY_BUFFER,new Float32Array(h.matrix[3]),i.STATIC_DRAW);i.vertexAttribPointer(k+3,4,i.FLOAT,false,0,0)};vxlDashEngine.prototype._renderSolid=function(){var b=vxl.def.actor.mode;var e=this.silos[b.SOLID];var f=e.data;var a=this.renderer;var d=a.transforms;var c=a.pm;var g=a.gl;var j=this.essl;c.setUniform("uUseShading",true);
c.enableAttribute(j.VERTEX_ATTRIBUTE);c.enableAttribute(j.NORMAL_ATTRIBUTE);c.enableAttribute(j.COLOR_ATTRIBUTE);this.enableMatrixAttribute(j.ACTOR_MATRIX);var i=this._gl_buffers[b.SOLID].mixin;g.bindBuffer(g.ARRAY_BUFFER,i);g.bufferData(g.ARRAY_BUFFER,new Float32Array(f.mixin),g.STATIC_DRAW);c.setAttributePointer(j.VERTEX_ATTRIBUTE,3,g.FLOAT,false,36,0);c.setAttributePointer(j.NORMAL_ATTRIBUTE,3,g.FLOAT,false,36,12);c.setAttributePointer(j.COLOR_ATTRIBUTE,3,g.FLOAT,false,36,24);var h=this._gl_buffers[b.SOLID].index;
g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,h);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(f.index),g.STATIC_DRAW);g.drawElements(g.TRIANGLES,f.index.length,g.UNSIGNED_SHORT,0)};