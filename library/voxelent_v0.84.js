if(!jQuery){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}if(typeof(vxl)=="undefined"){vxl={}}vxl.nucleo={ver:"0.2",codename:"bochica",};vxl.d={};vxl.glsl={};vxl.def={lutFolder:"voxdata/luts",modelsFolder:"voxdata/models",luts:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],lut:"default",modelColor:[0.9,0.9,0.9],ambientColor:[0.5,0.5,0.5],backgroundColor:[135/256,135/256,135/256],visMode:{SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS"},cameraTask:{NONE:0,PAN:1,ROTATE:2,DOLLY:3},cameraType:{ORBITING:"ORBITING",TRACKING:"TRACKING"},loadingMode:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"},VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",renderer:{mode:{TIMER:"TIMER",ANIMFRAME:"ANIFRAME"},rate:{SLOW:10000,NORMAL:500}}};
vxl.events={DEFAULT_LUT_LOADED:"vxl.events.DEFAULT_LUT_LOADED",SCENE_UPDATED:"vxl.events.SCENE_UPDATED",MODELS_LOADED:"vxl.events.MODELS_LOADED"};vxl.go={animationMode:false,animationFrames:1,modelToFrame:[],axisOn:true,debug:false,views:[],_rates:[],timid:0,notifier:undefined,modelManager:undefined,lookupTableManager:undefined,gui:undefined,render:function(){vxl.c.view.renderer.render();this.timid=window.requestAnimFrame(vxl.go.render)},cancelRender:function(){window.cancelRequestAnimFrame(this.timid)
},slowRendering:function(){vxl.go._rates=[];for(var a=0;a<vxl.go.views.length;a++){vxl.go._rates.push(vxl.go.views[a].renderer.renderRate);vxl.go.views[a].renderer.setRenderRate(vxl.def.renderer.rate.SLOW)}},normalRendering:function(){for(var a=0;a<vxl.go.views.length;a++){vxl.go.views[a].renderer.setRenderRate(vxl.go._rates[a])}},console:function(a){if(this.debug==true){console.info(a)}}};vxl.c={scene:undefined,view:undefined,camera:undefined,actor:undefined,animation:undefined};Array.prototype.max=function(){return Math.max.apply(Math,this)
};Array.prototype.min=function(){return Math.min.apply(Math,this)};Array.prototype.hasObject=(!Array.indexOf?function(b){var a=this.length+1;while(a-=1){if(this[a-1]===b){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){return window.setTimeout(b,1000/60)}})();
window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout})();$(window).bind("focus",vxl.go.normalRendering);$(window).bind("blur",vxl.go.slowRendering);vxl.go.notifier=new vxlNotifier();function vxlNotifier(){this.targetList={};this.sourceList={}}vxlNotifier.prototype.addTarget=function(b,a){vxl.go.console("vxlNotifier: adding target for event "+b);var c=this.targetList;if(c[b]==undefined){c[b]=[]}c[b].push(a)};vxlNotifier.prototype.addSource=function(b,d){vxl.go.console("vxlNotifier: adding source for event "+b);var c=this.targetList;var a=this.sourceList;if(a[b]==undefined){a[b]=d}if(c[b]==undefined){c[b]=[]}$(document).bind(b,function(h,g,j,i){for(var f=0;
f<i[g].length;f++){i[g][f].handleEvent(g,j)}})};vxlNotifier.prototype.fire=function(a){var c=this.targetList;var b=this.sourceList[a];vxl.go.console("vxlNotifier: firing "+a);$(document).trigger(a,[a,b,c])};vxlNotifier.prototype.getEvents=function(){var b=[];for(var a in this.sourceList){b.push(a)}return b};vxlNotifier.prototype.getTargetsFor=function(c){var a=this.targetList[c];var d=[];for(var b=0;b<a.length;b++){d.push(getObjectName(a[b]))}return d};vxl.vec3={};vxl.vec3.dot=function(d,c){if(!(d instanceof vxlVector3)||!(c instanceof vxlVector3)){alert("vxl.math.vector.dot ERROR");return null}return((d.x*c.x)+(d.y*c.y)+(d.z*c.z))};vxl.vec3.cross=function(d,c){if(!(d instanceof vxlVector3)||!(c instanceof vxlVector3)){alert("vxl.math.vector.cross ERROR");return null}var g=d.y*c.z-d.z*c.y;var f=d.z*c.x-d.x*c.z;var e=d.x*c.y-d.y*c.x;return new vxlVector3(g,f,e)};vxl.vec3.subtract=function(d,c){if(!(d instanceof vxlVector3)||!(c instanceof vxlVector3)){alert("vxl.math.vector.substract ERROR");
return null}return new vxlVector3(d.x-c.x,d.y-c.y,d.z-c.z)};vxl.vec3.scale=function(a,b){if(!(a instanceof vxlVector3)){alert("vxl.math.vector.scale ERROR");return null}var c=new vxlVector3();c.x=a.x*b;c.y=a.y*b;c.z=a.z*b;return c};vxl.vec3.negate=function(a){return vxl.vec3.scale(a,-1)};vxl.vec3.length=function(a){return Math.sqrt((a.x*a.x)+(a.y*a.y)+(a.z*a.z))};vxl.vec3.round=function(a,b){var a=this;if(b==null||b==undefined||b<0){a.x=Math.round(a.x);a.y=Math.round(a.y);a.z=Math.round(a.z)}a.x=Math.round(a.x*10*b)/(10*b);
a.y=Math.round(a.y*10*b)/(10*b);a.z=Math.round(a.z*10*b)/(10*b)};vxl.vec3.normalize=function(a){var b=vxl.vec3.length(a);if(b==0){message("ERROR: normalizing a vector by a zero norm")}a.x=a.x/b;a.y=a.y/b;a.z=a.z/b};vxl.vec3.set=function(d,c){if(d instanceof Array){c.x=d[0];c.y=d[1];c.z=d[2]}else{if(d instanceof vxlVector3){c.x=d.x;c.y=d.y;c.z=d.z}else{c.x=0;c.y=0;c.z=0}}};function vxlVector3(a,c,b){this.x=0;this.y=0;this.z=0;if(a!=null){this.x=a}if(c!=null){this.y=c}if(b!=null){this.z=b}}vxlVector3.prototype.toString=function(c,d){var a=this;
var b="vector ";if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z)){return"vector "+d+" does not have numeric values"}if(d!=null){b=d}if(c==null){return b+": ("+a.x+","+a.y+","+a.z+")"}else{if(c>0){return b+":("+a.x.toFixed(c)+","+a.y.toFixed(c)+","+a.z.toFixed(c)+")"}}};vxl.vec3.create=function(a){return new vxlVector3(a[0],a[1],a[2])};function vxlVector4(a,d,c,b){this.x=0;this.y=0;this.z=0;this.h=1;if(a!=null){this.x=a}if(d!=null){this.y=d}if(c!=null){this.z=c}if(b!=null){this.h=b}}vxlVector4.prototype.toString=function(c,d){var a=this;
var b="vector ";if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z)){return"vector "+d+" does not have numeric values"}if(d!=null){b=d}if(c==null){return b+": ("+a.x+","+a.y+","+a.z+","+a.h+")"}else{if(c>0){return b+":("+a.x.toFixed(c)+","+a.y.toFixed(c)+","+a.z.toFixed(c)+","+a.h.toFixed(c)+")"}}};vxl.vec4={};vxl.vec4.create=function(a){return new vxlVector4(a[0],a[1],a[2],a[3])};vxl.mat4={};vxl.mat4.set=function(a,b){if(arguments.length==2){if("length" in a&&a.length==16){b.m11=a[0];b.m12=a[1];b.m13=a[2];b.m14=a[3];
b.m21=a[4];b.m22=a[5];b.m23=a[6];b.m24=a[7];b.m31=a[8];b.m32=a[9];b.m33=a[10];b.m34=a[11];b.m41=a[12];b.m42=a[13];b.m43=a[14];b.m44=a[15];return}else{if(a instanceof vxlMatrix4x4){b.m11=a.m11;b.m12=a.m12;b.m13=a.m13;b.m14=a.m14;b.m21=a.m21;b.m22=a.m22;b.m23=a.m23;b.m24=a.m24;b.m31=a.m31;b.m32=a.m32;b.m33=a.m33;b.m34=a.m34;b.m41=a.m41;b.m42=a.m42;b.m43=a.m43;b.m44=a.m44;return}}}};vxl.mat4.identity=function(a){a.m11=1;a.m12=0;a.m13=0;a.m14=0;a.m21=0;a.m22=1;a.m23=0;a.m24=0;a.m31=0;a.m32=0;a.m33=1;
a.m34=0;a.m41=0;a.m42=0;a.m43=0;a.m44=1};vxl.mat4.transpose=function(a){var b=a.m12;a.m12=a.m21;a.m21=b;b=a.m13;a.m13=a.m31;a.m31=b;b=a.m14;a.m14=a.m41;a.m41=b;b=a.m23;a.m23=a.m32;a.m32=b;b=a.m24;a.m24=a.m42;a.m42=b;b=a.m34;a.m34=a.m43;a.m43=b};vxl.mat4.inverse=function(a,b){var c=vxl.mat4._determinant4x4(a);if(Math.abs(c)<1e-8){return null}vxl.mat4._makeAdjoint(a);a.m11/=c;a.m12/=c;a.m13/=c;a.m14/=c;a.m21/=c;a.m22/=c;a.m23/=c;a.m24/=c;a.m31/=c;a.m32/=c;a.m33/=c;a.m34/=c;a.m41/=c;a.m42/=c;a.m43/=c;
a.m44/=c};vxl.mat4.multVec3=function(a,c){var d=new vxlVector3();var b=new vxlVector3();if(c instanceof Array){b=vxl.vec3.create(c)}else{if(c instanceof vxlVector3){b=c}else{alert("error")}}d.x=a.m11*b.x+a.m12*b.y+a.m13*b.z;d.y=a.m21*b.x+a.m22*b.y+a.m23*b.z;d.z=a.m31*b.x+a.m32*b.y+a.m33*b.z;return d};vxl.mat4.multVec4=function(a,c){var d=new vxlVector4();var b=new vxlVector4();if(c instanceof Array){b=vxl.vec4.create(c)}else{if(c instanceof vxlVector4){b=c}else{alert("error")}}d.x=a.m11*b.x+a.m12*b.y+a.m13*b.z+a.m14*b.h;
d.y=a.m21*b.x+a.m22*b.y+a.m23*b.z+a.m24*b.h;d.z=a.m31*b.x+a.m32*b.y+a.m33*b.z+a.m34*b.h;d.h=a.m41*b.x+a.m42*b.y+a.m43*b.z+a.m44*b.h;return d};vxl.mat4.translate=function(a,b){a.m41=a.m11*b.x+a.m21*b.y+a.m31*b.z+a.m41;a.m42=a.m12*b.x+a.m22*b.y+a.m32*b.z+a.m42;a.m43=a.m13*b.x+a.m23*b.y+a.m33*b.z+a.m43;a.m44=a.m14*b.x+a.m24*b.y+a.m34*b.z+a.m44;return a};vxl.mat4.scale=function(a,c){if(c.x==undefined){c.x=1}if(c.z==undefined){if(c.y==undefined){c.y=c.x;c.z=c.x}else{c.z=1}}else{if(c.y==undefined){c.y=c.x
}}var b=new vxlMatrix4x4();b.m11=c.x;b.m22=c.y;b.m33=c.z;vxl.mat4.multRight(a,b)};vxl.mat4.rotate=function(c,d,j){d=d/180*Math.PI;d/=2;var h=Math.sin(d);var f=Math.cos(d);var i=h*h;var b=Math.sqrt(j.x*j.x+j.y*j.y+j.z*j.z);if(b==0){j.x=0;j.y=0;j.z=1}else{if(b!=1){j.x/=b;j.y/=b;j.z/=b}}var k=new vxlMatrix4x4();if(j.x==1&&j.y==0&&j.z==0){k.m11=1;k.m12=0;k.m13=0;k.m21=0;k.m22=1-2*i;k.m23=2*h*f;k.m31=0;k.m32=-2*h*f;k.m33=1-2*i;k.m14=k.m24=k.m34=0;k.m41=k.m42=k.m43=0;k.m44=1}else{if(j.x==0&&j.y==1&&j.z==0){k.m11=1-2*i;
k.m12=0;k.m13=-2*h*f;k.m21=0;k.m22=1;k.m23=0;k.m31=2*h*f;k.m32=0;k.m33=1-2*i;k.m14=k.m24=k.m34=0;k.m41=k.m42=k.m43=0;k.m44=1}else{if(j.x==0&&j.y==0&&j.z==1){k.m11=1-2*i;k.m12=2*h*f;k.m13=0;k.m21=-2*h*f;k.m22=1-2*i;k.m23=0;k.m31=0;k.m32=0;k.m33=1;k.m14=k.m24=k.m34=0;k.m41=k.m42=k.m43=0;k.m44=1}else{var a=j.x*j.x;var g=j.y*j.y;var e=j.z*j.z;k.m11=1-2*(g+e)*i;k.m12=2*(j.x*j.y*i+j.z*h*f);k.m13=2*(j.x*j.z*i-j.y*h*f);k.m21=2*(j.y*j.x*i-j.z*h*f);k.m22=1-2*(e+a)*i;k.m23=2*(j.y*j.z*i+j.x*h*f);k.m31=2*(j.z*j.x*i+j.y*h*f);
k.m32=2*(j.z*j.y*i-j.x*h*f);k.m33=1-2*(a+g)*i;k.m14=k.m24=k.m34=0;k.m41=k.m42=k.m43=0;k.m44=1}}}vxl.mat4.multRight(c,k)};vxl.mat4.rotateX=function(k,a,i){var n=Math.sin(a);var g=Math.cos(a);var m=k.m21,l=k.m22,j=k.m23,h=k.m24;var f=k.m31,e=k.m32,d=k.m33,b=k.m34;if(!i){i=k}else{if(k!=i){i.m11=k.m11;i.m12=k.m12;i.m13=k.m13;i.m14=k.m14;i.m41=k.m41;i.m42=k.m42;i.m43=k.m43;i.m44=k.m44}}i.m21=m*g+f*n;i.m22=l*g+e*n;i.m23=j*g+d*n;i.m24=h*g+b*n;i.m31=m*-n+f*g;i.m32=l*-n+e*g;i.m33=j*-n+d*g;i.m34=h*-n+b*g;return i
};vxl.mat4.rotateY=function(m,e,l){var n=Math.sin(e);var k=Math.cos(e);var f=m.m11,d=m.m12,b=m.m13,a=m.m14;var j=m.m31,i=m.m32,h=m.m33,g=m.m34;if(!l){l=m}else{if(m!=l){l.m21=m.m21;l.m22=m.m22;l.m23=m.m23;l.m24=m.m24;l.m41=m.m41;l.m42=m.m42;l.m43=m.m43;l.m44=m.m44}}l.m11=f*k+j*-n;l.m12=d*k+i*-n;l.m13=b*k+h*-n;l.m14=a*k+g*-n;l.m31=f*n+j*k;l.m32=d*n+i*k;l.m33=b*n+h*k;l.m34=a*n+g*k;return l};vxl.mat4.multRight=function(i,j){var q=(i.m11*j.m11+i.m12*j.m21+i.m13*j.m31+i.m14*j.m41);var o=(i.m11*j.m12+i.m12*j.m22+i.m13*j.m32+i.m14*j.m42);
var n=(i.m11*j.m13+i.m12*j.m23+i.m13*j.m33+i.m14*j.m43);var k=(i.m11*j.m14+i.m12*j.m24+i.m13*j.m34+i.m14*j.m44);var d=(i.m21*j.m11+i.m22*j.m21+i.m23*j.m31+i.m24*j.m41);var c=(i.m21*j.m12+i.m22*j.m22+i.m23*j.m32+i.m24*j.m42);var b=(i.m21*j.m13+i.m22*j.m23+i.m23*j.m33+i.m24*j.m43);var a=(i.m21*j.m14+i.m22*j.m24+i.m23*j.m34+i.m24*j.m44);var h=(i.m31*j.m11+i.m32*j.m21+i.m33*j.m31+i.m34*j.m41);var g=(i.m31*j.m12+i.m32*j.m22+i.m33*j.m32+i.m34*j.m42);var f=(i.m31*j.m13+i.m32*j.m23+i.m33*j.m33+i.m34*j.m43);
var e=(i.m31*j.m14+i.m32*j.m24+i.m33*j.m34+i.m34*j.m44);var s=(i.m41*j.m11+i.m42*j.m21+i.m43*j.m31+i.m44*j.m41);var r=(i.m41*j.m12+i.m42*j.m22+i.m43*j.m32+i.m44*j.m42);var p=(i.m41*j.m13+i.m42*j.m23+i.m43*j.m33+i.m44*j.m43);var l=(i.m41*j.m14+i.m42*j.m24+i.m43*j.m34+i.m44*j.m44);i.m11=q;i.m12=o;i.m13=n;i.m14=k;i.m21=d;i.m22=c;i.m23=b;i.m24=a;i.m31=h;i.m32=g;i.m33=f;i.m34=e;i.m41=s;i.m42=r;i.m43=p;i.m44=l};vxl.mat4.multLeft=function(i,j){var q=(j.m11*i.m11+j.m12*i.m21+j.m13*i.m31+j.m14*i.m41);var o=(j.m11*i.m12+j.m12*i.m22+j.m13*i.m32+j.m14*i.m42);
var n=(j.m11*i.m13+j.m12*i.m23+j.m13*i.m33+j.m14*i.m43);var k=(j.m11*i.m14+j.m12*i.m24+j.m13*i.m34+j.m14*i.m44);var d=(j.m21*i.m11+j.m22*i.m21+j.m23*i.m31+j.m24*i.m41);var c=(j.m21*i.m12+j.m22*i.m22+j.m23*i.m32+j.m24*i.m42);var b=(j.m21*i.m13+j.m22*i.m23+j.m23*i.m33+j.m24*i.m43);var a=(j.m21*i.m14+j.m22*i.m24+j.m23*i.m34+j.m24*i.m44);var h=(j.m31*i.m11+j.m32*i.m21+j.m33*i.m31+j.m34*i.m41);var g=(j.m31*i.m12+j.m32*i.m22+j.m33*i.m32+j.m34*i.m42);var f=(j.m31*i.m13+j.m32*i.m23+j.m33*i.m33+j.m34*i.m43);
var e=(j.m31*i.m14+j.m32*i.m24+j.m33*i.m34+j.m34*i.m44);var s=(j.m41*i.m11+j.m42*i.m21+j.m43*i.m31+j.m44*i.m41);var r=(j.m41*i.m12+j.m42*i.m22+j.m43*i.m32+j.m44*i.m42);var p=(j.m41*i.m13+j.m42*i.m23+j.m43*i.m33+j.m44*i.m43);var l=(j.m41*i.m14+j.m42*i.m24+j.m43*i.m34+j.m44*i.m44);i.m11=q;i.m12=o;i.m13=n;i.m14=k;i.m21=d;i.m22=c;i.m23=b;i.m24=a;i.m31=h;i.m32=g;i.m33=f;i.m34=e;i.m41=s;i.m42=r;i.m43=p;i.m44=l};vxl.mat4.ortho=function(c,b,k,a,i,h,g){var f=(b+k)/(b-k);var e=(i+a)/(i-a);var d=(g+h)/(g-h);
var j=new vxlMatrix4x4();j.m11=2/(b-k);j.m12=0;j.m13=0;j.m14=0;j.m21=0;j.m22=2/(i-a);j.m23=0;j.m24=0;j.m31=0;j.m32=0;j.m33=-2/(g-h);j.m34=0;j.m41=f;j.m42=e;j.m43=d;j.m44=1;vxl.mat4.multRight(c,j)};vxl.mat4.frustum=function(g,f,l,b,j,i,h){var k=new vxlMatrix4x4();var e=(l+f)/(l-f);var d=(j+b)/(j-b);var c=-(h+i)/(h-i);var a=-(2*h*i)/(h-i);k.m11=(2*i)/(l-f);k.m12=0;k.m13=0;k.m14=0;k.m21=0;k.m22=2*i/(j-b);k.m23=0;k.m24=0;k.m31=e;k.m32=d;k.m33=c;k.m34=-1;k.m41=0;k.m42=0;k.m43=a;k.m44=0;vxl.mat4.multRight(g,k)
};vxl.mat4.perspective=function(e,c,a,f,g){var h=Math.tan(c*Math.PI/360)*f;var b=-h;var d=a*b;var i=a*h;vxl.mat4.frustum(e,d,i,b,h,f,g)};vxl.mat4.lookat=function(i,p,o,n,k,j,h,d,c,b){var l=new vxlMatrix4x4();var s=p-k;var r=o-j;var q=n-h;var a=Math.sqrt(s*s+r*r+q*q);if(a){s/=a;r/=a;q/=a}var g=d;var f=c;var e=b;xx=f*q-e*r;xy=-g*q+e*s;xz=g*r-f*s;g=r*xz-q*xy;f=-s*xz+q*xx;g=s*xy-r*xx;a=Math.sqrt(xx*xx+xy*xy+xz*xz);if(a){xx/=a;xy/=a;xz/=a}a=Math.sqrt(g*g+f*f+e*e);if(a){g/=a;f/=a;e/=a}l.m11=xx;l.m12=xy;
l.m13=xz;l.m14=0;l.m21=g;l.m22=f;l.m23=e;l.m24=0;l.m31=s;l.m32=r;l.m33=q;l.m34=0;l.m41=0;l.m42=0;l.m43=0;l.m44=1;l.translate(-p,-o,-n);vxl.mat4.multRight(i,l)};vxl.mat4._determinant2x2=function(f,e,h,g){return f*g-e*h};vxl.mat4._determinant3x3=function(c,b,a,i,h,g,f,e,d){return c*vxl.mat4._determinant2x2(h,g,e,d)-i*vxl.mat4._determinant2x2(b,a,e,d)+f*vxl.mat4._determinant2x2(b,a,h,g)};vxl.mat4._determinant4x4=function(f){var e=f.m11;var o=f.m12;var j=f.m13;var c=f.m14;var d=f.m21;var n=f.m22;var i=f.m23;
var b=f.m24;var a=f.m31;var l=f.m32;var h=f.m33;var r=f.m34;var q=f.m41;var k=f.m42;var g=f.m43;var p=f.m44;return e*vxl.mat4._determinant3x3(n,l,k,i,h,g,b,r,p)-o*vxl.mat4._determinant3x3(d,a,q,i,h,g,b,r,p)+j*vxl.mat4._determinant3x3(d,a,q,n,l,k,b,r,p)-c*vxl.mat4._determinant3x3(d,a,q,n,l,k,i,h,g)};vxl.mat4._makeAdjoint=function(f){var e=f.m11;var o=f.m12;var j=f.m13;var c=f.m14;var d=f.m21;var n=f.m22;var i=f.m23;var b=f.m24;var a=f.m31;var l=f.m32;var h=f.m33;var r=f.m34;var q=f.m41;var k=f.m42;
var g=f.m43;var p=f.m44;f.m11=vxl.mat4._determinant3x3(n,l,k,i,h,g,b,r,p);f.m21=-vxl.mat4._determinant3x3(d,a,q,i,h,g,b,r,p);f.m31=vxl.mat4._determinant3x3(d,a,q,n,l,k,b,r,p);f.m41=-vxl.mat4._determinant3x3(d,a,q,n,l,k,i,h,g);f.m12=-vxl.mat4._determinant3x3(o,l,k,j,h,g,c,r,p);f.m22=vxl.mat4._determinant3x3(e,a,q,j,h,g,c,r,p);f.m32=-vxl.mat4._determinant3x3(e,a,q,o,l,k,c,r,p);f.m42=vxl.mat4._determinant3x3(e,a,q,o,l,k,j,h,g);f.m13=vxl.mat4._determinant3x3(o,n,k,j,i,g,c,b,p);f.m23=-vxl.mat4._determinant3x3(e,d,q,j,i,g,c,b,p);
f.m33=vxl.mat4._determinant3x3(e,d,q,o,n,k,c,b,p);f.m43=-vxl.mat4._determinant3x3(e,d,q,o,n,k,j,i,g);f.m14=-vxl.mat4._determinant3x3(o,n,l,j,i,h,c,b,r);f.m24=vxl.mat4._determinant3x3(e,d,a,j,i,h,c,b,r);f.m34=-vxl.mat4._determinant3x3(e,d,a,o,n,l,c,b,r);f.m44=vxl.mat4._determinant3x3(e,d,a,o,n,l,j,i,h)};vxlMatrix4x4=function(a){this.m11=0;this.m12=0;this.m13=0;this.m14=0;this.m21=0;this.m22=0;this.m23=0;this.m24=0;this.m31=0;this.m32=0;this.m33=0;this.m34=0;this.m41=0;this.m42=0;this.m43=0;this.m44=0;
if(arguments.length==1&&a instanceof vxlMatrix){vxl.mat4.set(a,this)}};vxlMatrix4x4.prototype.getAsArray=function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]};vxlMatrix4x4.prototype.getAsFloat32Array=function(){return new Float32Array(this.getAsArray())};vxlMatrix4x4.prototype.toString=function(){return debugMatrix(this)};debugMatrix=function(a){return"Matrix\n"+a.m11.toFixed(2)+" "+a.m12.toFixed(2)+" "+a.m13.toFixed(2)+" "+a.m14.toFixed(2)+"\n"+a.m21.toFixed(2)+" "+a.m22.toFixed(2)+" "+a.m23.toFixed(2)+" "+a.m24.toFixed(2)+"\n"+a.m31.toFixed(2)+" "+a.m32.toFixed(2)+" "+a.m33.toFixed(2)+" "+a.m34.toFixed(2)+"\n"+a.m41.toFixed(2)+" "+a.m42.toFixed(2)+" "+a.m43.toFixed(2)+" "+a.m44.toFixed(2)+"\n"
};function vxlCameraState(a){if(!(a instanceof vxlCamera)){alert("vxlCameraState needs a vxlCamera as argument");return null}this.c=a;this.position=new vxlVector3(0,0,1);this.focalPoint=new vxlVector3(0,0,0);this.up=new vxlVector3(0,1,0);this.right=new vxlVector3(1,0,0);this.distance=0;this.azimuth=0;this.elevation=0;this.xTr=0;this.yTr=0}vxlCameraState.prototype.reset=function(){var a=this.c;a.focalPoint=new vxlVector3(0,0,0);a.up=new vxlVector3(0,1,0);a.right=new vxlVector3(1,0,0);a.distance=0;a.elevation=0;
a.azimuth=0;a.xTr=0;a.yTr=0;a.setPosition(0,0,1);a.setOptimalDistance()};vxlCameraState.prototype.save=function(){var a=this.c;this.distance=a.distance;this.azimuth=a.azimuth;this.elevation=a.elevation;this.xTr=a.xTr;this.yTr=a.yTr;vxl.vec3.set(a.position,this.position);vxl.vec3.set(a.focalPoint,this.focalPoint);vxl.vec3.set(a.up,this.up);vxl.vec3.set(a.right,this.right)};vxlCameraState.prototype.retrieve=function(){var a=this.c;a.azimuth=this.azimuth;a.elevation=this.elevation;a.xTr=this.xTr;a.yTr=this.yTr;
vxl.vec3.set(this.focalPoint,a.focalPoint);vxl.vec3.set(this.up,a.up);vxl.vec3.set(this.right,a.right);a.setPosition(this.position.x,this.position.y,this.position.z)};function vxlCamera(b,a){this.view=b;this.matrix=new vxlMatrix4x4();this.up=vxl.vec3.create([0,1,0]);this.right=vxl.vec3.create([1,0,0]);this.normal=vxl.vec3.create([0,0,0]);this.position=vxl.vec3.create([0,0,1]);this.focus=vxl.vec3.create([0,0,0]);this.azimuth=0;this.elevation=0;this.steps=0;this.home=vxl.vec3.create([0,0,0]);this.id=0;if(a!=undefined&&a!=null){this.type=a}else{this.type=vxl.def.cameraType.ORBITING}this.distance=0;this.debug=false}vxlCamera.prototype.setType=function(a){if(a!=vxl.def.cameraType.ORBITING&&a!=vxl.def.cameraType.TRACKING){alert("Wrong Camera Type!. Setting Orbitting type by default");
this.type=vxl.def.cameraType.ORBITING}else{this.type=a}};vxlCamera.prototype.init=function(){var a=this;this.goHome([0,0,1]);this.setFocus([0,0,0]);vxl.mat4.identity(this.matrix)};vxlCamera.prototype.goHome=function(a){if(a!=null){this.home=vxl.vec3.create(a)}this.setPosition(a);this.setAzimuth(0);this.setElevation(0);this.steps=0};vxlCamera.prototype.computeDistance=function(){vxl.go.console("compute distance called")};vxlCamera.prototype.setDistance=function(a){vxl.go.console("set distance called")
};vxlCamera.prototype.computeViewTransform=function(){vxl.go.console("compute view transform called")};vxlCamera.prototype.setPosition=function(a){vxl.vec3.set(vxl.vec3.create(a),this.position);this.update();this.debugMessage("vxlCamera: Updated position: "+this.position.toString(1))};vxlCamera.prototype.setFocus=function(a){vxl.vec3.set(vxl.vec3.create(a),this.focus);this.update();this.debugMessage("vxlCamera: Updated focus: "+this.focus.toString(1))};vxlCamera.prototype.pan=function(b,a){vxl.go.console(" pan called")
};vxlCamera.prototype.dolly=function(a){vxl.go.console(" dolly called")};vxlCamera.prototype.setAzimuth=function(a){this.changeAzimuth(a-this.azimuth)};vxlCamera.prototype.changeAzimuth=function(a){var b=this;b.azimuth+=a;if(b.azimuth>360||b.azimuth<-360){b.azimuth=b.azimuth%360}b.update()};vxlCamera.prototype.setElevation=function(a){this.changeElevation(a-this.elevation)};vxlCamera.prototype.changeElevation=function(a){var b=this;b.elevation+=a;if(b.elevation>360||b.elevation<-360){b.elevation=b.elevation%360
}b.update()};vxlCamera.prototype.computeAxis=function(){var a=this.matrix;this.right=vxl.mat4.multVec3(a,[1,0,0]);this.up=vxl.mat4.multVec3(a,[0,1,0]);this.normal=vxl.mat4.multVec3(a,[0,0,1])};vxlCamera.prototype.update=function(){vxl.mat4.identity(this.matrix);this.computeAxis();if(this.type==vxl.def.cameraType.TRACKING){vxl.mat4.translate(this.matrix,this.position);vxl.mat4.rotateY(this.matrix,this.azimuth*Math.PI/180);vxl.mat4.rotateX(this.matrix,this.elevation*Math.PI/180)}else{var a=new vxlMatrix4x4();
vxl.mat4.translate(this.matrix,this.focus);vxl.mat4.rotateY(this.matrix,this.azimuth*Math.PI/180);vxl.mat4.rotateX(this.matrix,this.elevation*Math.PI/180);vxl.mat4.translate(this.matrix,vxl.vec3.negate(this.focus));vxl.mat4.translate(this.matrix,this.position)}this.computeAxis();if(this.type==vxl.def.cameraType.TRACKING){vxl.mat4.multVec4(this.matrix,new vxlVector4(0,0,0,1),this.position)}this.debugMessage("------------- update -------------");this.debugMessage(" right: "+this.right.toString(2)+", up: "+this.up.toString(2)+", normal: "+this.normal.toString(2));
this.debugMessage("   pos: "+this.position.toString(2));this.debugMessage("   azimuth: "+this.azimuth+", elevation: "+this.elevation)};vxlCamera.prototype.getViewTransform=function(){var a=new vxlMatrix4x4();vxl.mat4.set(this.matrix,a);vxl.mat4.inverse(a);return a};vxlCamera.prototype.refresh=function(){this.view.refresh()};vxlCamera.prototype.shot=function(c){var b=Math.max(c[3]-c[0],c[4]-c[1]);var a=this.view.scene.centre;if(b!=0){var d=1.5*b/(Math.tan(this.view.fovy*Math.PI/180));this.setPosition([a[0],a[1],a[2]+d])
}this.setFocus(a)};vxlCamera.prototype.longShot=function(){this.shot(this.view.scene.bb)};vxlCamera.prototype.save=function(){var a=this;a.state.save(this);this.debugMessage("Viewpoint saved")};vxlCamera.prototype.retrieve=function(){var a=this;a.state.retrieve();this.debugMessage("Viewpoint restored")};vxlCamera.prototype.reset=function(){var a=this;a.state.reset();vxl.go.console("Camera: reset")};vxlCamera.prototype.above=function(){var a=this;this.elevation=90;this.azimuth=0;this.xTr=0;this.yTr=0;
vxl.vec3.set([0,0,-1],a.up);vxl.vec3.set([1,0,0],a.right);a.setPosition(0,a.distance,0);vxl.go.console("Camera: above")};vxlCamera.prototype.below=function(){var a=this;this.elevation=-90;this.azimuth=0;this.xTr=0;this.yTr=0;vxl.vec3.set([0,0,1],a.up);vxl.vec3.set([1,0,0],a.right);a.setPosition(0,-a.distance,0);vxl.go.console("Camera: below")};vxlCamera.prototype.right=function(){var a=this;this.elevation=0;this.azimuth=-90;this.xTr=0;this.yTr=0;vxl.vec3.set([0,1,0],a.up);vxl.vec3.set([0,0,1],a.right);
a.setPosition(-a.distance,0,0);vxl.go.console("Camera: right")};vxlCamera.prototype.left=function(){var a=this;this.elevation=0;this.azimuth=90;this.xTr=0;this.yTr=0;vxl.vec3.set([0,1,0],a.up);vxl.vec3.set([0,0,1],a.right);a.setPosition(a.distance,0,0);vxl.go.console("Camera: left")};vxlCamera.prototype.debugMessage=function(a){if(this.debug){vxl.go.console(a)}};function vxlCameraManager(a){this.view=a;this.cameras=[];this.active=this.createCamera()}vxlCameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.createCamera(a)};vxlCameraManager.prototype.checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")}};vxlCameraManager.prototype.createCamera=function(b){var a=new vxlCamera(this.view,b);a.init();this.cameras.push(a);a.idx=this.cameras.length-1;return a};vxlCameraManager.prototype.getCamera=function(a){this.checkBoundary(a);
return this.cameras[a]};vxlCameraManager.prototype.getActiveCamera=function(){return this.active};vxlCameraManager.prototype.switchTo=function(a){this.checkBoundary(a);this.active=this.cameras[a];return this.active};function vxlCameraInteractor(){this.camera=null}vxlCameraInteractor.prototype.connectTo=function(a){if(a!=null){if(a instanceof vxlCamera){this.camera=a;this.camera.interactor=this}else{throw (" The object "+a+" is not a valid camera")}}};vxlCameraInteractor.prototype.onMouseUp=function(a){alert("implement onMouseUp")};vxlCameraInteractor.prototype.onMouseDown=function(a){alert("implement onMouseDown")};vxlCameraInteractor.prototype.onMouseMove=function(a){alert("implement onMouseMove")};vxlCameraInteractor.prototype.onKeyDown=function(a){alert("implement onKeyDown")
};vxlCameraInteractor.prototype.onKeyUp=function(a){alert("implement onKeyUp")};function vxlViewListener(a){this.view=a;this.interactor=new vxlTrackballCameraInteractor();this.picker=new vxlPickerInteractor();this.update()}vxlViewListener.prototype.setInteractor=function(a){this.interactor=a;this.update()};vxlViewListener.prototype.update=function(){var a=this;var c=this.view.canvas;var d=this.view.cameraman.active;var b=this.interactor;b.connectTo(d);c.onmousedown=function(e){b.onMouseDown(e)};c.onmouseup=function(e){b.onMouseUp(e)};c.onmousemove=function(e){b.onMouseMove(e)
};window.onkeydown=function(e){b.onKeyDown(e)};window.onkeyup=function(e){b.onKeyUp(e)}};vxlTrackballCameraInteractor.prototype=new vxlCameraInteractor();function vxlTrackballCameraInteractor(a){this.MOTION_FACTOR=10;this.task=vxl.def.cameraTask.NONE;this.x=0;this.y=0;this.lastX=0;this.lastY=0;this.ctrlPressed=false;this.altPressed=false;this.keyPressed=0;this.button=-1;this.dragging=false;this.connectTo(a)}vxlTrackballCameraInteractor.prototype.onMouseUp=function(a){task=vxl.def.cameraTask.NONE;this.dragging=false};vxlTrackballCameraInteractor.prototype.onMouseDown=function(a){this.x=a.clientX;
this.y=a.clientY;this.dragging=true;this.button=a.button};vxlTrackballCameraInteractor.prototype.onMouseMove=function(c){this.lastX=this.x;this.lastY=this.y;this.x=c.clientX;this.y=c.clientY;if(!this.dragging){return}this.ctrlPressed=c.ctrlKey;this.altPressed=c.altKey;var b=this.x-this.lastX;var a=this.y-this.lastY;if(this.button==0){if(this.ctrlPressed){this.dolly(a)}else{this.rotate(b,a)}}this.lastX=this.x;this.lastY=this.y};vxlTrackballCameraInteractor.prototype.onKeyDown=function(d){var c=this.camera;
this.keyPressed=d.keyCode;this.ctrlPressed=d.ctrlKey;if(!this.ctrlPressed){if(this.keyPressed==38){c.changeElevation(10);c.status("elevation up")}else{if(this.keyPressed==40){c.changeElevation(-10);c.status("elevation down")}else{if(this.keyPressed==37){c.changeAzimuth(-10);c.status("azimuth left")}else{if(this.keyPressed==39){c.changeAzimuth(10);c.status("azimuth right")}else{if(this.keyPressed=80){this.picking=!c.view.actorManager.picking;c.view.actorManager.setPicking(this.picking)}}}}}}else{if(this.ctrlPressed&&this.keyPressed!=17){var b=0;
var a=0;vxl.go.console(d);if(this.keyPressed==38){a=10}else{if(this.keyPressed==40){a=-10}else{if(this.keyPressed==37){b=-10}else{if(this.keyPressed==39){b=10}}}}if(b!=0||a!=0){this.pan(b,a)}}}};vxlTrackballCameraInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this.ctrlPressed=false}};vxlTrackballCameraInteractor.prototype.dolly=function(c){this.task=vxl.def.cameraTask.DOLLY;var b=this.camera;var a=2*this.MOTION_FACTOR*c/b.view.canvas.height;b.dolly(Math.pow(1.1,a));b.refresh()};vxlTrackballCameraInteractor.prototype.rotate=function(b,a){this.task=vxl.def.cameraTask.ROTATE;
var e=this.camera;var c=e.view.canvas;var d=-20/c.height;var g=-20/c.width;var f=b*g*this.MOTION_FACTOR;var h=a*d*this.MOTION_FACTOR;e.changeAzimuth(f);e.changeElevation(h);e.refresh()};vxlTrackballCameraInteractor.prototype.pan=function(j,i){this.task=vxl.def.cameraTask.PAN;var e=this.camera;var a=e.view.canvas;var d=e.view.scene;var h=Math.max(a.width,a.height);var c=1/h;var b=1/h;var g=j*c*this.MOTION_FACTOR*d.bb.max();var f=i*b*this.MOTION_FACTOR*d.bb.max();e.pan(g,f);e.refresh()};vxlPickerInteractor.prototype=new vxlCameraInteractor();function vxlPickerInteractor(a){this.plist=[];this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.hitPropertyCallback=null;this.processHitsCallback=null;this.addHitCallback=null;this.removeHitCallback=null;this.moveCallback=null;this.picking=false;this.connectTo(a)}vxlPickerInteractor.prototype.connectTo=function(a){vxlCameraInteractor.apply(this,a);if(this.camera){this.configure()}};vxlPickerInteractor.prototype.configure=function(){var c=this.camera.view.renderer.gl;
var b=512*4;var a=512*4;this.texture=c.createTexture();c.bindTexture(c.TEXTURE_2D,this.texture);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);this.renderbuffer=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a);this.framebuffer=c.createFramebuffer();
c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.texture,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.renderbuffer);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};vxlPickerInteractor.prototype.get2DCoords=function(b){var a,f,e=0,d=0,c=this.camera.view.canvas;while(c&&c.tagName!="BODY"){e+=c.offsetTop;d+=c.offsetLeft;c=c.offsetParent
}d+=window.pageXOffset;e+=window.pageYOffset;a=b.clientX-d;f=c_height-(b.clientY-e);return{x:a,y:f}};vxlPickerInteractor.prototype._compare=function(b,a){vxl.go.console("PickerInteractor: comparing object "+object.alias+" diffuse ("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+") == readout ("+b[0]+","+b[1]+","+b[2]+")");return(Math.abs(Math.round(a[0]*255)-b[0])<=1&&Math.abs(Math.round(a[1]*255)-b[1])<=1&&Math.abs(Math.round(a[2]*255)-b[2])<=1)};vxlPickerInteractor.prototype.find=function(g){var c=this.camera.view.renderer.gl;
var e=new Uint8Array(1*1*4);c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.readPixels(g.x,g.y,1,1,c.RGBA,c.UNSIGNED_BYTE,e);c.bindFramebuffer(c.FRAMEBUFFER,null);var k=false;var d=this.view.scene;if(this.hitPropertyCallback==undefined){alert("The picker needs an object property to perform the comparison");return}for(var b=0,f=d.actors.length;b<f;b+=1){var a=d.actors[b];if(a.name=="floor"){continue}var j=this.hitPropertyCallback(a);if(this._compare(e,j)){var h=this.plist.indexOf(a);if(h!=-1){this.plist.splice(h,1);
if(this.removeHitCallback){this.removeHitCallback(a)}}else{this.plist.push(a);if(this.addHitCallback){this.addHitCallback(a)}}k=true;break}}draw();return k};vxlPickerInteractor.prototype.stop=function(){if(this.processHitsCallback!=null&&this.plist.length>0){this.processHitsCallback(this.plist)}this.plist=[]};vxlPickerInteractor.prototype.onMouseUp=function(a){if(!a.shiftKey){this.stop()}};vxlPickerInteractor.prototype.onMouseDown=function(a){var b=this.get2DCoords(a);this.picking=this.find(b);if(!this.picking){this.stop()
}};vxlPickerInteractor.prototype.onMouseMove=function(c){this.lastX=this.x;this.lastY=this.y;this.x=c.clientX;this.y=c.clientY;var b=this.x-this.lastX;var a=this.y-this.lastY;if(this.picking&&this.moveCallback){this.moveCallback(this,b,a)}};vxlPickerInteractor.prototype.onKeyDown=function(a){};vxlPickerInteractor.prototype.onKeyUp=function(a){};function vxlTransforms(a){this.stack=[];this.view=a;this.mvMatrix=new vxlMatrix4x4();this.pMatrix=new vxlMatrix4x4();this.nMatrix=new vxlMatrix4x4();this.cMatrix=new vxlMatrix4x4()}vxlTransforms.prototype.calculateModelView=function(){vxl.mat4.set(this.view.cameraman.active.getViewTransform(),this.mvMatrix)};vxlTransforms.prototype.calculateNormal=function(){vxl.mat4.identity(this.nMatrix);vxl.mat4.set(this.mvMatrix,this.nMatrix);vxl.mat4.inverse(this.nMatrix);vxl.mat4.transpose(this.nMatrix)};vxlTransforms.prototype.calculatePerspective=function(){vxl.mat4.identity(this.pMatrix);
vxl.mat4.perspective(this.pMatrix,this.view.fovy,this.view.width/this.view.height,this.view.zNear,this.view.zFar)};vxlTransforms.prototype.update=function(){this.calculateModelView();this.calculatePerspective();this.calculateNormal()};vxlTransforms.prototype.updatePerspective=function(){vxl.mat4.perspective(this.transforms.pMatrix,this.view.fovy,this.view.width/this.view.height,this.view.zNear,this.view.zFar)};vxlTransforms.prototype.push=function(){var a=vxl.mat4.create();mat4.set(this.mvMatrix,a);
this.stack.push(a)};vxlTransforms.prototype.pop=function(){if(this.stack.length==0){return}this.mvMatrix=this.stack.pop()};vxl.glsl.diffusive={NAME:"diffusive",ATTRIBUTES:["aVertexPosition","aVertexColor","aVertexNormal"],UNIFORMS:["uPMatrix","uNMatrix","uMVMatrix","uOpacity","uPointSize","uUseVertexColors","uObjectColor","uUseShading","uAmbientColor","uDirectionalColor","uLightingDirection","uUseVertexColors"],VERTEX_SHADER:["attribute vec3 aVertexPosition; ","attribute vec3 aVertexNormal; ","attribute vec4 aVertexColor;","uniform mat4 uMVMatrix; ","uniform mat4 uPMatrix; ","uniform mat4 uNMatrix; ","uniform vec3 uLightingDirection;","uniform vec4 uDirectionalColor;","uniform vec4 uAmbientColor;","uniform vec4 uObjectColor;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uPointSize;","varying vec4 vColor;","varying vec4 vAux;","void main(void) {","   gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0); ","	if(uUseVertexColors) {","        vAux = aVertexColor;","   }","   else {","		 vAux = uObjectColor;","   }","   if(uUseShading) {","		vec4 transformedNormal = uNMatrix * vec4(aVertexNormal, 1.0);","	    float directionalLightWeighting = max(dot(transformedNormal.xyz,uLightingDirection),0.0);","	    vColor = vAux * (uAmbientColor + uDirectionalColor * directionalLightWeighting);","	}","   else {","		vColor = vAux;","   }","   gl_PointSize = uPointSize;","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform float uOpacity;","varying vec4  vColor;","void main(void)  {","		gl_FragColor = vec4(vColor.rgb,uOpacity);","}"].join("\n"),DEFAULTS:{uLightingDirection:[0,0.3,1],uDirectionalColor:[0.68,0.68,0.68,1],uAmbientColor:[0.24,0.24,0.24,1]}};vxl.glsl.phong={NAME:"phong",ATTRIBUTES:["aVertexPosition","aVertexNormal","aVertexColor",],UNIFORMS:["uMVMatrix","uPMatrix","uNMatrix","uShininess","uLightDirection","uLightAmbient","uLightDiffuse","uLightSpecular","uMaterialAmbient","uMaterialDiffuse","uMaterialSpecular","uOpacity","uPointSize","uUseVertexColors","uObjectColor","uUseShading",],VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","uniform mat4 uNMatrix;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec3 vAux;","void main(void) {","     vec4 vertex = uMVMatrix * vec4(aVertexPosition, 1.0);","     vNormal = vec3(uNMatrix * vec4(aVertexNormal, 1.0));","     vEyeVec = -vec3(vertex.xyz);","	if(uUseVertexColors) {","        vAux = aVertexColor;","   }","     gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","uniform float uOpacity;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec3 vAux;","void main(void)","{","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","	if(uUseVertexColors) {","        varMaterialDiffuse = vec4(vAux,uOpacity);","   }","  if(uUseShading){  ","  if(lambertTerm > 0.0)","  {","       Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","       vec3 E = normalize(vEyeVec);","       vec3 R = reflect(L, N);","       float specular = pow( max(dot(R, E), 0.0), uShininess);","       Is = uLightSpecular * uMaterialSpecular * specular;","  }","  vec4 finalColor = Ia + Id + Is;","  finalColor.a = uOpacity;","  gl_FragColor = finalColor;","  } else {","  gl_FragColor = vec4(1.0,1.0,1.0,1.0); ","  }","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,0,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}};function vxlProgram(a){this._gl=a;this._codebase={};this._webGLProgram={};this._attributeList={};this._uniformList={};this._uniformType={};this._uniform_cache={};this._currentWebGLProgram=null;this._currentProgramID="";this._currentUniformLocation={}}vxlProgram.prototype.register=function(b,a){vxl.go.console("Registering program "+b);this._codebase[b]=a};vxlProgram.prototype.isRegistered=function(a){return(this._codebase[a]!=undefined)};vxlProgram.prototype._createShader=function(a,c){var d=this._gl;
var b=null;if(a==vxl.def.VERTEX_SHADER){b=d.createShader(d.VERTEX_SHADER)}else{if(a==vxl.def.FRAGMENT_SHADER){b=d.createShader(d.FRAGMENT_SHADER)}}if(c==undefined||c==null){alert("Error getting the code for shader of type "+a)}d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS)){alert(d.getShaderInfoLog(b))}return b};vxlProgram.prototype.loadProgram=function(f){var b=this._codebase[f];var d=this._gl;var c=d.createProgram();if(b.VERTEX_SHADER){var e=this._createShader(vxl.def.VERTEX_SHADER,b.VERTEX_SHADER);
d.attachShader(c,e)}if(b.FRAGMENT_SHADER){var a=this._createShader(vxl.def.FRAGMENT_SHADER,b.FRAGMENT_SHADER);d.attachShader(c,a)}d.linkProgram(c);if(!d.getProgramParameter(c,d.LINK_STATUS)){alert("Program: Could not link the shading program")}else{vxl.go.console("Program: the program "+f+" has been loaded")}this._webGLProgram[f]=c};vxlProgram.prototype.isLoaded=function(a){return(this._webGLProgram[a]!=undefined)};vxlProgram.prototype._parseUniforms=function(d){vs=this._codebase[this._currentProgramID].VERTEX_SHADER;
fs=this._codebase[this._currentProgramID].FRAGMENT_SHADER;uNames=this._codebase[this._currentProgramID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var b=uNames[a];var c=new RegExp("uniform.*"+b,"g");if(vs.search(c)!=-1){uTypes[b]=vs.substring(vs.search(c),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(c)!=1){uTypes[b]=fs.substring(fs.search(c),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]}else{alert("Program: In the program "+this._currentProgramID+" the uniform "+b+" is listed but not used")
}}}this._uniformList[this._currentProgramID]=uNames;this._uniformType[this._currentProgramID]=uTypes};vxlProgram.prototype.useProgram=function(c){var b=this._gl;var a=this._webGLProgram[c];if(c in this._webGLProgram){b.linkProgram(a);b.useProgram(a);this._currentWebGLProgram=a;this._currentProgramID=c;this._parseUniforms();vxl.go.console("Program: the program "+c+" has been linked and is the current program")}else{alert("Program: the program "+c+" has NOT been loaded")}};vxlProgram.prototype.loadDefaults=function(){var b=this._codebase[this._currentProgramID];
if("DEFAULTS" in b){vxl.go.console("Program: defaults for program "+this._currentProgramID+" found. Loading..");var c=b.DEFAULTS;for(var a in c){this.setUniform(a,c[a]);vxl.go.console("Program: Uniform:"+a+", Default Value:"+c[a])}}else{vxl.go.console("Program: WARNING: defaults for program "+this._currentProgramID+" NOT found")}};vxlProgram.prototype.setUniforms=function(a){for(uni in a){this.setUniform(uni,a[uni])}};vxlProgram.prototype.setUniform=function(e,d,f){var b=this._currentWebGLProgram;
var c=this._uniformList[this._currentProgramID];var a=this._currentUniformLocation;var g=this._uniform_cache;if(c.hasObject(e)){a[e]=this._gl.getUniformLocation(b,e)}else{alert("Program: the uniform "+e+" is not defined for the program "+this._currentProgramID);return}g[e]=d;this._setPolymorphicUniform(e,a[e],d,f)};vxlProgram.prototype.getUniform=function(a){return this._uniform_cache[a]};vxlProgram.prototype._getAttributeLocation=function(a){if(!(a in this._attributeList)){this._attributeList[a]=this._gl.getAttribLocation(this._currentWebGLProgram,a)
}return this._attributeList[a]};vxlProgram.prototype._setPolymorphicUniform=function(d,b,c,f){var e=this._gl;var a=this._uniformType[this._currentProgramID][d];if(a=="bool"){e.uniform1i(b,c);return}else{if(a=="float"){e.uniform1f(b,c);return}else{if(a=="int"){e.uniform1i(b,c);return}else{if(a=="mat4"){if(!(c instanceof vxlMatrix4x4)){vxl.go.console("Program: the uniform "+d+" is defined as mat4 in GLSL. However the JS variable is not.")}e.uniformMatrix4fv(b,false,c.getAsFloat32Array());return}else{if(c instanceof Array){if(f=="int"){switch(c.length){case 1:e.uniform1iv(b,c);
break;case 2:e.uniform2iv(b,c);break;case 3:e.uniform3iv(b,c);break;case 4:e.uniform4iv(b,c);break;default:alert("ERROR")}}else{switch(c.length){case 1:e.uniform1fv(b,c);break;case 2:e.uniform2fv(b,c);break;case 3:e.uniform3fv(b,c);break;case 4:e.uniform4fv(b,c);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+d+" could not be mapped")}}}}}};vxlProgram.prototype.setVertexAttribPointer=function(d,b,f,e,g,h){var c=this._getAttributeLocation(d);this._gl.vertexAttribPointer(c,b,f,e,g,h)
};vxlProgram.prototype.enableVertexAttribArray=function(c){var b=this._getAttributeLocation(c);this._gl.enableVertexAttribArray(b)};vxlProgram.prototype.disableVertexAttribArray=function(c){var b=this._getAttributeLocation(c);this._gl.disableVertexAttribArray(b)};vxlProgram.prototype.setMatrixUniform=function(c,a){var b=this._gl.getUniformLocation(this._currentWebGLProgram,c);this._gl.uniformMatrix4fv(b,false,a.getAsFloat32Array())};function vxlRenderer(a){this.renderRate=vxl.def.renderer.rate.NORMAL;this.mode=vxl.def.renderer.mode.TIMER;this.timerID=0;this.view=a;this.gl=this.getWebGLContext();this.prg=new vxlProgram(this.gl);this.setDefaultProgram();this.transforms=new vxlTransforms(a)}vxlRenderer.prototype.getWebGLContext=function(){var d=null;var b=this.view.canvas;this.width=b.width;this.height=b.height;var g=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(var c=0;c<g.length;++c){try{d=b.getContext(g[c])}catch(f){}if(d){break
}}if(d==null){alert("Could not intiailise WebGL");throw ("Could not initialise WebGL");return}else{var a=d;a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.depthFunc(a.LEQUAL)}return d};vxlRenderer.prototype.setDefaultProgram=function(){this.setProgram(vxl.glsl.diffusive.NAME,vxl.glsl.diffusive)};vxlRenderer.prototype.setProgram=function(c,b){var a=this.prg;if(!a.isRegistered(c)){a.register(c,b)}if(!a.isLoaded(c)){a.loadProgram(c)}a.useProgram(c);a.loadDefaults()
};vxlRenderer.prototype.clear=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.gl.viewport(0,0,this.view.canvas.width,this.view.canvas.height);this.transforms.calculatePerspective()};vxlRenderer.prototype.start=function(){if(this.mode==vxl.def.renderer.mode.TIMER){this.timerID=setInterval((function(a){return function(){a.render()}})(this),this.renderRate)}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){message("Renderer for animation invoked")}}};vxlRenderer.prototype.stop=function(){if(this.mode==vxl.def.renderer.mode.TIMER){clearInterval(this.timerID)
}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){}}};vxlRenderer.prototype.setRenderRate=function(a){this.renderRate=a;this.stop();if(this.animation&&this.animation.running){this.animation.stop();this.animation.start()}if(a==null||a<=0){return}else{this.mode=vxl.def.renderer.mode.TIMER;message("Renderer: view["+this.view.name+"] mode = TIMER, render rate = "+a)}this.start()};vxlRenderer.prototype.clearColor=function(a){this.gl.clearColor(a[0],a[1],a[2],1)};vxlRenderer.prototype.clearDepth=function(a){this.gl.clearDepth(a)
};vxlRenderer.prototype._setMatrices=function(){this.transforms.update();var a=this.prg;a.setUniform("uMVMatrix",this.transforms.mvMatrix);a.setUniform("uPMatrix",this.transforms.pMatrix);a.setUniform("uNMatrix",this.transforms.nMatrix)};vxlRenderer.prototype.render=function(){var a=this.view.scene;this.view.prepareForRendering();this._setMatrices();a.render(this)};function vxlModel(a){this.name=a;this.indices=null;this.vertices=null;this.scalars=null;this.diffuse=null;this.normals=null;this.wireframe=null;this.centre=null;this.outline=null}vxlModel.prototype.load=function(a,b){this.name=a;if(b.obj_name!=null){this.name=b.obj_name}this.vertices=b.vertices;this.indices=b.indices;this.diffuse=b.diffuse;this.scalars=b.scalars;this.wireframe=b.wireframe;this.colors=b.colors;if(!this.normals&&!this.wireframe){this.getNormals()}if(!this.color){this.color=vxl.def.modelColor.slice(0)
}if(this.wireframe==null){this.getWireframeIndices()}this.getOutline();this.getCentre()};vxlModel.prototype.getNormals=function(e){if(e==undefined){e=false}var o=this.vertices;var a=this.indices;var l=0;var g=1;var f=2;var h=[];for(var b=0;b<o.length;b=b+3){h[b+l]=0;h[b+g]=0;h[b+f]=0}for(var b=0;b<a.length;b=b+3){var m=[];var k=[];var d=[];m[l]=o[3*a[b+2]+l]-o[3*a[b+1]+l];m[g]=o[3*a[b+2]+g]-o[3*a[b+1]+g];m[f]=o[3*a[b+2]+f]-o[3*a[b+1]+f];k[l]=o[3*a[b]+l]-o[3*a[b+1]+l];k[g]=o[3*a[b]+g]-o[3*a[b+1]+g];
k[f]=o[3*a[b]+f]-o[3*a[b+1]+f];d[l]=m[g]*k[f]-m[f]*k[g];d[g]=m[f]*k[l]-m[l]*k[f];d[f]=m[l]*k[g]-m[g]*k[l];if(e){d[l]=-d[l];d[g]=-d[g];d[f]=-d[f]}for(j=0;j<3;j++){h[3*a[b+j]+l]=h[3*a[b+j]+l]+d[l];h[3*a[b+j]+g]=h[3*a[b+j]+g]+d[g];h[3*a[b+j]+f]=h[3*a[b+j]+f]+d[f]}}for(var b=0;b<o.length;b=b+3){var n=[];n[l]=h[b+l];n[g]=h[b+g];n[f]=h[b+f];var c=Math.sqrt((n[l]*n[l])+(n[g]*n[g])+(n[f]*n[f]));if(c==0){c=1}n[l]=n[l]/c;n[g]=n[g]/c;n[f]=n[f]/c;h[b+l]=n[l];h[b+g]=n[g];h[b+f]=n[f]}this.normals=h};vxlModel.prototype.getWireframeIndices=function(){var d=this.indices;
var c=[];var a=0;for(var b=0;b<d.length;b=b+3){c[a]=d[b];c[a+1]=d[b+1];c[a+2]=d[b+1];c[a+3]=d[b+2];c[a+4]=d[b+2];c[a+5]=d[b];a=a+6}this.wireframe=c};vxlModel.prototype.getCentre=function(){var a=this.outline;var b=[0,0,0];b[0]=(a[3]+a[0])/2;b[1]=(a[4]+a[1])/2;b[2]=(a[5]+a[2])/2;this.centre=b};vxlModel.prototype.getOutline=function(){var c=this.vertices;var b=[c[0],c[1],c[2],c[0],c[1],c[2]];for(var a=0;a<c.length;a=a+3){b[0]=Math.min(b[0],c[a]);b[1]=Math.min(b[1],c[a+1]);b[2]=Math.min(b[2],c[a+2]);
b[3]=Math.max(b[3],c[a]);b[4]=Math.max(b[4],c[a+1]);b[5]=Math.max(b[5],c[a+2])}this.outline=b};function vxlActor(a){if(a){this.model=a;this.name=a.name;this.diffuse=a.diffuse}this.buffer={vertex:null,normal:null,color:null,index:null};this.renderers=[];this.buffers=[];this.matrix=new vxlMatrix4x4();this.allocated=false;this.visible=true;this.mode=vxl.def.visMode.SOLID;this.opacity=1;this.colors=a?(a.colors!=null?a.colors:null):null}vxlActor.prototype.allocate=function(c){if(this.renderers.indexOf(c)!=-1){return}vxl.go.console("Actor: Allocating actor "+this.model.name+" for view "+c.view.name);
var d=c.gl;var b=this.model;var a={};a.vertex=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,a.vertex);d.bufferData(d.ARRAY_BUFFER,new Float32Array(b.vertices.slice(0)),d.STATIC_DRAW);if(b.normals){a.normal=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,a.normal);d.bufferData(d.ARRAY_BUFFER,new Float32Array(b.normals.slice(0)),d.STATIC_DRAW)}if(b.scalars||b.colors){a.color=d.createBuffer()}d.bindBuffer(d.ARRAY_BUFFER,null);if(b.indices){a.index=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.index);
d.bufferData(d.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.indices.slice(0)),d.STATIC_DRAW)}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);this.renderers.push(c);this.buffers.push(a)};vxlActor.prototype.deallocate=function(){var a=this.buffer;this.buffer.vertex=null;this.buffer.normal=null;this.buffer.color=null;this.buffer.index=null;throw ("exception")};vxlActor.prototype.render=function(f){if(!this.visible){return}var a=this.renderers.indexOf(f);var c=this.model;var b=this.buffers[a];var g=f.gl;var e=f.prg;
e.setUniform("uOpacity",this.opacity);e.setUniform("uObjectColor",this.diffuse);e.setUniform("uUseVertexColors",false);e.disableVertexAttribArray("aVertexColor");e.disableVertexAttribArray("aVertexNormal");e.enableVertexAttribArray("aVertexPosition");try{g.bindBuffer(g.ARRAY_BUFFER,b.vertex);g.bufferData(g.ARRAY_BUFFER,new Float32Array(c.vertices.slice(0)),g.STATIC_DRAW);e.setVertexAttribPointer("aVertexPosition",3,g.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description);
throw ("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the vertex buffer. Error ="+d.description)}if(this.colors){try{e.setUniform("uUseVertexColors",true);g.bindBuffer(g.ARRAY_BUFFER,b.color);g.bufferData(g.ARRAY_BUFFER,new Float32Array(this.colors.slice(0)),g.STATIC_DRAW);e.enableVertexAttribArray("aVertexColor");e.setVertexAttribPointer("aVertexColor",4,g.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the color buffer. Error ="+d.description);
throw ("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the color buffer. Error ="+d.description)}}if(c.normals){try{g.bindBuffer(g.ARRAY_BUFFER,b.normal);g.bufferData(g.ARRAY_BUFFER,new Float32Array(c.normals.slice(0)),g.STATIC_DRAW);e.enableVertexAttribArray("aVertexNormal");e.setVertexAttribPointer("aVertexNormal",3,g.FLOAT,false,0,0)}catch(d){alert("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the normal buffer. Error ="+d.description);
throw ("There was a problem while rendering the actor ["+this.name+"]. The problem happened while handling the normal buffer. Error ="+d.description)}}try{if(this.mode==vxl.def.visMode.SOLID){e.setUniform("uUseShading",true);e.enableVertexAttribArray("aVertexNormal");g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,b.index);g.drawElements(g.TRIANGLES,c.indices.length,g.UNSIGNED_SHORT,0)}else{if(this.mode==vxl.def.visMode.WIREFRAME){e.setUniform("uUseShading",false);e.disableVertexAttribArray("aVertexNormal");
g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,b.index);g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices.slice(0)),g.STATIC_DRAW);g.drawElements(g.LINES,c.indices.length,g.UNSIGNED_SHORT,0)}else{if(this.mode==vxl.def.visMode.POINTS){e.setUniform("uUseShading",true);e.enableVertexAttribArray("aVertexNormal");g.drawArrays(g.POINTS,0,this.model.vertices.length/3)}else{alert("There was a problem while rendering the actor ["+this.name+"]. The visualization mode: "+this.mode+" is not valid.");throw ("There was a problem while rendering the actor ["+this.name+"]. The visualization mode: "+this.mode+" is not valid.")
}}}g.bindBuffer(g.ARRAY_BUFFER,null);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)}catch(d){alert("Error rendering actor ["+this.name+"]. Error ="+d.description);throw ("Error rendering actor ["+this.name+"]. Error ="+d.description)}};vxlActor.prototype.setColor=function(a){this.color=a.slice(0);vxl.go.console("Actor "+this.name+": color changed to : ("+this.color[0]+","+this.color[1]+","+this.color[2]+")")};vxlActor.prototype.setLookupTable=function(d,c,a){if(this.model.scalars){var b=vxl.go.lookupTableManager.get(d);
this.colors=b.getColors(this.model.scalars,c,a)}};vxlActor.prototype.setMode=function(a){this.mode=a};vxlActor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.opacity=a}else{throw"The opacity value is not valid"}};vxlActor.prototype.flipNormals=function(){this.model.getNormals(true)};vxlActor.prototype.setVisible=function(a){this.visible=a};vxlActor.prototype.isVisible=function(){return this.visible};function vxlScene(){this.views=[];this.actors=[];this.loadingMode=vxl.def.loadingMode.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.dispatchRate=500;this.scalarMIN=Number.MAX_VALUE;this.scalarMAX=Number.MIN_VALUE;this.bb=[];this.centre=[];this.axisActor=new vxlAxis();this.boundingBoxActor=new vxlBoundingBox();this.floorActor=new vxlFloor();this.actors.push(this.axisActor);this.actors.push(this.boundingBoxActor);this.actors.push(this.floorActor);vxl.c.scene=this;vxl.go.notifier.addTarget(vxl.events.MODELS_LOADED,this);
vxl.go.notifier.addTarget(vxl.events.DEFAULT_LUT_LOADED,this);vxl.go.notifier.addSource(vxl.events.SCENE_UPDATED,this)}vxlScene.prototype.handleEvent=function(a,b){if(a==vxl.events.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}if(a==vxl.events.DEFAULT_LUT_LOADED){this.lutID="default";this.setLookupTable(this.lutID)}};vxlScene.prototype.setLoadingMode=function(a){if(a==undefined||a==null||(a!=vxl.def.loadingMode.LIVE&&a!=vxl.def.loadingMode.LATER&&a!=vxl.def.loadingMode.DETACHED)){throw ("the mode "+a+"is not a valid loading mode")
}this.loadingMode=a};vxlScene.prototype.updateMetrics=function(a){vxl.go.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");var c=this.bb;var d=this.centre;c[0]=Math.min(c[0],a[0]);c[1]=Math.min(c[1],a[1]);c[2]=Math.min(c[2],a[2]);c[3]=Math.max(c[3],a[3]);c[4]=Math.max(c[4],a[4]);c[5]=Math.max(c[5],a[5]);d[0]=(c[3]+c[0])/2;d[1]=(c[4]+c[1])/2;d[2]=(c[5]+c[2])/2;d[0]=Math.round(d[0]*1000)/1000;d[1]=Math.round(d[1]*1000)/1000;d[2]=Math.round(d[2]*1000)/1000;
this.axisActor.setCentre(this.centre);this.boundingBoxActor.setBoundingBox(this.bb)};vxlScene.prototype.computeMetrics=function(){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];for(var a=0;a<this.actors.length;a++){if(this.actors[a].witness){continue}this.updateMetrics(this.actors[a].model.outline)}};vxlScene.prototype.createActor=function(a){var b=new vxlActor(a);if(this.normalsFlipped){b.flipNormals(true)}if(this.lutID!=null){b.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this.actors.push(b);
this.updateMetrics(b.model.outline);vxl.go.console("Scene: Actor for model "+a.name+" created");vxl.go.notifier.fire(vxl.events.SCENE_UPDATED);return b};vxlScene.prototype.createActors=function(b){vxl.go.console("Scene: Creating all the actors now");for(var a=0;a<b.length;a++){this.createActor(b[a])}};vxlScene.prototype.addActor=function(a){this.actors.push(a);this.updateMetrics(a.model.outline);vxl.go.notifier.fire(vxl.events.UPDATED_SCENE)};vxlScene.prototype.removeActor=function(b){var a=this.actors.indexOf(b);
this.actors.splice(a,1);this.computeMetrics()};vxlScene.prototype.updateScalarRange=function(){for(var a=0;a<this.actors.length;a++){var b=this.actors[a];if(b.model.scalars&&b.model.scalars.max()>this.scalarMAX){this.scalarMAX=b.model.scalars.max()}if(b.model.scalars&&b.model.scalars.min()<this.scalarMIN){this.scalarMIN=b.model.scalars.min()}}};vxlScene.prototype.setLookupTable=function(c){this.lutID=c;for(var a=0;a<this.actors.length;a++){var b=this.actors[a];if(b.setLookupTable){b.setLookupTable(c,this.scalarMIN,this.scalarMAX)
}}};vxlScene.prototype.reset=function(){for(var a=0;a<this.actors.length;a++){this.actors[a]=null}this.actors=[];vxl.c.actor=null;this.actors.push(this.axisActor);this.actors.push(this.boundingBoxActor);this.computeMetrics()};vxlScene.prototype.getActorByName=function(a){for(var b=0;b<this.actors.length;b++){if(this.actors[b].name==a){return this.actors[b]}}return null};vxlScene.prototype.setOpacity=function(d,a){if(a==null){for(var b=0;b<this.actors.length;b++){this.actors[b].setOpacity(d)}}else{var c=this.getActorByName(a);
c.setOpacity(d)}};vxlScene.prototype.flipNormals=function(a){this.normalsFlipped=a;for(var b=0;b<this.actors.length;b++){this.actors[b].flipNormals(a)}};vxlScene.prototype.setColor=function(e,a){if(a==null){vxl.go.console("Scene: set color for all actors");for(var b=0;b<this.actors.length;b++){this.actors[b].setColor(e)}}else{vxl.go.console("Scene: set color for active actor:"+a);var d=this.getActorByName(a);d.setColor(e)}};vxlScene.prototype.setVisualizationMode=function(b){if(b==null||b==undefined){return
}for(var a=0;a<this.actors.length;a++){this.actors[a].setVisualizationMode(b)}};vxlScene.prototype.render=function(g){for(var c=0,e=this.views.length;c<e;c+=1){var f=this.views[c].renderer;for(var b=0,d=this.actors.length;b<d;b+=1){this.actors[b].allocate(f);this.actors[b].render(f)}}};function vxlLookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE}vxlLookupTable.prototype.load=function(a,c){this.ID=a;this.map=c;for(var b in this.map){var d=Number(b);if(d<this.min){this.min=d}else{if(d>=this.max){this.max=d}}}};vxlLookupTable.prototype.getColor=function(d){var a=this;var b=Math.round(d);if(b>=a.min&&b<=a.max){var e=[a.map[b][0],a.map[b][1],a.map[b][2],1];return e}else{if(b<a.min){return[a.map[a.min][0],a.map[a.min][1],a.map[a.min][2],1]}else{if(b>a.max){return[a.map[a.max][0],a.map[a.max][1],a.map[a.max][2],1]
}else{alert("assertion error in getColor routine");return[a.map[a.min][0],a.map[a.min][1],a.map[a.min][2],1]}}}};vxlLookupTable.prototype.getColors=function(e,d,a){var h=[];for(var b=0;b<e.length;b++){var f=e[b]*this.max/a;var g=this.getColor(f);h.push(g[0]);h.push(g[1]);h.push(g[2]);h.push(g[3])}return h};function vxlLookupTableManager(){this.lutTimerID=0;this.tables=[];vxl.go.notifier.addSource(vxl.events.DEFAULT_LUT_LOADED,this);this.loadAll()}vxlLookupTableManager.prototype.load=function(b){var a=this;if(this.isLoaded(b)){return}var c=new XMLHttpRequest();c.open("GET",vxl.def.lutFolder+"/"+b+".lut");c.onreadystatechange=function(){if(c.readyState==4){if(c.status==404){alert(b+" does not exist");vxl.go.console("LookupTableManager: "+b+" does not exist")}else{a.handle(b,JSON.parse(c.responseText))
}}};c.send()};vxlLookupTableManager.prototype.handle=function(a,c){var b=new vxlLookupTable();b.load(a,c);this.tables.push(b);if(b.ID==vxl.def.lut){vxl.go.notifier.fire(vxl.events.DEFAULT_LUT_LOADED)}};vxlLookupTableManager.prototype.isLoaded=function(a){for(var b=0;b<this.tables.length;b++){if(this.tables[b].ID==a){return true}}return false};vxlLookupTableManager.prototype.get=function(a){for(var b=0;b<this.tables.length;b++){if(this.tables[b].ID==a){return this.tables[b]}}return null};vxlLookupTableManager.prototype.getAllLoaded=function(){var b=[];
for(var a=0;a<this.tables.length;a++){b[a]=this.tables[a].ID}return b};vxlLookupTableManager.prototype.allLoaded=function(){return(vxl.def.luts.length==this.tables.length)};vxlLookupTableManager.prototype.loadAll=function(){for(var a=0;a<vxl.def.luts.length;a++){this.load(vxl.def.luts[a])}};vxl.go.lookupTableManager=new vxlLookupTableManager();if(vxl.def.model==undefined){vxl.def.model={}}vxl.def.model.boundingBox=new vxlModel();vxl.def.model.boundingBox.load("bounding box",{vertices:[],indices:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],diffuse:[1,1,1,1]});vxlBoundingBox.prototype=new vxlActor();vxlBoundingBox.prototype.constructor=vxlBoundingBox;function vxlBoundingBox(){vxlActor.call(this,vxl.def.model.boundingBox);this.bb=[];this.mode=vxl.def.visMode.WIREFRAME;this.visible=false;this.witness=true}vxlBoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];
this.model.vertices=this.bb};if(vxl.def.model==undefined){vxl.def.model={}}vxl.def.model.axis=new vxlModel();vxl.def.model.axis.load("axis",{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],indices:[0,1,2,3,4,5],colors:[1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1]});vxlAxis.prototype=new vxlActor();vxlAxis.prototype.constructor=vxlAxis;function vxlAxis(){vxlActor.call(this,vxl.def.model.axis);this.centre=[0,0,0];this.mode=vxl.def.visMode.WIREFRAME;this.visible=false;this.witness=true}vxlAxis.prototype.setCentre=function(c){var b=c[0];
var e=c[1];var d=c[2];this.centre[0]=b;this.centre[1]=e;this.centre[2]=d;var a=this.model.vertices;a[0]=b-1;a[1]=e;a[2]=d;a[3]=b+1;a[4]=e;a[5]=d;a[6]=b;a[7]=e-2;a[8]=d;a[9]=b;a[10]=e+2;a[11]=d;a[12]=b;a[13]=e;a[14]=d-1;a[15]=b;a[16]=e;a[17]=d+1};if(vxl.def.model==undefined){vxl.def.model={}}vxl.def.model.floor=new vxlModel();vxl.def.model.floor.load("floor",{vertices:[],indices:[],diffuse:[1,1,1,1]});vxlFloor.prototype=new vxlActor();vxlFloor.prototype.constructor=vxlFloor;function vxlFloor(){vxlActor.call(this,vxl.def.model.floor);this.mode=vxl.def.visMode.WIREFRAME;this.visible=false;this.witness=true}vxlFloor.prototype.setGrid=function(g,h){var f=g;var b=2*f/h;var e=2*f/b;var c=[];var d=[];for(var a=0;a<=b;a++){c[6*a]=-f;c[6*a+1]=0;c[6*a+2]=-f+(a*e);
c[6*a+3]=f;c[6*a+4]=0;c[6*a+5]=-f+(a*e);c[6*(b+1)+6*a]=-f+(a*e);c[6*(b+1)+6*a+1]=0;c[6*(b+1)+6*a+2]=-f;c[6*(b+1)+6*a+3]=-f+(a*e);c[6*(b+1)+6*a+4]=0;c[6*(b+1)+6*a+5]=f;d[2*a]=2*a;d[2*a+1]=2*a+1;d[2*(b+1)+2*a]=2*(b+1)+2*a;d[2*(b+1)+2*a+1]=2*(b+1)+2*a+1}this.model.vertices=c.slice(0);this.model.indices=d.slice(0);this.visible=true};function vxlView(b,a){this.name=b;this.canvas=document.getElementById(this.name);if(this.canvas==null){alert("The canvas "+b+" does not exist.");throw ("The canvas "+b+" does not exist.")}this.ready=false;this.width=this.canvas.width;this.height=this.canvas.height;this.clearDepth=10000;this.zNear=0.1;this.zFar=10000;this.fovy=10;this.backgroundColor=vxl.def.backgroundColor.slice(0);this.ambientColor=vxl.def.ambientColor.slice(0);this.renderer=new vxlRenderer(this);this.setBackgroundColor(this.backgroundColor);
this.setClearDepth(this.clearDepth);this.cameraman=new vxlCameraManager(this);this.listener=new vxlViewListener(this);if(a!=null&&a instanceof vxlScene){this.scene=a}else{if(vxl.c.scene){this.scene=vxl.c.scene}else{this.scene=new vxlScene()}}this.scene.views.push(this);vxl.go.notifier.addTarget(vxl.events.SCENE_UPDATED,this);vxl.go.notifier.addTarget(vxl.events.DEFAULT_LUT_LOADED,this);this.ready=true;vxl.go.console("vxlView: the view "+this.name+" has been created")}vxlView.prototype.handleEvent=function(a,b){vxl.go.console("vxlView: receiving event "+a);
if(a==vxl.events.DEFAULT_LUT_LOADED){this.scene.setLookupTable(vxl.def.lut)}if(a==vxl.events.SCENE_UPDATED){this.cameraman.getActiveCamera().longShot()}};vxlView.prototype.clear=function(){this.renderer.clear()};vxlView.prototype.resize=function(){this.width=this.canvas.width;this.height=this.canvas.height};vxlView.prototype.prepareForRendering=function(){if(!this.ready){return}this.resize();this.clear()};vxlView.prototype.start=function(){this.renderer.start();this.refresh()};vxlView.prototype.stop=function(){this.renderer.stop()
};vxlView.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();this.start()};vxlView.prototype.setBackgroundColor=function(a){this.backgroundColor=a.slice(0);this.renderer.clearColor(this.backgroundColor)};vxlView.prototype.setAmbientColor=function(a){this.ambientColor=a.slice(0);this.renderer.prg.setUniform("uAmbientColor",this.ambientColor)};vxlView.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};vxlView.prototype.refresh=function(){this.renderer.render()
};function vxlAssetManager(){this.firstLoadedModel=false;this.toLoad=new Array();this.assets=[];vxl.go.notifier.addSource(vxl.events.MODELS_LOADED,this)}vxlAssetManager.prototype.add=function(b,a,c){this.createAsset(b,a,c)};vxlAssetManager.prototype.load=function(a,d){var b=this;if(b.isModelLoaded(a)){return}vxl.go.console("AssetManager: Requesting "+a+"...");var c=new XMLHttpRequest();c.open("GET",vxl.def.modelsFolder+"/"+a);c.onreadystatechange=function(){if(c.readyState==4){if(c.status==404){alert("vxl.go.assetManager says: "+a+" does not exist")
}else{b.createAsset(a,JSON.parse(c.responseText),d)}}};c.send()};vxlAssetManager.prototype.loadList=function(b,c){this.toLoad=b.slice(0);vxl.go.console("models to load: "+this.toLoad.length);for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],c)}};vxlAssetManager.prototype.createAsset=function(b,d,c){var a=new vxlModel();a.load(b,d);if(!this.firstLoadedModel){c.bb=a.outline;this.firstLoadedModel=true}a.loaded=true;this.assets.push(a);vxl.go.console("AssetManager: asset "+a.name+" created.");
if(c!=undefined&&c instanceof vxlScene){vxl.go.console("AssetManager: notifying the scene...");if(c.loadingMode==vxl.def.loadingMode.LIVE){c.createActor(a)}else{if(c.loadingMode==vxl.def.loadingMode.LATER){if(assetManager.allLoaded()){c.createActors(assetManager.assets)}}else{if(c.loadingMode==vxl.def.loadingMode.DETACHED){}}}}if(this.allLoaded()){vxl.go.notifier.fire(vxl.events.MODELS_LOADED)}};vxlAssetManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.assets.length;
a++){this.assets[a]=null}this.assets=[];this.toLoad=[]};vxlAssetManager.prototype.isModelLoaded=function(a){for(var b=0;b<this.assets.length;b++){if(this.assets[b].name==a){return true}}return false};vxlAssetManager.prototype.allLoaded=function(){return(this.assets.length==this.toLoad.length)};vxlAssetManager.prototype.getAssetByName=function(b){for(var c=0,a=this.assets.length;c<a;c+=1){if(this.assets[c].name==b){return this.assets[c]}}return null};vxl.go.assetManager=new vxlAssetManager();vxl.api=new api();function api(){}api.prototype.setup=function(a,b){if(b!=null&&!(b instanceof vxlScene)){throw ("api.setup: scene parameter is invalid")}return new vxlView(a,b)};api.prototype.setRenderRate=function(a){vxl.c.view.renderer.setRenderRate(a)};api.prototype.setCameraDistance=function(a){g_fovy=a;vxl.go.console("fovY = "+a)};api.prototype.setActiveView=function(b){if(b instanceof vxlView){vxl.c.view=b}};api.prototype.getActiveView=function(){return vxl.c.view};api.prototype.setActiveActor=function(b){if(b instanceof vxlActor){vxl.c.actor=b
}};api.prototype.getActiveActor=function(){return vxl.c.actor};api.prototype.setActiveCamera=function(b){if(b instanceof vxlCamera){vxl.c.camera=b}};api.prototype.getActiveCamera=function(){return vxl.c.camera};api.prototype.setLookupTable=function(a){if(!vxl.go.lookupTableManager.isLoaded(a)){vxl.go.console("Lookup Table "+a+" has not been loaded");return}vxl.c.view.scene.setLookupTable(a)};api.prototype.loadLUTS=function(){vxl.go.lookupTableManager.loadAll()};api.prototype.resetScene=function(){if(vxl.c.animation){vxl.c.animation.stop()
}vxl.c.view.reset();vxl.go.assetManager.reset()};api.prototype.loadAssets=function(c,e,d){var d=d==null?vxl.c.scene:d;var b=[];if(typeof(c)=="string"||c instanceof String){b.push(c)}else{if(c instanceof Array){for(var a=0;a<c.length;a++){b.push(c[a])}}}if(e!=undefined&&e!=null){d.setLoadingMode(e)}vxl.go.assetManager.loadList(b,d)};api.prototype.axisON=function(){vxl.c.view.scene.axis.setVisible(true);vxl.c.camera.refresh()};api.prototype.axisOFF=function(){vxl.c.view.scene.axis.setVisible(false);
vxl.c.camera.refresh()};api.prototype.boundingBoxON=function(){vxl.c.view.scene.boundingBox.visible=true;vxl.c.camera.refresh()};api.prototype.boundingBoxOFF=function(){vxl.c.view.scene.boundingBox.visible=false;vxl.c.camera.refresh()};api.prototype.toggleSpin=function(){vxl.c.camera.spin()};api.prototype.setAmbientColor=function(d,c,a){vxl.c.view.setAmbientColor([d,c,a])};api.prototype.setBackgroundColor=function(d,c,a){vxl.c.view.setBackgroundColor([d,c,a])};api.prototype.setAmbientLight=function(a){this.setAmbientColor(a,a,a);
vxl.c.view.refresh();vxl.go.console("API:Ambient light changed to "+(a*100)+"%");return true};api.prototype.wireframeON=function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.visMode.WIREFRAME)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.visMode.WIREFRAME)}vxl.go.console("API:Wireframe is shown.")};api.prototype.surfaceON=function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.visMode.SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.visMode.SOLID)}vxl.go.console("API:Wireframe is hidden.")
};api.prototype.pointsON=function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.visMode.POINTS)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.visMode.POINTS)}};api.prototype.setActorOpacity=function(b){var a=Math.min(Math.max(0,Math.abs(b)),1);if(vxl.c.actor){vxl.c.actor.setOpacity(b)}else{vxl.c.view.scene.setOpacity(a)}vxl.c.view.refresh();vxl.go.console("API:Opacity changed to "+(b*100)+"%")};api.prototype.setActorColor=function(e,d,a){var c=[e,d,a];if(vxl.c.actor){vxl.c.actor.setColor(c)
}else{vxl.c.view.scene.setColor(c)}vxl.c.view.refresh()};api.prototype.flipActorNormals=function(a){if(vxl.c.actor){vxl.c.actor.flipNormals(a)}else{vxl.c.view.scene.flipNormals(a)}vxl.c.view.refresh()};api.prototype.stopAnimation=function(){if(vxl.c.animation!=null){vxl.c.view.stop()}};api.prototype.startAnimation=function(){if(vxl.c.animation!=null){vxl.c.view.start()}};api.prototype.setFrame=function(c){if(vxl.c.animation==null){return}var b=vxl.c.animation;b.stop();if(c>=1){b.setFrame(c)}else{vxl.go.console("API:frame "+c+" does not exist. Animation goes back to the beginning");
b.setFrame(1)}};api.prototype.clearAnimation=function(){if(vxl.c.animation){vxl.c.animation.stop();vxl.c.animation=null;vxl.c.view.animation=null}};api.prototype.resetCamera=function(){vxl.c.camera.reset()};api.prototype.saveCamera=function(){vxl.c.camera.save()};api.prototype.retrieveCamera=function(){vxl.c.camera.retrieve()};api.prototype.setAzimuth=function(b){vxl.c.camera.changeAzimuth(b)};api.prototype.setElevation=function(a){vxl.c.camera.changeElevation(a)};api.prototype.go_above=function(){vxl.c.camera.above()
};api.prototype.go_below=function(){vxl.c.camera.below()};api.prototype.go_left=function(){vxl.c.camera.left()};api.prototype.go_right=function(){vxl.c.camera.right()};api.prototype.getLookupTables=function(){return vxl.go.lookupTableManager.getAllLoaded()};api.prototype.loadProgram=function(a){vxl.c.view.renderer.setProgram(a.NAME,a)};function vxlAnimation(){this.timerID=0;this.view=null;this.map=[];this.activeFrame=1;this.mark=1;this.running=false;this.frameCount=0}vxlAnimation.prototype.setup=function(d,c,a){this.activeFrame=1;this.view=d;this.view.animation=this;for(var b=0;b<c.length;b++){this.addModelToFrame(c[b],a[b])}vxl.go.console("animation setup")};vxlAnimation.prototype.start=function(){if(!this.view){alert("animation not initiated to any view");return}this.running=true;this.timerID=setInterval((function(a){return function(){a.nextFrame()
}})(this),500)};vxlAnimation.prototype.stop=function(){clearInterval(this.timerID);this.running=false};vxlAnimation.prototype.addModelToFrame=function(a,b){if(typeof(this.map[b])=="undefined"){this.map[b]=new Array()}this.map[b].push(a);if(b>this.frameCount){this.frameCount=b}};vxlAnimation.prototype.render=function(){if(!this.running){return}for(var b=0;b<this.map[this.activeFrame].length;b++){var a=this.map[this.activeFrame][b];var c=this.view.actorManager.getActorByName(a);if(c!=null){c.allocate(this.view.renderer);
c.render(this.view.renderer)}}};vxlAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)};vxlAnimation.prototype.allocateFrame=function(d){if(!this.isValidFrame(d)){return}for(var b=0;b<this.map[d].length;b++){var a=this.map[d][b];var c=this.view.actorManager.getActorByName(a);if(c!=null){c.allocate(this.view)}}};vxlAnimation.prototype.deallocateFrame=function(d){if(!this.isValidFrame(d)){return}for(var b=0;b<this.map[d].length;b++){var a=this.map[d][b];var c=this.view.actorManager.getActorByName(a);
if(c!=null){c.deallocate()}}};vxlAnimation.prototype.nextFrame=function(){if(vxl.c.animation.activeFrame<this.frameCount){vxl.c.animation.activeFrame++}else{vxl.c.animation.activeFrame=1}};vxlAnimation.prototype.getNextFrames=function(f){var d=[];var e=this.activeFrame;if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e+a;if(this.isValidFrame(b)){d.push(b)}else{d.push(b-this.frameCount)}}vxl.go.console("Animation: next frames: "+d);return d};vxlAnimation.prototype.getPreviousFrames=function(f){var d=[];
var e=this.activeFrame;if(f>this.frameCount){f=this.frameCount}for(var a=1;a<=f;a++){var b=e-a;if(this.isValidFrame(b)){d.push(b)}else{d.push(this.frameCount+b)}}vxl.go.console("Animation: previous frames: "+d);return d};vxlAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){vxl.c.animation.activeFrame=a;this.render()}};function vxlMain(){vxl.go.gui.doBinding();var a=new vxlView("vxl-id-canvas");a.init();a.start()};