vxlPickerInteractor.prototype=new vxlCameraInteractor();function vxlPickerInteractor(a){this.plist=[];this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.hitPropertyCallback=null;this.processHitsCallback=null;this.addHitCallback=null;this.removeHitCallback=null;this.moveCallback=null;this.picking=false;this.connectTo(a)}vxlPickerInteractor.prototype.connectTo=function(a){vxlCameraInteractor.apply(this,a);if(this.camera){this.configure()}};vxlPickerInteractor.prototype.configure=function(){var c=this.camera.view.renderer.gl;
var b=512*4;var a=512*4;this.texture=c.createTexture();c.bindTexture(c.TEXTURE_2D,this.texture);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST);c.generateMipmap(c.TEXTURE_2D);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b,a,0,c.RGBA,c.UNSIGNED_BYTE,null);this.renderbuffer=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,this.renderbuffer);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,b,a);this.framebuffer=c.createFramebuffer();
c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.texture,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.renderbuffer);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};vxlPickerInteractor.prototype.get2DCoords=function(b){var a,f,e=0,d=0,c=this.camera.view.canvas;while(c&&c.tagName!="BODY"){e+=c.offsetTop;d+=c.offsetLeft;c=c.offsetParent
}d+=window.pageXOffset;e+=window.pageYOffset;a=b.clientX-d;f=c_height-(b.clientY-e);return{x:a,y:f}};vxlPickerInteractor.prototype._compare=function(b,a){vxl.go.console("PickerInteractor: comparing object "+object.alias+" diffuse ("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+") == readout ("+b[0]+","+b[1]+","+b[2]+")");return(Math.abs(Math.round(a[0]*255)-b[0])<=1&&Math.abs(Math.round(a[1]*255)-b[1])<=1&&Math.abs(Math.round(a[2]*255)-b[2])<=1)};vxlPickerInteractor.prototype.find=function(g){var c=this.camera.view.renderer.gl;
var e=new Uint8Array(1*1*4);c.bindFramebuffer(c.FRAMEBUFFER,this.framebuffer);c.readPixels(g.x,g.y,1,1,c.RGBA,c.UNSIGNED_BYTE,e);c.bindFramebuffer(c.FRAMEBUFFER,null);var k=false;var d=this.view.scene;if(this.hitPropertyCallback==undefined){alert("The picker needs an object property to perform the comparison");return}for(var b=0,f=d.actors.length;b<f;b+=1){var a=d.actors[b];if(a.name=="floor"){continue}var j=this.hitPropertyCallback(a);if(this._compare(e,j)){var h=this.plist.indexOf(a);if(h!=-1){this.plist.splice(h,1);
if(this.removeHitCallback){this.removeHitCallback(a)}}else{this.plist.push(a);if(this.addHitCallback){this.addHitCallback(a)}}k=true;break}}draw();return k};vxlPickerInteractor.prototype.stop=function(){if(this.processHitsCallback!=null&&this.plist.length>0){this.processHitsCallback(this.plist)}this.plist=[]};vxlPickerInteractor.prototype.onMouseUp=function(a){if(!a.shiftKey){this.stop()}};vxlPickerInteractor.prototype.onMouseDown=function(a){var b=this.get2DCoords(a);this.picking=this.find(b);if(!this.picking){this.stop()
}};vxlPickerInteractor.prototype.onMouseMove=function(c){this.lastX=this.x;this.lastY=this.y;this.x=c.clientX;this.y=c.clientY;var b=this.x-this.lastX;var a=this.y-this.lastY;if(this.picking&&this.moveCallback){this.moveCallback(this,b,a)}};vxlPickerInteractor.prototype.onKeyDown=function(a){};vxlPickerInteractor.prototype.onKeyUp=function(a){};