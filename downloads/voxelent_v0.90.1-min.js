/*================================================================================
  This is Voxelent's Nucleo Framework [0.90.1]

  Nucleo is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation version 3.

  Nucleo is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Nucleo.  If not, see http://www.gnu.org/licenses/.
  
  WELCOME
                                                  ,     ,
                                                 (\____/)             [ ]
                                                  (_oo_)             (   )
                                                    (-)               |>|
                                                  __||__    \)     __/===\__
                                               []/______\[] /     //| o=o |\
                                               / \______/ \/    <]  | o=o |  [>
                                              /    /__\             \=====/
                                             (\   /____\           / / | \                                                    /--\           <_________>                                                  
                                                                                     
================================================================================*/
        
try{if(!jQuery){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}}catch(e){alert("Voxelent: jQuery is not loaded. Please include JQuery in your page")}var vxl={version:{number:"0.90.0",codename:"c4n314",plugins:[]},def:{piOver2:Math.PI/2,deg2rad:Math.PI/180,rad2deg:180/Math.PI,essl:{VERTEX_SHADER:"VERTEX_SHADER",FRAGMENT_SHADER:"FRAGMENT_SHADER",MODEL_VIEW_MATRIX:"mModelView",NORMAL_MATRIX:"mNormal",PERSPECTIVE_MATRIX:"mPerspective",MVP_MATRIX:"mModelViewPerspective",VERTEX_ATTRIBUTE:"aVertexPosition",NORMAL_ATTRIBUTE:"aVertexNormal",COLOR_ATTRIBUTE:"aVertexColor",TEXCOORD_ATTRIBUTE:"aVertexTextureCoords"},lut:{list:["default","aal","autumn","blackbody","bone","brodmann","cardiac","copper","cortex","cte","french","fs","ge_color","gold","gooch","hot","hotiron","hsv","jet","nih","nih_fire","nih_ice","pink","rainramp","spectrum","surface","x_hot","x_rain"],main:"default"},model:{loadingMode:{LIVE:"LIVE",LATER:"LATER",DETACHED:"DETACHED"},MAX_NUM_INDICES:65535,type:{SIMPLE:"SIMPLE",MESH:"MESH",BIG_DATA:"BIG DATA"}},material:{diffuse:[0.8,0.8,0.8,1],ambient:[0,0,0,1],specular:[0,0,0,1],shininess:0,opacity:1,shading:true},view:{background:[0.3,0.3,0.3]},interactor:{task:{NONE:0,PAN:1,ROTATE:2,DOLLY:3,ROLL:4}},actor:{mode:{TEXTURED:"TEXTURED",SOLID:"SOLID",WIREFRAME:"WIREFRAME",POINTS:"POINTS",LINES:"LINES",BOUNDING_BOX:"BOUNDING_BOX",BB_AND_SOLID:"BBANDSOLID",WIRED_AND_SOLID:"WIRED_AND_SOLID",FLAT:"FLAT",},cull:{BACK:"BACK",FRONT:"FRONT",NONE:"NONE"},picking:{DISABLED:"DISABLED",CELL:"CELL",OBJECT:"OBJECT"}},camera:{type:{ORBITING:"ORBITING",TRACKING:"TRACKING",EXPLORING:"EXPLORING"},right:[1,0,0],up:[0,1,0],normal:[0,0,1],fov:30,near:0.1,far:10000,tracking:{DEFAULT:"DEFAULT",ROTATIONAL:"ROTATIONAL",TRANSLATIONAL:"TRANSLATIONAL",CINEMATIC:"CINEMATIC"}},renderer:{mode:{TIMER:"TIMER",ANIMFRAME:"ANIMFRAME",ON_DEMAND:"ON_DEMAND"},rate:{SLOW:10000,NORMAL:500}},renderable:{task:{CREATE:"CREATE",UPDATE_GEOMETRY:"UPDATE_GEOMETRY",UPDATE_COLORS:"UPDATE_COLORS"}},texture:{filter:{NEAREST:"NEAREST",LINEAR:"LINEAR",NEAREST_MIPMAP_NEAREST:"NEAREST_MIPMAP_NEAREST",LINEAR_MIPMAP_NEAREST:"LINEAR_MIPMAP_NEAREST",NEAREST_MIPMAP_LINEAR:"NEAREST_MIPMAP_LINEAR",LINEAR_MIPMAP_LINEAR:"LINEAR_MIPMAP_LINEAR"}}},events:{DEFAULT_LUT_LOADED:"vxl.events.DEFAULT_LUT_LOADED",SCENE_UPDATED:"vxl.events.SCENE_UPDATED",MODELS_LOADING:"vxl.events.MODELS_LOADING",MODEL_NEW:"vxl.events.MODEL_NEW",MODELS_LOADED:"vxl.events.MODELS_LOADED",ACTOR_MOVED:"vxl.events.ACTOR_MOVED",ACTOR_SCALED:"vxl.events.ACTOR_SCALED",ACTOR_ROTATED:"vxl.events.ACTOR_ROTATED",ACTOR_CHANGED_COLOR:"vxl.events.ACTOR_CHANGED_COLOR",ACTOR_CHANGED_SHADING:"vxl.events.ACTOR_CHANGED_SHADING",VIEW_NEW:"vxl.events.VIEW_NEW",SCENE_NEW:"vxl.events.SCENE_NEW",READER_DONE:"vxl.events.READER_DONE"},go:{debug:false,notifier:undefined,modelManager:undefined,lookupTableManager:undefined,views:[],scenes:[],essl:{},console:function(a,c){if(this.debug==true||c){console.info(a)
}}},c:{scene:undefined,view:undefined,camera:undefined,actor:undefined,animation:undefined,engine:undefined},util:{isMac:function(){return navigator.platform.toUpperCase().indexOf("MAC")!=-1},int2rgb:function(a){return[((a>>16)&255)/256,((a>>8)&255)/256,(a&255)/256]},frac2rgb:function(f,d,a){var h=vxl.util.createArr3(f,d,a);h[0]=Math.round(255*h[0]);h[1]=Math.round(255*h[1]);h[2]=Math.round(255*h[2]);return h},rgb2frac:function(f,d,a){var h=vxl.util.createArr3(f,d,a);h[0]=Math.round(h[0]/255);h[1]=Math.round(h[1]/255);
h[2]=Math.round(h[2]/255);return h},rgb2hex:function(f,d,a){var h=vxl.util.createArr3(f,d,a);return"#"+((1<<24)+(h[0]<<16)+(h[1]<<8)+h[2]).toString(16).slice(1)},hex2rgb:function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;d=d.replace(c,function(h,l,k,f){return l+l+k+k+f+f});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null},rgb2decimal:function(a){if(a==null||a==undefined){return null}return[a[0]/255,a[1]/255,a[2]/255]
},createColor:function(h,f,a){var d=[];if(h==undefined){return null}if(h instanceof Array){var k=h.slice(0);h=k[0];f=k[1];a=k[2]}if(typeof(h)=="string"){d=this.rgb2decimal(this.hex2rgb(h))}else{if(typeof(h)=="number"){if(h<0||f==undefined||a==undefined||f<0||a<0){return null}else{if(h>1||f>1||a>1){d=this.rgb2decimal([h,f,a])}else{d=[h,f,a]}}}}return d},format:function(c,f){var h=Math.pow(10,f);if(typeof(c)=="object"){var a="[";for(var d=0;d<c.length-1;d+=1){a+=Math.round(c[d]*h)/h+", "}a+=Math.round(c[c.length-1]*h)/h+"]"
}else{if(typeof(c)=="number"){a="["+Math.round(c*h)/h+"]"}}return a},createVec3:function(a,f,d){var c=vec3.create();if(a instanceof Array||a instanceof Float32Array){c=vec3.clone(a)}else{c=vec3.fromValues(a,f,d)}return c},createArr3:function(a,f,d){var c=[];if(a instanceof Array||a instanceof Float32Array){c[0]=a[0];c[1]=a[1];c[2]=a[2]}else{c[0]=a;c[1]=f;c[2]=d}return c},generateUID:function(){function a(){return(((1+Math.random())*65536)|0).toString(16).substring(1)}return(a()+"-"+a()+"-"+a()+"-"+a())
},extend:function(){var c={};var a=arguments.length;for(var d=0;d<a;d++){for(p in arguments[d]){if(arguments[d].hasOwnProperty(p)){c[p]=arguments[d][p]}}}return c},getPath:function(a){if(a==undefined||a==null){return""}else{if(a.length-1==a.lastIndexOf("/")){return a}else{if(a.lastIndexOf(".")>a.lastIndexOf("/")){return a.substring(0,a.lastIndexOf("/")+1)}else{return a+"/"}}}},getAngle:function(a){if(a>360||a<-360){return a%360}else{return a}},deg2rad:function(a){return a*Math.PI/180},doTimer:function(c,h,n,f){var l=(c/100)*(h/10),d=c/l,k=0,a=new Date().getTime();
function m(){if(k++==l){f(l,k)}else{n(l,k);var o=(new Date().getTime()-a)-(k*d);window.setTimeout(m,(d-o))}}window.setTimeout(m,d)}}};Array.prototype.max=function(){if(this.length>65535){var a=this[0];for(var c=0,d=this.length;c<d;c+=1){if(this[c]>a){a=this[c]}}return a}else{return Math.max.apply(null,this)}};Array.prototype.min=function(){if(this.length>65535){var c=this[0];for(var a=0,d=this.length;a<d;a+=1){if(this[a]<c){c=this[a]}}return c}else{return Math.min.apply(null,this)}};Array.prototype.hasObject=(!Array.indexOf?function(c){var a=this.length+1;
while(a-=1){if(this[a-1]===c){return true}}return false}:function(a){return(this.indexOf(a)!==-1)});window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c,a){return window.setTimeout(c,1000/60)}})();window.cancelRequestAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout
})();function vxlNotifier(){this.targetList={};this.sourceList={}}vxlNotifier.prototype.subscribe=function(d,c){if(typeof(d)=="string"){this._addTarget(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addTarget(d[a],c)}}else{throw"vxlNotifier.receives: this method receives a string or a list of strings"}}};vxlNotifier.prototype.publish=function(d,c){if(typeof(d)=="string"){this._addSource(d,c)}else{if(d instanceof Array){for(var a=0;a<d.length;a+=1){this._addSource(d[a],c)}}else{throw"vxlNotifier.sends: this method receives a string or a list of strings"
}}};vxlNotifier.prototype._addTarget=function(a,c){vxl.go.console("vxlNotifier: adding target for event "+a);var d=this.targetList;if(d[a]==undefined){d[a]=[]}d[a].push(c)};vxlNotifier.prototype._addSource=function(c,f){vxl.go.console("vxlNotifier: adding source for event "+c);var d=this.targetList;var a=this.sourceList;if(a[c]==undefined){a[c]=[]}if(d[c]==undefined){d[c]=[]}a[c].push(f)};vxlNotifier.prototype.fire=function(d,f){if(this.targetList[d].length==0){return}var a=this;function c(){var m=a.targetList;
var h=a.sourceList[d].indexOf(f);if(h==-1){throw"The source "+f+" is not registered to trigger the event "+d+". Did you use vxlNotifier.publish?"}vxl.go.console("vxlNotifier: firing "+d);var k=a.targetList[d];for(var l=0;l<k.length;l++){if(typeof(k[l])=="object"){k[l].handleEvent(d,f)}else{if(typeof(k[l]=="function")){k[l](d,f)}}}}setTimeout(function(){c()},0)};vxlNotifier.prototype.getEvents=function(){var c=[];for(var a in this.sourceList){c.push(a)}return c};vxlNotifier.prototype.getTargetsFor=function(d){var a=this.targetList[d];
var f=[];for(var c=0;c<a.length;c++){f.push(a[c])}return f};vxl.go.notifier=new vxlNotifier();(function(c){var a={};if(typeof(exports)==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){a.exports={};define(function(){return a.exports})}else{a.exports=typeof(window)!=="undefined"?window:c}}else{a.exports=exports}(function(q){if(!w){var w=0.000001}if(!h){var h=(typeof Float32Array!=="undefined")?Float32Array:Array}if(!n){var n=Math.random}var k={};k.setMatrixArrayType=function(x){h=x
};if(typeof(q)!=="undefined"){q.glMatrix=k}var o=Math.PI/180;k.toRadian=function(x){return x*o};var u={};u.create=function(){var x=new h(2);x[0]=0;x[1]=0;return x};u.clone=function(x){var y=new h(2);y[0]=x[0];y[1]=x[1];return y};u.fromValues=function(z,B){var A=new h(2);A[0]=z;A[1]=B;return A};u.copy=function(y,x){y[0]=x[0];y[1]=x[1];return y};u.set=function(A,z,B){A[0]=z;A[1]=B;return A};u.add=function(z,y,x){z[0]=y[0]+x[0];z[1]=y[1]+x[1];return z};u.subtract=function(z,y,x){z[0]=y[0]-x[0];z[1]=y[1]-x[1];
return z};u.sub=u.subtract;u.multiply=function(z,y,x){z[0]=y[0]*x[0];z[1]=y[1]*x[1];return z};u.mul=u.multiply;u.divide=function(z,y,x){z[0]=y[0]/x[0];z[1]=y[1]/x[1];return z};u.div=u.divide;u.min=function(z,y,x){z[0]=Math.min(y[0],x[0]);z[1]=Math.min(y[1],x[1]);return z};u.max=function(z,y,x){z[0]=Math.max(y[0],x[0]);z[1]=Math.max(y[1],x[1]);return z};u.scale=function(z,y,x){z[0]=y[0]*x;z[1]=y[1]*x;return z};u.scaleAndAdd=function(z,y,x,A){z[0]=y[0]+(x[0]*A);z[1]=y[1]+(x[1]*A);return z};u.distance=function(B,A){var z=A[0]-B[0],C=A[1]-B[1];
return Math.sqrt(z*z+C*C)};u.dist=u.distance;u.squaredDistance=function(B,A){var z=A[0]-B[0],C=A[1]-B[1];return z*z+C*C};u.sqrDist=u.squaredDistance;u.length=function(A){var z=A[0],B=A[1];return Math.sqrt(z*z+B*B)};u.len=u.length;u.squaredLength=function(A){var z=A[0],B=A[1];return z*z+B*B};u.sqrLen=u.squaredLength;u.negate=function(y,x){y[0]=-x[0];y[1]=-x[1];return y};u.normalize=function(C,B){var A=B[0],D=B[1];var z=A*A+D*D;if(z>0){z=1/Math.sqrt(z);C[0]=B[0]*z;C[1]=B[1]*z}return C};u.dot=function(y,x){return y[0]*x[0]+y[1]*x[1]
};u.cross=function(A,y,x){var B=y[0]*x[1]-y[1]*x[0];A[0]=A[1]=0;A[2]=B;return A};u.lerp=function(z,y,x,A){var C=y[0],B=y[1];z[0]=C+A*(x[0]-C);z[1]=B+A*(x[1]-B);return z};u.random=function(x,z){z=z||1;var y=n()*2*Math.PI;x[0]=Math.cos(y)*z;x[1]=Math.sin(y)*z;return x};u.transformMat2=function(C,B,A){var z=B[0],D=B[1];C[0]=A[0]*z+A[2]*D;C[1]=A[1]*z+A[3]*D;return C};u.transformMat2d=function(C,B,A){var z=B[0],D=B[1];C[0]=A[0]*z+A[2]*D+A[4];C[1]=A[1]*z+A[3]*D+A[5];return C};u.transformMat3=function(C,B,A){var z=B[0],D=B[1];
C[0]=A[0]*z+A[3]*D+A[6];C[1]=A[1]*z+A[4]*D+A[7];return C};u.transformMat4=function(C,B,A){var z=B[0],D=B[1];C[0]=A[0]*z+A[4]*D+A[12];C[1]=A[1]*z+A[5]*D+A[13];return C};u.forEach=(function(){var x=u.create();return function(A,E,F,D,C,y){var B,z;if(!E){E=2}if(!F){F=0}if(D){z=Math.min((D*E)+F,A.length)}else{z=A.length}for(B=F;B<z;B+=E){x[0]=A[B];x[1]=A[B+1];C(x,x,y);A[B]=x[0];A[B+1]=x[1]}return A}})();u.str=function(x){return"vec2("+x[0]+", "+x[1]+")"};if(typeof(q)!=="undefined"){q.vec2=u}var t={};t.create=function(){var x=new h(3);
x[0]=0;x[1]=0;x[2]=0;return x};t.clone=function(x){var y=new h(3);y[0]=x[0];y[1]=x[1];y[2]=x[2];return y};t.fromValues=function(A,D,C){var B=new h(3);B[0]=A;B[1]=D;B[2]=C;return B};t.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];return y};t.set=function(B,A,D,C){B[0]=A;B[1]=D;B[2]=C;return B};t.add=function(z,y,x){z[0]=y[0]+x[0];z[1]=y[1]+x[1];z[2]=y[2]+x[2];return z};t.subtract=function(z,y,x){z[0]=y[0]-x[0];z[1]=y[1]-x[1];z[2]=y[2]-x[2];return z};t.sub=t.subtract;t.multiply=function(z,y,x){z[0]=y[0]*x[0];
z[1]=y[1]*x[1];z[2]=y[2]*x[2];return z};t.mul=t.multiply;t.divide=function(z,y,x){z[0]=y[0]/x[0];z[1]=y[1]/x[1];z[2]=y[2]/x[2];return z};t.div=t.divide;t.min=function(z,y,x){z[0]=Math.min(y[0],x[0]);z[1]=Math.min(y[1],x[1]);z[2]=Math.min(y[2],x[2]);return z};t.max=function(z,y,x){z[0]=Math.max(y[0],x[0]);z[1]=Math.max(y[1],x[1]);z[2]=Math.max(y[2],x[2]);return z};t.scale=function(z,y,x){z[0]=y[0]*x;z[1]=y[1]*x;z[2]=y[2]*x;return z};t.scaleAndAdd=function(z,y,x,A){z[0]=y[0]+(x[0]*A);z[1]=y[1]+(x[1]*A);
z[2]=y[2]+(x[2]*A);return z};t.distance=function(C,B){var A=B[0]-C[0],E=B[1]-C[1],D=B[2]-C[2];return Math.sqrt(A*A+E*E+D*D)};t.dist=t.distance;t.squaredDistance=function(C,B){var A=B[0]-C[0],E=B[1]-C[1],D=B[2]-C[2];return A*A+E*E+D*D};t.sqrDist=t.squaredDistance;t.length=function(B){var A=B[0],D=B[1],C=B[2];return Math.sqrt(A*A+D*D+C*C)};t.len=t.length;t.squaredLength=function(B){var A=B[0],D=B[1],C=B[2];return A*A+D*D+C*C};t.sqrLen=t.squaredLength;t.negate=function(y,x){y[0]=-x[0];y[1]=-x[1];y[2]=-x[2];
return y};t.normalize=function(D,C){var B=C[0],F=C[1],E=C[2];var A=B*B+F*F+E*E;if(A>0){A=1/Math.sqrt(A);D[0]=C[0]*A;D[1]=C[1]*A;D[2]=C[2]*A}return D};t.dot=function(y,x){return y[0]*x[0]+y[1]*x[1]+y[2]*x[2]};t.cross=function(y,D,C){var x=D[0],F=D[1],E=D[2],B=C[0],A=C[1],z=C[2];y[0]=F*z-E*A;y[1]=E*B-x*z;y[2]=x*A-F*B;return y};t.lerp=function(z,y,x,A){var D=y[0],C=y[1],B=y[2];z[0]=D+A*(x[0]-D);z[1]=C+A*(x[1]-C);z[2]=B+A*(x[2]-B);return z};t.random=function(x,C){C=C||1;var A=n()*2*Math.PI;var B=(n()*2)-1;
var y=Math.sqrt(1-B*B)*C;x[0]=Math.cos(A)*y;x[1]=Math.sin(A)*y;x[2]=B*C;return x};t.transformMat4=function(D,C,B){var A=C[0],F=C[1],E=C[2];D[0]=B[0]*A+B[4]*F+B[8]*E+B[12];D[1]=B[1]*A+B[5]*F+B[9]*E+B[13];D[2]=B[2]*A+B[6]*F+B[10]*E+B[14];return D};t.transformMat3=function(D,C,B){var A=C[0],F=C[1],E=C[2];D[0]=A*B[0]+F*B[3]+E*B[6];D[1]=A*B[1]+F*B[4]+E*B[7];D[2]=A*B[2]+F*B[5]+E*B[8];return D};t.transformQuat=function(G,M,A){var N=M[0],L=M[1],K=M[2],I=A[0],H=A[1],F=A[2],J=A[3],D=J*N+H*K-F*L,C=J*L+F*N-I*K,B=J*K+I*L-H*N,E=-I*N-H*L-F*K;
G[0]=D*J+E*-I+C*-F-B*-H;G[1]=C*J+E*-H+B*-I-D*-F;G[2]=B*J+E*-F+D*-H-C*-I;return G};t.rotateX=function(z,y,x,C){var B=[],A=[];B[0]=y[0]-x[0];B[1]=y[1]-x[1];B[2]=y[2]-x[2];A[0]=B[0];A[1]=B[1]*Math.cos(C)-B[2]*Math.sin(C);A[2]=B[1]*Math.sin(C)+B[2]*Math.cos(C);z[0]=A[0]+x[0];z[1]=A[1]+x[1];z[2]=A[2]+x[2];return z};t.rotateY=function(z,y,x,C){var B=[],A=[];B[0]=y[0]-x[0];B[1]=y[1]-x[1];B[2]=y[2]-x[2];A[0]=B[2]*Math.sin(C)+B[0]*Math.cos(C);A[1]=B[1];A[2]=B[2]*Math.cos(C)-B[0]*Math.sin(C);z[0]=A[0]+x[0];
z[1]=A[1]+x[1];z[2]=A[2]+x[2];return z};t.rotateZ=function(z,y,x,C){var B=[],A=[];B[0]=y[0]-x[0];B[1]=y[1]-x[1];B[2]=y[2]-x[2];A[0]=B[0]*Math.cos(C)-B[1]*Math.sin(C);A[1]=B[0]*Math.sin(C)+B[1]*Math.cos(C);A[2]=B[2];z[0]=A[0]+x[0];z[1]=A[1]+x[1];z[2]=A[2]+x[2];return z};t.forEach=(function(){var x=t.create();return function(A,E,F,D,C,y){var B,z;if(!E){E=3}if(!F){F=0}if(D){z=Math.min((D*E)+F,A.length)}else{z=A.length}for(B=F;B<z;B+=E){x[0]=A[B];x[1]=A[B+1];x[2]=A[B+2];C(x,x,y);A[B]=x[0];A[B+1]=x[1];
A[B+2]=x[2]}return A}})();t.str=function(x){return"vec3("+x[0]+", "+x[1]+", "+x[2]+")"};if(typeof(q)!=="undefined"){q.vec3=t}var s={};s.create=function(){var x=new h(4);x[0]=0;x[1]=0;x[2]=0;x[3]=0;return x};s.clone=function(x){var y=new h(4);y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];return y};s.fromValues=function(A,E,D,B){var C=new h(4);C[0]=A;C[1]=E;C[2]=D;C[3]=B;return C};s.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];return y};s.set=function(C,A,E,D,B){C[0]=A;C[1]=E;C[2]=D;C[3]=B;
return C};s.add=function(z,y,x){z[0]=y[0]+x[0];z[1]=y[1]+x[1];z[2]=y[2]+x[2];z[3]=y[3]+x[3];return z};s.subtract=function(z,y,x){z[0]=y[0]-x[0];z[1]=y[1]-x[1];z[2]=y[2]-x[2];z[3]=y[3]-x[3];return z};s.sub=s.subtract;s.multiply=function(z,y,x){z[0]=y[0]*x[0];z[1]=y[1]*x[1];z[2]=y[2]*x[2];z[3]=y[3]*x[3];return z};s.mul=s.multiply;s.divide=function(z,y,x){z[0]=y[0]/x[0];z[1]=y[1]/x[1];z[2]=y[2]/x[2];z[3]=y[3]/x[3];return z};s.div=s.divide;s.min=function(z,y,x){z[0]=Math.min(y[0],x[0]);z[1]=Math.min(y[1],x[1]);
z[2]=Math.min(y[2],x[2]);z[3]=Math.min(y[3],x[3]);return z};s.max=function(z,y,x){z[0]=Math.max(y[0],x[0]);z[1]=Math.max(y[1],x[1]);z[2]=Math.max(y[2],x[2]);z[3]=Math.max(y[3],x[3]);return z};s.scale=function(z,y,x){z[0]=y[0]*x;z[1]=y[1]*x;z[2]=y[2]*x;z[3]=y[3]*x;return z};s.scaleAndAdd=function(z,y,x,A){z[0]=y[0]+(x[0]*A);z[1]=y[1]+(x[1]*A);z[2]=y[2]+(x[2]*A);z[3]=y[3]+(x[3]*A);return z};s.distance=function(D,B){var A=B[0]-D[0],F=B[1]-D[1],E=B[2]-D[2],C=B[3]-D[3];return Math.sqrt(A*A+F*F+E*E+C*C)
};s.dist=s.distance;s.squaredDistance=function(D,B){var A=B[0]-D[0],F=B[1]-D[1],E=B[2]-D[2],C=B[3]-D[3];return A*A+F*F+E*E+C*C};s.sqrDist=s.squaredDistance;s.length=function(C){var A=C[0],E=C[1],D=C[2],B=C[3];return Math.sqrt(A*A+E*E+D*D+B*B)};s.len=s.length;s.squaredLength=function(C){var A=C[0],E=C[1],D=C[2],B=C[3];return A*A+E*E+D*D+B*B};s.sqrLen=s.squaredLength;s.negate=function(y,x){y[0]=-x[0];y[1]=-x[1];y[2]=-x[2];y[3]=-x[3];return y};s.normalize=function(E,D){var B=D[0],G=D[1],F=D[2],C=D[3];
var A=B*B+G*G+F*F+C*C;if(A>0){A=1/Math.sqrt(A);E[0]=D[0]*A;E[1]=D[1]*A;E[2]=D[2]*A;E[3]=D[3]*A}return E};s.dot=function(y,x){return y[0]*x[0]+y[1]*x[1]+y[2]*x[2]+y[3]*x[3]};s.lerp=function(z,y,x,A){var D=y[0],C=y[1],B=y[2],E=y[3];z[0]=D+A*(x[0]-D);z[1]=C+A*(x[1]-C);z[2]=B+A*(x[2]-B);z[3]=E+A*(x[3]-E);return z};s.random=function(x,y){y=y||1;x[0]=n();x[1]=n();x[2]=n();x[3]=n();s.normalize(x,x);s.scale(x,x,y);return x};s.transformMat4=function(E,D,B){var A=D[0],G=D[1],F=D[2],C=D[3];E[0]=B[0]*A+B[4]*G+B[8]*F+B[12]*C;
E[1]=B[1]*A+B[5]*G+B[9]*F+B[13]*C;E[2]=B[2]*A+B[6]*G+B[10]*F+B[14]*C;E[3]=B[3]*A+B[7]*G+B[11]*F+B[15]*C;return E};s.transformQuat=function(G,M,A){var N=M[0],L=M[1],K=M[2],I=A[0],H=A[1],F=A[2],J=A[3],D=J*N+H*K-F*L,C=J*L+F*N-I*K,B=J*K+I*L-H*N,E=-I*N-H*L-F*K;G[0]=D*J+E*-I+C*-F-B*-H;G[1]=C*J+E*-H+B*-I-D*-F;G[2]=B*J+E*-F+D*-H-C*-I;return G};s.forEach=(function(){var x=s.create();return function(A,E,F,D,C,y){var B,z;if(!E){E=4}if(!F){F=0}if(D){z=Math.min((D*E)+F,A.length)}else{z=A.length}for(B=F;B<z;B+=E){x[0]=A[B];
x[1]=A[B+1];x[2]=A[B+2];x[3]=A[B+3];C(x,x,y);A[B]=x[0];A[B+1]=x[1];A[B+2]=x[2];A[B+3]=x[3]}return A}})();s.str=function(x){return"vec4("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+")"};if(typeof(q)!=="undefined"){q.vec4=s}var l={};l.create=function(){var x=new h(4);x[0]=1;x[1]=0;x[2]=0;x[3]=1;return x};l.clone=function(x){var y=new h(4);y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];return y};l.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];return y};l.identity=function(x){x[0]=1;x[1]=0;x[2]=0;x[3]=1;
return x};l.transpose=function(z,y){if(z===y){var x=y[1];z[1]=y[2];z[2]=x}else{z[0]=y[0];z[1]=y[2];z[2]=y[1];z[3]=y[3]}return z};l.invert=function(B,z){var A=z[0],y=z[1],x=z[2],D=z[3],C=A*D-x*y;if(!C){return null}C=1/C;B[0]=D*C;B[1]=-y*C;B[2]=-x*C;B[3]=A*C;return B};l.adjoint=function(z,x){var y=x[0];z[0]=x[3];z[1]=-x[1];z[2]=-x[2];z[3]=y;return z};l.determinant=function(x){return x[0]*x[3]-x[2]*x[1]};l.multiply=function(B,G,E){var A=G[0],z=G[1],y=G[2],x=G[3];var H=E[0],F=E[1],D=E[2],C=E[3];B[0]=A*H+y*F;
B[1]=z*H+x*F;B[2]=A*D+y*C;B[3]=z*D+x*C;return B};l.mul=l.multiply;l.rotate=function(B,E,D){var A=E[0],z=E[1],y=E[2],x=E[3],F=Math.sin(D),C=Math.cos(D);B[0]=A*C+y*F;B[1]=z*C+x*F;B[2]=A*-F+y*C;B[3]=z*-F+x*C;return B};l.scale=function(B,C,E){var A=C[0],z=C[1],y=C[2],x=C[3],F=E[0],D=E[1];B[0]=A*F;B[1]=z*F;B[2]=y*D;B[3]=x*D;return B};l.str=function(x){return"mat2("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+")"};l.frob=function(x){return(Math.sqrt(Math.pow(x[0],2)+Math.pow(x[1],2)+Math.pow(x[2],2)+Math.pow(x[3],2)))
};l.LDU=function(x,A,z,y){x[2]=y[2]/y[0];z[0]=y[0];z[1]=y[1];z[3]=y[3]-x[2]*z[1];return[x,A,z]};if(typeof(q)!=="undefined"){q.mat2=l}var v={};v.create=function(){var x=new h(6);x[0]=1;x[1]=0;x[2]=0;x[3]=1;x[4]=0;x[5]=0;return x};v.clone=function(x){var y=new h(6);y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];y[5]=x[5];return y};v.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];y[5]=x[5];return y};v.identity=function(x){x[0]=1;x[1]=0;x[2]=0;x[3]=1;x[4]=0;x[5]=0;return x};v.invert=function(y,C){var x=C[0],F=C[1],E=C[2],D=C[3],A=C[4],z=C[5];
var B=x*D-F*E;if(!B){return null}B=1/B;y[0]=D*B;y[1]=-F*B;y[2]=-E*B;y[3]=x*B;y[4]=(E*z-D*A)*B;y[5]=(F*A-x*z)*B;return y};v.determinant=function(x){return x[0]*x[3]-x[1]*x[2]};v.multiply=function(B,I,G){var A=I[0],z=I[1],y=I[2],x=I[3],L=I[4],K=I[5],J=G[0],H=G[1],F=G[2],E=G[3],D=G[4],C=G[5];B[0]=A*J+y*H;B[1]=z*J+x*H;B[2]=A*F+y*E;B[3]=z*F+x*E;B[4]=A*D+y*C+L;B[5]=z*D+x*C+K;return B};v.mul=v.multiply;v.rotate=function(B,E,D){var A=E[0],z=E[1],y=E[2],x=E[3],H=E[4],F=E[5],G=Math.sin(D),C=Math.cos(D);B[0]=A*C+y*G;
B[1]=z*C+x*G;B[2]=A*-G+y*C;B[3]=z*-G+x*C;B[4]=H;B[5]=F;return B};v.scale=function(B,C,F){var A=C[0],z=C[1],y=C[2],x=C[3],H=C[4],G=C[5],E=F[0],D=F[1];B[0]=A*E;B[1]=z*E;B[2]=y*D;B[3]=x*D;B[4]=H;B[5]=G;return B};v.translate=function(B,C,F){var A=C[0],z=C[1],y=C[2],x=C[3],H=C[4],G=C[5],E=F[0],D=F[1];B[0]=A;B[1]=z;B[2]=y;B[3]=x;B[4]=A*E+y*D+H;B[5]=z*E+x*D+G;return B};v.str=function(x){return"mat2d("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+", "+x[4]+", "+x[5]+")"};v.frob=function(x){return(Math.sqrt(Math.pow(x[0],2)+Math.pow(x[1],2)+Math.pow(x[2],2)+Math.pow(x[3],2)+Math.pow(x[4],2)+Math.pow(x[5],2)+1))
};if(typeof(q)!=="undefined"){q.mat2d=v}var f={};f.create=function(){var x=new h(9);x[0]=1;x[1]=0;x[2]=0;x[3]=0;x[4]=1;x[5]=0;x[6]=0;x[7]=0;x[8]=1;return x};f.fromMat4=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[4];y[4]=x[5];y[5]=x[6];y[6]=x[8];y[7]=x[9];y[8]=x[10];return y};f.clone=function(x){var y=new h(9);y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];y[5]=x[5];y[6]=x[6];y[7]=x[7];y[8]=x[8];return y};f.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];y[5]=x[5];y[6]=x[6];
y[7]=x[7];y[8]=x[8];return y};f.identity=function(x){x[0]=1;x[1]=0;x[2]=0;x[3]=0;x[4]=1;x[5]=0;x[6]=0;x[7]=0;x[8]=1;return x};f.transpose=function(z,y){if(z===y){var B=y[1],A=y[2],x=y[5];z[1]=y[3];z[2]=y[6];z[3]=B;z[5]=y[7];z[6]=A;z[7]=x}else{z[0]=y[0];z[1]=y[3];z[2]=y[6];z[3]=y[1];z[4]=y[4];z[5]=y[7];z[6]=y[2];z[7]=y[5];z[8]=y[8]}return z};f.invert=function(B,I){var A=I[0],z=I[1],y=I[2],L=I[3],K=I[4],J=I[5],G=I[6],F=I[7],D=I[8],C=D*K-J*F,x=-D*L+J*G,H=F*L-K*G,E=A*C+z*x+y*H;if(!E){return null}E=1/E;
B[0]=C*E;B[1]=(-D*z+y*F)*E;B[2]=(J*z-y*K)*E;B[3]=x*E;B[4]=(D*A-y*G)*E;B[5]=(-J*A+y*L)*E;B[6]=H*E;B[7]=(-F*A+z*G)*E;B[8]=(K*A-z*L)*E;return B};f.adjoint=function(A,E){var z=E[0],y=E[1],x=E[2],H=E[3],G=E[4],F=E[5],D=E[6],C=E[7],B=E[8];A[0]=(G*B-F*C);A[1]=(x*C-y*B);A[2]=(y*F-x*G);A[3]=(F*D-H*B);A[4]=(z*B-x*D);A[5]=(x*H-z*F);A[6]=(H*C-G*D);A[7]=(y*D-z*C);A[8]=(z*G-y*H);return A};f.determinant=function(D){var z=D[0],y=D[1],x=D[2],G=D[3],F=D[4],E=D[5],C=D[6],B=D[7],A=D[8];return z*(A*F-E*B)+y*(-A*G+E*C)+x*(B*G-F*C)
};f.multiply=function(J,O,N){var R=O[0],Q=O[1],P=O[2],C=O[3],B=O[4],A=O[5],I=O[6],H=O[7],G=O[8],F=N[0],E=N[1],D=N[2],M=N[3],L=N[4],K=N[5],z=N[6],y=N[7],x=N[8];J[0]=F*R+E*C+D*I;J[1]=F*Q+E*B+D*H;J[2]=F*P+E*A+D*G;J[3]=M*R+L*C+K*I;J[4]=M*Q+L*B+K*H;J[5]=M*P+L*A+K*G;J[6]=z*R+y*C+x*I;J[7]=z*Q+y*B+x*H;J[8]=z*P+y*A+x*G;return J};f.mul=f.multiply;f.translate=function(C,I,K){var B=I[0],A=I[1],z=I[2],M=I[3],L=I[4],J=I[5],F=I[6],E=I[7],D=I[8],H=K[0],G=K[1];C[0]=B;C[1]=A;C[2]=z;C[3]=M;C[4]=L;C[5]=J;C[6]=H*B+G*M+F;
C[7]=H*A+G*L+E;C[8]=H*z+G*J+D;return C};f.rotate=function(A,G,F){var z=G[0],y=G[1],x=G[2],J=G[3],I=G[4],H=G[5],D=G[6],C=G[7],B=G[8],K=Math.sin(F),E=Math.cos(F);A[0]=E*z+K*J;A[1]=E*y+K*I;A[2]=E*x+K*H;A[3]=E*J-K*z;A[4]=E*I-K*y;A[5]=E*H-K*x;A[6]=D;A[7]=C;A[8]=B;return A};f.scale=function(C,A,B){var z=B[0],D=B[1];C[0]=z*A[0];C[1]=z*A[1];C[2]=z*A[2];C[3]=D*A[3];C[4]=D*A[4];C[5]=D*A[5];C[6]=A[6];C[7]=A[7];C[8]=A[8];return C};f.fromMat2d=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=0;y[3]=x[2];y[4]=x[3];y[5]=0;
y[6]=x[4];y[7]=x[5];y[8]=1;return y};f.fromQuat=function(K,H){var E=H[0],D=H[1],C=H[2],F=H[3],L=E+E,A=D+D,G=C+C,B=E*L,J=D*L,I=D*A,R=C*L,Q=C*A,O=C*G,P=F*L,N=F*A,M=F*G;K[0]=1-I-O;K[3]=J-M;K[6]=R+N;K[1]=J+M;K[4]=1-B-O;K[7]=Q-P;K[2]=R-N;K[5]=Q+P;K[8]=1-B-I;return K};f.normalFromMat4=function(Q,V){var Z=V[0],X=V[1],W=V[2],T=V[3],B=V[4],A=V[5],z=V[6],y=V[7],P=V[8],O=V[9],N=V[10],M=V[11],ab=V[12],aa=V[13],Y=V[14],U=V[15],L=Z*A-X*B,K=Z*z-W*B,J=Z*y-T*B,I=X*z-W*A,H=X*y-T*A,G=W*y-T*z,F=P*aa-O*ab,E=P*Y-N*ab,D=P*U-M*ab,C=O*Y-N*aa,S=O*U-M*aa,R=N*U-M*Y,x=L*R-K*S+J*C+I*D-H*E+G*F;
if(!x){return null}x=1/x;Q[0]=(A*R-z*S+y*C)*x;Q[1]=(z*D-B*R-y*E)*x;Q[2]=(B*S-A*D+y*F)*x;Q[3]=(W*S-X*R-T*C)*x;Q[4]=(Z*R-W*D+T*E)*x;Q[5]=(X*D-Z*S-T*F)*x;Q[6]=(aa*G-Y*H+U*I)*x;Q[7]=(Y*J-ab*G-U*K)*x;Q[8]=(ab*H-aa*J+U*L)*x;return Q};f.str=function(x){return"mat3("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+", "+x[4]+", "+x[5]+", "+x[6]+", "+x[7]+", "+x[8]+")"};f.frob=function(x){return(Math.sqrt(Math.pow(x[0],2)+Math.pow(x[1],2)+Math.pow(x[2],2)+Math.pow(x[3],2)+Math.pow(x[4],2)+Math.pow(x[5],2)+Math.pow(x[6],2)+Math.pow(x[7],2)+Math.pow(x[8],2)))
};if(typeof(q)!=="undefined"){q.mat3=f}var d={};d.create=function(){var x=new h(16);x[0]=1;x[1]=0;x[2]=0;x[3]=0;x[4]=0;x[5]=1;x[6]=0;x[7]=0;x[8]=0;x[9]=0;x[10]=1;x[11]=0;x[12]=0;x[13]=0;x[14]=0;x[15]=1;return x};d.clone=function(x){var y=new h(16);y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];y[5]=x[5];y[6]=x[6];y[7]=x[7];y[8]=x[8];y[9]=x[9];y[10]=x[10];y[11]=x[11];y[12]=x[12];y[13]=x[13];y[14]=x[14];y[15]=x[15];return y};d.copy=function(y,x){y[0]=x[0];y[1]=x[1];y[2]=x[2];y[3]=x[3];y[4]=x[4];
y[5]=x[5];y[6]=x[6];y[7]=x[7];y[8]=x[8];y[9]=x[9];y[10]=x[10];y[11]=x[11];y[12]=x[12];y[13]=x[13];y[14]=x[14];y[15]=x[15];return y};d.identity=function(x){x[0]=1;x[1]=0;x[2]=0;x[3]=0;x[4]=0;x[5]=1;x[6]=0;x[7]=0;x[8]=0;x[9]=0;x[10]=1;x[11]=0;x[12]=0;x[13]=0;x[14]=0;x[15]=1;return x};d.transpose=function(A,z){if(A===z){var E=z[1],C=z[2],B=z[3],x=z[6],D=z[7],y=z[11];A[1]=z[4];A[2]=z[8];A[3]=z[12];A[4]=E;A[6]=z[9];A[7]=z[13];A[8]=C;A[9]=x;A[11]=z[14];A[12]=B;A[13]=D;A[14]=y}else{A[0]=z[0];A[1]=z[4];A[2]=z[8];
A[3]=z[12];A[4]=z[1];A[5]=z[5];A[6]=z[9];A[7]=z[13];A[8]=z[2];A[9]=z[6];A[10]=z[10];A[11]=z[14];A[12]=z[3];A[13]=z[7];A[14]=z[11];A[15]=z[15]}return A};d.invert=function(Q,V){var Z=V[0],X=V[1],W=V[2],T=V[3],B=V[4],A=V[5],z=V[6],y=V[7],P=V[8],O=V[9],N=V[10],M=V[11],ab=V[12],aa=V[13],Y=V[14],U=V[15],L=Z*A-X*B,K=Z*z-W*B,J=Z*y-T*B,I=X*z-W*A,H=X*y-T*A,G=W*y-T*z,F=P*aa-O*ab,E=P*Y-N*ab,D=P*U-M*ab,C=O*Y-N*aa,S=O*U-M*aa,R=N*U-M*Y,x=L*R-K*S+J*C+I*D-H*E+G*F;if(!x){return null}x=1/x;Q[0]=(A*R-z*S+y*C)*x;Q[1]=(W*S-X*R-T*C)*x;
Q[2]=(aa*G-Y*H+U*I)*x;Q[3]=(N*H-O*G-M*I)*x;Q[4]=(z*D-B*R-y*E)*x;Q[5]=(Z*R-W*D+T*E)*x;Q[6]=(Y*J-ab*G-U*K)*x;Q[7]=(P*G-N*J+M*K)*x;Q[8]=(B*S-A*D+y*F)*x;Q[9]=(X*D-Z*S-T*F)*x;Q[10]=(ab*H-aa*J+U*L)*x;Q[11]=(O*J-P*H-M*L)*x;Q[12]=(A*E-B*C-z*F)*x;Q[13]=(Z*C-X*E+W*F)*x;Q[14]=(aa*K-ab*I-Y*L)*x;Q[15]=(P*I-O*K+N*L)*x;return Q};d.adjoint=function(F,I){var M=I[0],K=I[1],J=I[2],G=I[3],A=I[4],z=I[5],y=I[6],x=I[7],E=I[8],D=I[9],C=I[10],B=I[11],O=I[12],N=I[13],L=I[14],H=I[15];F[0]=(z*(C*H-B*L)-D*(y*H-x*L)+N*(y*B-x*C));
F[1]=-(K*(C*H-B*L)-D*(J*H-G*L)+N*(J*B-G*C));F[2]=(K*(y*H-x*L)-z*(J*H-G*L)+N*(J*x-G*y));F[3]=-(K*(y*B-x*C)-z*(J*B-G*C)+D*(J*x-G*y));F[4]=-(A*(C*H-B*L)-E*(y*H-x*L)+O*(y*B-x*C));F[5]=(M*(C*H-B*L)-E*(J*H-G*L)+O*(J*B-G*C));F[6]=-(M*(y*H-x*L)-A*(J*H-G*L)+O*(J*x-G*y));F[7]=(M*(y*B-x*C)-A*(J*B-G*C)+E*(J*x-G*y));F[8]=(A*(D*H-B*N)-E*(z*H-x*N)+O*(z*B-x*D));F[9]=-(M*(D*H-B*N)-E*(K*H-G*N)+O*(K*B-G*D));F[10]=(M*(z*H-x*N)-A*(K*H-G*N)+O*(K*x-G*z));F[11]=-(M*(z*B-x*D)-A*(K*B-G*D)+E*(K*x-G*z));F[12]=-(A*(D*L-C*N)-E*(z*L-y*N)+O*(z*C-y*D));
F[13]=(M*(D*L-C*N)-E*(K*L-J*N)+O*(K*C-J*D));F[14]=-(M*(z*L-y*N)-A*(K*L-J*N)+O*(K*y-J*z));F[15]=(M*(z*C-y*D)-A*(K*C-J*D)+E*(K*y-J*z));return F};d.determinant=function(S){var X=S[0],V=S[1],T=S[2],R=S[3],A=S[4],z=S[5],y=S[6],x=S[7],O=S[8],N=S[9],M=S[10],L=S[11],Z=S[12],Y=S[13],W=S[14],U=S[15],K=X*z-V*A,J=X*y-T*A,I=X*x-R*A,H=V*y-T*z,G=V*x-R*z,F=T*x-R*y,E=O*Y-N*Z,D=O*W-M*Z,C=O*U-L*Z,B=N*W-M*Y,Q=N*U-L*Y,P=M*U-L*W;return K*P-J*Q+I*B+H*C-G*D+F*E};d.multiply=function(J,N,K){var R=N[0],Q=N[1],O=N[2],L=N[3],D=N[4],B=N[5],z=N[6],x=N[7],I=N[8],H=N[9],G=N[10],F=N[11],T=N[12],S=N[13],P=N[14],M=N[15];
var E=K[0],C=K[1],A=K[2],y=K[3];J[0]=E*R+C*D+A*I+y*T;J[1]=E*Q+C*B+A*H+y*S;J[2]=E*O+C*z+A*G+y*P;J[3]=E*L+C*x+A*F+y*M;E=K[4];C=K[5];A=K[6];y=K[7];J[4]=E*R+C*D+A*I+y*T;J[5]=E*Q+C*B+A*H+y*S;J[6]=E*O+C*z+A*G+y*P;J[7]=E*L+C*x+A*F+y*M;E=K[8];C=K[9];A=K[10];y=K[11];J[8]=E*R+C*D+A*I+y*T;J[9]=E*Q+C*B+A*H+y*S;J[10]=E*O+C*z+A*G+y*P;J[11]=E*L+C*x+A*F+y*M;E=K[12];C=K[13];A=K[14];y=K[15];J[12]=E*R+C*D+A*I+y*T;J[13]=E*Q+C*B+A*H+y*S;J[14]=E*O+C*z+A*G+y*P;J[15]=E*L+C*x+A*F+y*M;return J};d.mul=d.multiply;d.translate=function(M,O,H){var G=H[0],F=H[1],E=H[2],R,Q,P,N,D,C,B,A,L,K,J,I;
if(O===M){M[12]=O[0]*G+O[4]*F+O[8]*E+O[12];M[13]=O[1]*G+O[5]*F+O[9]*E+O[13];M[14]=O[2]*G+O[6]*F+O[10]*E+O[14];M[15]=O[3]*G+O[7]*F+O[11]*E+O[15]}else{R=O[0];Q=O[1];P=O[2];N=O[3];D=O[4];C=O[5];B=O[6];A=O[7];L=O[8];K=O[9];J=O[10];I=O[11];M[0]=R;M[1]=Q;M[2]=P;M[3]=N;M[4]=D;M[5]=C;M[6]=B;M[7]=A;M[8]=L;M[9]=K;M[10]=J;M[11]=I;M[12]=R*G+D*F+L*E+O[12];M[13]=Q*G+C*F+K*E+O[13];M[14]=P*G+B*F+J*E+O[14];M[15]=N*G+A*F+I*E+O[15]}return M};d.scale=function(D,B,C){var A=C[0],F=C[1],E=C[2];D[0]=B[0]*A;D[1]=B[1]*A;D[2]=B[2]*A;
D[3]=B[3]*A;D[4]=B[4]*F;D[5]=B[5]*F;D[6]=B[6]*F;D[7]=B[7]*F;D[8]=B[8]*E;D[9]=B[9]*E;D[10]=B[10]*E;D[11]=B[11]*E;D[12]=B[12];D[13]=B[13];D[14]=B[14];D[15]=B[15];return D};d.rotate=function(U,ab,ad,A){var K=A[0],J=A[1],I=A[2],V=Math.sqrt(K*K+J*J+I*I),P,Z,O,af,ae,ac,aa,H,G,F,E,T,S,R,Q,N,M,L,Y,X,W,D,C,B;if(Math.abs(V)<w){return null}V=1/V;K*=V;J*=V;I*=V;P=Math.sin(ad);Z=Math.cos(ad);O=1-Z;af=ab[0];ae=ab[1];ac=ab[2];aa=ab[3];H=ab[4];G=ab[5];F=ab[6];E=ab[7];T=ab[8];S=ab[9];R=ab[10];Q=ab[11];N=K*K*O+Z;M=J*K*O+I*P;
L=I*K*O-J*P;Y=K*J*O-I*P;X=J*J*O+Z;W=I*J*O+K*P;D=K*I*O+J*P;C=J*I*O-K*P;B=I*I*O+Z;U[0]=af*N+H*M+T*L;U[1]=ae*N+G*M+S*L;U[2]=ac*N+F*M+R*L;U[3]=aa*N+E*M+Q*L;U[4]=af*Y+H*X+T*W;U[5]=ae*Y+G*X+S*W;U[6]=ac*Y+F*X+R*W;U[7]=aa*Y+E*X+Q*W;U[8]=af*D+H*C+T*B;U[9]=ae*D+G*C+S*B;U[10]=ac*D+F*C+R*B;U[11]=aa*D+E*C+Q*B;if(ab!==U){U[12]=ab[12];U[13]=ab[13];U[14]=ab[14];U[15]=ab[15]}return U};d.rotateX=function(x,E,D){var J=Math.sin(D),C=Math.cos(D),I=E[4],H=E[5],G=E[6],F=E[7],B=E[8],A=E[9],z=E[10],y=E[11];if(E!==x){x[0]=E[0];
x[1]=E[1];x[2]=E[2];x[3]=E[3];x[12]=E[12];x[13]=E[13];x[14]=E[14];x[15]=E[15]}x[4]=I*C+B*J;x[5]=H*C+A*J;x[6]=G*C+z*J;x[7]=F*C+y*J;x[8]=B*C-I*J;x[9]=A*C-H*J;x[10]=z*C-G*J;x[11]=y*C-F*J;return x};d.rotateY=function(B,I,H){var J=Math.sin(H),G=Math.cos(H),A=I[0],z=I[1],y=I[2],x=I[3],F=I[8],E=I[9],D=I[10],C=I[11];if(I!==B){B[4]=I[4];B[5]=I[5];B[6]=I[6];B[7]=I[7];B[12]=I[12];B[13]=I[13];B[14]=I[14];B[15]=I[15]}B[0]=A*G-F*J;B[1]=z*G-E*J;B[2]=y*G-D*J;B[3]=x*G-C*J;B[8]=A*J+F*G;B[9]=z*J+E*G;B[10]=y*J+D*G;B[11]=x*J+C*G;
return B};d.rotateZ=function(B,E,D){var J=Math.sin(D),C=Math.cos(D),A=E[0],z=E[1],y=E[2],x=E[3],I=E[4],H=E[5],G=E[6],F=E[7];if(E!==B){B[8]=E[8];B[9]=E[9];B[10]=E[10];B[11]=E[11];B[12]=E[12];B[13]=E[13];B[14]=E[14];B[15]=E[15]}B[0]=A*C+I*J;B[1]=z*C+H*J;B[2]=y*C+G*J;B[3]=x*C+F*J;B[4]=I*C-A*J;B[5]=H*C-z*J;B[6]=G*C-y*J;B[7]=F*C-x*J;return B};d.fromRotationTranslation=function(N,L,J){var G=L[0],F=L[1],E=L[2],H=L[3],O=G+G,A=F+F,I=E+E,D=G*O,C=G*A,B=G*I,M=F*A,K=F*I,R=E*I,S=H*O,Q=H*A,P=H*I;N[0]=1-(M+R);N[1]=C+P;
N[2]=B-Q;N[3]=0;N[4]=C-P;N[5]=1-(D+R);N[6]=K+S;N[7]=0;N[8]=B+Q;N[9]=K-S;N[10]=1-(D+M);N[11]=0;N[12]=J[0];N[13]=J[1];N[14]=J[2];N[15]=1;return N};d.fromQuat=function(K,H){var E=H[0],D=H[1],C=H[2],F=H[3],L=E+E,A=D+D,G=C+C,B=E*L,J=D*L,I=D*A,R=C*L,Q=C*A,O=C*G,P=F*L,N=F*A,M=F*G;K[0]=1-I-O;K[1]=J+M;K[2]=R-N;K[3]=0;K[4]=J-M;K[5]=1-B-O;K[6]=Q+P;K[7]=0;K[8]=R+N;K[9]=Q-P;K[10]=1-B-I;K[11]=0;K[12]=0;K[13]=0;K[14]=0;K[15]=1;return K};d.frustum=function(B,y,G,x,F,D,C){var E=1/(G-y),A=1/(F-x),z=1/(D-C);B[0]=(D*2)*E;
B[1]=0;B[2]=0;B[3]=0;B[4]=0;B[5]=(D*2)*A;B[6]=0;B[7]=0;B[8]=(G+y)*E;B[9]=(F+x)*A;B[10]=(C+D)*z;B[11]=-1;B[12]=0;B[13]=0;B[14]=(C*D*2)*z;B[15]=0;return B};d.perspective=function(A,z,y,B,x){var D=1/Math.tan(z/2),C=1/(B-x);A[0]=D/y;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=D;A[6]=0;A[7]=0;A[8]=0;A[9]=0;A[10]=(x+B)*C;A[11]=-1;A[12]=0;A[13]=0;A[14]=(2*x*B)*C;A[15]=0;return A};d.ortho=function(A,y,G,x,E,D,C){var B=1/(y-G),F=1/(x-E),z=1/(D-C);A[0]=-2*B;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=-2*F;A[6]=0;A[7]=0;A[8]=0;A[9]=0;
A[10]=2*z;A[11]=0;A[12]=(y+G)*B;A[13]=(E+x)*F;A[14]=(C+D)*z;A[15]=1;return A};d.lookAt=function(L,S,T,D){var R,Q,O,z,y,x,G,F,E,M,P=S[0],N=S[1],K=S[2],C=D[0],B=D[1],A=D[2],J=T[0],I=T[1],H=T[2];if(Math.abs(P-J)<w&&Math.abs(N-I)<w&&Math.abs(K-H)<w){return d.identity(L)}G=P-J;F=N-I;E=K-H;M=1/Math.sqrt(G*G+F*F+E*E);G*=M;F*=M;E*=M;R=B*E-A*F;Q=A*G-C*E;O=C*F-B*G;M=Math.sqrt(R*R+Q*Q+O*O);if(!M){R=0;Q=0;O=0}else{M=1/M;R*=M;Q*=M;O*=M}z=F*O-E*Q;y=E*R-G*O;x=G*Q-F*R;M=Math.sqrt(z*z+y*y+x*x);if(!M){z=0;y=0;x=0}else{M=1/M;
z*=M;y*=M;x*=M}L[0]=R;L[1]=z;L[2]=G;L[3]=0;L[4]=Q;L[5]=y;L[6]=F;L[7]=0;L[8]=O;L[9]=x;L[10]=E;L[11]=0;L[12]=-(R*P+Q*N+O*K);L[13]=-(z*P+y*N+x*K);L[14]=-(G*P+F*N+E*K);L[15]=1;return L};d.str=function(x){return"mat4("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+", "+x[4]+", "+x[5]+", "+x[6]+", "+x[7]+", "+x[8]+", "+x[9]+", "+x[10]+", "+x[11]+", "+x[12]+", "+x[13]+", "+x[14]+", "+x[15]+")"};d.frob=function(x){return(Math.sqrt(Math.pow(x[0],2)+Math.pow(x[1],2)+Math.pow(x[2],2)+Math.pow(x[3],2)+Math.pow(x[4],2)+Math.pow(x[5],2)+Math.pow(x[6],2)+Math.pow(x[6],2)+Math.pow(x[7],2)+Math.pow(x[8],2)+Math.pow(x[9],2)+Math.pow(x[10],2)+Math.pow(x[11],2)+Math.pow(x[12],2)+Math.pow(x[13],2)+Math.pow(x[14],2)+Math.pow(x[15],2)))
};if(typeof(q)!=="undefined"){q.mat4=d}var m={};m.create=function(){var x=new h(4);x[0]=0;x[1]=0;x[2]=0;x[3]=1;return x};m.rotationTo=(function(){var x=t.create();var y=t.fromValues(1,0,0);var z=t.fromValues(0,1,0);return function(D,B,A){var C=t.dot(B,A);if(C<-0.999999){t.cross(x,y,B);if(t.length(x)<0.000001){t.cross(x,z,B)}t.normalize(x,x);m.setAxisAngle(D,x,Math.PI);return D}else{if(C>0.999999){D[0]=0;D[1]=0;D[2]=0;D[3]=1;return D}else{t.cross(x,B,A);D[0]=x[0];D[1]=x[1];D[2]=x[2];D[3]=1+C;return m.normalize(D,D)
}}}})();m.setAxes=(function(){var x=f.create();return function(A,z,B,y){x[0]=B[0];x[3]=B[1];x[6]=B[2];x[1]=y[0];x[4]=y[1];x[7]=y[2];x[2]=-z[0];x[5]=-z[1];x[8]=-z[2];return m.normalize(A,m.fromMat3(A,x))}})();m.clone=s.clone;m.fromValues=s.fromValues;m.copy=s.copy;m.set=s.set;m.identity=function(x){x[0]=0;x[1]=0;x[2]=0;x[3]=1;return x};m.setAxisAngle=function(y,A,x){x=x*0.5;var z=Math.sin(x);y[0]=z*A[0];y[1]=z*A[1];y[2]=z*A[2];y[3]=Math.cos(x);return y};m.add=s.add;m.multiply=function(z,F,E){var x=F[0],H=F[1],G=F[2],y=F[3],C=E[0],B=E[1],A=E[2],D=E[3];
z[0]=x*D+y*C+H*A-G*B;z[1]=H*D+y*B+G*C-x*A;z[2]=G*D+y*A+x*B-H*C;z[3]=y*D-x*C-H*B-G*A;return z};m.mul=m.multiply;m.scale=s.scale;m.rotateX=function(z,D,B){B*=0.5;var x=D[0],F=D[1],E=D[2],y=D[3],A=Math.sin(B),C=Math.cos(B);z[0]=x*C+y*A;z[1]=F*C+E*A;z[2]=E*C-F*A;z[3]=y*C-x*A;return z};m.rotateY=function(z,D,B){B*=0.5;var x=D[0],F=D[1],E=D[2],y=D[3],A=Math.sin(B),C=Math.cos(B);z[0]=x*C-E*A;z[1]=F*C+y*A;z[2]=E*C+x*A;z[3]=y*C-F*A;return z};m.rotateZ=function(z,D,B){B*=0.5;var x=D[0],F=D[1],E=D[2],y=D[3],A=Math.sin(B),C=Math.cos(B);
z[0]=x*C+F*A;z[1]=F*C-x*A;z[2]=E*C+y*A;z[3]=y*C-E*A;return z};m.calculateW=function(C,B){var A=B[0],E=B[1],D=B[2];C[0]=A;C[1]=E;C[2]=D;C[3]=-Math.sqrt(Math.abs(1-A*A-E*E-D*D));return C};m.dot=s.dot;m.lerp=s.lerp;m.slerp=function(B,J,I,M){var x=J[0],N=J[1],L=J[2],z=J[3],G=I[0],F=I[1],E=I[2],H=I[3];var K,y,A,D,C;y=x*G+N*F+L*E+z*H;if(y<0){y=-y;G=-G;F=-F;E=-E;H=-H}if((1-y)>0.000001){K=Math.acos(y);A=Math.sin(K);D=Math.sin((1-M)*K)/A;C=Math.sin(M*K)/A}else{D=1-M;C=M}B[0]=D*x+C*G;B[1]=D*N+C*F;B[2]=D*L+C*E;
B[3]=D*z+C*H;return B};m.invert=function(D,z){var B=z[0],y=z[1],x=z[2],E=z[3],A=B*B+y*y+x*x+E*E,C=A?1/A:0;D[0]=-B*C;D[1]=-y*C;D[2]=-x*C;D[3]=E*C;return D};m.conjugate=function(y,x){y[0]=-x[0];y[1]=-x[1];y[2]=-x[2];y[3]=x[3];return y};m.length=s.length;m.len=m.length;m.squaredLength=s.squaredLength;m.sqrLen=m.squaredLength;m.normalize=s.normalize;m.fromMat3=function(B,x){var y=x[0]+x[4]+x[8];var D;if(y>0){D=Math.sqrt(y+1);B[3]=0.5*D;D=0.5/D;B[0]=(x[7]-x[5])*D;B[1]=(x[2]-x[6])*D;B[2]=(x[3]-x[1])*D}else{var C=0;
if(x[4]>x[0]){C=1}if(x[8]>x[C*3+C]){C=2}var A=(C+1)%3;var z=(C+2)%3;D=Math.sqrt(x[C*3+C]-x[A*3+A]-x[z*3+z]+1);B[C]=0.5*D;D=0.5/D;B[3]=(x[z*3+A]-x[A*3+z])*D;B[A]=(x[A*3+C]+x[C*3+A])*D;B[z]=(x[z*3+C]+x[C*3+z])*D}return B};m.str=function(x){return"quat("+x[0]+", "+x[1]+", "+x[2]+", "+x[3]+")"};if(typeof(q)!=="undefined"){q.quat=m}})(a.exports)})(this);function vxlLandmark(a,d){if(!(d instanceof vxlCamera)){alert("vxlLandmark needs a vxlCamera as argument");return null}this.name=a;var f=d;this._matrix=mat4.clone(f._matrix);
this._right=vec3.clone(f._right);this._up=vec3.clone(f._up);this._forward=vec3.clone(f._forward);this._position=vec3.clone(f._position);this._focalPoint=vec3.clone(f._focalPoint);this._distanceVector=vec3.clone(f._distanceVector);this._azimuth=f._azimuth;this._elevation=f._elevation;this._roll=f._roll;this._relAzimuth=f._relAzimuth;this._relElevation=f._relElevation;this._relRoll=f._relRoll;this._dollyingStep=f._dollyngStep;this._distance=f._distance}vxlLandmark.prototype.retrieve=function(a){var d=a;
d._matrix=mat4.copy(d._matrix,this._matrix);d._right=vec3.copy(d._right,this._right);d._up=vec3.copy(d._up,this._up);d._forward=vec3.copy(d._forward,this._forward);d._position=vec3.copy(d._position,this._position);d._focalPoint=vec3.copy(d._focalPoint,this._focalPoint);d._distanceVector=vec3.copy(d._distanceVector,this._distanceVector);d._azimuth=this._azimuth;d._elevation=this._elevation;d._roll=this._roll;d._relAzimuth=this._relAzimuth;d._relElevation=this._relElevation;d._relRoll=this._relRoll;
d._dollyingStep=this._dollyngStep;d._distance=this._distance;d.refresh()};function vxlCamera(c,a){this.UID=vxl.util.generateUID();this.view=c;this._matrix=mat4.create();this._right=vec3.fromValues(1,0,0);this._up=vec3.fromValues(0,1,0);this._forward=vec3.fromValues(0,0,1);this._position=vec3.fromValues(0,0,1);this._focalPoint=vec3.fromValues(0,0,0);this._distanceVector=vec3.fromValues(0,0,0);this._azimuth=0;this._elevation=0;this._roll=0;this._relAzimuth=0;this._relElevation=0;this._relRoll=0;this._dollyingStep=0;
this._distance=1;this._rotate_world=false;this._fov=vxl.def.camera.fov;this._near=vxl.def.camera.near;this._far=vxl.def.camera.far;this._aspect=undefined;this._perspective=mat4.create();this.updatePerspective();this._following=undefined;this._trackingMode=vxl.def.camera.tracking.DEFAULT;this.landmarks=[];this._lmarkAnimationID=undefined;if(a==undefined){this.setType(vxl.def.camera.type.EXPLORING)}else{this.setType(a)}}vxlCamera.prototype.setWorldRotation=function(a){this._rotate_world=a;this._getAngles();
return this};vxlCamera.prototype.setType=function(c,a){var d=vxl.def.camera.type;if(c!=d.ORBITING&&c!=d.TRACKING&&c!=d.EXPLORING){console.warn("vxlCamera.setType WARNING type ["+c+"] unknown. Setting camera to EXPLORING type.");this.type=d.EXPLORING;this.setWorldRotation(true)}else{this.type=c;if(this.type==d.EXPLORING){this.setWorldRotation(true)}else{this.setWorldRotation(false)}this._getAngles()}if(this.type==vxl.def.camera.type.TRACKING&&a!=undefined){this.setTrackingMode(a)}return this};vxlCamera.prototype.setTrackingMode=function(a){if(this.type!=vxl.def.camera.type.TRACKING){alert("Impossible to set a tracking mode if the camera is not of tracking type");
throw ("Impossible to set a tracking mode if the camera is not of tracking type")}if(a==undefined){return}this._trackingMode=a};vxlCamera.prototype.follow=function(a,c){this.setType(vxl.def.camera.type.TRACKING,c);if(a instanceof vxlActor){instance=a}else{if(typeof(a)=="string"){instance=this.view.scene.getActorByName(a)}}if(instance==undefined){console.error("vxlCamera.follow ERROR: The actor "+a+" does not exist")}else{this._following=instance;instance.addTrackingCamera(this)}return this};vxlCamera.prototype.unfollow=function(){this._following.removeTrackingCamera(this);
this._following=undefined;return this};vxlCamera.prototype.updateWithActor=function(a){if(this._following!=a){return}switch(this._trackingMode){case vxl.def.camera.tracking.DEFAULT:break;case vxl.def.camera.tracking.ROTATIONAL:case vxl.def.camera.tracking.CINEMATIC:this.setFocalPoint(a._position);break;case vxl.def.camera.tracking.TRANSLATIONAL:this.translate(a._translation);this.setFocalPoint(a._position);break}};vxlCamera.prototype.setPosition=function(a,d,c){this._setPosition(a,d,c);this.setFocalPoint(this._focalPoint);
return this};vxlCamera.prototype.setFocalPoint=function(o,n,l){var h=vec3.fromValues(0,1,0);this._focalPoint=vxl.util.createVec3(o,n,l);if(this._trackingMode==vxl.def.camera.tracking.CINEMATIC){var k=vec3.subtract(vec3.create(),this._focalPoint,this._position);var o=k[0],n=k[1],l=k[2],a=vec3.length(k);var c=Math.asin(n/a)*vxl.def.rad2deg;var q=90+Math.atan2(l,o)*vxl.def.rad2deg;var f=mat4.create();mat4.rotateY(f,f,q*vxl.def.deg2rad);mat4.rotateX(f,f,c*vxl.def.deg2rad);h=vec3.transformMat4(vec3.create(),[0,1,0],f)
}mat4.invert(this._matrix,mat4.lookAt(mat4.create(),this._position,this._focalPoint,h));this._getAxes();this._getDistance();this._getAngles();return this};vxlCamera.prototype.setDistance=function(c){if(this._distance==c||c<0){return}this._distance=c;if(this._distance<0.0002){this._distance=0.0002;console.warn(" vxlCamera.setDistance WARN: Distance is set to minimum (0.0002)")}this._dollyingStep=this._distance/100;var k=vec3.create();var c=this._distance;var h=this._forward;var a=this._focalPoint;
k[0]=c*h[0]+a[0];k[1]=c*h[1]+a[1];k[2]=c*h[2]+a[2];this._setPosition(k);return this};vxlCamera.prototype.changeAzimuth=function(a){this.setAzimuth(this._azimuth+a);return this};vxlCamera.prototype.changeElevation=function(a){this.setElevation(this._elevation+a);return this};vxlCamera.prototype.changeRoll=function(a){this.setRoll(this._roll+a);return this};vxlCamera.prototype.setAzimuth=function(a){this._azimuth=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()
}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.setElevation=function(a){this._elevation=this._getAngle(a);this._computeMatrix();this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.setRoll=function(a){this._roll=this._getAngle(a);this._computeMatrix();this._getAxes();
if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}return this};vxlCamera.prototype.rotate=function(m,l,d){if(this.type==vxl.def.camera.type.EXPLORING){m=this._getAngle(m);l=this._getAngle(l);d=this._getAngle(d);var k=quat.setAxisAngle(quat.create(),[1,0,0],-l*vxl.def.deg2rad);var h=quat.setAxisAngle(quat.create(),[0,1,0],-m*vxl.def.deg2rad);if(this._rotate_world){k=quat.setAxisAngle(quat.create(),[1,0,0],l*vxl.def.deg2rad);
h=quat.setAxisAngle(quat.create(),[0,1,0],m*vxl.def.deg2rad)}var f=quat.setAxisAngle(quat.create(),[0,0,1],d*vxl.def.deg2rad);var c=quat.multiply(quat.create(),h,k);c=quat.multiply(quat.create(),c,f);var a=mat4.fromQuat(mat4.create(),c);mat4.translate(this._matrix,this._matrix,[0,0,-this._distance]);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(Math.abs(this._elevation+l)>90){return}this._relElevation=this._getAngle(l);this._relAzimuth=this._getAngle(m);
this._relRoll=this._getAngle(d);this._elevation+=this._relElevation;this._azimuth+=this._relAzimuth;this._roll+=this._relRoll;this._computeMatrix()}this._getAxes();if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getPosition()}else{if(this.type==vxl.def.camera.type.TRACKING){this._getFocalPoint()}}this._update();return this};vxlCamera.prototype.dolly=function(c){var f=this._forward;var d=vec3.clone(this._position);var a=c*this._dollyingStep;d[0]+=a*f[0];
d[1]+=a*f[1];d[2]+=a*f[2];this._setPosition(d);if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){this._getDistance()}else{if(this.type==vxl.def.camera.type.TRACKING){vec3.add(this._focalPoint,d,this._distanceVector)}}return this};vxlCamera.prototype.pan=function(c,a){var d=vxl.util.createVec3(c,a,0);var f=vec3.clone(this._position);vec3.add(f,f,vec3.scale(vec3.create(),this._right,d[0]));vec3.add(f,f,vec3.scale(vec3.create(),this._up,d[1]));this._setPosition(f);
return this};vxlCamera.prototype.translate=function(a,h,d){var c=vxl.util.createVec3(a,h,d);var f=vec3.clone(this._position);vec3.add(f,f,c);this._setPosition(f);return this};vxlCamera.prototype.refresh=function(){this.view.refresh();return this};vxlCamera.prototype.lookAt=function(a){if(a instanceof vxlActor){this.setFocalPoint(a._position)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this.setFocalPoint(a._position)
}}}return this};vxlCamera.prototype.closeUp=function(a){if(a instanceof vxlActor){this._shot(a._bb)}else{if(typeof(a)=="string"){var a=this.view.scene.getActorByName(a);if(a==undefined){throw"vxlCamera.lookAt ERROR: The actor "+actorName+" does not exist"}else{this._shot(a._bb)}}}return this};vxlCamera.prototype.longShot=function(){this.view.scene.computeBoundingBox();this._shot(this.view.scene.bb);return this};vxlCamera.prototype.setFieldOfView=function(a){this._fov=a;return this};vxlCamera.prototype.createLandmark=function(k,a,f,h){var m=new vxlCamera(this.view,this.type);
m.setPosition(a);m.setFocalPoint(f);if(h!=undefined){m.setRoll(h)}var d=new vxlLandmark(k,m);this.landmarks.push(d);return this};vxlCamera.prototype.setLandmark=function(c){var a=new vxlLandmark(c,this);this.landmarks.push(a);return this};vxlCamera.prototype.gotoLandmark=function(a,f,h){var n=undefined;var l=this.landmarks.length;while(l--){if(this.landmarks[l].name==a){n=this.landmarks[l];break}}if(n==undefined){console.warn("vxlCamera.goTo: landmark with name: "+a+", was not found");return}if(f==undefined||f==0){n.retrieve(this);
return}if(this._lmarkAnimationID!=undefined){window.clearTimeout(this._lmarkAnimationID)}var o=this;var q=n._position;var k=n._focalPoint;var m=n._roll;if(f==undefined){f=1000}if(h==undefined){h==20}var d=this.view.interactor;d.disconnectFromView();function c(w,t){var s=(w/100)*(t/10),x=w/s,v=0,y=new Date().getTime();function u(){var z=vec3.create();var B=vec3.create();var D=0;if(v++!=s){percent=v/s;percent2=(1-Math.cos(percent*Math.PI))/2;z=vec3.lerp(z,o._focalPoint,k,percent2);B=vec3.lerp(B,o._position,q,percent2);
D=o._roll*(1-percent2)+m*(percent2);o.setFocalPoint(z);o.setPosition(B);o.setRoll(D);o.refresh();var C=vec3.dist(z,k)+vec3.dist(B,q);if(C>0.01){var A=(new Date().getTime()-y)-(v*x);o._lmarkAnimationID=window.setTimeout(u,(x-A))}else{o.setFocalPoint(k);o.setPosition(q);o.setRoll(m);o.refresh();d.connectView(this.view)}return}}o._lmarkAnimationID=window.setTimeout(u,x)}c(f,h);return this};vxlCamera.prototype.doLandmarkAnimation=function(a){var d=a.slice(0);var c=this;function f(){if(d.length==0){return
}if(c._stop_lmark_animation){c._stop_lmark_animation=false;vxl.go.console("Landmark Animation Stopped",true);return}step=d.splice(0,1)[0];lmark=step[0];duration=step[1];fps=step[2];c.gotoLandmark(lmark,duration,fps);window.setTimeout(f,duration)}f();return this};vxlCamera.prototype.stopLandmarkAnimation=function(){this._stop_lmark_animation=true};vxlCamera.prototype.getLandmarks=function(){var c=[];var a=this.landmarks.length;while(a--){c.push(this.landmarks[a].name)}return c};vxlCamera.prototype._shot=function(f){this.setElevation(0);
this.setAzimuth(0);this.setRoll(0);var c=Math.max(f[3]-f[0],f[4]-f[1]);cc=[0,0,0];cc[0]=(f[3]+f[0])/2;cc[1]=(f[4]+f[1])/2;cc[2]=(f[5]+f[2])/2;cc[0]=Math.round(cc[0]*1000)/1000;cc[1]=Math.round(cc[1]*1000)/1000;cc[2]=Math.round(cc[2]*1000)/1000;if(c!=0){var a=1.5*c/(Math.tan(this._fov*Math.PI/180));this.setPosition([cc[0],cc[1],cc[2]+a])}this.setFocalPoint(cc);this.refresh()};vxlCamera.prototype.setAspectRatio=function(a){this._aspect=a};vxlCamera.prototype.setPerspective=function(h,f,c,k){var a=this.view;
this._fov=c;this._near=h;this._far=f;this._aspect=k;var d=vxl.util.deg2rad(c);if(this._aspect==undefined){mat4.perspective(this._perspective,d,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,d,this._aspect,this._near,this._far)}};vxlCamera.prototype.updatePerspective=function(){var a=this.view;var c=vxl.util.deg2rad(this._fov);if(this._aspect==undefined){mat4.perspective(this._perspective,c,a.width/a.height,this._near,this._far)}else{mat4.perspective(this._perspective,c,this._aspect,this._near,this._far)
}};vxlCamera.prototype.status=function(){console.info("------------- Camera Status -------------");console.info("       type: "+this.type);console.info("      right: "+vxl.util.format(this._right,2));console.info("         up: "+vxl.util.format(this._up,2));console.info("    forward: "+vxl.util.format(this._forward,2));console.info("   position: "+vxl.util.format(this._position,2));console.info("focal point: "+vxl.util.format(this._focalPoint,2));console.info("    azimuth: "+vxl.util.format(this._azimuth,2));
console.info("  elevation: "+vxl.util.format(this._elevation,2));console.info("       roll: "+vxl.util.format(this._roll,2));console.info("   distance: "+vxl.util.format(this._distance,2));console.info("   d vector: "+vxl.util.format(this._distanceVector,2))};vxlCamera.prototype.getViewTransform=function(){return mat4.invert(mat4.create(),this._matrix)};vxlCamera.prototype.setMatrix=function(a){this._matrix=a;this._update()};vxlCamera.prototype._computeMatrix=function(){mat4.identity(this._matrix);
var d=quat.setAxisAngle(quat.create(),[0,0,1],this._roll*vxl.def.deg2rad);var h=undefined;var f=undefined;if(this.type==vxl.def.camera.type.TRACKING){h=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*vxl.def.deg2rad);f=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*vxl.def.deg2rad)}else{if(this._rotate_world){h=quat.setAxisAngle(quat.create(),[1,0,0],this._elevation*vxl.def.deg2rad);f=quat.setAxisAngle(quat.create(),[0,1,0],this._azimuth*vxl.def.deg2rad)}else{h=quat.setAxisAngle(quat.create(),[1,0,0],-this._elevation*vxl.def.deg2rad);
f=quat.setAxisAngle(quat.create(),[0,1,0],-this._azimuth*vxl.def.deg2rad)}}var c=quat.multiply(quat.create(),f,h);c=quat.multiply(quat.create(),c,d);var a=mat4.fromQuat(mat4.create(),c);if(this.type==vxl.def.camera.type.ORBITING||this.type==vxl.def.camera.type.EXPLORING){mat4.translate(this._matrix,this._matrix,this._focalPoint);mat4.multiply(this._matrix,this._matrix,a);mat4.translate(this._matrix,this._matrix,[0,0,this._distance])}else{if(this.type==vxl.def.camera.type.TRACKING){mat4.translate(this._matrix,this._matrix,this._position);
mat4.multiply(this._matrix,this._matrix,a)}}};vxlCamera.prototype._setPosition=function(c,f,d){this._position=vxl.util.createVec3(c,f,d);var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1};vxlCamera.prototype._getAxes=function(){var a=this._matrix;vec3.copy(this._right,vec4.transformMat4(vec4.create(),[1,0,0,0],a));vec3.copy(this._up,vec4.transformMat4(vec4.create(),[0,1,0,0],a));vec3.copy(this._forward,vec4.transformMat4(vec4.create(),[0,0,1,0],a));
vec3.normalize(this._right,this._right);vec3.normalize(this._up,this._up);vec3.normalize(this._forward,this._forward)};vxlCamera.prototype._getPosition=function(){var a=this._matrix;vec3.copy(this._position,vec4.transformMat4(vec4.create(),[0,0,0,1],a));this._getDistance()};vxlCamera.prototype._getFocalPoint=function(){vec3.transformMat3(this._distanceVector,[0,0,-this._distance],mat3.fromMat4(mat3.create(),this._matrix));vec3.add(this._focalPoint,this._position,this._distanceVector);this._getDistance()
};vxlCamera.prototype._getDistance=function(){this._distanceVector=vec3.subtract(vec3.create(),this._focalPoint,this._position);this._distance=vec3.length(this._distanceVector);this._dollyingStep=this._distance/100};vxlCamera.prototype._getAngles=function(){var a=this._distanceVector[0],f=this._distanceVector[1],d=this._distanceVector[2];var c=vec3.length(this._distanceVector);if(c==0){this._elevation=0;this._azimuth=0;return}if(this.type==vxl.def.camera.type.TRACKING){this._elevation=Math.asin(f/c)*vxl.def.rad2deg;
this._azimuth=Math.atan2(-a,-d)*vxl.def.rad2deg}else{if(this._rotate_world){this._elevation=Math.asin(f/c)*vxl.def.rad2deg;this._azimuth=Math.atan2(-a,-d)*vxl.def.rad2deg}else{this._elevation=-1*Math.asin(f/c)*vxl.def.rad2deg;this._azimuth=-1*Math.atan2(-a,-d)*vxl.def.rad2deg}}};vxlCamera.prototype._update=function(){this._getAxes();this._getPosition();this._getDistance();this._getAngles()};vxlCamera.prototype._calculateAngles=function(){var k=mat4.toMat3(this._matrix);var f=mat3.toQuat4(k);var m=f[0],l=f[1],h=f[2],n=f[3];
var c=Math.atan2(2*(n*m+l*h),1-2*(m*m+l*l))*vxl.def.rad2deg;var a=Math.asin(2*(n*l-h*l))*vxl.def.rad2deg;var d=Math.atan2(2*(n*h+m*l),1-2*(l*l+h*h))*vxl.def.rad2deg;console.info(" roll :"+vxl.util.format(c,2));console.info("pitch :"+vxl.util.format(a,2));console.info("  yaw :"+vxl.util.format(d,2))};vxlCamera.prototype._getAngle=function(a){if(a==undefined){return 0}else{if(a>360||a<-360){return a%360}else{return a}}};function vxlCameraManager(a){this.view=a;this.cameras=[];this.active=this.create(vxl.def.camera.type.EXPLORING);
if(vxl.c.camera==undefined){vxl.c.camera=this.active}}vxlCameraManager.prototype.reset=function(a){this.cameras=[];this.interactors=[];this.active=this.create(a)};vxlCameraManager.prototype.create=function(c){var a=new vxlCamera(this.view,c);this.cameras.push(a);return a};vxlCameraManager.prototype.remove=function(a){if(this.cameras.length==1){throw ("vxlCameraManager.remove ERROR: the camera manager must not eliminate the last camera standing. Operation cancelled")}else{this.cameras.splice(a,1)}};
vxlCameraManager.prototype.get=function(a){this._checkBoundary(a);return this.cameras[a]};vxlCameraManager.prototype.switchTo=function(a){var c=this.view;this._checkBoundary(a);this.active=this.cameras[a];if(c.interactor!=undefined){c.interactor.connectCamera(this.active)}else{throw ("vxlCameraManager.switchTo ERROR: switching to camera ["+a+"] while the view "+c.name+" does not have an interactor set")}vxl.c.camera=this.active;return this.active};vxlCameraManager.prototype._checkBoundary=function(a){if(a<0||a>=this.cameras.length){throw ("The camera "+a+" does not exist")
}};function vxlViewInteractor(){this.view=undefined;this.camera=undefined;this.UID=vxl.util.generateUID();this.keymap={};this.keysEnabled=true}vxlViewInteractor.prototype.getType=function(){return"vxlViewInteractor"};vxlViewInteractor.prototype.disconnectFromView=function(){canvas=this.view.canvas;canvas.onmousedown=null;canvas.onmouseup=null;canvas.onmousemove=null;canvas.ondragover=null;canvas.ondragleave=null;canvas.ondrop=null;window.onkeydown=null;window.onkeyup=null;canvas.ondblclick=null};
vxlViewInteractor.prototype.connectView=function(a){if(!(a instanceof vxlView)){throw"ViewInteractor.connectView: the parameter is not a vxlView"}var d=this;var c=a.canvas;this.view=a;this.camera=a.cameraman.active;c.onmousedown=function(f){d.onMouseDown(f)};c.onmouseup=function(f){d.onMouseUp(f)};c.onmousemove=function(f){d.onMouseMove(f)};c.ondragover=function(f){d.onDragOver(f)};c.ondragleave=function(f){d.onDragLeave(f)};c.ondrop=function(f){d.onDrop(f)};window.onkeydown=function(f){d.onKeyDown(f)
};window.onkeyup=function(f){d.onKeyUp(f)};c.ondblclick=function(f){d.onDoubleClick(f)}};vxlViewInteractor.prototype.connectCamera=function(a){if(a instanceof vxlCamera){this.camera=a;this.camera.interactor=this}else{throw ("ViewInteractor.connectCamera: The object "+a+" is not a valid camera")}};vxlViewInteractor.prototype.addKeyAction=function(c,d){var a=c.charCodeAt(0);this.keymap[a]=d};vxlViewInteractor.prototype.removeKeyAction=function(c){var a=c.charCodeAt(0);delete this.keymap[a]};vxlViewInteractor.prototype.fireKeyAction=function(a){if(!this.keysEnabled){return
}if(this.keymap[a]){this.keymap[a](this.view,this.camera)}};vxlViewInteractor.prototype.enableKeyActions=function(a){this.keysEnabled=a};vxlTrackerInteractor.prototype=new vxlViewInteractor();vxlTrackerInteractor.prototype.constructor=vxlViewInteractor;function vxlTrackerInteractor(){vxlViewInteractor.call(this);this.MOTION_FACTOR=10;this.task=vxl.def.interactor.task.NONE;this.x=0;this.y=0;this.lastX=0;this.lastY=0;this.lastClickedX=0;this.lastClickedY=0;this.ctrlPressed=false;this.altPressed=false;
this.keyPressed=0;this.button=-1;this.dragging=false;this.dragndrop=false;this.isMac=vxl.util.isMac();this.addKeyAction("F",function(a,c){a.fullscreen(true)});this.addKeyAction("X",function(a,c){a.fullscreen(false)})}vxlTrackerInteractor.prototype.getType=function(){return"vxlTrackerInteractor"};vxlTrackerInteractor.prototype.onKeyDown=function(f){this.keyPressed=f.keyCode;this.altPressed=f.altKey;this.shiftPressed=f.shiftKey;var d=this.camera;if(!this.altPressed&&!this.shiftPressed){switch(this.keyPressed){case 38:d.changeElevation(10);
break;case 40:d.changeElevation(-10);break;case 37:d.changeAzimuth(-10);break;case 39:d.changeAzimuth(10);break;default:this.fireKeyAction(this.keyPressed)}}else{if(this.shiftPressed&&this.keyPressed!=17){var c=0;var a=0;switch(this.keyPressed){case 38:a=10;break;case 40:a=-10;break;case 37:c=-10;break;case 39:c=10;break;default:this.fireKeyAction(this.keyPressed)}if(c!=0||a!=0){this.pan(c,a)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onKeyUp=function(a){if(a.keyCode==17){this.ctrlPressed=false
}};vxlTrackerInteractor.prototype.onMouseUp=function(a){task=vxl.def.interactor.task.NONE;this.dragging=false};vxlTrackerInteractor.prototype.onMouseDown=function(a){this.x=a.clientX;this.y=a.clientY;this.lastClikedX=this.x;this.lastClickedY=this.y;this.button=a.button;this.dragging=true};vxlTrackerInteractor.prototype.onMouseMove=function(a){this.lastX=this.x;this.lastY=this.y;this.x=a.clientX;this.y=a.clientY;if(!this.dragging){return}if(this.button!=0){return}this.ctrlPressed=a.ctrlKey;if(this.isMac&&a.metaKey){this.ctrlPressed=true
}this.altPressed=a.altKey;this.shiftPressed=a.shiftKey;var d=this.x-this.lastX;var c=this.y-this.lastY;if(this.ctrlPressed&&!this.shiftPressed){this.dolly(c)}else{if(this.shiftPressed&&!this.ctrlPressed){this.pan(d,c)}else{if(this.ctrlPressed&&this.shiftPressed){this.roll(c)}else{this.rotate(d,c)}}}this.camera.refresh()};vxlTrackerInteractor.prototype.onDragOver=function(a){a.stopPropagation();a.preventDefault();if(this.view.dragndrop){if(!this.dragndrop){this.bgcolor=this.view.backgroundColor.slice(0);
this.dragndrop=true}a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(0,0.514,0.678)}};vxlTrackerInteractor.prototype.onDragLeave=function(a){a.stopPropagation();a.preventDefault();if(this.view.dragndrop){a.dataTransfer.dropEffect="copy";this.view.setBackgroundColor(this.bgcolor);this.dragndrop=false}};vxlTrackerInteractor.prototype.onDrop=function(d){d.stopPropagation();d.preventDefault();if(!this.view.dragndrop){return}this.dragndrop=false;this.view.setBackgroundColor(this.bgcolor);
var c=d.dataTransfer.files;var a=new vxlVTKReader(this.view.scene);if(a.isSupported()){a.readFile(c[0])}else{throw"vxlTrackerInteractor.drop: File API is not supported on this browser"}};vxlTrackerInteractor.prototype.onDoubleClick=function(a){this.camera.longShot()};vxlTrackerInteractor.prototype.dolly=function(a){this.task=vxl.def.interactor.task.DOLLY;this.camera.dolly(a)};vxlTrackerInteractor.prototype.roll=function(f){this.task=vxl.def.interactor.task.ROLL;var c=this.camera.view.canvas;var a=-20/c.width;
var d=f*a*this.MOTION_FACTOR;this.camera.rotate(0,0,d)};vxlTrackerInteractor.prototype.rotate=function(d,a){this.task=vxl.def.interactor.task.ROTATE;var k=this.camera.view.canvas;var n=-20/k.height;var m=-20/k.width;var f=this.MOTION_FACTOR;var c=this.MOTION_FACTOR;if(d*d>2*a*a){c*=0.5}else{if(a*a>2*d*d){f*=0.5}}var l=d*n*f;var h=a*m*c;this.camera.rotate(l,h)};vxlTrackerInteractor.prototype.pan=function(q,o){this.task=vxl.def.interactor.task.PAN;var h=this.camera;var a=h.view.canvas;var f=h.view.scene;
this.dragndrop=false;var n=Math.max(a.width,a.height);var d=1/n;var c=1/n;var k=f.bb.max();var m=q*d*this.MOTION_FACTOR*k/2;var l=-o*c*this.MOTION_FACTOR*k/2;h.pan(m,l)};vxlPickerInteractor.prototype=new vxlViewInteractor();vxlPickerInteractor.prototype.constructor=vxlPickerInteractor;function vxlPickerInteractor(){vxlViewInteractor.call(this);this._drag=false;this.timerID=-1;this.list=[];this.rate=50}vxlPickerInteractor.prototype.getType=function(){return"vxlPickerInteractor"};vxlPickerInteractor.prototype.get2DCoords=function(d){var a,l,k=0,h=0,f=this.view.canvas;
var c=f.getBoundingClientRect();a=d.clientX-c.left;l=vxl.c.view.canvas.height-(d.clientY-c.top);return[a,l]};vxlPickerInteractor.prototype.onMouseUp=function(a){this._drag=false;if(this.timerID!=-1){clearInterval(this.timerID)}};vxlPickerInteractor.prototype.onMouseDown=function(a){a.preventDefault();this.view.canvas.style.cursor="crosshair";this.list.push(this.get2DCoords(a));this._doWork();this._drag=true;if(this.timerID!=-1){clearInterval(this.timerID)}this.timerID=setInterval((function(c){return function(){c._doWork()
}})(this),this.rate)};vxlPickerInteractor.prototype.onMouseMove=function(a){a.preventDefault();if(this._drag){this.list.push(this.get2DCoords(a))}};vxlPickerInteractor.prototype._doWork=function(){var d=this.list.length;var k=this.view.renderer;var l=this.view.scene;while(d--){var h=this.list.pop();var a=k.readOffscreenPixel(h[0],h[1]);if(a[0]==0&&a[1]==0&&a[2]==0&&a[3]==0){continue}var c=vxl.go.picker.query(a);if(c==null){continue}var f=l.getActorByCellUID(c.uid);if(f==null){f=l.getActorByUID(c.uid)
}if(f!=null&&f.isPickable()&&f._pickingCallback!=undefined){f._pickingCallback(f,c.uid)}}};vxlPickerInteractor.prototype.onKeyDown=function(a){};vxlPickerInteractor.prototype.onKeyUp=function(a){};vxlPickerInteractor.prototype.onDragOver=function(a){};vxlPickerInteractor.prototype.onDragLeave=function(a){};vxlPickerInteractor.prototype.onDrop=function(a){};vxlViewInteractor.prototype.onDoubleClick=function(a){};function vxlTransforms(a){this._stack=[];this.view=a;this.model_view=mat4.create();this.projection=mat4.create();
this.camera=mat4.create();this.normal=mat4.create();this.projection_model_view=mat4.create()}vxlTransforms.prototype.calculateModelView=function(){this.model_view=mat4.copy(this.model_view,this.view.cameraman.active.getViewTransform())};vxlTransforms.prototype.calculateCamera=function(){this.camera=mat4.inverse(this.camera,this.model_view)};vxlTransforms.prototype.calculateNormal=function(){this.normal=mat4.clone(this.model_view);this.normal=mat4.invert(mat4.create(),this.normal);this.normal=mat4.transpose(this.normal,this.normal)
};vxlTransforms.prototype.calculateProjection=function(){var a=this.view.cameraman.active;a.updatePerspective();this.projection=a._perspective};vxlTransforms.prototype.calculateProjectionModelView=function(){mat4.multiply(this.projection_model_view,this.projection,this.model_view)};vxlTransforms.prototype.update=function(){this.calculateModelView();this.calculateProjection();this.calculateNormal();this.calculateProjectionModelView()};vxlTransforms.prototype.push=function(){var a=mat4.create();mat4.copy(a,this.model_view);
this._stack.push(a)};vxlTransforms.prototype.pop=function(){if(this._stack.length==0){return}this.model_view=this._stack.pop();this.calculatePerspective();this.calculateNormal();this.calculateProjectionModelView()};function vxlProgram(){this.ID=undefined;this.ATTRIBUTES=[];this.UNIFORMS=[];this.VERTEX_SHADER="";this.FRAGMENT_SHADER="";this.DEFAULTS={}}vxlProgram.prototype.copy=function(a){this.ID=a.ID;this.ATTRIBUTES=a.ATTRIBUTES;this.UNIFORMS=a.UNIFORMS;this.VERTEX_SHADER=a.VERTEX_SHADER;this.FRAGMENT_SHADER=a.FRAGMENT_SHADER;
this.DEFAULTS=a.DEFAULTS};vxlProgram.prototype.introspect=function(){this.ATTRIBUTES=[];this.UNIFORMS=[];var f=this.VERTEX_SHADER.concat(this.FRAGMENT_SHADER);f=f.replace(/(\r\n|\n\r|\n)/gm,"");var a=f.match(/(uniform)\s*\w*\s*\w*/g);var c=f.match(/(attribute)\s*\w*\s*\w*/g);if(a.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid uniforms")}if(c.length==0){throw new vxlProgramException("The code for the program "+this.ID+" does not contain any valid attributes")
}for(var d=0,h=a.length;d<h;d+=1){this.UNIFORMS.push(a[d].substr(a[d].lastIndexOf(" ")+1,a[d].length))}for(var d=0,h=c.length;d<h;d+=1){this.ATTRIBUTES.push(c[d].substr(c[d].lastIndexOf(" ")+1,c[d].length))}};vxlProgram.createFromDOM=function(k,c,a){var d=new vxlProgram();d.ID=k;var h=document.getElementById(c);var f=document.getElementById(a);if(h==null||f==null){throw new vxlProgramException("shaders don't exist")}d.VERTEX_SHADER=h.innerHTML;d.FRAGMENT_SHADER=f.innerHTML;d.introspect();return d
};vxlProgram.createFromJSON=function(a){var c=new vxlProgram();if(a.ID){c.ID=a.ID}c.VERTEX_SHADER=a.VERTEX_SHADER;c.FRAGMENT_SHADER=a.FRAGMENT_SHADER;c.DEFAULTS=a.DEFAULTS;c.introspect();return c};vxlProgram.createFromTextURL=function(d,c,a){};function vxlProgramException(a){this.message="vxlProgramException:"+a}vxlLambertProgram.prototype=new vxlProgram();vxlLambertProgram.prototype.constructor=vxlLambertProgram;function vxlLambertProgram(){this.copy(vxlProgram.createFromJSON({ID:"lambert",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform vec4 uMaterialDiffuse;","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform bool uUseLightTranslation;","uniform bool uUseTextures;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","   gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","   gl_PointSize = uPointSize;","   if (uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,uMaterialDiffuse.a);","   }","   else {","       vFinalColor = uMaterialDiffuse;","   }","   if (uUseShading){","       vec3 N = normalize(vec3(mNormal * vec4(aVertexNormal, 1.0)));","       vec3 L = normalize(uLightDirection);","       if (uUseLightTranslation){ L = vec3(mNormal * vec4(L,1.0));}","       float lambertTerm = max(dot(N,-L),0.4);","       vec4 Ia = uLightAmbient;","       vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","       vFinalColor = Ia + Id;","       vFinalColor.a = uMaterialDiffuse.a;","   }","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4      vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)  {","   if (uUseTextures){","       gl_FragColor = texture2D(uSampler, vTextureCoords);","   }","   else{","       gl_FragColor = vFinalColor;","   }","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uMaterialDiffuse:[0.9,0.9,0.9,1],uPointSize:1,uUseLightTranslation:false}}))
}vxl.go.essl.lambert=new vxlLambertProgram();vxlPhongProgram.prototype=new vxlProgram();vxlPhongProgram.prototype.constructor=vxlPhongProgram;function vxlPhongProgram(){this.copy(vxlProgram.createFromJSON({ID:"phong",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","uniform float uPointSize;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","uniform bool uUseVertexColors;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","uniform bool uUseTextures;","void main(void) {","  gl_Position = mPerspective * mModelView * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","   if(uUseVertexColors) {","       vFinalColor = vec4(aVertexColor,1.0);","       return;","   }","   vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","   vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","   vEyeVec = -vec3(vertex.xyz);","   if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform bool uUseVertexColors;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = uMaterialDiffuse;","  if(uUseVertexColors) {","        varMaterialDiffuse = vFinalColor;","   }","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}vxl.go.essl.phong=new vxlPhongProgram();vxlBakeProgram.prototype=new vxlProgram();vxlBakeProgram.prototype.constructor=vxlBakeProgram;function vxlBakeProgram(){this.copy(vxlProgram.createFromJSON({ID:"bake",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec3 aPosition;","attribute vec3 aScale;","attribute float aShading;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mNormal;","uniform mat4 mModelViewPerspective;","uniform vec3 uLightDirection;","uniform vec4 uLightAmbient;","uniform vec4 uLightDiffuse;","uniform bool uUseLightTranslation;","varying vec4 vFinalColor;","void main(void) {","   vec3 position = (aVertexPosition * aScale) + aPosition;","   gl_Position = mModelViewPerspective * vec4(position, 1.0);","   vFinalColor = vec4(aVertexColor,1.0);","   if (aShading == 1.0){","      vec3 N = vec3(mNormal * vec4(aVertexNormal, 1.0));","      vec3 L = normalize(uLightDirection);","      if (uUseLightTranslation) { L = vec3(mNormal * vec4(L,1.0));}","      float lambertTerm = max(dot(N,-L),0.4);","      vec4 Ia = uLightAmbient;","      vec4 Id = vFinalColor * uLightDiffuse * lambertTerm;","      vFinalColor = Ia + Id;","      vFinalColor.a = 1.0;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","varying vec4  vFinalColor;","void main(void)  {","       gl_FragColor = vFinalColor;","}"].join("\n"),DEFAULTS:{uLightDirection:[0,0,-1],uLightAmbient:[0,0,0,1],uLightDiffuse:[1,1,1,1],uUseLightTranslation:false}}))
}vxl.go.essl.bake=new vxlBakeProgram();vxlDashProgram.prototype=new vxlProgram();vxlDashProgram.prototype.constructor=vxlDashProgram;function vxlDashProgram(){this.copy(vxlProgram.createFromJSON({ID:"dash",VERTEX_SHADER:["attribute vec3 aVertexPosition;","attribute vec3 aVertexNormal;","attribute vec3 aVertexColor;","attribute vec2 aVertexTextureCoords;","attribute mat4 aActorMatrix;","uniform float uPointSize;","uniform bool uUseTextures;","uniform mat4 mModelView;","uniform mat4 mPerspective;","uniform mat4 mModelViewPerspective;","uniform mat4 mNormal;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2 vTextureCoords;","void main(void) {","  mat4 matrix = aActorMatrix; ","  gl_Position =  mPerspective * mModelView * matrix * vec4(aVertexPosition, 1.0);","  gl_PointSize = uPointSize;","  vFinalColor = vec4(aVertexColor,1.0);","  vec4 vertex = mModelView * vec4(aVertexPosition, 1.0);","  vNormal = vec3(mNormal * vec4(aVertexNormal, 1.0));","  vEyeVec = -vec3(vertex.xyz);","  if (uUseTextures){","       vTextureCoords = aVertexTextureCoords;","   }","}"].join("\n"),FRAGMENT_SHADER:["#ifdef GL_ES","precision highp float;","#endif","uniform bool uUseShading;","uniform float uShininess;      ","uniform vec3 uLightDirection;  ","uniform vec4 uLightAmbient;    ","uniform vec4 uLightDiffuse;    ","uniform vec4 uLightSpecular;   ","uniform vec4 uMaterialAmbient; ","uniform vec4 uMaterialDiffuse; ","uniform vec4 uMaterialSpecular;","varying vec3 vNormal;","varying vec3 vEyeVec;","varying vec4 vFinalColor;","varying vec2      vTextureCoords;","uniform bool      uUseTextures;","uniform sampler2D uSampler;","void main(void)","{","  vec4 finalColor = vec4(0.0);","  vec3 L = normalize(uLightDirection);","  vec3 N = normalize(vNormal);","  float lambertTerm = dot(N,-L);","  vec4 Ia = uLightAmbient * uMaterialAmbient;","  vec4 Id = vec4(0.0,0.0,0.0,1.0);","  vec4 Is = vec4(0.0,0.0,0.0,1.0);","  vec4 varMaterialDiffuse = vFinalColor;","  if(uUseShading){  ","      if(lambertTerm > 0.0)","      {","          Id = uLightDiffuse * varMaterialDiffuse * lambertTerm;","          vec3 E = normalize(vEyeVec);","          vec3 R = reflect(L, N);","          float specular = pow( max(dot(R, E), 0.0), uShininess);","          Is = uLightSpecular * uMaterialSpecular * specular;","      }","      finalColor = Ia + Id + Is;","      finalColor.a = uMaterialDiffuse.a;","  } ","  else {","      finalColor = varMaterialDiffuse; ","  }","   if (uUseTextures){","       finalColor =  texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t));","   }","   gl_FragColor = finalColor;","}"].join("\n"),DEFAULTS:{uUseTextures:false,uShininess:230,uLightDirection:[0,-1,-1],uLightAmbient:[0.03,0.03,0.03,1],uLightDiffuse:[1,1,1,1],uLightSpecular:[1,1,1,1],uMaterialAmbient:[1,1,1,1],uMaterialDiffuse:[0.8,0.8,0.8,1],uMaterialSpecular:[1,1,1,1]}}))
}vxl.go.essl.dash=new vxlDashProgram();function vxlProgramManager(a){this._gl=a;this._registered_programs={};this._programs={};this._uniform_map={};this._uniform_types={};this._current_program_object=null;this._current_program_ID=undefined;this._curr_uniform_loc_map={};this._curr_uniform_cache={};this._curr_attribute_loc_map={};this._enabled_attribute_list=[];this._defaults=[];this._one_time_warning=false;this._program_enforced=false}vxlProgramManager.prototype._isProgramRegistered=function(a){return(this._registered_programs[a]!=undefined)
};vxlProgramManager.prototype._registerProgram=function(a){vxl.go.console("Registering program "+a.ID);this._registered_programs[a.ID]=a};vxlProgramManager.prototype._isProgramCreated=function(a){return(this._programs[a]!=undefined)};vxlProgramManager.prototype._createProgramObject=function(c){if(this._isProgramCreated(c)){return}var h=this._registered_programs[c];if(h==undefined){var f="vxlProgramManager.loadProgram ERROR:  The program "+c+" must be registered first!";console.error(f);return}var l=this._gl;
var d=l.createProgram();var k=vxl.def.essl;if(h.VERTEX_SHADER){var m=this._createShader(k.VERTEX_SHADER,h.VERTEX_SHADER);l.attachShader(d,m)}if(h.FRAGMENT_SHADER){var a=this._createShader(k.FRAGMENT_SHADER,h.FRAGMENT_SHADER);l.attachShader(d,a)}l.bindAttribLocation(d,0,k.VERTEX_ATTRIBUTE);l.linkProgram(d);if(!l.getProgramParameter(d,l.LINK_STATUS)){alert(c+":\n\n "+l.getProgramInfoLog(d));throw ("Error linking program "+c+":\n\n "+l.getProgramInfoLog(d))}this._programs[c]=d};vxlProgramManager.prototype.useProgram=function(a){var d=this._gl;
var c=this._programs[a];if(c!=undefined&&c!=null){if(c==this._current_program_object){return}d.useProgram(c);this._current_program_object=c;this._current_program_ID=a;this._parseUniforms();this._one_time_warning=false}else{alert("Program: the program "+a+" has NOT been loaded")}};vxlProgramManager.prototype.releaseProgram=function(){this._enforce=false};vxlProgramManager.prototype.setProgram=function(c,f){var a=undefined;if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.error("vxlProgramManager.setProgram ERROR: "+c+" is not an engine");
return}}if(this._enforce&&a.ID!=this._current_program_id){var d="vxlProgramManager.setProgram WARN: Unable to set the program "+a.ID+".\nThe current program ["+a.ID+"] is being enforced\nPlease use releaseProgram first.";console.warn(d);return}this._program_enforced=(f!=undefined&&f==true);if(!this._isProgramRegistered(a.ID)){this._registerProgram(a)}if(!this._isProgramCreated(a.ID)){this._createProgramObject(a.ID)}this.useProgram(a.ID);this.clearCache();this.loadDefaults()};vxlProgramManager.prototype.clearCache=function(){this._curr_uniform_cache={};
this._curr_uniform_loc_map={};this._curr_attribute_loc_map={}};vxlProgramManager.prototype.loadDefaults=function(){var c=this._registered_programs[this._current_program_ID];if("DEFAULTS" in c){var d=c.DEFAULTS;for(var a in d){this.setUniform(a,d[a])}}var d=this._defaults[this._current_program_ID];if(d!=undefined){for(var a in d){this.setUniform(a,d[a])}}};vxlProgramManager.prototype.setDefault=function(c,a,d){if(this._defaults[c]==undefined){this._defaults[c]={}}this._defaults[c][a]=d;if(c==this._current_program_ID){this.setUniform(a,d)
}};vxlProgramManager.prototype.getDefault=function(c,a){if(this._defaults[c]==undefined){return undefined}return this._defaults[c][a]};vxlProgramManager.prototype.setUniforms=function(a){for(key in a){this.setUniform(key,a[key])}};vxlProgramManager.prototype.setUniform=function(q,n,f){var h=this._gl;var c=this._current_program_object;var o=this._uniform_map[this._current_program_ID];var a=this._curr_uniform_loc_map;var d=this._curr_uniform_cache;var s=this._uniform_types[this._current_program_ID];
var l=undefined;var k=false;if(o.indexOf(q)==-1){console.warn("vxlProgramManager.setUniform: the uniform "+q+" is not defined for the program "+this._current_program_ID);return}l=a[q];if(l==undefined){l=h.getUniformLocation(c,q);a[q]=l}var t=d[q];var m=s[q];if(t==undefined){k=true}else{switch(m){case"sampler2D":case"float":case"int":case"bool":k=(t!==n);break;case"mat4":k=((n[0]!==t[0])||(n[1]!==t[1])||(n[2]!==t[2])||(n[3]!==t[3])||(n[4]!==t[4])||(n[5]!==t[5])||(n[6]!==t[6])||(n[7]!==t[7])||(n[8]!==t[8])||(n[9]!==t[9])||(n[10]!==t[10])||(n[11]!==t[11])||(n[12]!==t[12])||(n[13]!==t[13])||(n[14]!==t[14])||(n[15]!==t[15]));
break;case"vec3":k=((n[0]!==t[0])||(n[1]!==t[1])||(n[2]!==t[2]));break;case"vec4":k=((n[0]!==t[0])||(n[1]!==t[1])||(n[2]!==t[2])||(n[3]!==t[3]));break;default:k=true}}if(k){switch(m){case"float":case"int":case"bool":d[q]=n;break;case"mat4":d[q]=mat4.clone(n);break;case"mat3":d[q]=mat3.clone(n);break;case"vec4":d[q]=vec4.clone(n);break;case"vec3":d[q]=vec3.clone(n);break;case"vec2":d[q]=vec2.clone(n);break;case"sampler2D":d[q]=n;break;default:alert("error: type unknown cannot update uniform cache")
}this._setPolymorphicUniform(q,l,n,f)}};vxlProgramManager.prototype.getUniform=function(a){return this._curr_uniform_cache[a]};vxlProgramManager.prototype.setAttributePointer=function(f,c,k,h,l,m){var d=this._getAttributeLocation(f);this._gl.vertexAttribPointer(d,c,k,h,l,m)};vxlProgramManager.prototype.enableAttribute=function(d){if(this._enabled_attribute_list.indexOf(d)!=-1){return}var c=this._getAttributeLocation(d);this._gl.enableVertexAttribArray(c);this._enabled_attribute_list.push(d)};vxlProgramManager.prototype.disableAttribute=function(c){if(c==undefined){return
}var a=this._enabled_attribute_list.indexOf(c);if(a>=0){var d=this._getAttributeLocation(c);this._gl.disableVertexAttribArray(d);this._enabled_attribute_list.splice(a,1)}};vxlProgramManager.prototype._createShader=function(a,d){var f=this._gl;var c=null;if(a==vxl.def.essl.VERTEX_SHADER){c=f.createShader(f.VERTEX_SHADER)}else{if(a==vxl.def.essl.FRAGMENT_SHADER){c=f.createShader(f.FRAGMENT_SHADER)}}if(d==undefined||d==null){alert("Error getting the code for shader of type "+a)}f.shaderSource(c,d);f.compileShader(c);
if(!f.getShaderParameter(c,f.COMPILE_STATUS)){alert(a+":\n\n "+f.getShaderInfoLog(c));throw ("Error compiling shader "+a+":\n\n "+f.getShaderInfoLog(c))}return c};vxlProgramManager.prototype._parseUniforms=function(f){vs=this._registered_programs[this._current_program_ID].VERTEX_SHADER;fs=this._registered_programs[this._current_program_ID].FRAGMENT_SHADER;uNames=this._registered_programs[this._current_program_ID].UNIFORMS;uTypes={};for(var a=0;a<uNames.length;a++){var c=uNames[a];var d=new RegExp("uniform\\s+\\w+\\s"+c,"g");
if(vs.search(d)!=-1){uTypes[c]=vs.substring(vs.search(d),vs.length).substring(0,vs.indexOf(";")).split(" ")[1]}else{if(fs.search(d)!=1){uTypes[c]=fs.substring(fs.search(d),fs.length).substring(0,fs.indexOf(";")).split(" ")[1]}else{alert("Program: In the program "+this._current_program_ID+" the uniform "+c+" is listed but not used")}}}this._uniform_map[this._current_program_ID]=uNames;this._uniform_types[this._current_program_ID]=uTypes};vxlProgramManager.prototype._getAttributeLocation=function(a){var c=this._curr_attribute_loc_map[a];
if(c!=undefined){return c}c=this._gl.getAttribLocation(this._current_program_object,a);if(c==-1){console.error("vxlProgramManager._getAttributeLocation ERROR: the attribute "+a+"could not be located");c=undefined}else{this._curr_attribute_loc_map[a]=c}return c};vxlProgramManager.prototype._setPolymorphicUniform=function(f,c,d,k){var h=this._gl;var a=this._uniform_types[this._current_program_ID][f];if(a=="bool"){h.uniform1i(c,d);return}else{if(a=="float"){h.uniform1f(c,d);return}else{if(a=="int"||a=="sampler2D"){h.uniform1i(c,d);
return}else{if(a=="mat4"){h.uniformMatrix4fv(c,false,d);return}else{if(d instanceof Array||d instanceof Float32Array){if(d.length==3&&a=="vec4"){d[3]=1;if(!this._one_time_warning){alert("The uniform "+f+" has only 3 components but voxelent needs 4. This is a one time warning");this._one_time_warning=true}}if(k=="int"){switch(d.length){case 1:h.uniform1iv(c,d);break;case 2:h.uniform2iv(c,d);break;case 3:h.uniform3iv(c,d);break;case 4:h.uniform4iv(c,d);break;default:alert("ERROR")}}else{switch(d.length){case 1:h.uniform1fv(c,d);
break;case 2:h.uniform2fv(c,d);break;case 3:h.uniform3fv(c,d);break;case 4:h.uniform4fv(c,d);break;default:alert("ERROR")}}}else{alert("Program: ERROR. The uniform  "+f+" could not be mapped")}}}}}};function vxlRenderer(a){this.view=a;this.renderRate=vxl.def.renderer.rate.NORMAL;this.mode=vxl.def.renderer.mode.TIMER;this.fps=0;this.engine=undefined;this._time=0;this._startDate=0;this._running=false;this.setEngine(vxlRenderEngine);this.setProgram(vxl.go.essl.lambert)}vxlRenderer.prototype.setEngine=function(c){var a=undefined;
if(typeof c=="function"){a=new c()}else{if(typeof c=="object"){a=c}else{console.warn("vxlRenderer.setEngine WARN: "+c+" is not an engine");console.warn("vxlRenderer.setEngine WARN: using vxlRenderEngine by default");a=new vxlRenderEngine()}}a.init(this);this.engine=a;vxl.c.engine=this.engine};vxlRenderer.prototype.setProgram=function(a,c){this.engine.setProgram(a,c)};vxlRenderer.prototype.releaseProgram=function(){this.engine.releaseProgram()};vxlRenderer.prototype.clear=function(){this.engine.clear()
};vxlRenderer.prototype.clearColor=function(d,c,a){this.engine.clearColor(d,c,a)};vxlRenderer.prototype.clearDepth=function(a){this.engine.clearDepth(a)};vxlRenderer.prototype.reallocate=function(){this.engine.allocate(this.view.scene)};vxlRenderer.prototype.disableOffscreen=function(){this.engine.disableOffscreen()};vxlRenderer.prototype.enableOffscreen=function(){this.engine.enableOffscreen()};vxlRenderer.prototype.isOffscreenEnabled=function(){return this.engine.isOffscreenEnabled()};vxlRenderer.prototype.readOffscreenPixel=function(a,c){return this.engine.readOffscreenPixel(a,c)
};vxlRenderer.prototype.setMode=function(a){if(this._running){this.stop();this.mode=a;this.start()}else{this.mode=a}};vxlRenderer.prototype.start=function(){this._running=true;this._startDate=new Date().getTime();this._time=0;switch(this.mode){case vxl.def.renderer.mode.TIMER:vxl.go.console("Renderer [TIMER]: starting rendering for view ["+this.view.name+"] at "+this.renderRate+"ms");this._timeUp();break;case vxl.def.renderer.mode.ANIMFRAME:vxl.go.console("Renderer [ANIMFRAME]: starting request animation frame procedure",true);
var a=this;function c(){this.render();window.requestAnimFrame(c.bind(a))}c.bind(this)();break;case vxl.def.renderer.mode.ON_DEMAND:vxl.go.console("Renderer [ON_DEMAND]: waiting for rendering requests",true);this.clear();break}};vxlRenderer.prototype.doBeforeRendering=function(a){this._do_before_rendering=a};vxlRenderer.prototype.doAfterRendering=function(a){this._do_after_rendering=a};vxlRenderer.prototype._timeUp=function(){if(!this._running||this.mode==vxl.def.renderer.mode.ANIMFRAME){return}this.render();
if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)};vxlRenderer.prototype.stop=function(){if(this.mode==vxl.def.renderer.mode.TIMER){this._running=false}else{if(this.mode==vxl.def.renderer.mode.ANIMFRAME){vxl.go.renderman.cancel()}}};vxlRenderer.prototype.setRenderRate=function(a){if(a==undefined||a<=0){throw"vxlRenderer.setRenderRate: the rate cannot be zero or undefined"
}if(this.mode==vxl.def.renderer.mode.ANIMFRAME){throw"vxlRenderer.setRenderRate: if the mode is ANIMFRAME render rate is irrelevant"}this.stop();this.renderRate=a;this.start();vxl.go.console("Renderer: view["+this.view.name+"], render rate = "+a,true)};vxlRenderer.prototype.render=function(){var c=this.engine,d=this.view.scene,f=undefined,a=undefined;if(this._do_before_rendering){this._do_before_rendering()}this.clear();c.allocate(d);f=new Date().getTime();c.render(d);a=new Date().getTime()-f;c.deallocate(d);
if(a>0){this.fps=Math.round((this.fps*0.8+(1000/a)*0.2)*100)/100}if(this._do_after_rendering){this._do_after_rendering()}};function vxlRendererException(a){this.message=a}function vxlRenderTarget(a){this.canvas=a._view.canvas;this.texture=null;this.framebuffer=null;this.renderbuffer=null;this.gl=a.gl;this.configure()}vxlRenderTarget.prototype.configure=function(){var c=this.canvas.width;var a=this.canvas.height;var d=this.gl;this.texture=d.createTexture();d.bindTexture(d.TEXTURE_2D,this.texture);
d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);this.renderbuffer=d.createRenderbuffer();d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a);this.framebuffer=d.createFramebuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,this.texture,0);d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.renderbuffer);d.bindTexture(d.TEXTURE_2D,null);
d.bindRenderbuffer(d.RENDERBUFFER,null);d.bindFramebuffer(d.FRAMEBUFFER,null)};vxlRenderTarget.prototype.update=function(){var d=this.gl;var c=this.canvas.width;var a=this.canvas.height;d.bindTexture(d.TEXTURE_2D,this.texture);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,c,a,0,d.RGBA,d.UNSIGNED_BYTE,null);d.bindRenderbuffer(d.RENDERBUFFER,this.renderbuffer);d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,c,a)};vxlRenderTarget.prototype.readPixel=function(a,f){var d=this.gl;var c=new Uint8Array(1*1*4);
d.bindFramebuffer(d.FRAMEBUFFER,this.framebuffer);d.readPixels(a,f,1,1,d.RGBA,d.UNSIGNED_BYTE,c);d.bindFramebuffer(d.FRAMEBUFFER,null);return c};function vxlModel(a,c){this.UID=vxl.util.generateUID();this.name=a;this.indices=[];this.vertices=[];this.scalars=undefined;this.diffuse=undefined;this.ambient=undefined;this.specular=undefined;this.shininness=undefined;this.normals=undefined;this.wireframe=undefined;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];this.mode=vxl.def.actor.mode.SOLID;this.image=undefined;
this.uri=undefined;this.colors=undefined;this.type=vxl.def.model.type.SIMPLE;this.renderable=undefined;if(c!=undefined){this.load(this.name,c)}this.setType(this.type)}vxlModel.prototype.setType=function(a){if(this.indices.max()<vxl.def.model.MAX_NUM_INDICES&&a==vxl.def.model.type.BIG_DATA){throw ("The model is not big enough to be of BIG_DATA type. Max index found: "+this.indices.max())}this.type=a};vxlModel.BB_INDICES=[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7];vxlModel.prototype.load=function(a,c){if(a==undefined){throw"vxlModel.load ERROR: the object must have a name"
}this.name=a.replace(/\.[^/.]+$/,"");if(c.name!=null){this.name=c.name}for(i in c){this[i]=c[i]}this.update()};vxlModel.prototype.update=function(){if(this.vertices==undefined){alert("The model "+this.name+" does not have vertices. Impossible to render!")}if(this.normals==undefined&&this.indices!=undefined&&this.mode!=vxl.def.actor.mode.LINES){this.computeNormals()}if(this.wireframe==undefined){this.computeWireframeIndices()}if(this.mode==undefined){this.mode=vxl.def.actor.mode.SOLID}if(this.texture!=undefined){this.mode=vxl.def.actor.mode.TEXTURED
}this.computeBoundingBox();if(this.type==vxl.def.model.type.SIMPLE&&this.indices.max()>vxl.def.model.MAX_NUM_INDICES){this.setType(vxl.def.model.type.BIG_DATA);console.info("the model "+this.name+" type is BIG_DATA")}};vxlModel.prototype.computeNormals=function(){var s=this.vertices;var a=this.indices;var n=0;var k=1;var h=2;var l=[];for(var c=0;c<s.length;c=c+3){l[c+n]=0;l[c+k]=0;l[c+h]=0}for(var c=0;c<a.length;c=c+3){var o=[];var m=[];var f=[];o[n]=s[3*a[c+2]+n]-s[3*a[c+1]+n];o[k]=s[3*a[c+2]+k]-s[3*a[c+1]+k];
o[h]=s[3*a[c+2]+h]-s[3*a[c+1]+h];m[n]=s[3*a[c]+n]-s[3*a[c+1]+n];m[k]=s[3*a[c]+k]-s[3*a[c+1]+k];m[h]=s[3*a[c]+h]-s[3*a[c+1]+h];f[n]=o[k]*m[h]-o[h]*m[k];f[k]=o[h]*m[n]-o[n]*m[h];f[h]=o[n]*m[k]-o[k]*m[n];for(j=0;j<3;j++){l[3*a[c+j]+n]=l[3*a[c+j]+n]+f[n];l[3*a[c+j]+k]=l[3*a[c+j]+k]+f[k];l[3*a[c+j]+h]=l[3*a[c+j]+h]+f[h]}}for(var c=0;c<s.length;c=c+3){var q=[];q[n]=l[c+n];q[k]=l[c+k];q[h]=l[c+h];var d=Math.sqrt((q[n]*q[n])+(q[k]*q[k])+(q[h]*q[h]));if(d==0){d=1}q[n]=q[n]/d;q[k]=q[k]/d;q[h]=q[h]/d;l[c+n]=q[n];
l[c+k]=q[k];l[c+h]=q[h]}this.normals=l};vxlModel.prototype.flipNormals=function(){var c=this.normals;if(c==undefined){return}for(var a=0;a<c.length;a+=1){c[a]=-c[a]}};vxlModel.prototype.computeWireframeIndices=function(){var f=this.indices;var d=[];var a=0;for(var c=0;c<f.length;c=c+3){d[a]=f[c];d[a+1]=f[c+1];d[a+2]=f[c+1];d[a+3]=f[c+2];d[a+4]=f[c+2];d[a+5]=f[c];a=a+6}this.wireframe=d};vxlModel.prototype.computeBoundingBox=function(){if(this.vertices.length==0){this.bb=[0,0,0,0,0,0];this.centre=[0,0,0,0,0,0];
return}var k=this.vertices;var a=[k[0],k[1],k[2],k[0],k[1],k[2]];var d=k.length;for(var d=0,f=k.length;d<f;d=d+3){a[0]=Math.min(a[0],k[d]);a[1]=Math.min(a[1],k[d+1]);a[2]=Math.min(a[2],k[d+2]);a[3]=Math.max(a[3],k[d]);a[4]=Math.max(a[4],k[d+1]);a[5]=Math.max(a[5],k[d+2])}var h=[0,0,0];h[0]=(a[3]+a[0])/2;h[1]=(a[4]+a[1])/2;h[2]=(a[5]+a[2])/2;this.bb=a;this.centre=h};vxlModel.prototype.getBoundingBoxVertices=function(){var a=this.bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]
};function vxlCell(f,d,c,a){this.UID=vxl.util.generateUID();this.mesh=f;this.index=d;this.vertices=c;this.color=a==undefined?[0.8,0.8,0.8]:a;this.normal=[0,0,0];this.position=[0,0,0];this._calculatePosition();this._calculateNormal();this._pickingColor=vxl.go.picker.getColorFor(this)}vxlCell.prototype._calculatePosition=function(){this.position[0]=(this.vertices[0][0]+this.vertices[1][0]+this.vertices[2][0])/3;this.position[1]=(this.vertices[0][1]+this.vertices[1][1]+this.vertices[2][1])/3;this.position[2]=(this.vertices[0][2]+this.vertices[1][2]+this.vertices[2][2])/3
};vxlCell.prototype._calculateNormal=function(){var c=vec3.subtract(vec3.create(),this.vertices[1],this.vertices[0]);var a=vec3.subtract(vec3.create(),this.vertices[2],this.vertices[0]);this.normal=vec3.normalize(this.normal,vec3.cross(this.normal,c,a))};vxlCell.prototype.getFlattenVertices=function(){var a=this.vertices;return[a[0][0],a[0][1],a[0][2],a[1][0],a[1][1],a[1][2],a[2][0],a[2][1],a[2][2]]};vxlCell.prototype.setColor=function(d,c,a){this.color=vxl.util.createArr3(d,c,a);this.mesh._updateCellColor(this.index)
};function vxlMesh(a){if(a==undefined){throw ("vxlMesh: the model passed as parameter cannot be undefined")}this.name=a.name+"-mesh";this.cells=[];this.color=[0.8,0.8,0.8];this.actor=a;this.model=undefined;this._createMesh(a)}vxlMesh.prototype.setColor=function(a){this.color=a;this._setModelColor(this.color)};vxlMesh.prototype.scalarsToCellColors=function(a,c){};vxlMesh.prototype.updateColor=function(){var c=this.model;c.colors=[];c.pickingColors=[];for(var d=0,f=this.cells.length;d<f;d+=1){for(var a=0;
a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}this.actor.updateRenderable()};vxlMesh.prototype.hasCell=function(a){var c=this.cells.length;while(c--){if(this.cells[c].UID==a){return true}}return false};vxlMesh.prototype.getCell=function(a){var c=this.cells.length;while(c--){if(this.cells[c].UID==a){return this.cells[c]}}return null};vxlMesh.prototype.removeCell=function(c){var a=-1;var d=this.cells.length;while(d--){if(this.cells[d].UID==c){a=d;
break}}if(a!=-1){this.cells.splice(a,1);this._createModel()}};vxlMesh.prototype.intersect=function(c,d){var a=c._forward;selection=[];return selection};vxlMesh.prototype._createMesh=function(d){var f=d.model;var a=f.vertices;var h=f.indices;var c=this;this.cells=[];function k(){var l=new Date().getTime();var s=0;var o=[c.color[0],c.color[1],c.color[2]];for(var m=0,t=h.length;m<t;m+=3){w=h[m];var n=[],v,u,q,w;v=a[w*3];u=a[w*3+1];q=a[w*3+2];n.push([v,u,q]);w=h[m+1];v=a[w*3];u=a[w*3+1];q=a[w*3+2];n.push([v,u,q]);
w=h[m+2];v=a[w*3];u=a[w*3+1];q=a[w*3+2];n.push([v,u,q]);c.cells.push(new vxlCell(c,s,n,o));s+=1}c._createModel();var A=new Date().getTime()-l;console.info("Mesh ["+c.name+"] generated in "+A+" ms")}setTimeout(function(){k()},0)};vxlMesh.prototype._createModel=function(){var c=new vxlModel(this.name+"-model");c.colors=[];c.pickingColors=[];for(var d=0,f=this.cells.length;d<f;d+=1){c.indices.push.apply(c.indices,[d*3,d*3+1,d*3+2]);c.vertices.push.apply(c.vertices,this.cells[d].getFlattenVertices());
for(var a=0;a<3;a+=1){c.colors.push.apply(c.colors,this.cells[d].color);c.pickingColors.push.apply(c.pickingColors,this.cells[d]._pickingColor)}}c.computeNormals();c.setType(vxl.def.model.type.MESH);this.model=c;this.actor.updateRenderable(vxl.def.renderable.task.CREATE)};vxlMesh.prototype._setModelColor=function(a){if(this.model==undefined){return}var d=this.model;d.colors=[];for(var f=0,h=this.cells.length;f<h;f+=1){this.cells[f].color=[a[0],a[1],a[2]];for(var c=0;c<3;c+=1){d.colors.push.apply(d.colors,this.cells[f].color)
}}this.actor.updateRenderable(vxl.def.renderable.task.CREATE)};vxlMesh.prototype._updateCellColor=function(c){var a=this.cells[c].color;for(var d=c*9,f=c*9+9;d<f;d+=3){this.model.colors[d]=a[0];this.model.colors[d+1]=a[1];this.model.colors[d+2]=a[2]}this.actor.updateRenderable(vxl.def.renderable.task.UPDATE_COLORS)};function vxlActor(a){this._bb=[0,0,0,0,0,0];this._position=vec3.fromValues(0,0,0);this._translation=vec3.fromValues(0,0,0);this._centre=vec3.fromValues(0,0,0);this._scale=vec3.fromValues(1,1,1);
this._rotation=vec3.fromValues(0,0,0);this._matrix=mat4.create();this._matrix_world=mat4.create();this._matrix_normal=mat4.create();this._matrix_pmv=mat4.create();this._dirty=false;this._picking=vxl.def.actor.picking.DISABLED;this._pickingCallback=undefined;this._pickingColor=undefined;this._trackingCameras=[];this.UID=vxl.util.generateUID();this.scene=undefined;this.clones=0;this.mode=vxl.def.actor.mode.SOLID;this.cull=vxl.def.actor.cull.NONE;this.visible=true;this.mesh=undefined;this.renderable=undefined;
this._bb_disabled=false;if(a){this.model=a;this.name=a.name;this.mode=a.mode;this._bb=a.bb.slice(0);this._centre=vec3.clone(a.centre);if(a.type==vxl.def.model.type.BIG_DATA){this.renderable=new vxlRenderable(this)}var c=new vxlMaterial();this.setMaterial(c.getFrom(a))}else{this.model=undefined;this.material=undefined}var d=vxl.events;vxl.go.notifier.publish([d.ACTOR_MOVED,d.ACTOR_SCALED,d.ACTOR_ROTATED,d.ACTOR_CHANGED_COLOR,d.ACTOR_CHANGED_SHADING,],this)}vxlActor.prototype.setScene=function(a){this.scene=a
};vxlActor.prototype.setPosition=function(c,h,f){var d=vxl.util.createVec3(c,h,f);vec3.subtract(this._translation,d,this._position);this._position=d;var a=this._matrix;a[12]=this._position[0];a[13]=this._position[1];a[14]=this._position[2];a[15]=1;if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this);return this};vxlActor.prototype.translate=function(c,f,d){this._translation=vxl.util.createVec3(c,f,d);var a=this._matrix;mat4.translate(a,a,this._translation);
this._position=vec3.fromValues(a[12],a[13],a[14]);if(!this._bb_disabled){this._computeBoundingBox()}this._notifyTrackingCameras();vxl.go.notifier.fire(vxl.events.ACTOR_MOVED,this);return this};vxlActor.prototype.rotateX=function(f){var c=this._matrix;var d=vxl.util.deg2rad(vxl.util.getAngle(f));mat4.rotateX(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.rotateY=function(f){var c=this._matrix;var d=vxl.util.deg2rad(vxl.util.getAngle(f));
mat4.rotateY(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.rotateZ=function(f){var c=this._matrix;var d=vxl.util.deg2rad(vxl.util.getAngle(f));mat4.rotateZ(c,c,d);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_ROTATED,this);return this};vxlActor.prototype.setScale=function(h,f,d){if(h==0&&f==undefined&&d==undefined){return}if(typeof(h)=="number"&&f==undefined&&d==undefined){this._scale=vxl.util.createVec3(h,h,h)
}else{this._scale=vxl.util.createVec3(h,f,d)}var c=this._matrix;mat4.scale(c,c,this._scale);if(!this._bb_disabled){this._computeBoundingBox()}vxl.go.notifier.fire(vxl.events.ACTOR_SCALED,this);return this};vxlActor.prototype.addTrackingCamera=function(a){if(a instanceof vxlCamera&&a.type!=vxl.def.camera.type.TRACKING){throw"vxlActor._addTrackingCamera ERROR: the selected camera is not set to tracking"}else{if(a instanceof vxlCamera){this._trackingCameras.push(a)}else{throw"vxlActor._addTrackingCamera ERROR: the object passed as a parameter is not a vxlCamera"
}}};vxlActor.prototype.removeTrackingCamera=function(c){var a=this._trackingCameras.indexOf(c);this._trackingCameras.splice(a,1)};vxlActor.prototype._notifyTrackingCameras=function(){for(var a=0,c=this._trackingCameras.length;a<c;a+=1){this._trackingCameras[a].updateWithActor(this)}};vxlActor.prototype._computeBoundingBox=function(){var k=this.model.vertices;var f=[];var d=this._matrix;for(var h=0;h<k.length;h=h+3){var a=vxl.util.createVec3(k[h],k[h+1],k[h+2]);vec3.transformMat4(a,a,d);f.push(a[0],a[1],a[2])
}var c=[f[0],f[1],f[2],f[0],f[1],f[2]];for(var h=0;h<f.length;h=h+3){c[0]=Math.min(c[0],f[h]);c[1]=Math.min(c[1],f[h+1]);c[2]=Math.min(c[2],f[h+2]);c[3]=Math.max(c[3],f[h]);c[4]=Math.max(c[4],f[h+1]);c[5]=Math.max(c[5],f[h+2])}this._bb=c};vxlActor.prototype.getBoundingBoxVertices=function(){var a=this._bb;return[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]]};vxlActor.prototype.getBoundingBox=function(){return this._bb.slice[0]
};vxlActor.prototype.getHeight=function(){var a=this._bb;return a[4]-a[1]};vxlActor.prototype.setMaterial=function(a){this.material=a;if(this.material.texture){this._new_texture=true}};vxlActor.prototype.setColor=function(d,c,a){this.material.diffuse=vxl.util.createVec3(d,c,a);if(this.mesh){this.mesh.setColor(this.material.diffuse)}vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_COLOR,this);return this};vxlActor.prototype.setOpacity=function(a){if(a>=0&&a<=1){this.material.opacity=a}else{throw"The opacity value is not valid"
}return this};vxlActor.prototype.setShininess=function(a){this.material.shininess=a;return this};vxlActor.prototype.setTexture=function(c){var a=undefined;if(typeof(c)=="string"){a=new vxlTexture(c)}else{a=c}this.material.texture=a;this._new_texture=true;return this};vxlActor.prototype.setProperty=function(d,c,a){if(a==vxl.def.actor||a==undefined||a==null){switch(d){case"position":this.setPosition(c);break;case"scale":this.setScale(c);break;case"color":this.setColor(c);break;case"shading":this.setShading(c);
break;case"texture":this.setTexture(c);break;case"opacity":this.setOpacity(c);break;case"shininess":this.setShininess(c);break;default:this[d]=c;break}vxl.go.console("Actor: The actor "+this.name+" has been updated. ["+d+" = "+c+"]")}else{if(a==vxl.def.model){this.model[d]=c;vxl.go.console("vxlActor: The model "+this.model.namname+" has been updated. ["+d+" = "+c+"]")}else{throw ("vxlActor.setProperty. Scope:"+a+" is not valid")}}return this};vxlActor.prototype.setShading=function(a){this.material.shading=a;
vxl.go.notifier.fire(vxl.events.ACTOR_CHANGED_SHADING,this);return this};vxlActor.prototype.getProperty=function(a){if(a=="color"){return this.materia.diffuse}else{if(this.hasOwnProperty(a)){return this[a]}else{if(this.material.hasOwnProperty(a)){return this.material[a]}else{if(this.model.hasOwnProperty(a)){return this.model[a]}else{return undefined}}}}};vxlActor.prototype.computePosition=function(){bb=this._bb;var a=vec3.create();a[0]=(bb[3]+bb[0])/2;a[1]=(bb[4]+bb[1])/2;a[2]=(bb[5]+bb[2])/2;a[0]=Math.round(a[0]*1000)/1000;
a[1]=Math.round(a[1]*1000)/1000;a[2]=Math.round(a[2]*1000)/1000;return vec3.clone(a)};vxlActor.prototype.setVisualizationMode=function(a){this.mode=a;this._dirty=true;return this};vxlActor.prototype.cullFace=function(a){this.cull=a;return this};vxlActor.prototype.setLookupTable=function(h,d,a){if(this.model.scalars==undefined){return}var c=this;function f(k){var l=vxl.go.lookupTableManager.get(h);c.material.colors=l.getColors(c.model.scalars,d,a);if(c.model.type==vxl.def.model.type.BIG_DATA){c.renderable.update()
}}setTimeout(function(){f()},0);return this};vxlActor.prototype.flipNormals=function(){this.model.flipNormals();return this};vxlActor.prototype.setVisible=function(a){this.visible=a;return this};vxlActor.prototype.isVisible=function(){return this.visible};vxlActor.prototype.clone=function(){this.clones++;var a=new vxlActor(this.model);a.name+="-"+this.clones;a.material=this.material.clone();return a};vxlActor.prototype.setPicker=function(c,f){this._picking=c;switch(c){case vxl.def.actor.picking.DISABLED:this._pickingCallback=undefined;
this.mesh=undefined;this.renderable=undefined;this.setVisualizationMode(vxl.def.actor.mode.SOLID);break;case vxl.def.actor.picking.CELL:if(this.mesh==undefined){this.mesh=new vxlMesh(this);this.mesh.setColor(this.material.diffuse);this.renderable=new vxlRenderable(this);this.setVisualizationMode(vxl.def.actor.mode.FLAT)}this._pickingCallback=f;break;case vxl.def.actor.picking.OBJECT:this._pickingColor=vxl.go.picker.getColorFor(this);this._pickingCallback=f;break}if(this._picking!=vxl.def.actor.picking.DISABLED){var a=this.scene.views.length;
while(a--){var d=this.scene.views[a].renderer;if(!d.isOffscreenEnabled()){d.enableOffscreen()}}}return this};vxlActor.prototype.isPickable=function(){return(this._picking!=vxl.def.actor.picking.DISABLED)};vxlActor.prototype.getPickingType=function(){return this._picking};vxlActor.prototype.updateRenderable=function(a){this.renderable.update(a)};vxlActor.prototype.reallocate=function(){this._dirty=true};function vxlPicker(){this._objects={};this._colors={}}vxlPicker.RESOLUTION=1/255;vxlPicker.prototype._hex2rgb=function(d){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;
hex=d.replace(c,function(h,l,k,f){return l+l+k+k+f+f});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return a?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null};vxlPicker.prototype._rgb2hex=function(f,d,a){var h=vxl.util.createArr3(f,d,a);return"#"+((1<<24)+(h[0]<<16)+(h[1]<<8)+h[2]).toString(16).slice(1)};vxlPicker.prototype._getColor=function(){function a(){var c=Math.floor(Math.random()*255);if(c==0){return a()}else{return c}}return[a(),a(),a()]};vxlPicker.prototype.color2decimal=function(a){r=a[0]*vxlPicker.RESOLUTION;
g=a[1]*vxlPicker.RESOLUTION;b=a[2]*vxlPicker.RESOLUTION;return[r,g,b]};vxlPicker.prototype.getColorFor=function(f){var d=f.UID;if(d==null||d==undefined){alert("vxlPicker.getColor: invalid object");return}var a,c;if(!this._objects[d]){do{a=this._getColor();c=this._rgb2hex(a)}while(c in this._colors);this._objects[d]=a;this._colors[c]=d}a=this._objects[d];return this.color2decimal(a)};vxlPicker.prototype.query=function(f){var k=100;var h=undefined;var d={};var a=f.slice(0,3);var c=this._rgb2hex(a);
if(this._colors[c]){d.uid=this._colors[c];d.color=a;return d}return null};vxl.go.picker=new vxlPicker();function vxlEngine(){this.gl=undefined;this.pm=undefined;this._view=undefined;this._clear_color=undefined;this._transforms=undefined}vxlEngine.prototype.allocate=function(a){};vxlEngine.prototype.render=function(a){};vxlEngine.prototype.deallocate=function(a){};vxlEngine.prototype.reallocate=function(a){};vxlEngine.prototype.disableOffscreen=function(){};vxlEngine.prototype.enableOffscreen=function(){};
vxlEngine.prototype.isOffscreenEnabled=function(){};vxlEngine.prototype.readOffscreenPixel=function(a,c){};vxlEngine.prototype.init=function(a){this._getGL(a);this.pm=new vxlProgramManager(this.gl);this._view=a.view;this._clear_color=this._view.backgroundColor;this._transforms=new vxlTransforms(a.view);this.configure()};vxlEngine.prototype._getGL=function(c){var a=undefined;var d=c.view.canvas;var k=["webgl","experimental-webgl","webkit-3d","moz-webgl"];this.gl=undefined;for(var f=0;f<k.length;++f){try{a=d.getContext(k[f])
}catch(h){}if(a){break}}if(a==null){alert("Sorry: WebGL is not available on this browser. Have you tried the newest version of Firefox, Chrome or Safari?");return undefined}else{this.gl=a}};vxlEngine.prototype.configure=function(){var a=this.gl;a.enable(a.DEPTH_TEST);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.depthFunc(a.LESS);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,true)};vxlEngine.prototype.clear=function(){var f=this.gl;var c=this._view.canvas;var d=c.width;var a=c.height;var h=this._clear_color;
f.clearColor(h[0],h[1],h[2],1);f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);f.viewport(0,0,d,a);this._transforms.calculateProjection()};vxlEngine.prototype.clearColor=function(d,c,a){var f=vxl.util.createArr3(d,c,a);this._clear_color=f;this.gl.clearColor(f[0],f[1],f[2],1)};vxlEngine.prototype.clearDepth=function(a){this.gl.clearDepth(a)};vxlEngine.prototype.releaseProgram=function(){this.pm.releaseProgram()};vxlEngine.prototype.setProgram=function(a,c){this.pm.setProgram(a,c)};vxlExternalEngine.prototype=new vxlEngine();
vxlExternalEngine.prototype.constructor=vxlExternalEngine;function vxlExternalEngine(d,f,c,a){vxlEngine.call(this);this.renderer=d;this.allocateCallback=f;this.renderCallback=c;this.deallocateCallback=a}vxlExternalEngine.prototype.allocate=function(a){this.allocateCallback(this.renderer,a)};vxlExternalEngine.prototype.render=function(a){this.renderCallback(this.renderer,a)};vxlExternalEngine.prototype.deallocate=function(a){this.deallocateCallback(this.renderer,a)};vxlRenderEngine.prototype=new vxlEngine();
vxlRenderEngine.prototype.constructor=vxlRenderEngine;function vxlRenderEngine(){vxlEngine.call(this);this._gl_buffers={};this._gl_textures={};this._offscreen=false;this._target=undefined;this._onPickingBuffer=false;this._debug_picking_flag=false}vxlRenderEngine.prototype.configure=function(){vxlEngine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};vxlRenderEngine.prototype.allocate=function(d){var c=d._actors.concat(d.toys.list);var a=c.length;while(a--){this._allocateActor(c[a])
}};vxlRenderEngine.prototype.deallocate=function(a){};vxlRenderEngine.prototype._allocateActor=function(d){var f=this.gl;var c=d.model;var a={};if(!(c.UID in this._gl_buffers)||d._dirty){this._reallocateActor(d);d._dirty=false}};vxlRenderEngine.prototype._reallocateActor=function(f){var l=this.gl;var d=f.model;var a=this._gl_buffers[d.UID]||{};var h=vxl.def.actor.mode;if(a.vertex==undefined){a.vertex=l.createBuffer()}var c=undefined;switch(f.mode){case h.BOUNDING_BOX:c=f.getBoundingBoxVertices();
break;default:c=d.vertices}l.bindBuffer(l.ARRAY_BUFFER,a.vertex);l.bufferData(l.ARRAY_BUFFER,new Float32Array(c),l.STATIC_DRAW);if(d.normals){if(a.normal==undefined){a.normal=l.createBuffer()}l.bindBuffer(l.ARRAY_BUFFER,a.normal);l.bufferData(l.ARRAY_BUFFER,new Float32Array(d.normals),l.STATIC_DRAW)}if(d.scalars!=undefined||d.colors!=undefined){if(a.color==undefined){a.color=l.createBuffer()}}if(d.indices!=undefined){if(a.index==undefined){a.index=l.createBuffer()}var k=undefined;switch(f.mode){case h.SOLID:k=d.indices;
break;case h.WIREFRAME:k=d.wireframe;break;case h.POINTS:k=d.indices;break;case h.LINES:k=d.indices;break;case h.BOUNDING_BOX:k=vxlModel.BB_INDICES;break;case h.BB_AND_SOLID:k=d.indices;break;case h.WIRED_AND_SOLID:k=d.indices;break;case h.FLAT:k=d.indices;break;case h.TEXTURED:k=d.indices;break;default:throw ("There was a problem while rendering the actor ["+f.name+"].The visualization mode: "+f.mode+" is not valid.")}l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(k),l.STATIC_DRAW)
}if(f.mode==h.FLAT||f.model.type==vxl.def.model.type.BIG_DATA){if(a.vertex_parts==undefined){a.vertex_parts=l.createBuffer()}if(a.normal_parts==undefined){a.normal_parts=l.createBuffer()}if(a.color_parts==undefined){a.color_parts=l.createBuffer()}if(a.index_parts==undefined){a.index_parts=l.createBuffer()}}else{if(a.vertex_parts!=undefined){l.deleteBuffer(a.vertex_parts);a.vertex_parts=null;delete a.vertex_parts}if(a.normal_parts!=undefined){l.deleteBuffer(a.normal_parts);a.normal_parts=null;delete a.normal_parts
}if(a.color_parts!=undefined){l.deleteBuffer(a.color_parts);a.color_parts=null;delete a.color_parts}if(a.index_parts!=undefined){l.deleteBuffer(a.index_parts);a.index_parts=null;delete a.index_parts}}if(f.mode==h.WIRED_AND_SOLID){a.index_ws=l.createBuffer();l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_ws);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(d.wireframe),l.STATIC_DRAW);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)}else{if(a.index_ws!=undefined){l.deleteBuffer(a.index_ws);a.index_ws=null;
delete a.index_ws}}if(f.mode==h.BB_AND_SOLID){a.vertex_bs=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,a.vertex_bs);l.bufferData(l.ARRAY_BUFFER,new Float32Array(f.getBoundingBoxVertices()),l.STATIC_DRAW);l.bindBuffer(l.ARRAY_BUFFER,null);a.index_bs=l.createBuffer();l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_bs);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(vxlModel.BB_INDICES),l.STATIC_DRAW);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)}else{if(a.vertex_bs!=undefined){l.deleteBuffer(a.vertex_bs);
a.vertex_bs=null;delete a.vertex_bs}if(a.index_bs!=undefined){l.deleteBuffer(a.index_bs);a.index_bs=null;delete a.index_bs}}if(d.texcoords&&f.material.texture){a.texcoords=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,a.texcoords);l.bufferData(l.ARRAY_BUFFER,new Float32Array(d.texcoords),l.STATIC_DRAW);this._gl_textures[f.UID]=l.createTexture();l.bindTexture(l.TEXTURE_2D,this._gl_textures[f.UID]);l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,f.material.texture.image);l.generateMipmap(l.TEXTURE_2D);
l.bindTexture(l.TEXTURE_2D,null)}l.bindBuffer(l.ARRAY_BUFFER,null);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null);this._gl_buffers[d.UID]=a};vxlRenderEngine.prototype._setNormals=function(f){var c=f.model;var k=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var h=vxl.def.essl;if(c.normals&&f.material.shading){k.bindBuffer(k.ARRAY_BUFFER,a.normal);d.enableAttribute(h.NORMAL_ATTRIBUTE);d.setAttributePointer(h.NORMAL_ATTRIBUTE,3,k.FLOAT,false,0,0)}};vxlRenderEngine.prototype._setColors=function(f){var c=f.model;
var k=this.gl;var d=this.pm;var a=this._gl_buffers[c.UID];var h=vxl.def.essl;if(f.material.colors&&f.material.colors.length==f.model.vertices.length){d.setUniform("uUseVertexColors",true);k.bindBuffer(k.ARRAY_BUFFER,a.color);k.bufferData(k.ARRAY_BUFFER,new Float32Array(f.material.colors),k.STATIC_DRAW);d.enableAttribute(h.COLOR_ATTRIBUTE);d.setAttributePointer(h.COLOR_ATTRIBUTE,3,k.FLOAT,false,0,0)}};vxlRenderEngine.prototype._setRenderableVertices=function(f,c){var k=this.gl;var d=this.pm;var a=this._gl_buffers[f.model.UID];
var h=vxl.def.essl;k.bindBuffer(k.ARRAY_BUFFER,a.vertex_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(c.vertices),k.STATIC_DRAW);d.setAttributePointer(h.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0)};vxlRenderEngine.prototype._setRenderableNormals=function(f,c){var k=this.gl;var d=this.pm;var a=this._gl_buffers[f.model.UID];var h=vxl.def.essl;if(c.normals!=undefined&&c.normals.length>0){k.bindBuffer(k.ARRAY_BUFFER,a.normal_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(c.normals),k.STATIC_DRAW);
d.enableAttribute(h.NORMAL_ATTRIBUTE);d.setAttributePointer(h.NORMAL_ATTRIBUTE,3,k.FLOAT,false,0,0)}};vxlRenderEngine.prototype._setRenderableColors=function(f,c){var k=this.gl;var d=this.pm;var a=this._gl_buffers[f.model.UID];var h=vxl.def.essl;if(c.colors!=undefined&&c.colors.length>0){d.setUniform("uUseVertexColors",true);k.bindBuffer(k.ARRAY_BUFFER,a.color_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(c.colors),k.STATIC_DRAW);d.enableAttribute(h.COLOR_ATTRIBUTE);d.setAttributePointer(h.COLOR_ATTRIBUTE,3,k.FLOAT,false,0,0)
}};vxlRenderEngine.prototype._updateActorTransforms=function(h){var d=this._transforms;var f=h._actors.concat(h.toys.list);var k=f.length;var c=undefined;d.calculateModelView();for(var a=0;a<k;a+=1){c=f[a];if(c.visible==false&&h.frameAnimation==undefined){continue}c._matrix_world=mat4.multiply(c._matrix_world,d.model_view,c._matrix);c._matrix_normal=mat4.copy(c._matrix_normal,c._matrix_world);c._matrix_normal=mat4.invert(mat4.create(),c._matrix_normal);c._matrix_normal=mat4.transpose(c._matrix_normal,c._matrix_normal)
}};vxlRenderEngine.prototype.render=function(k){var d=this._transforms,c=this.pm,l=this.gl,h=vxl.def.essl;this._updateActorTransforms(k);c.setUniform(h.PERSPECTIVE_MATRIX,d.projection);if(k.frameAnimation!=undefined){k.frameAnimation.update()}this._renderPicking(k._actors);var f=k._actors.concat(k.toys.list);var a=f.length;while(a--){this._renderActor(f[a])}};vxlRenderEngine.prototype._renderPicking=function(c){if(this._target==undefined){return}if(this._offscreen){var d=this.gl;this._onPickingBuffer=true;
d.bindFramebuffer(d.FRAMEBUFFER,this._target.framebuffer);d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT);var a=c.length;while(a--){if(c[a].isPickable()){this._renderActor(c[a])}}this._onPickingBuffer=false;d.bindFramebuffer(d.FRAMEBUFFER,null)}if(this._debug_picking_flag){d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT)}};vxlRenderEngine.prototype._renderActor=function(d){if(!d.visible){return}var h=d.model;var o=this._gl_buffers[h.UID];var l=this._gl_textures[d.UID];
var f=this.gl;var a=this.pm;var n=vxl.def.essl;var c=this._transforms;var m=[d.material.diffuse[0],d.material.diffuse[1],d.material.diffuse[2],d.material.opacity];if(d.mode==vxl.def.actor.mode.FLAT){this.setProgram(vxl.go.essl.lambert)}else{}a.disableAttribute(n.TEXCOORD_ATTRIBUTE);a.disableAttribute(n.COLOR_ATTRIBUTE);a.disableAttribute(n.NORMAL_ATTRIBUTE);a.disableAttribute(n.PICKING_COLOR_ATTRIBUTE);a.enableAttribute(n.VERTEX_ATTRIBUTE);a.setUniform("uUseVertexColors",false);a.setUniform("uUseTextures",false);
a.setUniform("uUseShading",d.material.shading);a.setUniform("uMaterialDiffuse",m);a.setUniform(n.MODEL_VIEW_MATRIX,d._matrix_world);a.setUniform(n.NORMAL_MATRIX,d._matrix_normal);this._handleCulling(d);if(this._onPickingBuffer||this._debug_picking_flag){this._renderPickingBuffer(d);return}f.bindBuffer(f.ARRAY_BUFFER,o.vertex);a.setAttributePointer(n.VERTEX_ATTRIBUTE,3,f.FLOAT,false,0,0);var k=vxl.def.actor.mode;switch(d.mode){case k.SOLID:this._renderSolid(d);break;case k.WIREFRAME:this._renderWireframe(d);
break;case k.POINTS:this._renderPoints(d);break;case k.LINES:this._renderLines(d);break;case k.BOUNDING_BOX:this._renderBoundingBox(d);break;case k.BB_AND_SOLID:this._renderBoundingBoxAndSolid(d);break;case k.WIRED_AND_SOLID:this._renderWiredAndSolid(d);break;case k.FLAT:this._renderFlat(d);break;case k.TEXTURED:this._renderTextured(d);break;default:throw ("There was a problem while rendering the actor ["+d.name+"]. The visualization mode: "+d.mode+" is not valid.")}f.bindBuffer(f.ARRAY_BUFFER,null);
f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)};vxlRenderEngine.prototype._renderSolid=function(h){var a=this._gl_buffers[h.model.UID];var l=this.gl;var f=this.pm;var k=vxl.def.essl;if(h.model.type!=vxl.def.model.type.SIMPLE){if(h.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=h.renderable.parts;var d=parts.length;while(d--){var c=parts[d];this._setRenderableVertices(h,c);this._setRenderableNormals(h,c);this._setRenderableColors(h,c);
l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_parts);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),l.STATIC_DRAW);l.drawElements(l.TRIANGLES,c.indices.length,l.UNSIGNED_SHORT,0)}}else{this._setNormals(h);this._setColors(h);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index);l.drawElements(l.TRIANGLES,h.model.indices.length,l.UNSIGNED_SHORT,0)}};vxlRenderEngine.prototype._renderWireframe=function(d){var a=this._gl_buffers[d.model.UID];var h=this.gl;var c=this.pm;var f=vxl.def.essl;if(!d.toy){this._setNormals(d)
}this._setColors(d);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index);h.drawElements(h.LINES,d.model.wireframe.length,h.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderPoints=function(d){var a=d.model;var f=this.gl;var c=this.pm;c.setUniform("uUseShading",false);c.setUniform("uPointSize",5);this._setColors(d);f.drawArrays(f.POINTS,0,a.vertices.length/3)};vxlRenderEngine.prototype._renderLines=function(k){var a=this._gl_buffers[k.model.UID];var m=this.gl;var h=this.pm;var l=vxl.def.essl;h.setUniform("uUseShading",false);
if(k.model.type==vxl.def.model.type.BIG_DATA){if(k.renderable==undefined){alert("the actor does not have a renderable object");throw"the actor does not have a renderable object"}parts=k.renderable.parts;var f=parts.length;for(var d=0;d<f;d++){var c=parts[d];this._setRenderableVertices(k,c);this._setRenderableColors(k,c);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,a.index_parts);m.bufferData(m.ELEMENT_ARRAY_BUFFER,new Uint16Array(c.indices),m.STATIC_DRAW);m.drawElements(m.LINES,c.indices.length,m.UNSIGNED_SHORT,0)
}}else{this._setColors(k);m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,a.index);m.drawElements(m.LINES,k.model.indices.length,m.UNSIGNED_SHORT,0)}};vxlRenderEngine.prototype._renderBoundingBox=function(d){var a=this._gl_buffers[d.model.UID];var h=this.gl;var c=this.pm;var f=vxl.def.essl;c.disableAttribute(f.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",false);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,a.index);h.drawElements(h.LINES,vxlModel.BB_INDICES.length,h.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderBoundingBoxAndSolid=function(f){var c=f.model;
var a=this._gl_buffers[c.UID];var l=this.gl;var d=this.pm;var k=vxl.def.essl;var h=this._transforms;this._renderSolid(f);h.calculateModelView();h.calculateNormal();d.setUniform(k.MODEL_VIEW_MATRIX,h.model_view);d.setUniform(k.NORMAL_MATRIX,h.normal);d.disableAttribute(k.NORMAL_ATTRIBUTE);d.setUniform("uUseShading",false);l.bindBuffer(l.ARRAY_BUFFER,a.vertex_bs);d.setAttributePointer(k.VERTEX_ATTRIBUTE,3,l.FLOAT,false,0,0);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index_bs);l.drawElements(l.LINES,vxlModel.BB_INDICES.length,l.UNSIGNED_SHORT,0)
};vxlRenderEngine.prototype._renderWiredAndSolid=function(f){var c=f.model;var a=this._gl_buffers[c.UID];var k=this.gl;var d=this.pm;var h=vxl.def.essl;this._renderSolid(f);d.setUniform("uUseShading",false);d.setUniform("uMaterialDiffuse",[0.9,0.9,0.9,1]);d.disableAttribute(h.NORMAL_ATTRIBUTE);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.index_ws);k.drawElements(k.LINES,c.wireframe.length,k.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._renderFlat=function(f){var l=f.model;var o=this._gl_buffers[l.UID];var m=this._gl_textures[f.UID];
var k=this.gl;var c=this.pm;var n=vxl.def.essl;if(f.mesh==undefined){f.mesh=new vxlMesh(f);f.renderable=new vxlRenderable(f)}if(f.mesh.model==undefined){var l=f.model;k.bindBuffer(k.ARRAY_BUFFER,o.vertex);c.setAttributePointer(n.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0);k.bindBuffer(k.ARRAY_BUFFER,o.normal);c.setAttributePointer(n.NORMAL_ATTRIBUTE,3,k.FLOAT,false,0,0);k.bindBuffer(k.ARRAY_BUFFER,null);c.enableAttribute(n.NORMAL_ATTRIBUTE);c.setUniform("uUseShading",f.material.shading);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,o.index);
k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(l.wireframe),k.STATIC_DRAW);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null);this._renderWireframe(f);return}c.setUniform("uUseShading",true);c.enableAttribute(n.NORMAL_ATTRIBUTE);var d=f.renderable.parts;var h=d.length;while(h--){var a=d[h];k.bindBuffer(k.ARRAY_BUFFER,o.vertex_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(a.vertices),k.STATIC_DRAW);c.setAttributePointer(n.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0);k.bindBuffer(k.ARRAY_BUFFER,o.normal_parts);
k.bufferData(k.ARRAY_BUFFER,new Float32Array(a.normals),k.STATIC_DRAW);c.setAttributePointer(n.NORMAL_ATTRIBUTE,3,k.FLOAT,false,0,0);if(a.colors&&a.colors.length>0){c.enableAttribute(n.COLOR_ATTRIBUTE);c.setUniform("uUseVertexColors",true);k.bindBuffer(k.ARRAY_BUFFER,o.color_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(a.colors),k.STATIC_DRAW);c.setAttributePointer(n.COLOR_ATTRIBUTE,3,k.FLOAT,false,0,0)}k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,o.index_parts);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),k.STATIC_DRAW);
k.drawElements(k.TRIANGLES,a.indices.length,k.UNSIGNED_SHORT,0)}};vxlRenderEngine.prototype._renderPickingBuffer=function(f){var l=f.model;var n=this._gl_buffers[l.UID];var k=this.gl;var c=this.pm;var m=vxl.def.essl;if(f._picking==vxl.def.actor.picking.DISABLED){return}c.setUniform("uUseShading",false);if(f._picking==vxl.def.actor.picking.CELL){if(f.mesh==undefined||f.mesh.model==undefined){return}if(n.picking_parts==undefined){n.picking_parts=k.createBuffer();n.picking_colors=k.createBuffer();n.picking_index=k.createBuffer()
}c.setUniform("uUseVertexColors",true);c.enableAttribute(m.COLOR_ATTRIBUTE);var d=f.renderable.parts;var h=d.length;while(h--){var a=d[h];k.bindBuffer(k.ARRAY_BUFFER,n.picking_parts);k.bufferData(k.ARRAY_BUFFER,new Float32Array(a.vertices),k.STATIC_DRAW);c.setAttributePointer(m.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0);if(a.pickingColors&&a.pickingColors.length==a.vertices.length){k.bindBuffer(k.ARRAY_BUFFER,n.picking_colors);k.bufferData(k.ARRAY_BUFFER,new Float32Array(a.pickingColors),k.STATIC_DRAW);
c.setAttributePointer(m.COLOR_ATTRIBUTE,3,k.FLOAT,false,0,0)}else{alert("The object "+a.name+" does not have picking colors assigned.");throw ("The object "+a.name+" does not have picking colors assigned.")}k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,n.picking_index);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),k.STATIC_DRAW);k.drawElements(k.TRIANGLES,a.indices.length,k.UNSIGNED_SHORT,0)}}else{if(f._picking==vxl.def.actor.picking.OBJECT){c.setUniform("uMaterialDiffuse",f._pickingColor.concat(1));
k.bindBuffer(k.ARRAY_BUFFER,n.vertex);c.setAttributePointer(m.VERTEX_ATTRIBUTE,3,k.FLOAT,false,0,0);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,n.index);k.drawElements(k.TRIANGLES,l.indices.length,k.UNSIGNED_SHORT,0)}}k.bindBuffer(k.ARRAY_BUFFER,null);k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)};vxlRenderEngine.prototype._renderTextured=function(f){var c=f.model;var a=this._gl_buffers[c.UID];var h=this._gl_textures[f.UID];var l=this.gl;var d=this.pm;var k=vxl.def.essl;if(!f.material.texture.loaded){this._renderSolid(f);
return}if(f._new_texture){f.reallocate();f._new_texture=false;return}if(c.texcoords){d.setUniform("uUseTextures",true);l.bindBuffer(l.ARRAY_BUFFER,a.texcoords);d.setAttributePointer(k.TEXCOORD_ATTRIBUTE,2,l.FLOAT,false,0,0);d.enableAttribute(k.TEXCOORD_ATTRIBUTE)}else{throw ("error")}l.activeTexture(l.TEXTURE0);l.bindTexture(l.TEXTURE_2D,h);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE);l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,f.material.texture.getMagFilter(l));
l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,f.material.texture.getMinFilter(l));d.setUniform("uSampler",0);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,a.index);l.drawElements(l.TRIANGLES,c.indices.length,l.UNSIGNED_SHORT,0)};vxlRenderEngine.prototype._handleCulling=function(a){var c=this.gl;c.disable(c.CULL_FACE);if(a.cull!=vxl.def.actor.cull.NONE){c.enable(c.CULL_FACE);switch(a.cull){case vxl.def.actor.cull.BACK:c.cullFace(c.BACK);break;case vxl.def.actor.cull.FRONT:c.cullFace(c.FRONT);break}}};vxlRenderEngine.prototype.enableOffscreen=function(){this._offscreen=true;
this._target=new vxlRenderTarget(this)};vxlRenderEngine.prototype.disableOffscreen=function(){this._offscreen=false;delete this._target;this._target=undefined};vxlRenderEngine.prototype.isOffscreenEnabled=function(){return(this._target!=undefined)};vxlRenderEngine.prototype.readOffscreenPixel=function(a,d){var c=this._target.readPixel(a,d);value=Array.apply([],c);value.constructor===Array;return value};function vxlBakeEngine(a){this.renderer=a;var c=a.gl;this._calls={};this._gl_buffers={index:c.createBuffer(),baked:c.createBuffer(),position:c.createBuffer(),scale:c.createBuffer(),shading:c.createBuffer()};
this._data={index:[],baked:[],position:[],scale:[],shading:[]};this._allocated=[];this._offsets={position:{},scale:{},shading:{},baked:{}};this.glsl=vxl.util.extend(vxl.def.essl,{POSITION:"aPosition",SCALE:"aScale",SHADING:"aShading"})}vxlBakeEngine.prototype._populate=function(k,h){var c=[];for(var f=0;f<h;f+=1){if(k instanceof Array||k instanceof Float32Array){for(var d=0;d<k.length;d+=1){c.push(k[d])}}else{c.push(k)}}return c};vxlBakeEngine.prototype._computeRequiredCalls=function(k){var h=k._actors;
var a=h.length;var c=0;var f=1;for(var d=0;d<a;d+=1){c+=h[d].model.indices.length;if(c>65000){c=0;f++}}return f};vxlBakeEngine.prototype._allocateActor=function(k){if(this._allocated.indexOf(k.UID)!=-1){return}var m=this._data;var f=this._offsets;var n=this.renderer.gl;var o=k.model;var a=o.vertices.length;var h=[],q=[];if(k.material.diffuse){h=this._populate(k.material.diffuse,a/3)}else{h=this._populate([0.7,0.7,0.7],a/3)}if(o.normals){q=o.normals}else{q=this._populate(0,a)}f.baked[k.UID]=m.baked.length;
for(var l=0;l<a;l+=3){m.baked.push(o.vertices[l]);m.baked.push(o.vertices[l+1]);m.baked.push(o.vertices[l+2]);m.baked.push(q[l]);m.baked.push(q[l+1]);m.baked.push(q[l+2]);m.baked.push(h[l]);m.baked.push(h[l+1]);m.baked.push(h[l+2])}f.position[k.UID]=m.position.length;f.scale[k.UID]=m.scale.length;f.shading[k.UID]=m.shading.length;m.position=m.position.concat(this._populate(k._position,a/3));m.scale=m.scale.concat(this._populate(k._scale,a/3));m.shading=m.shading.concat(this._populate(k.material.opacity,a/3));
var c=o.indices.slice(0);if(m.index.length>0){var s=m.index.max()+1;var d=o.indices.length;for(var l=0;l<d;l+=1){c[l]+=s}m.index=m.index.concat(c)}else{m.index=c}this._allocated.push(k.UID)};vxlBakeEngine.prototype._updateActorPosition=function(c){var d=this._data;var h=this._offsets.position[c.UID];if(h==undefined){return}var f=c.model.vertices.length+h;for(var a=h;a<f;a+=3){d.position[a]=c._position[0];d.position[a+1]=c._position[1];d.position[a+2]=c._position[2]}};vxlBakeEngine.prototype._updateActorScale=function(c){var d=this._data;
var h=this._offsets.scale[c.UID];if(h==undefined){return}var f=c.model.vertices.length+h;for(var a=h;a<f;a+=3){d.scale[a]=c._scale[0];d.scale[a+1]=c._scale[1];d.scale[a+2]=c._scale[2]}};vxlBakeEngine.prototype._updateActorColor=function(c){var d=this._data;var h=this._offsets.baked[c.UID];if(h==undefined){return}var f=(c.model.vertices.length*3)+h;for(var a=h;a<f;a+=9){d.baked[a+6]=c.material.diffuse[0];d.baked[a+7]=c.material.diffuse[1];d.baked[a+8]=c.material.diffuse[2]}};vxlBakeEngine.prototype._updateActorShading=function(c){var d=this._data;
var k=this._offsets.shading[c.UID];if(k==undefined){return}var f=(c.model.vertices.length/3)+k;var h=0;if(c.material.opacity){h=1}for(var a=k;a<f;a+=1){d.shading[a]=h}};vxlBakeEngine.prototype.deallocate=function(a){};vxlBakeEngine.prototype.allocate=function(m){if(this._computeRequiredCalls(m)>1){throw"Not renderable yet. Working on it. The number of indices exceeds the 65K limit"}var a=m._actors;var d=a.length;var c=this.renderer;var q=this._gl_buffers;var k=this._data;var f=c.pm;var l=c.gl;var o=this.glsl;
var n=l.STATIC_DRAW;for(var h=0;h<d;h+=1){this._allocateActor(a[h])}f.enableAttribute(o.VERTEX_ATTRIBUTE);f.enableAttribute(o.NORMAL_ATTRIBUTE);f.enableAttribute(o.COLOR_ATTRIBUTE);f.enableAttribute(o.POSITION);f.enableAttribute(o.SCALE);f.enableAttribute(o.SHADING);l.bindBuffer(l.ARRAY_BUFFER,q.baked);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.baked),n);f.setAttributePointer(o.VERTEX_ATTRIBUTE,3,l.FLOAT,false,36,0);f.setAttributePointer(o.NORMAL_ATTRIBUTE,3,l.FLOAT,false,36,12);f.setAttributePointer(o.COLOR_ATTRIBUTE,3,l.FLOAT,false,36,24);
l.bindBuffer(l.ARRAY_BUFFER,q.position);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.position),n);f.setAttributePointer(o.POSITION,3,l.FLOAT,false,12,0);l.bindBuffer(l.ARRAY_BUFFER,q.scale);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.scale),n);f.setAttributePointer(o.SCALE,3,l.FLOAT,false,12,0);l.bindBuffer(l.ARRAY_BUFFER,q.shading);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.shading),n);f.setAttributePointer(o.SHADING,1,l.FLOAT,false,4,0);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,q.index);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(k.index),n)
};vxlBakeEngine.prototype.render=function(m){var a=this.renderer;var d=a.transforms;var c=a.pm;var l=a.gl;var o=vxl.def.essl;var h=this._data;d.update();c.setUniform(o.PERSPECTIVE_MATRIX,d.pMatrix);c.setUniform(o.MODEL_VIEW_MATRIX,d.mvMatrix);c.setUniform(o.NORMAL_MATRIX,d.nMatrix);c.setUniform(o.MVP_MATRIX,d.mvpMatrix);for(var k=0,n=m._actors.length;k<n;k+=1){var f=m._actors[k];this._updateActorPosition(f);this._updateActorScale(f);this._updateActorShading(f);this._updateActorColor(f)}l.drawElements(l.TRIANGLES,h.index.length,l.UNSIGNED_SHORT,0);
l.bindBuffer(l.ARRAY_BUFFER,null);l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null)};function vxlScene(){this.views=[];this._actors=[];this._groups=[];this.toys=new vxlSceneToys(this);this.loadingMode=vxl.def.model.loadingMode.LIVE;this.normalsFlipped=false;this.lutID=null;this.timerID=null;this.scalarMIN=Number.MAX_VALUE;this.scalarMAX=Number.MIN_VALUE;this.bb=[0,0,0,0,0,0];this.centre=[0,0,0];this.frameAnimation=null;this.UID=vxl.util.generateUID();if(vxl.c.scene==null){vxl.c.scene=this}vxl.go.scenes.push(this);
var c=vxl.go.notifier;var a=vxl.events;c.publish([a.SCENE_NEW,a.SCENE_UPDATED],this);c.subscribe([a.MODELS_LOADED,a.DEFAULT_LUT_LOADED],this);c.fire(a.SCENE_NEW,this)}vxlScene.prototype.handleEvent=function(a,c){if(a==vxl.events.MODELS_LOADED){this.updateScalarRange();if(this.lutID!=null){this.setLookupTable(this.lutID)}}else{if(a==vxl.events.DEFAULT_LUT_LOADED){this.lutID="default";this.setLookupTable(this.lutID)}}};vxlScene.prototype.setLoadingMode=function(c){var a=vxl.def.model.loadingMode;if(c==undefined||c==null||(c!=a.LIVE&&c!=a.LATER&&c!=a.DETACHED)){throw ("the mode "+c+"is not a valid loading mode")
}this.loadingMode=c};vxlScene.prototype._updateBoundingBoxWith=function(c){var a=c._bb;vxl.go.console("Scene: updating metrics with ("+a[0]+","+a[1]+","+a[2]+") - ("+a[3]+","+a[4]+","+a[5]+")");if(this._actors.length==1){this.bb=this._actors[0]._bb.slice(0);this.toys.update();return}var d=this.bb;var f=this.centre;d[0]=Math.min(d[0],a[0]);d[1]=Math.min(d[1],a[1]);d[2]=Math.min(d[2],a[2]);d[3]=Math.max(d[3],a[3]);d[4]=Math.max(d[4],a[4]);d[5]=Math.max(d[5],a[5]);f[0]=(d[3]+d[0])/2;f[1]=(d[4]+d[1])/2;
f[2]=(d[5]+d[2])/2;f[0]=Math.round(f[0]*1000)/1000;f[1]=Math.round(f[1]*1000)/1000;f[2]=Math.round(f[2]*1000)/1000;this.toys.update()};vxlScene.prototype.computeBoundingBox=function(){if(this._actors.length>0){this.bb=this._actors[0]._bb.slice(0)}else{this.bb=[0,0,0,0,0,0]}this.centre=[0,0,0];var a=this._actors.length;while(a--){this._updateBoundingBoxWith(this._actors[a])}};vxlScene.prototype.createActor=function(a){var c=new vxlActor(a);this.addActor(c);return c};vxlScene.prototype.createActors=function(c){var a=c.length;
while(a--){this.createActor(c[a])}};vxlScene.prototype.addActor=function(a){a.setScene(this);if(this.normalsFlipped){a.flipNormals(true)}if(this.lutID!=null){a.setLookupTable(this.lutID,this.scalarMIN,this.scalarMAX)}this._actors.push(a);this._updateBoundingBoxWith(a);vxl.go.console("Scene: Actor for model "+a.model.name+" added");if(this._actors.length==1){vxl.c.actor=a}else{vxl.c.actor=undefined}vxl.go.notifier.fire(vxl.events.SCENE_UPDATED,this)};vxlScene.prototype.updateActor=function(c){if(!this.hasActor(c)){return
}c.dirty=true;var a=this.views.length;while(a--){this.views[a].renderer.reallocate()}c.dirty=false};vxlScene.prototype.removeActor=function(c){var a=this._actors.indexOf(c);this._actors.splice(a,1);this.computeBoundingBox()};vxlScene.prototype.hasActor=function(c){if(c instanceof vxlActor){return(this._actors.indexOf(c)!=-1)}else{if(typeof(c)=="string"){var a=this.getActorByName(c);return(a!=undefined)}else{return false}}};vxlScene.prototype.setPropertyForAll=function(d,c){var a=this._actors.length;
while(a--){this._actors[a].setProperty(d,c)}};vxlScene.prototype.setPropertyFor=function(h,f,d){var a=h.length;while(a--){if(this.hasActor(h[a])){var c=undefined;if(typeof(h[a])=="string"){c=this.getActorByName(h[a])}else{if(h[a] instanceof vxlActor){h[a].setProperty(f,d)}else{throw"vxlScene.setPropertyFor: ERROR, the list of actors is invalid"}}}}};vxlScene.prototype.updateScalarRange=function(){var a=this._actors.length;while(a--){var c=this._actors[a];if(c.model.scalars&&c.model.scalars.max()>this.scalarMAX){this.scalarMAX=c.model.scalars.max()
}if(c.model.scalars&&c.model.scalars.min()<this.scalarMIN){this.scalarMIN=c.model.scalars.min()}}};vxlScene.prototype.setLookupTable=function(c){this.lutID=c;var a=this._actors.length;while(a--){this._actors[a].setLookupTable(c,this.scalarMIN,this.scalarMAX)}};vxlScene.prototype.reset=function(){var a=this._actors.length;while(a--){this._actors[a]=null}this._actors=[];vxl.c.actor=null;this.computeBoundingBox()};vxlScene.prototype.getActorByName=function(a){a=a.replace(/\.[^/.]+$/,"");var c=this._actors.length;
while(c--){if(this._actors[c].name==a){return this._actors[c]}}return null};vxlScene.prototype.getActorByUID=function(a){var c=this._actors.length;while(c--){if(this._actors[c].UID==a){return this._actors[c]}}return null};vxlScene.prototype.getActor=function(c){var a=this.getActorByName(c);if(a==null){a=this.getActorByUID(c)}return a};vxlScene.prototype.getActorsThat=function(h){var a=[];var f=this._actors.length;while(f--){if(h(this._actors[f])){a.push(f)}}var d=[];var c=a.length;while(c--){d.push(this._actors[a[c]])
}return d};vxlScene.prototype.setOpacity=function(f,a){if(a==null){var c=this._actors.length;while(c--){this._actors[c].setOpacity(f)}}else{var d=this.getActorByName(a);d.setOpacity(f)}};vxlScene.prototype.flipNormals=function(){var a=this._actors.length;while(a--){this._actors[a].flipNormals()}};vxlScene.prototype.setVisualizationMode=function(c){if(c==null||c==undefined){return}var a=this._actors.length;while(a--){this._actors[a].setVisualizationMode(c)}};vxlScene.prototype.setAnimation=function(c){if(c instanceof vxlFrameAnimation){this.frameAnimation=c;
this.frameAnimation.scene=this;var a=this.views.length;while(a--){this.views[a].renderer.setMode(vxl.def.renderer.mode.ANIMFRAME)}vxl.go.console("Scene: animation added")}};vxlScene.prototype.clearAnimation=function(){if(this.frameAnimation){this.frameAnimation.scene=null;this.frameAnimation=null}};vxlScene.prototype.getActorNames=function(){var c=[];var a=this._actors.length;while(a--){c.push(this._actors[a].name)}return c};vxlScene.prototype.getPickableActors=function(){function a(c){return c.isPickable()
}return this.getActorsThat(a)};vxlScene.prototype.getActorByCellUID=function(a){var f=[];var c=this._actors.length;while(c--){var d=this._actors[c];if(d.mesh!=undefined&&d.mesh.hasCell(a)){return d}}return null};vxlScene.prototype.createActorGroup=function(a,d){var f=undefined;if(this.getActorGroup(a)!=undefined){alert("vxlScene.createActorGroup: an actor group with the name "+a+" already exists");throw ("vxlScene.createActorGroup: an actor group with the name "+a+" already exists")}try{f=new vxlActorGroup(this,a,d);
this._groups.push(f)}catch(c){if(c instanceof vxlActorGroupException){alert(c.messages)}}finally{return f}};vxlScene.prototype.getActorGroup=function(a){var c=this._groups.length;while(c--){if(this._groups[c].name==a){return this._groups[c]}}return undefined};function vxlSceneToys(a){this.scene=a;this.list=[];this.axis=new vxlAxis();this.boundingbox=new vxlBoundingBox();this.floor=new vxlFloor();this.list.push(this.axis);this.list.push(this.boundingbox);this.list.push(this.floor)}vxlSceneToys.prototype.update=function(){this.axis.setCentre(this.scene.centre);
this.boundingbox.setBoundingBox(this.scene.bb)};function vxlLookupTable(){this.ID=null;this.map=null;this.max=Number.MIN_VALUE;this.min=Number.MAX_VALUE}vxlLookupTable.prototype.load=function(a,d){this.ID=a;this.map=d;for(var c in this.map){var f=Number(c);if(f<this.min){this.min=f}else{if(f>=this.max){this.max=f}}}};vxlLookupTable.prototype._scale=function(d,c,a){return d*this.max/a};vxlLookupTable.prototype.getColor=function(m,h,a){var k=this._scale(m,h,a);var d=this;var f=Math.round(k);if(f>=d.min&&f<=d.max){var n=[d.map[f][0],d.map[f][1],d.map[f][2]];
return n}else{if(f<d.min){return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}else{if(f>d.max){return[d.map[d.max][0],d.map[d.max][1],d.map[d.max][2]]}else{alert("assertion error in getColor routine");return[d.map[d.min][0],d.map[d.min][1],d.map[d.min][2]]}}}};vxlLookupTable.prototype.getColors=function(h,f,a){var l=[];for(var d=0;d<h.length;d++){var k=this.getColor(h[d],f,a);l.push(k[0]);l.push(k[1]);l.push(k[2])}return l};function vxlLookupTableManager(){this._hashmap={};this._location="";vxl.go.notifier.publish(vxl.events.DEFAULT_LUT_LOADED,this)
}vxlLookupTableManager.prototype.setLocation=function(a){this._location=a};vxlLookupTableManager.prototype.load=function(d){if(this.isLoaded(d)){return}var f=this;var k=this._location+"/"+d+".lut";var l=k+"?nocache="+(new Date()).getTime();var c=function(n,m){return function(o,q){n._handle(m,o)}};var a=function(m){return function(q,n,o){if(o.code=1012){alert("The file "+m+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+m+". HTTP error code:"+q.status)
}}};var h=$.ajax({url:l,type:"GET",dataType:"json",success:c(f,d),error:a(k)})};vxlLookupTableManager.prototype._handle=function(a,d){var c=new vxlLookupTable();c.load(a,d);this._hashmap[a]=c;if(c.ID==vxl.def.lut.main){vxl.go.notifier.fire(vxl.events.DEFAULT_LUT_LOADED,this)}};vxlLookupTableManager.prototype.isLoaded=function(a){return this._hashmap[a]!=undefined};vxlLookupTableManager.prototype.get=function(a){return this._hashmap[a]};vxlLookupTableManager.prototype.getAllLoaded=function(){var a=[];
for(lut in this._hashmap){a.push(this._hashmap[lut].ID)}return a};vxlLookupTableManager.prototype.allLoaded=function(){var a=0;for(lut in this._hashmap){a++}return(vxl.def.lut.list.length==a)};vxlLookupTableManager.prototype.loadAll=function(){for(var a=0;a<vxl.def.lut.list.length;a++){this.load(vxl.def.lut.list[a])}};vxl.go.lookupTableManager=new vxlLookupTableManager();vxl.def.model.boundingBox=new vxlModel();vxl.def.model.boundingBox.load("bounding box",{vertices:[],wireframe:[0,1,1,2,2,3,3,0,0,4,4,5,5,6,6,7,7,4,1,5,2,6,3,7],color:[1,1,1,1],shading:false});
vxlBoundingBox.prototype=new vxlActor();vxlBoundingBox.prototype.constructor=vxlBoundingBox;function vxlBoundingBox(){vxlActor.call(this,vxl.def.model.boundingBox);this.bb=this.setBoundingBox([-1,-1,-1,1,1,1]);this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true}vxlBoundingBox.prototype.setBoundingBox=function(a){this.bb=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5],a[3],a[1],a[5]];this.model.vertices=this.bb;this.reallocate()
};vxl.def.model.axis=new vxlModel();vxl.def.model.axis.load("axis",{vertices:[-1,0,0,1,0,0,0,-2,0,0,2,0,0,0,-1,0,0,1],wireframe:[0,1,2,3,4,5],colors:[1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],shading:false});vxlAxis.prototype=new vxlActor();vxlAxis.prototype.constructor=vxlAxis;function vxlAxis(){vxlActor.call(this,vxl.def.model.axis);this.centre=[0,0,0];this.mode=vxl.def.actor.mode.WIREFRAME;this.visible=false;this.toy=true}vxlAxis.prototype.setCentre=function(d){var c=d[0];var h=d[1];var f=d[2];this.centre[0]=c;
this.centre[1]=h;this.centre[2]=f;var a=this.model.vertices;a[0]=c-1;a[1]=h;a[2]=f;a[3]=c+1;a[4]=h;a[5]=f;a[6]=c;a[7]=h-2;a[8]=f;a[9]=c;a[10]=h+2;a[11]=f;a[12]=c;a[13]=h;a[14]=f-1;a[15]=c;a[16]=h;a[17]=f+1};vxl.def.model.floor=new vxlModel();vxl.def.model.floor.load("floor",{vertices:[],indices:[],color:[0.6,0.6,0.6,1],shading:false});vxlFloor.prototype=new vxlActor();vxlFloor.prototype.constructor=vxlFloor;function vxlFloor(){vxlActor.call(this,vxl.def.model.floor);this.mode=vxl.def.actor.mode.WIREFRAME;
this.visible=false;this.toy=true}vxlFloor.prototype.setGrid=function(m,n){var k=m;var c=2*k/n;var h=2*k/c;var d=[];var f=[];for(var a=0;a<=c;a++){d[6*a]=-k;d[6*a+1]=0;d[6*a+2]=-k+(a*h);d[6*a+3]=k;d[6*a+4]=0;d[6*a+5]=-k+(a*h);d[6*(c+1)+6*a]=-k+(a*h);d[6*(c+1)+6*a+1]=0;d[6*(c+1)+6*a+2]=-k;d[6*(c+1)+6*a+3]=-k+(a*h);d[6*(c+1)+6*a+4]=0;d[6*(c+1)+6*a+5]=k;f[2*a]=2*a;f[2*a+1]=2*a+1;f[2*(c+1)+2*a]=2*(c+1)+2*a;f[2*(c+1)+2*a+1]=2*(c+1)+2*a+1}this.model.vertices=d.slice(0);this.model.wireframe=f.slice(0);this.visible=true;
this.reallocate()};function vxlView(f,d,h){this.canvas=document.getElementById(f);if(this.canvas==null){alert("View: the canvas "+f+" does not exist.");throw ("View: the canvas "+f+" does not exist.")}this.name=f;this.width=this.canvas.width;this.height=this.canvas.height;this.clearDepth=1;this.backgroundColor=vxl.def.view.background.slice(0);this.dragndrop=false;this.renderer=new vxlRenderer(this);this.setBackgroundColor(this.backgroundColor);this.setClearDepth(this.clearDepth);this.cameraman=new vxlCameraManager(this);
this.interactor=new vxlTrackerInteractor();this.interactor.connectView(this);if(d!=null&&d instanceof vxlScene){this.scene=d}else{if(vxl.c.scene!=undefined){this.scene=vxl.c.scene}else{this.scene=new vxlScene()}}this.scene.views.push(this);if(vxl.c.view==undefined){vxl.c.view=this}vxl.go.views.push(this);if(h==undefined){h=true}this.setAutoResize(h);this._fullscreenFlag=true;this.UID=vxl.util.generateUID();var c=vxl.go.notifier;var a=vxl.events;c.publish(a.VIEW_NEW,this);c.subscribe(a.DEFAULT_LUT_LOADED,this);
c.fire(a.VIEW_NEW,this);vxl.go.console("View: the view "+this.name+" has been created")}vxlView.prototype.handleEvent=function(a,c){vxl.go.console("vxlView ["+this.name+"]: receiving event "+a);if(a==vxl.events.DEFAULT_LUT_LOADED){this.scene.setLookupTable(vxl.def.lut.main)}};vxlView.prototype.clear=function(){this.renderer.clear()};vxlView.prototype._wrapDiv=function(){$(this.canvas).css({position:"absolute",height:"auto",bottom:0,top:0,left:0,right:0,margin:"5px"});$(this.canvas).wrap("<div id="+this.name+"-wrapper />");
$("#"+this.name+"-wrapper").css({width:"100%",height:"100%"});this.canvas.focus()};vxlView.prototype.resize=function(){var a=this.canvas.parentNode;this.width=$(a).width()-5;this.height=$(a).height()-5;if(this.width>window.innerWidth-5){this.width=window.innerWidth-5}if(this.height>window.innerHeight-5){this.height=window.innerHeight-5}$(this.canvas).attr("width",this.width);$(this.canvas).attr("height",this.height)};vxlView.prototype.setAutoResize=function(a){if(a){this._wrapDiv();this.resize();
$(window).resize((function(c){return function(){c.resize()}})(this))}else{$(window).unbind("resize")}};vxlView.prototype._runPrefixMethod=function(f,k){var h=["webkit","moz","ms","o",""];var d=0,a,c;while(d<h.length&&!f[a]){a=k;if(h[d]==""){a=a.substr(0,1).toLowerCase()+a.substr(1)}a=h[d]+a;c=typeof f[a];if(c!="undefined"){h=[h[d]];return(c=="function"?f[a]():f[a])}d++}};vxlView.prototype.fullscreen=function(a){if(!this._fullscreenFlag){return}if(a==true){this._runPrefixMethod(this.canvas,"RequestFullScreen")
}else{if(this._runPrefixMethod(document,"FullScreen")||this._runPrefixMethod(document,"isFullScreen")){this._runPrefixMethod(document,"CancelFullScreen")}}};vxlView.prototype.disableFullScreen=function(){this._fullscreenFlag=false};vxlView.prototype.enableFullScreen=function(){this._fullscreenFlag=true};vxlView.prototype.start=function(){this.renderer.start();this.refresh()};vxlView.prototype.stop=function(){this.renderer.stop()};vxlView.prototype.reset=function(){this.stop();this.scene.reset();this.cameraman.reset();
this.start()};vxlView.prototype.setBackgroundColor=function(d,c,a){this.backgroundColor=vxl.util.createColor(d,c,a);this.renderer.clearColor(this.backgroundColor)};vxlView.prototype.setClearDepth=function(a){this.renderer.clearDepth(a)};vxlView.prototype.refresh=function(){if(this.renderer.mode!=vxl.def.renderer.mode.ANIMFRAME){this.renderer.render()}};vxlView.prototype.setInteractor=function(a){this.interactor=a;this.interactor.connectView(this)};vxlView.prototype.setDragAndDrop=function(a){this.dragndrop=a
};vxlView.prototype.getFPS=function(){return this.renderer.fps};function vxlModelManager(){this.toLoad=[];this.models=[];var a=vxl.events;vxl.go.notifier.publish([a.MODELS_LOADING,a.MODEL_NEW,a.MODELS_LOADED],this);vxl.go.notifier.subscribe(a.READER_DONE,this)}vxlModelManager.prototype.handleEvent=function(d,f){var a=f;var c=a.getModel();this.add(c,a.scene)};vxlModelManager.prototype.load=function(c,k){var f=this;var a=c.replace(/^.*[\\\/]/,"");var d=a.split(".")[0];var n=a.split(".")[1];var o="json";
if(f.isModelLoaded(d)){return}if(n=="vtk"){o="text"}else{if(n=="json"){o="json"}else{alert("vxlManager.load ERROR: Unknown filetype ["+n+"]");throw ("vxlManager.load ERROR: Unknown filetype ["+n+"]")}}nocacheuri=c+"?nocache="+(new Date()).getTime();vxl.go.console("ModelManager.load: Requesting "+c+"...");vxl.go.notifier.fire(vxl.events.MODELS_LOADING,this);var m=function(s,q,t){switch(n){case"json":return function(u,v){u.uri=a;u.path=vxl.util.getPath(c);u.name=q;s.add(u,t)};break;case"vtk":return function(u){reader=new vxlVTKReader(t);
reader.readText(q,u)}}};var l=function(q){return function(u,s,t){if(t.code=1012){alert("The file "+q+" could not be accessed. \n\nPlease make sure that the path is correct and that you have the right pemissions")}else{alert("There was a problem loading the file "+q+". HTTP error code:"+u.status)}}};var h=$.ajax({url:nocacheuri,type:"GET",dataType:o,success:m(f,d,k),error:l(c)})};vxlModelManager.prototype.loadList=function(c,d){this.toLoad=c.slice(0);vxl.go.console("ModelManager.loadList: models to load ->"+this.toLoad.length);
for(var a=0;a<this.toLoad.length;a++){this.load(this.toLoad[a],d)}};vxlModelManager.prototype.add=function(h,a){var d=this;var f=undefined;if(h instanceof vxlModel){f=h}else{f=new vxlModel(h.name,h)}function c(){f.loaded=true;d.models.push(f);d.toLoad.splice(name,1);vxl.go.console("ModelManager: model "+f.name+" created.");if(a!=undefined&&a instanceof vxlScene){vxl.go.console("ModelManager: notifying the scene...");if(a.loadingMode==vxl.def.model.loadingMode.LIVE){a.createActor(f)}else{if(a.loadingMode==vxl.def.model.loadingMode.LATER){if(d.allLoaded()){a.createActors(d.models)
}}else{if(a.loadingMode==vxl.def.model.loadingMode.DETACHED){}}}}if(d.allLoaded()){vxl.go.notifier.fire(vxl.events.MODELS_LOADED,d)}else{vxl.go.notifier.fire(vxl.events.MODEL_NEW,d)}}setTimeout(function(){c()},0)};vxlModelManager.prototype.reset=function(){this.firstLoadedModel=false;for(var a=0;a<this.models.length;a++){this.models[a]=null}this.models=[];this.toLoad=[]};vxlModelManager.prototype.isModelLoaded=function(a){for(var c=0;c<this.models.length;c++){if(this.models[c].name==a){return true
}}return false};vxlModelManager.prototype.allLoaded=function(){return(this.toLoad.length==0)};vxlModelManager.prototype.getModelByName=function(c){for(var d=0,a=this.models.length;d<a;d+=1){if(this.models[d].name==c){return this.models[d]}}return null};vxl.go.modelManager=new vxlModelManager();vxl.api={setup:function(a,c,d){if(c!=null&&!(c instanceof vxlScene)){throw ("api.setup: scene parameter is invalid")}return new vxlView(a,c,d)},setRenderRate:function(a){vxl.c.view.renderer.setRenderRate(a)
},setRenderMode:function(c,a){if(a==undefined&&vxl.c.view==undefined){throw ("api.setRnederMode: you need to define a view")}else{if(a!=undefined&&a instanceof vxlView){a.renderer.setMode(c)}else{vxl.c.view.renderer.setMode(c)}}},setFieldOfView:function(a){if(a>0&&a<=360){vxl.c.camera.setFieldOfView(a)}else{throw ("api.setFieldOfView: the field of view should be between 0 and 360 degrees")}},setCurrentView:function(c){if(c instanceof vxlView){vxl.c.view=c}},getCurrentView:function(){return vxl.c.view
},setCurrentActor:function(a){if(a instanceof vxlActor){vxl.c.actor=a}else{if(typeof a=="string"){if(vxl.c.scene==undefined){throw ("vxl.api.setCurrentActor: there is no Current scene. Please call vxl.api.setCurrentScene")}var c=vxl.c.scene.getActorByName(a);if(c!=undefined){vxl.c.actor=c}else{throw ("vxl.api.setCurrentActor: the actor "+a+" does not exist in the current scene")}}else{vxl.c.actor=a}}},getCurrentActor:function(){return vxl.c.actor},setCurrentCamera:function(c){if(c instanceof vxlCamera){vxl.c.camera=c
}},getCurrentCamera:function(){return vxl.c.camera},setLookupTable:function(a){if(!vxl.go.lookupTableManager.isLoaded(a)){vxl.go.console("Lookup Table "+a+" has not been loaded");return}vxl.c.view.scene.setLookupTable(a)},loadLUTS:function(a){vxl.go.lookupTableManager.setLocation(a);vxl.go.lookupTableManager.loadAll()},resetScene:function(){if(vxl.c.animation){vxl.c.animation.stop()}vxl.c.view.reset();vxl.go.modelManager.reset()},load:function(c,h,k,f){var f=f==null?vxl.c.scene:f;var l=[];var d=vxl.util.getPath(h);
if(typeof(c)=="string"||c instanceof String){l.push(d+c)}else{if(c instanceof Array){for(var a=0;a<c.length;a++){l.push(d+c[a])}}}if(k!=undefined&&k!=null){f.setLoadingMode(k)}vxl.go.modelManager.loadList(l,f)},loadSequence:function(m,c,f,n,l,k){var k=k==null?vxl.c.scene:k;var a=[];var d=vxl.util.getPath(n);for(var h=c;h<=f;h+=1){a.push(d+m+h+".json")}if(l!=undefined&&l!=null){k.setLoadingMode(l)}vxl.go.modelManager.loadList(a,k)},axisON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisON: There is no current scene")
}vxl.c.scene.toys.axis.setVisible(true);vxl.c.camera.refresh()},axisOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.axisOFF: There is no current scene")}vxl.c.scene.toys.axis.setVisible(false);vxl.c.camera.refresh()},boundingBoxON:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxON: There is no current scene")}vxl.c.scene.toys.boundingbox.setVisible(true);vxl.c.camera.refresh()},boundingBoxOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.boundingBoxOFF: There is no current scene")
}vxl.c.scene.toys.boundingbox.setVisible(false);vxl.c.camera.refresh()},floorON:function(a,c){if(vxl.c.scene==undefined){throw ("vxl.api.floorON: There is no current scene")}if(a==undefined||c==undefined){vxl.c.scene.toys.floor.setVisible(true)}else{vxl.c.scene.toys.floor.setGrid(a,c)}vxl.c.camera.refresh()},floorOFF:function(){if(vxl.c.scene==undefined){throw ("vxl.api.floorOFF: There is no current scene")}vxl.c.scene.toys.floor.setVisible(false);vxl.c.camera.refresh()},setBackgroundColor:function(d,c,a){vxl.c.view.setBackgroundColor(d,c,a)
},wireframeON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)}else{vxl.c.scene.setVisualizationMode(vxl.def.actor.mode.WIREFRAME)}vxl.go.console("API:Wireframe is shown.")},surfaceON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.SOLID)}vxl.go.console("API:Wireframe is hidden.")},pointsON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.POINTS)
}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.POINTS)}},solidWireframeON:function(){if(vxl.c.actor){vxl.c.actor.setVisualizationMode(vxl.def.actor.mode.WIRED_AND_SOLID)}else{vxl.c.view.scene.setVisualizationMode(vxl.def.actor.mode.WIRED_AND_SOLID)}vxl.go.console("API:Wireframe is hidden.")},getActorNames:function(c){var a=c;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorNames: There is no current scene")}else{a=vxl.c.scene}}return a.getActorNames()},createActorGroup:function(a,c){return vxl.c.scene.createActorGroup(a,c)
},getAllActors:function(){var c=vxl.c.scene;var a=c.getActorGroup("all");if(a==undefined){a=c.createActorGroup("all",vxl.c.scene._actors)}else{a.reset(vxl.c.scene._actors)}return a},getActor:function(d,c){var a=this.getActorByName(d,c);if(a==null){a=this.getActorByUID(d,c)}return a},getActorByUID:function(c,d){var a=d;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByUID: There is no current scene. Please the scene you want to look the actor with uid: "+UID+" into")}else{a=vxl.c.scene
}}return a.getActorByUID(c)},getActorByName:function(d,c){var a=c;if(a==undefined){if(vxl.c.scene==undefined){throw ("vxl.api.getActorByName: There is no current scene. Please the scene you want to look the actor "+d+" into")}else{a=vxl.c.scene}}return a.getActorByName(d)},setActorOpacity:function(c){var a=Math.min(Math.max(0,Math.abs(c)),1);if(vxl.c.actor){vxl.c.actor.setOpacity(c)}else{vxl.c.view.scene.setOpacity(a)}vxl.c.view.refresh();vxl.go.console("API:Opacity changed to "+(c*100)+"%")},setActorProperty:function(c,f,d){if(vxl.c.scene==undefined){throw ("vxl.api.setActorProperty: there is no current scene. Please call vxl.api.setCurrentScene")
}var h=vxl.c.scene;var a=c;if(a instanceof vxlActor){a.setProperty(f,d)}else{a=h.getActorByName(a);if(a==undefined){throw"The actor "+a+" does not belong to the current scene"}a.setProperty(f,d)}},setPropertyForAll:function(d,c,f){var a=undefined;if(vxl.c.scene==undefined&&f==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(f==undefined){a=vxl.c.scene}else{a=f}a.setPropertyForAll(d,c)},setPropertyFor:function(f,d,c,h){var a=undefined;
if(vxl.c.scene==undefined&&h==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(h==undefined){a=vxl.c.scene}else{a=h}a.setPropertyFor(f,d,c)},getActorsThat:function(d,c){var a=undefined;if(vxl.c.scene==undefined&&c==undefined){throw ("vxl.api.setPropertyForAll: there is no current scene. Please call vxl.api.setCurrentScene")}if(c==undefined){a=vxl.c.scene}else{a=c}return a.getActorsThat(d)},flipActorNormals:function(){if(vxl.c.actor){vxl.c.actor.flipNormals()
}else{vxl.c.view.scene.flipNormals()}vxl.c.view.refresh()},stopAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.stop()}},startAnimation:function(){if(vxl.c.animation!=null){vxl.c.animation.start()}},setFrame:function(d){if(vxl.c.animation==null){return}var c=vxl.c.animation;c.stop();if(d>=1){c.setFrame(d)}else{vxl.go.console("API:frame "+d+" does not exist. Animation goes back to the beginning");c.setFrame(1)}},clearAnimation:function(){if(vxl.c.animation){vxl.c.animation.stop();vxl.c.animation=null
}},resetCamera:function(){vxl.c.camera.reset()},saveCamera:function(){vxl.c.camera.save()},retrieveCamera:function(){vxl.c.camera.retrieve()},setAzimuth:function(c){vxl.c.camera.setAzimuth(c)},setElevation:function(a){vxl.c.camera.setElevation(a)},getLookupTables:function(){return vxl.go.lookupTableManager.getAllLoaded()},setProgram:function(a,c){a.renderer.engine.pm.setProgram(c)},releaseProgram:function(a){a.renderer.engine.pm.releaseProgram()},getProgram:function(a){if(a==undefined){a=vxl.c.view
}if(a==undefined){throw ("vxl.api.getProgram: please indicate a view")}return a.renderer.engine.pm._current_program_ID},setUniformDefault:function(a,d,c){vxl.c.view.renderer.engine.pm.setDefault(a,d,c)},setUniform:function(c,a){vxl.c.view.renderer.engine.pm.setUniform(c,a)},getUniformDefault:function(a,c){vxl.c.view.renderer.engine.pm.getDefault(a,c)},getUniformList:function(){return vxl.c.view.renderer.pm._uniformList[vxl.c.view.renderer.pm._currentProgramID].slice(0)},getUniform:function(a){return vxl.c.view.renderer.pm.getUniform(a)
},subscribe:function(c,a){vxl.go.notifier.subscribe(c,a)}};function vxlFrameAnimation(a){this.scene=null;this.actorByFrameMap=[];this.activeFrame=1;this.mark=1;this._running=false;this.frameCount=0;this.renderRate=500;this._startDate=undefined;this._time=0;this._setup(a);if(vxl.c.animation==null){vxl.c.animation=this}}vxlFrameAnimation.prototype.addActorToFrame=function(c,a){if(typeof(this.actorByFrameMap[c])=="undefined"){this.actorByFrameMap[c]=new Array()}if(this.actorByFrameMap[c].indexOf(a)==-1){this.actorByFrameMap[c].push(a)
}if(c>this.frameCount){this.frameCount=c}};vxlFrameAnimation.prototype._setup=function(k){this.activeFrame=1;for(var h in k){var c=k[h];var l=parseInt(h.substr(5,h.length));for(var d=0,a=c.length;d<a;d+=1){this.addActorToFrame(l,c[d])}}vxl.go.console("FrameAnimation: Setup finished.")};vxlFrameAnimation.prototype.start=function(a){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this._startDate=new Date().getTime();
this._time=0;this._running=true;if(a!=undefined&&a>=0){this.renderRate=a}this._timeUp()};vxlFrameAnimation.prototype._timeUp=function(){if(!this._running){return}this.nextFrame();if(this._time==this.renderRate*100){this._time=0;this._startDate=new Date().getTime()}this._time+=this.renderRate;var a=(new Date().getTime()-this._startDate)-this._time;if(a>this.renderRate){a=0}setTimeout((function(c){return function(){c._timeUp()}})(this),this.renderRate-a)};vxlFrameAnimation.prototype.stop=function(){this._running=false
};vxlFrameAnimation.prototype.setFrameRate=function(a){if(a<=0){return}this.stop();this.renderRate=a;this.start()};vxlFrameAnimation.prototype.update=function(){if(this.scene==null){throw"FrameAnimation: the animation is not associated with any scene. Please use scene.setFrameAnimation method"}this.scene.setPropertyForAll("visible",false);var d=this.actorByFrameMap[this.activeFrame];var a=d.length;for(var c=0;c<a;c++){var f=this.scene.getActorByName(d[c]);if(f!=null){f.setVisible(true)}}};vxlFrameAnimation.prototype.isValidFrame=function(a){return(a>=1&&a<=this.frameCount)
};vxlFrameAnimation.prototype.nextFrame=function(){if(this.activeFrame<this.frameCount){this.activeFrame++}else{this.activeFrame=1}};vxlFrameAnimation.prototype.getNextFrames=function(k){var f=[];var h=this.activeFrame;if(k>this.frameCount){k=this.frameCount}for(var a=1;a<=k;a++){var d=h+a;if(this.isValidFrame(d)){f.push(d)}else{f.push(d-this.frameCount)}}vxl.go.console("Animation: next frames: "+f);return f};vxlFrameAnimation.prototype.getPreviousFrames=function(k){var f=[];var h=this.activeFrame;
if(k>this.frameCount){k=this.frameCount}for(var a=1;a<=k;a++){var d=h-a;if(this.isValidFrame(d)){f.push(d)}else{f.push(this.frameCount+d)}}vxl.go.console("Animation: previous frames: "+f);return f};vxlFrameAnimation.prototype.setFrame=function(a){if(a>=1&&a<=this.frameCount){this.activeFrame=a;this.render()}};function vxlVTKReader(a){this.scene=a;vxl.go.notifier.publish(vxl.events.READER_DONE,this)}vxlVTKReader.prototype.isSupported=function(){return(window.File&&window.FileReader&&window.FileList&&window.Blob)
};vxlVTKReader.prototype.readFile=function(f){var a=this;var d=f.name;if(d.length-4!==d.indexOf(".vtk")){throw"vxlVTKReader.read: the file "+f+" is not a VTK file"}modelname=d.replace(/\.[^/.]+$/,"");var c=new FileReader();c.onload=function(l){document.body.style.cursor="default";var k=l.target.result.trim();var h=k.split(/\r\n|\r|\n/);a._parse(modelname,h);vxl.go.notifier.fire(vxl.events.READER_DONE,a)};document.body.style.cursor="wait";c.readAsText(f)};vxlVTKReader.prototype.readText=function(c,d){document.body.style.cursor="wait";
var a=d.split(/\r\n|\r|\n/);this._parse(c,a);vxl.go.notifier.fire(vxl.events.READER_DONE,this);document.body.style.cursor="default"};vxlVTKReader.prototype._parse=function(E,d){var h=65536*3;var B="";var f=0;var c="NOWHERE";var l=0;var q=[];var o=[];var z=[];var k=[];var t=[];var x="SOLID";var y={NOWHERE:0,POINTS:1,LINES:2,POLYGONS:3,POINT_DATA:4,NORMALS:5,CELL_DATA:6,TEXTURE_COORDINATES:7,SCALARS:8,LOOKUP_TABLE:9,COLOR_SCALARS:10};this.json={name:E};function s(n){var G=n.length-1;if(G!=n[0]){throw"Assertion Error. Inconsistent line"
}var v=n.splice(1,G);for(var F=0;F<G-1;F+=1){o.push(parseInt(v[F]));o.push(parseInt(v[F+1]))}}for(var l=0;l<d.length;l++){try{if(d[l].indexOf("POINTS")==0){console.log(d[l]);c=y.POINTS;continue}else{if(d[l].indexOf("LINES")==0){console.log(d[l]);c=y.LINES;x="LINES";continue}else{if(d[l].indexOf("TRIANGLE_STRIPS")==0){console.log(d[l]);alert("vxlVTKParser ERROR: \nTriangle Strips Not Supported. Please triangulate first");throw ("Triangle Strips Not Supported. Please triangulate first")}else{if(d[l].indexOf("POLYGONS")==0){console.log(d[l]);
c=y.POLYGONS;continue}else{if(d[l].indexOf("POINT_DATA")==0){c=y.POINT_DATA;continue}else{if(d[l].indexOf("NORMALS")==0){console.log(d[l]);c=y.NORMALS;continue}else{if(d[l].indexOf("CELL_DATA")==0){console.log(d[l]);c=y.CELL_DATA;continue}else{if(d[l].indexOf("TEXTURE_COORDINATES")==0){console.log(d[l]);c=y.TEXTURE_COORDINATES;continue}else{if(d[l].indexOf("SCALARS")==0){console.log(d[l]);c=y.SCALARS;continue}else{if(d[l].indexOf("LOOKUP_TABLE")==0){console.log(d[l]);c=y.LOOKUP_TABLE;continue}else{if(d[l].indexOf("COLOR_SCALARS")==0){console.log(d[l]);
c=y.COLOR_SCALARS;continue}else{if(c==y.POINTS){var u=d[l].trim().split(" ");if(u==""){continue}for(var C=0;C<u.length;C++){q.push(parseFloat(u[C]))}}else{if(c==y.LINES){var w=d[l].trim().split(" ");if(w==""){continue}s(w)}else{if(c==y.POLYGONS){var a=d[l].trim().split(" ");if(a==""){continue}if(a.length>0&&a[0]!="3"){throw"Error: please make sure your vtk file contains triangles instead of polygons (triangulate first)"}for(var C=1;C<a.length;C++){o.push(parseInt(a[C]))}}else{if(c==y.LOOKUP_TABLE){if(d[l].indexOf("LOOKUP_TABLE")==0){continue
}else{var D=d[l].trim().split(" ");if(D==""){continue}for(var C=0;C<D.length;C++){k.push(parseFloat(D[C]))}}}else{if(c==y.COLOR_SCALARS){var A=d[l].trim().split(" ");if(A==""){continue}for(var C=0;C<A.length;C++){t.push(parseFloat(A[C]))}}else{if(c==y.NORMALS){var A=d[l].trim().split(" ");if(A==""){continue}for(var C=0;C<A.length;C++){z.push(parseFloat(A[C]))}}}}}}}}}}}}}}}}}}}catch(m){console.log("Error while processing line "+l.toString());throw m}}this.json.vertices=q;this.json.mode=x;if(o.length>0){this.json.indices=o
}if(z.length>0){this.json.normals=z}if(t.length>0){this.json.colors=t}if(k.length>0){this.json.scalars=k}};vxlVTKReader.prototype.getModel=function(){var a=new vxlModel(this.json.name,this.json);this.json=null;delete this.json;return a};function vxlTexture(c){var a=this;this.image=new Image();this.image.onload=function(){a._onLoad()};this.image.onError=function(){a._onError()};this.uri=c;if(this.uri!=undefined){this.load(this.uri)}this.mag=vxl.def.texture.filter.LINEAR;this.min=vxl.def.texture.filter.LINEAR_MIPMAP_LINEAR;
this.loaded=false}vxlTexture.prototype.setMagFilter=function(a){this.mag=a};vxlTexture.prototype.setMinFilter=function(a){this.min=a};vxlTexture.prototype.load=function(a){this.image.src=a};vxlTexture.prototype._onError=function(){console.info("vxlTexture: the texture "+this.uri+" could not be found.");this.loaded=false};vxlTexture.prototype._onLoad=function(){this.loaded=true};vxlTexture.prototype.getMagFilter=function(c){var a=vxl.def.texture.filter;switch(this.mag){case a.LINEAR:return c.LINEAR;
break;case a.NEAREST:return c.NEAREST;break;default:return c.NEAREST}};vxlTexture.prototype.getMinFilter=function(c){var a=vxl.def.texture.filter;switch(this.min){case a.LINEAR:return c.LINEAR;break;case a.NEAREST:return c.NEAREST;break;case a.LINEAR_MIPMAP_LINEAR:return c.LINEAR_MIPMAP_LINEAR;break;case a.LINEAR_MIPMAP_NEAREST:return c.LINEAR_MIPMAP_NEAREST;break;case a.NEAREST_MIPMAP_LINEAR:return c.NEAREST_MIPMAP_LINEAR;break;case a.NEAREST_MIPMAP_NEAREST:return c.NEAREST_MIPMAP_NEAREST;break;
default:return c.NEAREST}};function vxlMaterial(a){this.ambient=vxl.def.material.ambient;this.diffuse=vxl.def.material.diffuse;this.specular=vxl.def.material.specular;this.shininess=vxl.def.material.shininess;this.opacity=vxl.def.material.opacity;this.shading=vxl.def.material.shading;this.texture=undefined;this.colors=undefined;if(a){this.getFrom(a)}}vxlMaterial.prototype.getFrom=function(a){if(a.ambient!=undefined){this.ambient=a.ambient.slice(0)}if(a.diffuse!=undefined){this.diffuse=a.diffuse.slice(0)
}if(a.specular!=undefined){this.specular=a.specular.slice(0)}if(a.color!=undefined){this.diffuse=a.color.slice(0)}if(a.shininess!=undefined){this.shininess=a.shininess}if(a.opacity!=undefined){this.opacity=a.opacity}if(a.shading!=undefined){this.shading=a.shading}if(a.texture!=undefined){this.texture=new vxlTexture(a.path+a.texture)}if(a.colors!=undefined){this.colors=a.colors}return this};vxlMaterial.prototype.clone=function(){var d=new vxlMaterial();var a=this;for(var c in a){if(a.hasOwnProperty(c)){if(a[c] instanceof Array){d[c]=a[c].slice(0)
}else{d[c]=a[c]}}}return d};function vxlRenderable(a){if(a==undefined){throw ("vxlRenderable: the actor can not be undefined")}this.actor=a;this.parts=[];this.update(vxl.def.renderable.task.CREATE)}vxlRenderable.prototype.update=function(a){if(a==undefined){throw ("vxlRenderable.update: Please specify a task")}var c=this._getModel();if(c==undefined){return}switch(c.type){case vxl.def.model.type.MESH:this._processMesh(c,a);break;case vxl.def.model.type.BIG_DATA:this._processBigData(c,a);break}};vxlRenderable.prototype._getModel=function(){var a=this.actor;
if(a.mesh&&a.mesh.model){return a.mesh.model}else{if(a.model.type==vxl.def.model.type.BIG_DATA){return a.model}else{return undefined}}};vxlRenderable.prototype._processMesh=function(m,d){var q=vxl.def.model.MAX_NUM_INDICES;var n=Math.floor(m.indices.length/q),h=m.indices.length%q;if(d==vxl.def.renderable.task.CREATE){this.parts=[];for(var k=0;k<=n;k+=1){var c=new vxlModel(m.name+"-renderable-part-"+k);var o=k*q;var l=o+q;var a=k*q*3;var f=a+q*3;if(k==n){o=n*q;l=o+h;a=n*q*3;f=a+h*3;if(h==0){break}}c.indices=this._reindex(m.indices.slice(o,l));
c.vertices=m.vertices.slice(a,f);if(m.normals&&m.normals.length>0){c.normals=m.normals.slice(a,f)}if(m.colors&&m.colors.length>0){c.colors=m.colors.slice(a,f)}if(m.pickingColors){c.pickingColors=m.pickingColors.slice(a,f)}c.update();this.parts.push(c)}}else{if(d==vxl.def.renderable.task.UPDATE_COLORS){for(var k=0;k<=n;k+=1){var c=this.parts[k];var a=k*q*3;var f=a+q*3;if(k==n){a=n*q*3;f=a+h*3;if(h==0){break}}if(m.colors&&m.colors.length>0){c.colors=m.colors.slice(a,f)}}}}};vxlRenderable.prototype._reindex=function(d){var c=d.min();
var a=d.length;while(a--){d[a]=d[a]-c}return d};vxlRenderable.prototype._processBigData=function(h,n){var o=h.indices;var t=vxl.def.model.MAX_NUM_INDICES;if(h.mode==vxl.def.actor.mode.LINES){t=t-1}var q=o.length;var f=o.max();var m=this.actor.material;var l=(m.colors&&m.colors.length>0);var c=(h.normals&&h.normals.length>0);var s=(h.scalars&&h.scalars.length>0);var k=h.mode;data={vertices:[],indices:[],mode:k};if(l){data.colors=[]}if(c){data.normals=[]}if(s){data.scalars=[]}index_map={};part_number=1;
new_index=0;progress=0;for(var d=0;d<q;d+=1){index=o[d];if(index_map[index]==undefined){index_map[index]=new_index;vertex=this._getVertexData(index);data.vertices.push.apply(data.vertices,vertex.coords);if(c){data.normals.push.apply(data.normals,vertex.normal)}if(l){data.colors.push.apply(data.colors,vertex.color)}if(s){data.scalars.push(vertex.scalar)}new_index+=1}data.indices.push(index_map[index]);if((new_index==t+1)||(d==q-1)){var a=new vxlModel(h.name+"-renderable-part-"+part_number,data);a.update();
vxl.go.console("Creating part "+a.name+" ["+part_number+"]",true);this.parts.push(a);new_index=0;part_number+=1;a={vertices:[],indices:[],mode:k};index_map={};data={vertices:[],indices:[],mode:k};if(l){data.colors=[]}if(c){data.normals=[]}if(s){data.scalars=[]}}}};vxlRenderable.prototype._getVertexData=function(c){var d=this.actor.material;var a=this.actor.model;var f={};f.coords=a.vertices.slice(c*3,c*3+3);if(a.normals){f.normal=a.normals.slice(c*3,c*3+3)}if(d.colors){f.color=d.colors.slice(c*3,c*3+3)
}if(a.scalars){f.scalar=a.scalars[c]}return f};function vxlActorGroup(d,a,c){this.scene=d;this.name=a;this.list=[];this.addList(c)}vxlActorGroup.prototype.addList=function(h){var f=[];for(var c=0,k=h.length;c<k;c+=1){var d=h[c];if(d instanceof vxlActor&&d.scene==this.scene){this.list.push(d)}else{if(typeof(d)=="string"){var a=this.scene.getActor(d);if(a!=null){this.list.push(a)}else{f.push("Could not find actor: "+d)}}else{f.push("The object "+d+" is not of the expected type (vxlActor, string)")}}}if(f.length!=0){this.list=[];
throw new vxlActorGroupException(f)}};vxlActorGroup.prototype.add=function(c){var d=[];if(c instanceof vxlActor&&c.scene==this.scene){this.list.push(c)}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);if(a!=null){this.list.push(a)}else{d.push("Could not find actor: "+c)}}else{d.push("The object "+c+" is not of the expected type (vxlActor, string)")}}if(d.length!=0){this.list=[];throw new vxlActorGroupException(d)}};vxlActorGroup.prototype.hasActor=function(c){if(c instanceof vxlActor){return(this.list.indexOf(c)!=-1)
}else{if(typeof(c)=="string"){var a=this.scene.getActor(c);return(a!=null)}else{return false}}};vxlActorGroup.prototype.remove=function(c){var a=-1;if(c instanceof vxlActor){a=this.list.indexOf(c)}else{if(typeof(c)=="string"){actorObject=this.scene.getActor(c);a=this.list.indexOf(actorObject)}}if(a!=1){this.list.splice(a,1)}else{throw new vxlActorGroupException(["the actor "+c+" was not found in the group "+this.name])}};vxlActorGroup.prototype.reset=function(a){this.list=[];if(a!=undefined&&a instanceof Array){this.addList(a)
}};vxlActorGroup.prototype.size=function(){return this.list.length};vxlActorGroup.prototype.setProperty=function(d,c){for(var a=0,f=this.list.length;a<f;a+=1){this.list[a].setProperty(d,c,vxl.def.actor)}return this};vxlActorGroup.prototype._apply=function(a,d){for(var c=0,f=this.list.length;c<f;c+=1){a.apply(this.list[c],d)}return this};vxlActorGroup.prototype.flipNormals=function(){return this._apply(vxlActor.prototype.flipNormals)};vxlActorGroup.prototype.rotateX=function(a){return this._apply(vxlActor.prototype.rotateX,[a])
};vxlActorGroup.prototype.rotateY=function(a){return this._apply(vxlActor.prototype.rotateY,[a])};vxlActorGroup.prototype.rotateZ=function(a){return this._apply(vxlActor.prototype.rotateZ,[a])};vxlActorGroup.prototype.translate=function(a,d,c){return this._apply(vxlActor.prototype.translate,[a,d,c])};vxlActorGroup.prototype.setColor=function(a){return this.setProperty("color",a)};vxlActorGroup.prototype.setLookupTable=function(d,c,a){return this._apply(vxlActor.prototype.setLookupTable,[d,c,a])};
vxlActorGroup.prototype.setOpacity=function(a){return this.setProperty("opacity",a)};vxlActorGroup.prototype.setPicker=function(a,c){return this._apply(vxlActor.prototype.setPicker,[a,c])};vxlActorGroup.prototype.setPosition=function(a,d,c){return this._apply(vxlActor.prototype.setPosition,[a,d,c])};vxlActorGroup.prototype.setScale=function(a,d,c){return this._apply(vxlActor.prototype.setScale,[a,d,c])};vxlActorGroup.prototype.setShininess=function(a){return this.setProperty("shininess",a)};vxlActorGroup.prototype.setVisible=function(a){return this.setProperty("visible",a)
};vxlActorGroup.prototype.setShading=function(a){return this.setProperty("shading",a)};vxlActorGroup.prototype.setVisualizationMode=function(a){return this._apply(vxlActor.prototype.setVisualizationMode,[a])};function vxlActorGroupException(a){this.messages=a}function vxlSilo(a){this._mode=a;this._actors=[];this.data={};this.cached={};this.added={};this.prepare()}vxlSilo.prototype.populate=function(d){var f=d.length;for(var a=0;a<f;a+=1){var c=d[a];if(this.cached[c.UID]==undefined&&c.mode==this._mode){this._actors.push(c);
this.cached[c.UID]=c}}};vxlSilo.prototype.prepare=function(){var a={mixin:[],index:[],matrix:[[],[],[],[]]};this.data=a};vxlSilo.prototype.process=function(){var d=this._actors.length;for(var a=0;a<d;a+=1){var c=this._actors[a];if(this.added[c.UID]==undefined){this.processActor(this._actors[a]);this.added[c.UID]=c}}};vxlSilo.prototype.processActor=function(h){var l=h.model;var o=h.material;var s=this.data.mixin;var n=this.data.index;var q=this.data.matrix;var a=l.vertices.length;var f=l.indices.length;
var m=Array.prototype.slice.call(h._matrix);if(o.colors!=undefined){}else{for(var k=0;k<a;k+=3){s=s.concat([l.vertices[k],l.vertices[k+1],l.vertices[k+2],l.normals[k],l.normals[k+1],l.normals[k+2],o.diffuse[0],o.diffuse[1],o.diffuse[2]]);q[0]=q[0].concat(m.slice(0,4));q[1]=q[1].concat(m.slice(4,8));q[2]=q[2].concat(m.slice(8,12));q[3]=q[3].concat(m.slice(12,16))}}var c=l.indices.slice(0);if(n.length>0){var d=n.max()+1;for(var k=0;k<f;k+=1){c[k]+=d}n=n.concat(c)}else{n=c}this.data.mixin=s;this.data.index=n;
this.data.matrix=q};vxlDashEngine.prototype=new vxlEngine();vxlDashEngine.prototype.constructor=vxlDashEngine;function vxlDashEngine(a){vxlEngine.call(this);this.silos={};this._createSilos();this._gl_buffers={};this._createGLBuffers();this.essl=vxl.util.extend(vxl.def.essl,{ACTOR_MATRIX:"aActorMatrix"})}vxlRenderEngine.prototype.configure=function(){vxlEngine.prototype.configure.call(this);var a=this.gl;a.clearDepth(1);a.disable(a.CULL_FACE)};vxlDashEngine.prototype._createSilos=function(){for(key in vxl.def.actor.mode){this.silos[key]={};
this.silos[key]=new vxlSilo(key)}};vxlDashEngine.prototype._createGLBuffers=function(){var a=this.renderer.gl;for(key in vxl.def.actor.mode){this._gl_buffers[key]={};this._gl_buffers[key].mixin=a.createBuffer();this._gl_buffers[key].index=a.createBuffer();this._gl_buffers[key].matrix=a.createBuffer()}};vxlDashEngine.prototype.allocate=function(c){var a=c._actors;for(key in this.silos){this.silos[key].populate(a);this.silos[key].process()}};vxlDashEngine.prototype.render=function(h){var d=this.renderer;
var c=d.transforms;var a=d.pm;var k=d.gl;var f=this.essl;if(h._actors.length==0){return}c.update();a.setUniform(f.PERSPECTIVE_MATRIX,c.pMatrix);a.setUniform(f.MODEL_VIEW_MATRIX,c.mvMatrix);a.setUniform(f.NORMAL_MATRIX,c.nMatrix);a.setUniform(f.MVP_MATRIX,c.mvpMatrix);this._renderSolid()};vxlDashEngine.prototype.deallocate=function(a){};vxlDashEngine.prototype.enableMatrixAttribute=function(c){var a=this.renderer;var o=a.gl;var d=a.pm._essl;var f=vxl.def.actor.mode;var l=this.silos[f.SOLID];var n=l.data;
var s=o.getAttribLocation(d,c);o.enableVertexAttribArray(s);o.enableVertexAttribArray(s+1);o.enableVertexAttribArray(s+2);o.enableVertexAttribArray(s+3);var t=o.createBuffer();var q=o.createBuffer();var k=o.createBuffer();var h=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,t);o.bufferData(o.ARRAY_BUFFER,new Float32Array(n.matrix[0]),o.STATIC_DRAW);o.vertexAttribPointer(s,4,o.FLOAT,false,0,0);o.bindBuffer(o.ARRAY_BUFFER,q);o.bufferData(o.ARRAY_BUFFER,new Float32Array(n.matrix[1]),o.STATIC_DRAW);o.vertexAttribPointer(s+1,4,o.FLOAT,false,0,0);
o.bindBuffer(o.ARRAY_BUFFER,k);o.bufferData(o.ARRAY_BUFFER,new Float32Array(n.matrix[2]),o.STATIC_DRAW);o.vertexAttribPointer(s+2,4,o.FLOAT,false,0,0);o.bindBuffer(o.ARRAY_BUFFER,h);o.bufferData(o.ARRAY_BUFFER,new Float32Array(n.matrix[3]),o.STATIC_DRAW);o.vertexAttribPointer(s+3,4,o.FLOAT,false,0,0)};vxlDashEngine.prototype._renderSolid=function(){var c=vxl.def.actor.mode;var h=this.silos[c.SOLID];var k=h.data;var a=this.renderer;var f=a.transforms;var d=a.pm;var l=a.gl;var q=this.essl;d.setUniform("uUseShading",true);
d.enableAttribute(q.VERTEX_ATTRIBUTE);d.enableAttribute(q.NORMAL_ATTRIBUTE);d.enableAttribute(q.COLOR_ATTRIBUTE);this.enableMatrixAttribute(q.ACTOR_MATRIX);var o=this._gl_buffers[c.SOLID].mixin;l.bindBuffer(l.ARRAY_BUFFER,o);l.bufferData(l.ARRAY_BUFFER,new Float32Array(k.mixin),l.STATIC_DRAW);d.setAttributePointer(q.VERTEX_ATTRIBUTE,3,l.FLOAT,false,36,0);d.setAttributePointer(q.NORMAL_ATTRIBUTE,3,l.FLOAT,false,36,12);d.setAttributePointer(q.COLOR_ATTRIBUTE,3,l.FLOAT,false,36,24);var n=this._gl_buffers[c.SOLID].index;
l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,n);l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array(k.index),l.STATIC_DRAW);l.drawElements(l.TRIANGLES,k.index.length,l.UNSIGNED_SHORT,0)};